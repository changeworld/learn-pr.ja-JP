ローカルの Ubuntu Linux サーバー上で実行されている既存の Web サイトがあります。 目標は、最新の Ubuntu イメージを使用して Azure VM を作成し、サイトをクラウドに移行することです。 このユニットでは、Azure で仮想マシンを作成するときに決定する必要があるオプションについて学習します。

## <a name="introduction-to-azure-virtual-machines"></a>Azure Virtual Machines の概要

Azure VM は、オンデマンドのスケーラブルなクラウド コンピューティング リソースです。 プロセッサ、メモリ、ストレージ、およびネットワーク リソースが含まれます。 自由に仮想マシンを開始および停止し、Azure portal から、または Azure CLI を使用して仮想マシンを管理できます。 また、リモート Secure Shell (SSH) を使用して実行中の VM に直接接続し、ローカル コンピューターの場合と同じようにコマンドを実行することもできます。

### <a name="running-linux-in-azure"></a>Azure での Linux の実行

Azure で Linux ベースの VM を作成することは簡単です。 Microsoft は主要な Linux ベンダーと提携し、ディストリビューションが Azure プラットフォーム用に確実に最適化されるようにしています。 SUSE、Red Hat、Ubuntu などのさまざまな人気のある Linux ディストリビューションの事前構築済みイメージから仮想マシンを作成することも、クラウドで実行するように独自の Linux ディストリビューションを構築することもできます。

## <a name="creating-an-azure-vm"></a>Azure VM の作成

VM を定義して Azure にデプロイするには、いくつかの方法があります。つまり、Azure portal、スクリプト (Azure CLI または Azure PowerShell を使用)、Azure Resource Manager テンプレートのいずれかを使用します。 いずれの場合も、いくつかの情報を指定する必要があります。それについては、この後すぐに説明します。

Azure Marketplace には、OS と特定のシナリオ用にインストールされた人気のあるソフトウェア ツールの両方を含む、事前構成済みのイメージも用意されています。

![Azure Marketplace の仮想マシン](../media-drafts/2-marketplace-vm-choices.png)

## <a name="resources-used-in-a-linux-vm"></a>Linux VM で使用されるリソース

Azure 内に Linux VM を作成する場合、VM をホストするためのリソースも作成します。 これらのリソースが連携することによってコンピューターが仮想化され、Linux オペレーティング システムが実行されます。 これらのリソースは、存在しているか (VM の作成時に選択します)、または VM と共に作成する必要があります。

- CPU とメモリ リソースを提供する仮想マシン。
- 仮想ハード ディスクを保持する Azure Storage アカウント。
- OS、アプリケーション、データを保持する仮想ディスク。
- 他の Azure サービスやオンプレミスのハードウェアに VM を接続する仮想ネットワーク (VNet)。
- VNet と通信するためのネットワーク インターフェイス。
- VM にアクセスできるようにするための省略可能なパブリック IP アドレス。

他の Azure サービスと同じように、VM を格納する (および、必要に応じて管理のためにこれらのリソースをグループ化する) ための**リソース グループ**が必要です。 新しい VM を作成する場合、既存のリソース グループを使用することも、新しいリソース グループを作成することもできます。

## <a name="choose-the-vm-image"></a>VM イメージを選択する

イメージの選択は、VM を作成するときに行う最初の最も重要な決定事項の 1 つです。 イメージとは、VM の作成に使用するテンプレートです。 これらのテンプレートには、OS と、多くの場合はその他のソフトウェア (開発ツールや Web ホスティング環境など) が含まれています。

コンピューターにインストールできるものはすべて、イメージに含めることができます。 Apache サーバーでの Web アプリのホスティングなど、必要なタスクに正確に対応するように事前構成されたイメージから、VM を作成できます。

> [!TIP]
> カスタム ディスク イメージを作成してアップロードすることもできます。詳しくは、ドキュメントをご覧ください。

## <a name="sizing-your-vm"></a>VM のサイズ設定
物理マシンに一定量のメモリや CPU 電源があるように、仮想マシンにも同様にあります。 Azure では、さまざまなサイズの VM が、異なる価格ポイントで提供されています。 選択したサイズにより、VM の処理能力、メモリ、最大ストレージ容量が決まります。

> [!WARNING]
> 各サブスクリプションには、VM の作成に影響するクォータ制限があります。 既定では、リージョン内のすべての VM で保持できる仮想 "_コア_" の数は最大 20 個です。 VM を複数のリージョンに分割するか、制限を引き上げる[オンライン要求](https://docs.microsoft.com/en-us/azure/azure-supportability/resource-manager-core-quotas-request)を申請することができます。

VM のサイズは複数のカテゴリにグループ化されており、基本的なテストと実行のための B シリーズから、大規模なコンピューティング タスク向けの H シリーズまであります。 実行するワークロードに基づいて VM のサイズを選択する必要があります。 VM 作成後に VM のサイズを変更することは可能ですが、そのためにはまず VM を停止する必要があるので、可能であれば最初から適切なサイズを選択することをお勧めします。

#### <a name="here-are-some-guidelines-based-on-the-scenario-you-are-targeting"></a>対象とするシナリオに基づいたガイドラインを以下に示します。

| 操作内容 | 考慮するサイズ
|-------|------------------|
| **汎用コンピューティング/Web**: テストと開発、小規模から中規模のデータベース、軽度から中程度のトラフィックの Web サーバー。 | B、Dsv3、Dv3、DSv2、Dv2 |
| **高負荷の計算タスク**: トラフィックが中程度の Web サーバー、ネットワーク アプライアンス、バッチ処理、アプリケーション サーバー。 | Fsv2、Fs、F |
| **大容量のメモリ使用量**: リレーショナル データベース サーバー、中規模から大規模のキャッシュ、メモリ内分析。 | Esv3、Ev3、M、GS、G、DSv2、Dv2 |
| **データのストレージと処理**: 高いディスク スループットと IO を必要とするビッグ データ、SQL、および NoSQL データベース。 | Ls |
| **負荷の高いグラフィックスのレンダリング**やビデオ編集、およびディープ ラーニングを使用したモデル トレーニングと推論 (ND)。 | NV、NC、NCv2、NCv3、ND |
| **ハイ パフォーマンス コンピューティング (HPC)**: 高スループットのネットワーク インターフェイスのオプションを備えた、最も高速かつ強力な CPU 仮想マシンが必要な場合。 | H |

## <a name="choosing-storage-options"></a>ストレージ オプションの選択

次の一連の決定では、ストレージに関して解決します。 最初に、ディスク テクノロジを選択できます。 オプションには、従来の円盤状の記憶媒体ベースのハード ディスク ドライブ (HDD) や、より最新のソリッドステート ドライブ (SSD) が含まれます。 ハードウェアを購入する場合と同じように、SSD ストレージは高コストですがパフォーマンスに優れています。

> [!TIP]
> SSD ストレージでは、Standard と Premium の 2 つのレベルを利用できます。 通常のワークロードで優れたパフォーマンスが必要な場合は、Standard SSD ディスクを選択します。 I/O 集中型ワークロードの場合、または非常に高速のデータ処理が必要なミッション クリティカルなシステムの場合は、Premium SSD ディスクを選択します。

### <a name="mapping-storage-to-disks"></a>ディスクへのストレージのマッピング

Azure では、VM 用の物理ディスクを表すために仮想ハード ディスク (VHD) が使用されます。 VHD は、ディスク ドライブの論理形式とデータをレプリケートしますが、Azure Storage アカウント内のページ BLOB として格納されます。 ディスクごとに、使用するストレージの種類 (SSD または HDD) を選択できます。 これにより、一般にはディスクで実行する予定の I/O に基づいて、各ディスクのパフォーマンスを制御することができます。

既定では、2 個の仮想ハード ディスク (VHD) が Linux VM に作成されます。

1. **オペレーティング システム ディスク**。 これはプライマリ ドライブであり、最大容量は 2,048 GB です。 既定のラベルは `/dev/sda` です。

1. **一時ディスク**。 このディスクは、OS またはアプリ用の一時的なストレージを提供します。 Linux 仮想マシンでは、このディスクは `/dev/sdb` であり、Azure Linux エージェントによりフォーマットされて、`/mnt` にマウントされます。 サイズは、VM のサイズに基づいて設定され、スワップ ファイルの格納に使用されます。 

> [!WARNING]
> 一時ディスクは永続的ではありません。 このディスクには、システムにとって重大ではないデータのみを書き込む必要があります。

#### <a name="what-about-data"></a>データについて

プライマリ ドライブに OS だけでなくデータを格納することもできますが、専用の "_データ ディスク_" を作成する方がよい方法です。 追加のディスクを作成して VM にアタッチできます。 各ディスクには最大 4,095 GB のデータを保持でき、ストレージの最大量は選択した VM のサイズによって決まります。

> [!NOTE]
> 興味深い機能として、実際のディスクから VHD イメージを作成することができます。 これにより、オンプレミスのコンピューターからクラウドに "_既存の_" 情報を簡単に移行できます。

### <a name="unmanaged-vs-managed-disks"></a>アンマネージド ディスクとマネージド ディスク

ストレージに関して最後に行う選択は、**アンマネージド** ディスクと**マネージド** ディスクのどちらを使用するかです。

アンマネージド ディスクを使用する場合、VM ディスクに対応する VHD を保持するために使用するストレージ アカウントを自分で管理する必要があります。 使用する領域の容量に対応したストレージ アカウントの料金を負担します。 1 つのストレージ アカウントには、I/O 操作数 20,000/秒という固定レート制限があります。これは、1 つのストレージ アカウントがフル スロットルで 40 個の Standard 仮想ハード ディスクをサポートできることを意味します。 スケールアウトする必要がある場合は、複数のストレージ アカウントが必要であり、複雑になる可能性があります。

マネージド ディスクは、より新しい、お勧めのディスク ストレージ モデルです。 ストレージ アカウントを管理する負担を Azure に移すことで、この複雑さを適切に解決します。 ユーザーはディスクの種類 (Premium または Standard) とディスクのサイズを指定し、ディスクとそれが使用するストレージ "_両方_" の作成と管理は Azure によって行われます。 ストレージ アカウント制限について気にする必要がないため、簡単にスケールアウトできます。その他にもいくつかの利点があります。

- **信頼性の向上**: Azure では、高信頼性の VM に関連付けられた VHD が Azure ストレージのさまざまな部分に配置されて、同等のレベルの回復力が提供されます。
- **セキュリティの向上**: マネージド ディスクは、リソース グループ内の実際の管理対象リソースです。 つまり、ロールベースのアクセス制御を使用して、VHD データを使用できるユーザーを制限することができます。
- **スナップショットのサポート**: スナップショットを使用して、VHD の読み取り専用コピーを作成できます。 所有している VM をシャットダウンする必要がありますが、スナップショットの作成に要する時間はわずか数秒です。 完了したら、VM の電源を入れ、スナップショットを使用して重複する VM を作成し、運用環境の問題をトラブルシューティングしたり、スナップショットが作成された時点に VM をロールバックしたりできます。
- **バックアップのサポート**: Azure Backup を使用して、ディザスター リカバリーのために、マネージド ディスクを異なるリージョンに自動的にバックアップできます。VM のサービスに影響はありません。

## <a name="network-communication"></a>ネットワーク通信

仮想マシンは、仮想ネットワーク (VNet) を使用して外部のリソースと通信します。 VNet は、リソースが通信を行う 1 つのリージョン内のプライベート ネットワークを表します。 仮想ネットワークは、ユーザーがオンプレミスで管理するネットワークと同じようなものです。 サブネットに分割してリソースを分離したり、他のネットワーク (オンプレミスのネットワークを含む) に接続したり、トラフィック規則を適用して受信および送信接続を管理したりできます。

### <a name="planning-your-network"></a>ネットワークの計画

新しい VM を作成するときは、新しい仮想ネットワークの作成、またはリージョン内の既存の VNet の使用を選択できます。

VM と一緒に Azure でネットワークを自動的に作成するとシンプルですが、ほとんどのシナリオに適していない可能性が高くなります。 アーキテクチャ内のすべてのコンポーネントに対するネットワーク要件を "_事前に_" 計画し、必要な VNet の構造を別に作成することをお勧めします。 その後、VM を作成して、既に作成されている VNet に配置します。 このモジュールでは、後でもう少し詳しく仮想ネットワークについて説明します。

仮想マシンを作成する前に、VM の望ましい管理方法を決定する必要があります。 そのオプションを見てみましょう。