オンプレミス環境内の機器では、サーバーの構成を調整することは、一般によく行われています。 この意味で、Azure VM はその環境の拡張機能だと考えることができます。 構成の変更、ネットワークの管理、トラフィックの開放またはブロックなどを、Azure portal、Azure CLI、または Azure PowerShell ツールを使って行うことができます。

サーバーは実行中の状態で、Apache はインストールされ、ページを提供しています。 Microsoft のセキュリティ チームは、すべてのサーバーをロック ダウンすることを必須にしていますが、この VM にはまだ何もしていません。 何も実行していないので、Apache はまだポート 80 をリッスンできます。 Azure のネットワーク構成を調べ、組み込みのセキュリティ サポートを使用してサーバーを強化する方法を見てみましょう。

## <a name="opening-ports-in-azure-vms"></a>Azure VM でポートを開く

<!-- TODO: Azure portal is inconsistent here in applying the NSG.
By default, new VMs are locked down. 

Apps can make outgoing requests, but the only inbound traffic allowed is from the virtual network (e.g., other resources on the same local network), and from Azure's Load Balancer (probe checks). -->

ネットワーク上の複数のプロトコルをサポートするように構成を調整するには、2 つの手順があります。 新しい VM を作成するときに、いくつかの一般的なポート (RDP、HTTP、HTTPS、SSH) を開く機会があります。 ただし、ファイアウォールに対するその他の変更が必要な場合は、手動で調整する必要があります。

このプロセスには、2 つのステップが含まれます。

1. ネットワーク セキュリティ グループを作成します。
2. 必要なポートでのトラフィックを許可する受信規則を作成します。

### <a name="what-is-a-network-security-group"></a>ネットワーク セキュリティ グループとは何ですか?

Azure ネットワーク モデルの基盤である仮想ネットワーク (VNet) によって、分離と保護が提供されます。 ネットワーク セキュリティ グループ (NSG) は、ネットワーク レベルでネットワーク トラフィック規則を適用するために使う主要なツールです。 NSG は、VNet 上で受信トラフィックと送信トラフィックをフィルター処理することによってソフトウェア ファイアウォールを提供する、オプションのセキュリティ レイヤーです。 

セキュリティ グループは、ネットワーク インターフェイス (ホストごとの規則) に関連付けるか、仮想ネットワーク内のサブネットに関連付けるか (複数のリソースに適用するため)、または両方のレベルに関連付けることができます。 

#### <a name="security-group-rules"></a>セキュリティ グループ規則

NGS では、_規則_を使って、ネットワークを経由して移動するトラフィックを許可または拒否します。 各規則は、ソースと宛先のアドレス (または範囲)、プロトコル、ポート (または範囲)、方向 (受信または送信)、数値の優先度を識別し、規則に合致するトラフィックを許可するか拒否するかを決定します。

![ネットワーク セキュリティ グループ規則](../media/7-nsg-rules.png)

各セキュリティ グループには既定のセキュリティ規則があり、上記で説明した既定のネットワーク規則が適用されます。 これらの既定の規則は変更できませんが、オーバーライドすることは_できます_。

#### <a name="how-azure-uses-network-rules"></a>Azure によってネットワーク規則が使用される方法

受信トラフィックの場合は、サブネットに関連付けられているセキュリティ グループが処理され、次にネットワーク インターフェイスに適用されているセキュリティ グループが処理されます。 送信トラフィックは、逆の順番に処理されます (最初にネットワーク インターフェイス、その後にサブネット)。

> [!WARNING]
> 両方のレベルでセキュリティ グループはオプションであることに注意してください。 セキュリティ グループが適用されていない場合、Azure によって**すべてのトラフィックが許可されます**。 これは、VM にパブリック IP がある場合、特に OS に組み込みのファイアウォールが用意されていない場合に、重大なリスクになる可能性があります。

規則は_優先度順_に評価されます (**最も低い優先度**の規則から開始されます)。 拒否規則は常に評価を**停止**します。 たとえば、送信要求がネットワーク インターフェイス規則によってブロックされている場合、サブネットに適用されている規則はチェックされません。 セキュリティ グループを経由するトラフィックが許可されるためには、適用されている_すべての_グループをトラフィックが通過する必要があります。

最後の規則は常に**すべて拒否**の規則です。 これは、受信トラフィックと送信トラフィックの両方を対象に、すべてのセキュリティ グループに優先度 65500 として追加される既定の規則です。 つまり、トラフィックがセキュリティ グループを通過するようにするには、"_許可規則_" を設定する必要があります。そうしないと、既定の最後の規則によってブロックされます。

> [!NOTE]
> SMTP (ポート 25) は特殊なケースであり、サブスクリプション レベルによって、およびアカウントがいつ作成されたかによって、送信 SMTP トラフィックがブロックされる可能性があります。 ビジネス上の妥当性がある場合には、この制限の解除を要求することができます。

この VM ではセキュリティ グループを作成しなかったため、作成して適用してみましょう。

## <a name="creating-network-security-groups"></a>ネットワーク セキュリティ グループの作成

セキュリティ グループは、Azure のほとんどすべてと同様の管理対象リソースです。Azure portal またはコマンド ライン スクリプト ツールを使用して作成することができます。 規則を定義することが課題になります。 HTTP アクセスを許可し、他のすべてをブロックする新しい規則を定義する方法を見てみましょう。