Text Analytics API サービスを呼び出すし、センチメント スコアを取得する、関数の実装を更新してみましょう。

1. 当社の関数を選択する[!INCLUDE [func-name-discover](./func-name-discover.md)]ポータルで関数アプリでします。

1. 展開、**ファイルを表示**画面の右側のメニュー。

1. 下、**ファイルを表示**] タブで [ **index.js**をエディターでコード ファイルを開きます。

1. 内容全体を置き換える**index.js**で次の JavaScript と**保存**します。

[!code-javascript[](../code/discover-sentiment-sort.js?highlight=7)]

このコードで何が起こっているかを見てみましょう。

- テキスト分析サービスを呼び出すには、次のように設定します。 `accessKey`、以前に保存したキーに、コード スニペットの強調表示します。
- Update`uri`から取得したアクセス キー、そのリージョンが異なる場合、リージョンに*westus*この例に示すようにします。
- コード ファイルの下部には、定義した、`documents`配列。 この配列は、Text Analytics サービスに送信ペイロードを示します。
- `documents`配列が 1 つのエントリここでは、これは、関数をトリガーしたキュー メッセージ。 のみ 1 つのドキュメントが配列で、当社のソリューションが一度にで 1 つのメッセージを処理できるだけこととは限りません。 Azure Functions ランタイムを取得し、関数の複数のインスタンスを呼び出すバッチでメッセージを処理*並列*します。 現時点では、既定のバッチ サイズは 16 および最大バッチ サイズは 32 です。
- `id`配列内で一意である必要があります。 `language`プロパティは、ドキュメントのテキストの言語を指定します。
- 次のメソッドを呼び出して`get_sentiments`、Text Analytics api の呼び出しに HTTPS モジュールを使用します。 すべての要求のヘッダーで、サブスクリプション、または、アクセス キーを渡していることを確認します。
- サービスが返されるときに、`response_handler`が呼び出されを使用して、コンソールへの応答を記録しています `context.log`


## <a name="try-it-out"></a>試してみる

キューに並べ替えを見ると、前に、どのようなテストを実行しました見てみましょう。

1. この関数を使用した[!INCLUDE [func-name-discover](./func-name-discover.md)]、展開に一番左にあるテスト メニュー項目をクリックして、関数アプリのポータルで選択されている。

1. 選択、**テスト**メニュー項目し、テストのパネルが開いていることを確認します。 次のスクリーン ショット、どのようなようになります。

    ![関数のテストのパネルを示すスクリーン ショットが展開されます。](../media/test-panel-open-small.png)

1. スクリーン ショットに示すように、要求本文にテキストの文字列を追加します。

1.  クリックして**実行**テスト パネルの下部にあります。

1. 確認、**ログ**コード エディターの下のメイン画面の左下にあるタブが展開されています。

1. いることを確認、**ログ** タブには、関数が完了したログ情報が表示されます。 ウィンドウは、Text Analytics API の呼び出しからの応答にも表示されます。

![パネルのテストと成功したテストの結果を示すスクリーン ショット。](../media/sentiment-response-log1.png)

お疲れさまでした。 [!INCLUDE [func-name-discover](./func-name-discover.md)]設計どおりに動作します。 この例では非常に長旅メッセージで渡され、0.98 経由でのスコアを受信しました。 何かの小さいオプティミスティックにメッセージを変更してください、テストを再実行し、応答に注意してください。

## <a name="add-a-message-to-the-queue"></a>メッセージをキューに追加する

テストをもう一度見てみましょう。 今回は、ポータルの [テスト] ウィンドウを使用せずが実際にメッセージを入力キューに配置され処理内容を見る。

1. リソース グループに移動し、**リソース グループ**ポータルのセクション。

1. このレッスンで使用されるリソース グループを選択します。

1. **リソース グループ**パネルが表示されたら、ストレージ アカウント エントリを検索して選択します。

    ![リソース グループ ウィンドウで選択したストレージ アカウントをスクリーン ショット。](../media/select-storage-account.png)

1. 選択**ストレージ エクスプ ローラー (プレビュー)** ストレージ アカウントのメイン ウィンドウの左側のメニュー。  この操作は、ポータル内で Azure Storage Explorer を開きます。 この段階で画面に次のスクリーン ショットのようになります。

![現在キューなしで、ストレージ アカウントを表示するストレージ エクスプ ローラーのスクリーン ショット。](../media/sa-no-queue.png)

ご覧のように、このストレージ アカウントに、キューがまだある、それではこれを修正しましたはありません。

5. このレッスンでは以前から覚えて場合、トリガーに関連付けられたキューという名前**新しいフィードバック q**します。 右クリックし、**キュー**ストレージ エクスプ ローラーでアイテムを選択します*Create Queue*します。

1. 表示されたダイアログ ボックスで、次のように入力します。**新しいフィードバック q**  をクリック**OK**します。 この入力キューがあるようになりました。

1. このキューのデータ エクスプ ローラーを参照してください。 左側のメニューで、新しいキューを選択します。 予想どおり、キューが空です。 使用してキューにメッセージを追加してみましょう、**メッセージの追加**ウィンドウの上部にあるコマンド。

1. **メッセージの追加**ダイアログ ボックスで、入力"このメッセージの送信元、入力キューでは、新しいフィードバック q"に、**メッセージ テキスト**フィールドし、をクリックして **[ok]** ダイアログの下部にあります。

1. データ エクスプ ローラーで、次のスクリーン ショットのようなメッセージを確認します。
    ![キューで作成したメッセージと、ストレージ アカウントを表示するストレージ エクスプ ローラーのスクリーン ショット。](../media/message-in-input-queue.png)

1. 数秒後に、後に次のようにクリックします。**更新**キューの表示を更新します。 キューが空であるもう一度確認します。 キューからメッセージを読み取る何かする必要があります。

1. ポータルで開く、関数に戻り、**モニター**タブ。最新のメッセージを選択し、ボックスの一覧。 この関数が新しいフィードバック q に投稿してキュー メッセージを処理することを確認します。

![関数が新しいフィードバック q を掲載したキュー メッセージを処理することを示すエントリを示すスクリーン ショットの監視ダッシュ ボード。](../media/message-in-monitor.png)

このテストでは、キューに投稿するものとし、それを処理する関数が表示される完全なラウンド トリップを行いました。

進行状況は、ソリューションを加えています。 関数は何かの便利な行っていますようになりました。 テキストを入力キューから受信され、センチメント スコアを取得する、Text Analytics API サービスを呼び出すことです。  また、Azure portal と、ストレージ エクスプ ローラーで、関数をテストする方法を学習しました。 次の手順で出力バインドを使用してキューに書き込むがいかに簡単か見ていきます。