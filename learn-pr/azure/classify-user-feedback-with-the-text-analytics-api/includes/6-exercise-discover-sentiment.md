Text Analytics API サービスを呼び出してセンチメント スコアを返すように関数の実装を更新しましょう。

1. ポータルの関数アプリで関数 [!INCLUDE [func-name-discover](./func-name-discover.md)] を選択します。

1. 画面の右側にある **[ファイルの表示]** メニューを展開します。

1. **[ファイルの表示]** タブで **[index.js]** を選択し、エディターでコード ファイルを開きます。

1. **index.js** の内容全体を次の JavaScript に変更し、**[保存]** をクリックします。

    [!code-javascript[](../code/discover-sentiment-sort.js?highlight=7)]

1. 貼り付けたコードの `accessKey` 値を、このモジュールで先に保存した Text Analytics API のアクセス キーに変更します。 

1. `uri` 値をアクセス キーの取得元であるリージョンに更新します。

このコードで何が起こっているかを見てみましょう。

- Text Analytics サービスを呼び出すたびにアクセス キーが必要になりますが、これは `Ocp-Apim-Subscription-Key` ヘッダーとして追加します。 
- 各呼び出しは、コード内で `uri` により定義されているリージョン固有のエンドポイントに行われます。
- コード ファイルの末尾に、`documents` 配列を定義してあります。 この配列は、Text Analytics サービスに送信するペイロードです。
- ここでは、`documents` 配列には単一のエントリがあります。これは、関数をトリガーしたキュー メッセージです。 この配列内には 1 つのドキュメントしかありませんが、ソリューションが一度に 1 つのメッセージしか処理できないわけではありません。 Azure Functions ランタイムは、関数のいくつかのインスタンスを "*並列*" で呼び出して、メッセージを一括して取得および処理します。 現在、既定のバッチ サイズは 16 で、最大バッチ サイズは 32 です。
- `id` は、配列内で一意である必要があります。 `language` プロパティは、ドキュメント テキストの言語を指定するものです。
- 次に、`get_sentiments` メソッドを呼び出します。このメソッドは、HTTPS モジュールを使用して、Text Analytics API を呼び出します。 各要求のヘッダーで、サブスクリプションまたはアクセス キーを渡している点に注意してください。
- サービスが終了するとき、`response_handler` が呼び出され、コンソールへの応答が `context.log` を使用してログに記録されます


## <a name="try-it-out"></a>試してみる

キューへの分類を見る前に、テスト実行用にどのようなものがあるかを確認しておきましょう。

1. ポータルの Function App 領域で関数 [!INCLUDE [func-name-discover](./func-name-discover.md)] を選択した状態で、右端にある **[テスト]** メニュー項目をクリックします。

1. **[テスト]** メニュー項目を選択し、テスト パネルを開いていることを確認します。

1. スクリーンショットに示すように、要求本文にテキストの文字列を追加します。

    ![展開された関数のテスト パネルを示すスクリーンショット。](../media/test-panel-open-small.png)

1.  テスト パネルの下部にある **[実行]** をクリックします。

1. メイン画面の左下のコード エディターの下で、**[ログ]** タブが展開されていることを確認します。

1. **[ログ]** タブで、関数が完了したというログ情報が表示されていることを確認します。 ウィンドウには、Text Analytics API 呼び出しからの応答も表示されます。

    ![テスト パネルと成功したテストの結果を示すスクリーンショット。](../media/sentiment-response-log1.png)

うまくいきました。 [!INCLUDE [func-name-discover](./func-name-discover.md)] は設計どおりに動作します。 この例では、非常に明るいメッセージを渡し、0.98 を超えるスコアを受け取りました。 それよりも明るくないメッセージに変更してテストを再実行し、応答に注意してみてください。

## <a name="add-a-message-to-the-queue"></a>メッセージをキューに追加する

テストを繰り返してみましょう。 今回は、ポータルのテスト ウィンドウを使用する代わりに、実際に入力キューにメッセージを入れて、何が起きるかを監視します。

1. ポータルの **[リソース グループ]** セクションで、該当するリソース グループに移動します。

1. このレッスンで使用されたリソース グループである、<rgn>[サンドボックス リソース グループ名]</rgn> を選択します。

1. 表示された **[リソース グループ]** パネルで、[ストレージ アカウント] エントリを検索して選択します。

    ![スクリーンショット ([リソース グループ] ウィンドウでストレージ アカウントを選択したところ)。](../media/select-storage-account.png)

1. [ストレージ アカウント] メイン ウィンドウの左側のメニューから **[ストレージ エクスプローラー (プレビュー)]** を選択します。 この操作により、ポータル内で Azure Storage Explorer が開きます。 

    ![ストレージ アカウントが示されているストレージ エクスプローラーのスクリーンショット (現時点でキューはなし)。](../media/sa-no-queue.png)

    ご覧のとおり、このストレージ アカウントにはまだキューがないので追加しましょう。

5. このレッスンの前の方で、トリガーに関連付けられているキューに **new-feedback-q** という名前を付けました。 ストレージ エクスプローラーで **[キュー]** 項目を右クリックし、*[キューの作成]* を選択します。

1. ダイアログ ボックスが開いたら、「**new-feedback-q**」と入力して **[OK]** をクリックします。 これで、入力キューができました。

1. 左側のメニューで新しいキューを選択して、このキューのデータ エクスプローラーを表示します。 当然、キューは空です。 ウィンドウ上部にある **[メッセージの追加]** コマンドを使って、キューにメッセージを追加してみましょう。

1. **[メッセージの追加]** ダイアログ ボックスの **[メッセージ テキスト]** フィールドに「This message came from our input queue, new-feedback-q」 (このメッセージは入力キューの new-feedback-q からのものです) と入力し、ダイアログの下部にある **[OK]** をクリックします。

1. データ エクスプローラーで、次のスクリーンショットのようなメッセージを確認します。
    ![ストレージ アカウントが示されているストレージ エクスプローラーのスクリーンショット (作成したメッセージがキューにある状態)。](../media/message-in-input-queue.png)

1. 数秒後、**[最新の情報に更新]** をクリックして、キューのビューを最新の情報に更新します。 キューが**空**であるかどうかをもう一度確認します。 何かがキューからメッセージを読み取ったはずです。

1. ポータルで関数に戻り、**[モニター]** タブを開きます。一覧で最新のメッセージを選択します。 new-feedback-q に投稿したキュー メッセージが関数によって処理されたことを確認します。 このログでは結果が遅れることがあります。そのため、場合によっては、数分待ち、*[更新]* を押す必要があります。

    ![new-feedback-q に投稿したキュー メッセージが関数によって処理されたことを示すエントリが表示されている [モニター] ダッシュボードのスクリーンショット。](../media/message-in-monitor.png)

    このテストでは、キューに何かを追加した後で関数によってそれが処理されるのを確認する、完全なラウンドトリップを行いました。

ソリューションは着実に進歩しています。 関数が有益なことを実行できるようになりました。 入力キューからテキストを受け取り、Text Analytics API サービスを呼び出してセンチメント スコアを取得しています。 また、Azure portal と Storage Explorer を通じて関数をテストする方法も学習しました。 次の演習では、出力バインディングを使用したキューへの書き込みがいかに簡単であるかを見ていきます。