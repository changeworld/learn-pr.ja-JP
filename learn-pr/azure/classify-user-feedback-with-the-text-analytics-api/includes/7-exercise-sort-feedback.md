<span data-ttu-id="6295f-101">すべての関数には、トリガー バインドが 1 つだけ備わっています。</span><span class="sxs-lookup"><span data-stu-id="6295f-101">Every function must have one, and only one, trigger binding.</span></span> <span data-ttu-id="6295f-102">これは、コードの実行をどのようにして引き起こすかを定義するものです。</span><span class="sxs-lookup"><span data-stu-id="6295f-102">It defines how our code is triggered to run.</span></span> <span data-ttu-id="6295f-103">トリガーに加え、データ ソースへの接続手段となるバインドを定義することができます。</span><span class="sxs-lookup"><span data-stu-id="6295f-103">In addition to a trigger, we can define bindings that connect us to data sources.</span></span> <span data-ttu-id="6295f-104">既出のソリューション図で、3 つのキューにメッセージを送信したいと思います。</span><span class="sxs-lookup"><span data-stu-id="6295f-104">If you remember from our diagram of the solution, we want to send messages to three queues.</span></span> <span data-ttu-id="6295f-105">それらの接続を出力バインドとして関数に定義することになります。</span><span class="sxs-lookup"><span data-stu-id="6295f-105">So, we'll define those connections as output bindings in our function.</span></span> <span data-ttu-id="6295f-106">これらのバインドは、**[出力バインディング]** という UI で作成することができます。</span><span class="sxs-lookup"><span data-stu-id="6295f-106">We could create those bindings through the **Output binding** UI.</span></span> <span data-ttu-id="6295f-107">ただしここでは、時間を節約するために構成ファイルを直接編集します。</span><span class="sxs-lookup"><span data-stu-id="6295f-107">However, to save time, we'll edit the config file directly.</span></span>

1. <span data-ttu-id="6295f-108">Function App ポータルで目的の関数 ([!INCLUDE [func-name-discover](./func-name-discover.md)]) を選択します。</span><span class="sxs-lookup"><span data-stu-id="6295f-108">Select our function, [!INCLUDE [func-name-discover](./func-name-discover.md)], in the Function Apps portal.</span></span>

1. <span data-ttu-id="6295f-109">画面の右側にある **[ファイルの表示]** メニューを展開します。</span><span class="sxs-lookup"><span data-stu-id="6295f-109">Expand the **View files** menu on the right of the screen.</span></span>

1. <span data-ttu-id="6295f-110">**[ファイルの表示]** タブで **[function.json]** を選択し、エディターで構成ファイルを開きます。</span><span class="sxs-lookup"><span data-stu-id="6295f-110">Under the **View files** tab, select **function.json** to open the config file in the editor.</span></span>

1. <span data-ttu-id="6295f-111">構成ファイルの内容全体を次の JSON に置き換えます。</span><span class="sxs-lookup"><span data-stu-id="6295f-111">Replace the entire content of the config file with the following JSON.</span></span> 

[!code-json[](../code/function.json)]

<span data-ttu-id="6295f-112">この構成には、新しいバインドを 3 つ追加しています。</span><span class="sxs-lookup"><span data-stu-id="6295f-112">We've added three new bindings to the config.</span></span>

- <span data-ttu-id="6295f-113">新しいバインドの種類は、いずれも `queue` です。</span><span class="sxs-lookup"><span data-stu-id="6295f-113">Each new binding is of type `queue`.</span></span> <span data-ttu-id="6295f-114">フィードバックのセンチメントが明らかになった後、3 つのキューにフィードバック メッセージが追加されます。これらのバインドは、それらのキューに使用するものです。</span><span class="sxs-lookup"><span data-stu-id="6295f-114">These bindings are for the three queues that we'll populate with our feedback messages to once we know the sentiment of the feedback.</span></span>
- <span data-ttu-id="6295f-115">メッセージはこれらのキューに対してポストされるため、各バインドの方向は `out` として定義します。</span><span class="sxs-lookup"><span data-stu-id="6295f-115">Each binding has a direction defined as `out`, since we'll post messages to these queues.</span></span>
- <span data-ttu-id="6295f-116">それぞれのバインドには、同じストレージ アカウント接続を使用します。</span><span class="sxs-lookup"><span data-stu-id="6295f-116">Each binding uses the same connection to our storage account.</span></span>
- <span data-ttu-id="6295f-117">各バインドには、一意の `queueName` と `name` があります。</span><span class="sxs-lookup"><span data-stu-id="6295f-117">Each binding has a unique `queueName` and `name`.</span></span>

<span data-ttu-id="6295f-118">キューには、簡単にメッセージを追加できます (例: `context.bindings.negativeFeedbackQueueItem = "<message>"`)。</span><span class="sxs-lookup"><span data-stu-id="6295f-118">Posting a message to a queue is as easy as saying, for example,  `context.bindings.negativeFeedbackQueueItem = "<message>"`.</span></span>

## <a name="update-implementation-to-sort-feedback-into-queues-based-on-sentiment-score"></a><span data-ttu-id="6295f-119">センチメント スコアに基づいてフィードバックを各キューに分類するよう実装を更新する</span><span class="sxs-lookup"><span data-stu-id="6295f-119">Update implementation to sort feedback into queues based on sentiment score</span></span>

<span data-ttu-id="6295f-120">フィードバック ソーターの目的は、ポジティブ、ニュートラル、ネガティブの 3 つのバケットにフィードバックを分類することです。</span><span class="sxs-lookup"><span data-stu-id="6295f-120">The goal of our feedback sorter is to sort feedback into three buckets, positive, neutral, and negative.</span></span> <span data-ttu-id="6295f-121">ここまでで、入力キューを追加し、Text Analytics API を呼び出すコードを追加して、出力キューを定義しました。</span><span class="sxs-lookup"><span data-stu-id="6295f-121">So far, we have our input queue, our code to call Text Analytics API, and we've defined our output queues.</span></span> <span data-ttu-id="6295f-122">このセクションでは、センチメントに基づいてメッセージを各キューに移動するロジックを追加します。</span><span class="sxs-lookup"><span data-stu-id="6295f-122">In this section, we'll add the logic to move messages into those queues based on sentiment.</span></span>

1. <span data-ttu-id="6295f-123">目的の関数 ([!INCLUDE [func-name-discover](./func-name-discover.md)]) に移動し、もう一度コード エディターで `index.js` を開きます。</span><span class="sxs-lookup"><span data-stu-id="6295f-123">Navigate to our function, [!INCLUDE [func-name-discover](./func-name-discover.md)], and  open `index.js` in the code editor again.</span></span>

1. <span data-ttu-id="6295f-124">この実装を次のように置き換えます。</span><span class="sxs-lookup"><span data-stu-id="6295f-124">Replace the implementation with the following update.</span></span>
[!code-javascript[](../code/discover-sentiment+sort.js?highlight=25-48)]

<span data-ttu-id="6295f-125">強調表示されているのは、既存の実装に追加したコードです。</span><span class="sxs-lookup"><span data-stu-id="6295f-125">We've added the highlighted code to our implementation.</span></span> <span data-ttu-id="6295f-126">このコードによって、Text Analytics API コグニティブ サービスからの応答が解析されます。</span><span class="sxs-lookup"><span data-stu-id="6295f-126">The code parses the response from the Text Analytics API cognitive service.</span></span> <span data-ttu-id="6295f-127">メッセージは、センチメント スコアに基づき、3 つの出力キューのいずれかに転送されます。</span><span class="sxs-lookup"><span data-stu-id="6295f-127">Based on the sentiment score, the message is forwarded to one of or three output queues.</span></span> <span data-ttu-id="6295f-128">メッセージをポストするコードでは単に、適切なバインド パラメーターを設定しています。</span><span class="sxs-lookup"><span data-stu-id="6295f-128">The code to post the message is just setting the correct binding parameter.</span></span>

## <a name="try-it-out"></a><span data-ttu-id="6295f-129">試してみる</span><span class="sxs-lookup"><span data-stu-id="6295f-129">Try it out</span></span>

<span data-ttu-id="6295f-130">更新後の実装をテストするために、Storage Explorer に戻りましょう。</span><span class="sxs-lookup"><span data-stu-id="6295f-130">To test the updated implementation, we'll head back to the Storage Explorer.</span></span> 

1. <span data-ttu-id="6295f-131">ポータルの **[リソース グループ]** セクションで、該当するリソース グループに移動します。</span><span class="sxs-lookup"><span data-stu-id="6295f-131">Navigate to your resource group in the **Resource Groups** section of the portal.</span></span>

1. <span data-ttu-id="6295f-132">このレッスンで使用したリソース グループを選択します。</span><span class="sxs-lookup"><span data-stu-id="6295f-132">Select the resource group used in this lesson.</span></span>

1. <span data-ttu-id="6295f-133">開いた **[リソース グループ]** パネルで、[ストレージ アカウント] エントリを探して選択します。</span><span class="sxs-lookup"><span data-stu-id="6295f-133">In the **Resource group** panel that opens, locate the Storage Account entry and select it.</span></span>
<span data-ttu-id="6295f-134">![スクリーンショット ([リソース グループ] ウィンドウでストレージ アカウントを選択したところ)。](../media-draft/select-storage-account.png)</span><span class="sxs-lookup"><span data-stu-id="6295f-134">![Screenshot storage account selected in the Resource Group window.](../media-draft/select-storage-account.png)</span></span>

1. <span data-ttu-id="6295f-135">[ストレージ アカウント] メイン ウィンドウの左側のメニューから **[ストレージ エクスプローラー (プレビュー)]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="6295f-135">Select **Storage Explorer (preview)** from the left menu of the Storage Account main window.</span></span>  <span data-ttu-id="6295f-136">この操作により、ポータル内で Azure Storage Explorer が開きます。</span><span class="sxs-lookup"><span data-stu-id="6295f-136">This action opens the Azure Storage Explorer inside the portal.</span></span> <span data-ttu-id="6295f-137">この段階では、画面は次のスクリーンショットのようになります。</span><span class="sxs-lookup"><span data-stu-id="6295f-137">Your screen should look like the following screenshot at this stage.</span></span>
<span data-ttu-id="6295f-138">![ストレージ アカウントを表示する Storage Explorer のスクリーンショット (現時点でキューは 1 つ)。](../media-draft/storage-explorer-menu-inputq.png)</span><span class="sxs-lookup"><span data-stu-id="6295f-138">![Screenshot of storage explorer showing our storage account, with one queue currently.](../media-draft/storage-explorer-menu-inputq.png)</span></span>

<span data-ttu-id="6295f-139">**[キュー]** コレクションにキューが 1 つ表示されています。</span><span class="sxs-lookup"><span data-stu-id="6295f-139">We have one queue listed under the **Queues** collection.</span></span> <span data-ttu-id="6295f-140">このモジュールの前出のテスト セクションで定義した入力キュー [!INCLUDE [input-q](./q-name-input.md)] です。</span><span class="sxs-lookup"><span data-stu-id="6295f-140">This queue is [!INCLUDE [input-q](./q-name-input.md)],  the input queue we defined in the preceding test section of the module.</span></span>

1. <span data-ttu-id="6295f-141">左側のメニューから [!INCLUDE [input-q](./q-name-input.md)] を選択して、このキューのデータ エクスプローラーを表示します。</span><span class="sxs-lookup"><span data-stu-id="6295f-141">Select [!INCLUDE [input-q](./q-name-input.md)] in the left-hand menu to see the data explorer for this queue.</span></span> <span data-ttu-id="6295f-142">当然、キューにデータはありません。</span><span class="sxs-lookup"><span data-stu-id="6295f-142">As expected, the queue had no data.</span></span> <span data-ttu-id="6295f-143">ウィンドウ上部にある **[メッセージの追加]** コマンドを使って、キューにメッセージを追加してみましょう。</span><span class="sxs-lookup"><span data-stu-id="6295f-143">Let's add a message to the queue using the **Add Message** command at the top of the window.</span></span> 

1. <span data-ttu-id="6295f-144">**[メッセージの追加]** ダイアログの </span><span class="sxs-lookup"><span data-stu-id="6295f-144">In the **Add Message** dialog, enter "I'm having fun with this exercise!"</span></span> <span data-ttu-id="6295f-145">**[メッセージ テキスト]** フィールドに「I'm having fun with this exercise!」と入力し、ダイアログの一番下にある **[OK]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="6295f-145">into the **Message text** field and click **OK** at the bottom of the dialog.</span></span> 

1. <span data-ttu-id="6295f-146">[!INCLUDE [input-q](./q-name-input.md)] のデータ ウィンドウにメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="6295f-146">The message is displayed in the data window for [!INCLUDE [input-q](./q-name-input.md)].</span></span> <span data-ttu-id="6295f-147">数秒後、データ ビューの一番上にある **[最新の情報に更新]** をクリックして、キューのビューを最新の情報に更新します。</span><span class="sxs-lookup"><span data-stu-id="6295f-147">After a few seconds, click **Refresh** at the top of the data view to refresh the view of the queue.</span></span> <span data-ttu-id="6295f-148">しばらくしてメッセージが消えるようすを観察してください。</span><span class="sxs-lookup"><span data-stu-id="6295f-148">Observe that the message disappears after a while.</span></span> <span data-ttu-id="6295f-149">どこに行ってしまったのでしょうか。</span><span class="sxs-lookup"><span data-stu-id="6295f-149">So, where did it go?</span></span>

1. <span data-ttu-id="6295f-150">左側のメニューの **[キュー]** コレクションを右クリックします。</span><span class="sxs-lookup"><span data-stu-id="6295f-150">Right-click on the **QUEUES** collection in the left-hand menu.</span></span> <span data-ttu-id="6295f-151">"*新しい*" キューが出現していることがわかります。</span><span class="sxs-lookup"><span data-stu-id="6295f-151">Observe that a *new* queue has appeared.</span></span>
<span data-ttu-id="6295f-152">![Storage Explorer のスクリーンショット。コレクションに新しいキューが作成されている。</span><span class="sxs-lookup"><span data-stu-id="6295f-152">![Screenshot of Storage Explorer with showing a new queue has been created in the collection.</span></span> <span data-ttu-id="6295f-153">キューにはメッセージが 1 つ存在している。](../media-draft/sa-new-output-q.png)</span><span class="sxs-lookup"><span data-stu-id="6295f-153">The queue has one message.](../media-draft/sa-new-output-q.png)</span></span>

<span data-ttu-id="6295f-154">キュー [!INCLUDE [positive-q](./q-name-positive.md)] は、初めてメッセージがポストされたときに自動的に作成されたものです。</span><span class="sxs-lookup"><span data-stu-id="6295f-154">The queue [!INCLUDE [positive-q](./q-name-positive.md)] was automatically created when a message was posted to it for the first time.</span></span> <span data-ttu-id="6295f-155">Azure Functions のキュー出力バインドでは、ポスト先となる出力キューを事前に手動で作成する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="6295f-155">With Azure Functions queue output bindings, you don't have to manually create the output queue before posting to it!</span></span> <span data-ttu-id="6295f-156">受信メッセージが関数によって [!INCLUDE [positive-q](./q-name-positive.md)] に分類されていることを確認したら、次のメッセージがどこに到達するかを見てみましょう。</span><span class="sxs-lookup"><span data-stu-id="6295f-156">Now that we see an incoming message has been sorted by our function into [!INCLUDE [positive-q](./q-name-positive.md)], let's see where the following messages land.</span></span>

5. <span data-ttu-id="6295f-157">上記と同じ手順を使って次のメッセージを [!INCLUDE [input-q](./q-name-input.md)] に追加します。</span><span class="sxs-lookup"><span data-stu-id="6295f-157">Using the same steps as above, add the following messages to [!INCLUDE [input-q](./q-name-input.md)].</span></span>

- <span data-ttu-id="6295f-158">"I like broccoli!"</span><span class="sxs-lookup"><span data-stu-id="6295f-158">"I like broccoli!"</span></span>
- <span data-ttu-id="6295f-159">"Microsoft is a company"</span><span class="sxs-lookup"><span data-stu-id="6295f-159">"Microsoft is a company"</span></span>

6. <span data-ttu-id="6295f-160">[!INCLUDE [input-q](./q-name-input.md)] が再び空になるまで **[最新の情報に更新]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="6295f-160">Click **Refresh** until [!INCLUDE [input-q](./q-name-input.md)] is empty once again.</span></span> <span data-ttu-id="6295f-161">このプロセスには少し時間がかかる場合があります。何度か更新ボタンを押さなければならないこともあります。</span><span class="sxs-lookup"><span data-stu-id="6295f-161">This process might take a few moments and require several refreshes.</span></span>

1. <span data-ttu-id="6295f-162">**[キュー]** コレクションを右クリックすると、さらに 2 つのキューが出現していることがわかります。</span><span class="sxs-lookup"><span data-stu-id="6295f-162">Right-click on the **QUEUES** collection and observe two more queues appearing.</span></span> <span data-ttu-id="6295f-163">キューの名前はそれぞれ [!INCLUDE [neutral-q](./q-name-neutral.md)] と [!INCLUDE [negative-q](./q-name-negative.md)] です。</span><span class="sxs-lookup"><span data-stu-id="6295f-163">The queues are named [!INCLUDE [neutral-q](./q-name-neutral.md)] and [!INCLUDE [negative-q](./q-name-negative.md)].</span></span> <span data-ttu-id="6295f-164">これには数秒かかる場合があるので、新しいキューが表示されるまで、**[キュー]** コレクションの更新操作を繰り返してください。</span><span class="sxs-lookup"><span data-stu-id="6295f-164">This might take a few seconds, so continue refreshing the **QUEUES** collection until new queues.</span></span> <span data-ttu-id="6295f-165">完了すると、キューの一覧が次のように表示されます。</span><span class="sxs-lookup"><span data-stu-id="6295f-165">When complete, your queue list should look like the following.</span></span>

![[キュー] コレクションに 4 つのキューを表示する Storage Explorer メニューのスクリーンショット。](../media-draft/sa-final-q-list.png)

<span data-ttu-id="6295f-167">一覧に表示されている各キューをクリックして、メッセージが存在するかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="6295f-167">Click on each queue in the list to see whether they have messages.</span></span> <span data-ttu-id="6295f-168">先ほど示したメッセージを追加した場合、[!INCLUDE [positive-q](./q-name-positive.md)]、[!INCLUDE [neutral-q](./q-name-neutral.md)]、[!INCLUDE [negative-q](./q-name-negative.md)] にそれぞれ 1 つメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="6295f-168">If you added the suggested messages, you should see one message in [!INCLUDE [positive-q](./q-name-positive.md)], [!INCLUDE [neutral-q](./q-name-neutral.md)], and [!INCLUDE [negative-q](./q-name-negative.md)].</span></span>

<span data-ttu-id="6295f-169">うまくいきました。</span><span class="sxs-lookup"><span data-stu-id="6295f-169">Congratulations!</span></span> <span data-ttu-id="6295f-170">これで正常に機能するフィードバック ソーターが完成しました。</span><span class="sxs-lookup"><span data-stu-id="6295f-170">We now have a working feedback sorter!</span></span> <span data-ttu-id="6295f-171">入力キューにメッセージが到着すると、関数が Text Analytics API サービスを使ってセンチメント スコアを取得します。</span><span class="sxs-lookup"><span data-stu-id="6295f-171">As messages arrive in the input queue, our function uses the Text Analytics API service to get a sentiment score.</span></span> <span data-ttu-id="6295f-172">そのスコアに基づいて、メッセージが適切なキューに転送されます。</span><span class="sxs-lookup"><span data-stu-id="6295f-172">Based on that score, the function forwards the messages to the appropriate queue.</span></span> <span data-ttu-id="6295f-173">この関数は 1 度に 1 つのキュー アイテムしか処理できないように見えますが、実際には、Azure Functions Runtime は複数のキュー アイテムを一括で読み取り、さらに関数のインスタンスを追加で生成することによって、それらのアイテムを並列に処理します。</span><span class="sxs-lookup"><span data-stu-id="6295f-173">While it seems like the function processes only one queue item at a time, the Azure Functions runtime will actually read batches of queue items and spin up other instances of our function to process them in parallel.</span></span> 