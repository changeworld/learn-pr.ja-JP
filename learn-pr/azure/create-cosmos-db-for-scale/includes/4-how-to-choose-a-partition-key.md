勤務しているオンライン小売業者では、間もなく新しい地理的地域に拡張することが計画されています。 この動きにより、顧客ベースおよびトランザクション ボリュームが増大します。 必要なときはいつでも拡張に確実に対処できるようにデータベースの備えを整えておく必要があります。

パーティション戦略を使用すれば、ご利用のデータベースを拡大する必要が生じたとき、それを容易に実施し、クエリおよびトランザクションを引き続き効率的に実行できるようにすることができます。

## <a name="what-is-a-partition-strategy"></a>パーティション戦略とは?

単一のサーバーまたは単一のパーティションに新しいデータを追加し続けた場合、最終的にそれらは容量不足になります。 これに備えるには、スケール アップではなく**スケール アウト**を行うためにパーティション戦略が必要です。 スケール アウトは水平方向のスケーリングとも呼ばれています。このスケーリングでは、アプリケーションでさらにパーティションが必要になったときに、ご利用のデータベースにそれらのパーティションを追加することができます。

Azure Cosmos DB でのパーティションおよびスケール アウト戦略は、コレクション作成時に設定される値であるパーティション キーによって主導されます。 パーティション キーはいったん設定すると、コレクションを作成し直さない限り変更することはできません。このため、適切なパーティション キーを選択することは、開発プロセスの早い段階で行うべき重要な決定事項となります。  

このユニットでは、ご自分のシナリオに適しているパーティション キーを選択する方法を学習し、Azure Cosmos DB によって自動的に実行される自動スケールを活用します。

## <a name="what-is-a-partition-key"></a>パーティション キーとは

パーティション キーは、クエリ対象となる頻度が高いご利用のデータベース内の値を表します。 このオンライン小売シナリオでは、`userID` または `productId` の値をパーティション キーとして使用するのが適切です。これらの値は一意であり、レコードのルックアップに使用される可能性が高いからです。 `userID` が適しているのは、個人用設定、ショッピング カート、注文履歴、ユーザーのプロファイル情報などをアプリケーションで頻繁に取得する必要がある場合です。 `productId` が適しているのは、在庫レベル、運送費、色のオプション、倉庫の場所などに対してアプリケーションでクエリを実行する必要がある場合です。

パーティション キーでは、演算をデータベース全体に分散することを目指す必要があります。 要求を分散するのは、ホット パーティションを回避するためです。 ホット パーティションとは、他のパーティションよりもはるかに多くの要求を受信している単一のパーティションです。これによってスループットのボトルネックが作成される可能性があります。 たとえば、ご利用の eコマース アプリケーションにおいて、現在の時刻はパーティションキーとして適切ではありません。それは、すべての受信データが単一のパーティション キーに送られるからです。 それよりも、`userID` または `productId` の方が適切です。サイト上のユーザーが自分のショッピング カートやプロファイル情報を追加または更新する頻度はどのユーザーでもほぼ同じである可能性が高く、したがって読み取りと書き込みがすべてのユーザー パーティションとプロダクト パーティションに分散されるからです。

各パーティション キーの最大ストレージ スペースは 10 GB です。これは、Azure Cosmos DB 内の 1 つの物理パーティションのサイズとなります。 このため、`userID` または `productId` のレコード 1 つのサイズが 10 GB を超える場合は、代わりに複合キーを使用して各レコードのサイズを小さくすることを検討します。 複合キーの例としては `userID-date` があり、値は **CustomerName-08072018** などとなります。 この複合キー アプローチを使用すると、ユーザーがサイトを訪問した日ごとに新しいパーティションを作成することができます。

## <a name="best-practices"></a>ベスト プラクティス

適切なパーティション キーを決めようとしているが、明らかな答えが得られない場合、留意すべきいくつかのヒントを次に示します。

- パーティション キーの数が多すぎても心配しないでください。 使用するパーティション キーの数が多いほど、拡張性が高くなります。
- 読み取り負荷の高いワークロード用に最適なパーティション キーを決定するには、使用するつもりでいるクエリのうち上位 3 番目から 5 番目を確認します。 WHERE 句に最も頻繁に含まれている値は、パーティション キーの候補として適切です。
- 書き込み負荷の高いワークロードの場合、パーティション キーは複数ドキュメント トランザクションのスコープになるため、ご利用のワークロードのトランザクション上のニーズを理解することが必要です。
