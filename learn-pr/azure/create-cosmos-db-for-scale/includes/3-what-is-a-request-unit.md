[次へ]、データベースの全体にデータを見てみましょう。 十分なスループットは、ビジネス ニーズのトランザクションの量を処理できる必要があります。 スループットの要件は、必ずしも一貫性があるとは限りません。 たとえば、セールや祝日の間に拡大させる必要があるショッピング Web サイトを構築している可能性があります。 まず、要求ユニットとスループットの要件を推定する方法について学習します。

## <a name="what-is-database-throughput"></a>データベース スループットとは 

データベース スループットは、データベースによって 1 秒で実行できる読み取り/書き込みの数です。

戦略的にスループットをスケーリングするには、さまざまな時間およびさまざまなドキュメント サイズをサポートする必要がある読み取り/書き込みの数を見積もることで、スループットのニーズを見積もる必要があります。 正しく見積もれた場合は、要求が急増したときもユーザーは適切に使用し続けられます。 正しく見積もれなかった場合は、要求の使用回数が制限され、長い待ち時間や不幸な顧客が発生するなど、操作の待機や再試行が必要になります。

## <a name="what-is-a-request-unit"></a>要求ユニットとは?

Azure Cosmos DB では、**要求ユニット (RU)** と呼ばれるものを使ってスループットを測定します。 要求ユニットの使用は 1 秒ごとに測定されるため、単位は **1 秒あたりの要求ユニット (RU/秒)** になります。 事前に Azure Cosmos DB にプロビジョニングさせる RU/秒の数を予約する必要があり、そのため、見積もった読み込みを処理することができます。また、現在の要求を満たすようにいつでも RU/秒をスケールアップ、またはスケールダウンすることができます。

## <a name="request-unit-basics"></a>要求ユニットの基本

単一の要求ユニット (1 RU) とは、ドキュメントの ID を使用した、1 KB のドキュメントにおける単一の GET 要求を実行する概算コストと同じです。 ドキュメントの ID を使用することによって GET を実行することは、ドキュメントを取得するために効率的な手段であり、コストは少額です。 同じアイテムを作成、置換、または削除するには、サービスによる追加の処理が必要です。そのため、追加の要求ユニットが必要になります。

操作に使用する要求ユニット数は、ドキュメント サイズ、ドキュメントのプロパティの数、実行されている操作、追加の複雑な概念 (一貫性やインデックス作成ポリシーなど) によって異なります。

次の表は、3 種類のサイズのアイテム (1 KB、4 KB、64 KB) を 2 種類のパフォーマンス レベル (500 読み取り/秒 + 100 書き込み/秒と、500 読み取り/秒 + 500 書き込み/秒) で必要な要求ユニット数を示しています。 この例では、データの一貫性が "**セッション**" に設定され、インデックス作成ポリシーは "**なし**" に設定されています。

| アイテムのサイズ | 読み取り/秒 | 書き込み数/秒 | 要求ユニット
| --- | --- | --- | --- |
| 1 KB | 500 | 100 | (500 * 1) + (100 * 5) = 1,000 RU/秒
| 1 KB | 500 | 500 | (500 * 1) + (500 * 5) = 3,000 RU/秒
| 4 KB | 500 | 100 | (500 * 1.3) + (100 * 7) = 1,350 RU/秒
| 4 KB | 500 | 500 | (500 * 1.3) + (500 * 7) = 4,150 RU/秒
| 64 KB | 500 | 100 | (500 * 10) + (100 * 48) = 9,800 RU/秒
| 64 KB | 500 | 500 | (500 * 10) + (500 * 48) = 29,000 RU/秒
 
ご覧のとおり、アイテムがより大きくなり、読み取り/書き込みが多くなるほど、受け取る必要がある要求ユニットが多くなります。 アプリケーションのスループットのニーズを見積もる必要がある場合、Azure Cosmos DB [Capacity Planner](https://www.documentdb.com/capacityplanner) が、サンプルの JSON ドキュメントをアップロードし、1 秒あたりに完了する必要がある操作の数を設定できるようにするオンライン ツールです。 これによって、予約する推定される合計が示されます。

## <a name="exceeding-throughput-limits"></a>スループット上限の超過

十分な要求ユニットを予約せずに、プロビジョニングしたスループットで許可されるよりも多くデータの読み取り/書き込みを試行する場合は、お客様の要求の使用回数が制限されます。 要求の使用回数が制限された場合、指定した間隔後にもう一度要求を再試行する必要があります。 .NET SDK を使用する場合は、ヘッダーの後の再試行で指定した時間を待機してから要求は自動的に再試行されます。

## <a name="creating-an-account-built-to-scale"></a>スケーリングするためのアカウントを作成する

いつでもデータベースにプロビジョニングされた要求ユニット数を変更できます。 そのため、大量の処理が発生する期間中はスケールアップして多くの要求に対応し、ピーク時以外はプロビジョニングされたスループットを削減してコストを節約することができます。

アカウントを作成すると、ポータルで最小値で 400 RU/秒、または最大値で 250,000 RU/秒をプロビジョニングできます。 さらにスループットが必要な場合は、Azure portal でチケットを入力します。 ほぼすべてのアカウントにおいて、最初のスループットを 1000 RU/秒に設定することをお勧めします。10 GB を超えるストレージが必要な場合、実際にはこれがデータベースのサイズに自動設定される最小値になります。 最初のスループットを 1000 RU/秒より小さい値に設定した場合は、データベースをプロビジョニングして、パーティション キーを指定しない限り、データベースを 10 GB より大きくスケーリングすることはできません。 パーティション キーを利用すると、Azure Cosmos DB 内のデータをすばやくルックアップすることや、必要なときにデータベースを自動スケーリングすることができます。 パーティション キーについては、このモジュールで後ほど取り上げます。

## <a name="summary"></a>まとめ

これで、要求の単位を使用して Azure Cosmos DB を推定する方法とスコープのスループットを理解し、新しい Azure Cosmos DB コレクションを作成するときに、適切な選択を行うことができます。 要求ユニットは、いつでも変更できますが、RU/秒のアカウントを作成するときに支援を 1000 に設定して、データベースが後でスケーリングできる状態にすることを確認します。