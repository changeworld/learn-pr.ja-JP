音楽共有アプリケーション用のアーキテクチャを計画中であるとします。 モバイル アプリから Web API に音楽ファイルが確実にアップロードされるようにし、その後、アーティストが新しい曲をそのコレクションに追加すると、新しい曲の詳細がアプリに直接配信されるようにします。 これは、メッセージ ベースのシステムの使用法として最適であり、Azure では、この問題に対して次の 2 つのソリューションが提供されています。

- Azure Queue Storage
- Azure Service Bus

## <a name="what-is-azure-queue-storage"></a>Azure Queue Storage とは
Queue Storage は、Azure Storage を使用して、REST ベースの単純なインターフェイスを介して世界中のどこからでも安全にアクセスできる多数のメッセージを格納するサービスです。 キューには数百万のメッセージを格納でき、それを所有するストレージ アカウントの容量のみが制限となります。

## <a name="what-is-azure-service-bus-queues"></a>Azure Service Bus キューとは何ですか。
Service Bus は、エンタープライズ アプリケーションを対象とするメッセージ ブローカー システムです。 多くの場合、これらのアプリは複数の通信プロトコルを利用し、さまざまなデータ コントラクトと、より高いセキュリティ要件を持ち、クラウドとオンプレミスの両方のサービスを含むことができます。 Service Bus は、こうしたシナリオに的を絞って設計された専用のメッセージング インフラストラクチャの上に構築されます。

これら両方のサービスは、送信されたメッセージを、ターゲットが受信できるようになるまで保持する "キュー" の概念に基づいています。

## <a name="what-are-azure-service-bus-topics"></a>Azure Service Bus トピックとは
Azure Service Bus のトピックでは、キューと同様しますが、複数のサブスクライバーが存在することができます。 キューではなくトピックにメッセージが送信されるときに仕事を行う複数のコンポーネントをトリガーできます。 共有アプリケーションを音楽を聴けるリッスンしているユーザーの音楽を想像してください。 モバイル アプリは、"Listened"トピックにメッセージを送信する可能性があります。 このトピックでは、"UpdateArtistsFanList"の"UpdateUserListenHistory"と別のサブスクリプションのサブスクリプションがあります。 各関数は、メッセージのコピーを受信する別のコンポーネントによって処理されます。

内部的には、トピックでは、キューを使用します。 トピックに投稿すると、メッセージがコピーされ、サブスクリプションごとにキューにドロップします。 キューはメッセージのコピーが処理される程度に維持**各サブスクリプションの分岐によって**場合でも、そのサブスクリプションの処理コンポーネントがビジー状態保持します。

## <a name="benefits-of-queues"></a>キューの利点があります。
キューのインフラストラクチャが非常に便利で多くの高度な機能をサポートできます。 

### <a name="increased-reliability"></a>信頼性の向上
キューは、分散アプリケーションによって、宛先コンポーネントへの配信が保留されているメッセージの一時保管場所として使用されます。 ソース コンポーネントでは、メッセージをキューに追加でき、宛先コンポーネントでは、そのメッセージをキューの先頭で取得して処理することができます。 キューにより、メッセージ交換の信頼性が向上します。それは混み合っているときに、宛先コンポーネント側でメッセージを処理する準備が整うまで、メッセージを単純に待機させることができるからです。

### <a name="message-delivery-guarantees"></a>メッセージの配信保証
キュー内の各メッセージを宛先コンポーネントに配信する処理は、通常、キュー システムによって保証されます。 ただし、このような保証は、次のようなさまざまなアプローチで実現できます。

- **At-Least-Once 配信。** このアプローチでは、キューからメッセージを取得するコンポーネントの少なくとも 1 つへ、各メッセージが配信されることが保証されます。 ただし、特定の状況では、同じメッセージが複数回配信される可能性があります。 たとえば、キューからメッセージを取得する Web アプリのインスタンスが 2 つある場合、通常、各メッセージはこれらのインスタンスの 1 つだけに送信されます。 ただし、一方のインスタンスでメッセージの処理に時間がかかり、タイムアウトになった場合、もう一方のインスタンスにもメッセージが送信される可能性があります。 Web アプリ コードは、この可能性を考慮して設計する必要があります。

- **At-Most-Once 配信。** このアプローチでは、各メッセージの配信は保証されず、メッセージが届かない可能性がごくわずかにあります。 ただし、At-Least-Once 配信の場合とは異なり、同じメッセージが 2 回配信されることはありません。 これは、"自動重複データ検出" と呼ばれる場合もあります。

- **先入れ先出し法 (FIFO)。** ほとんどのメッセージング システムでは、通常、メッセージはキューに入れられたのと同じ順番でキューから出されますが、この順番が保証されているかどうかを検討する必要があります。 分散アプリケーションにおいてメッセージが正確に正しい順序で処理される必要がある場合、FIFO 保証を含むキュー システムを選択する必要があります。

### <a name="transactional-support"></a>トランザクションのサポート
いくつかのメッセージ グループが密接に関連しているために、グループ内の 1 つのメッセージについて配信が失敗すると、問題が発生する場合があります。

たとえば、e コマース アプリケーションを考えてみます。 ユーザーが**購入**ボタンをクリックすると、一連のメッセージが生成され、次のようにさまざまな処理を行う宛先に送信される可能性があります。

- 注文の詳細を含むメッセージが、処理センターに送信されます。
- 合計額と支払いの詳細を含むメッセージが、クレジット カード プロセッサに送信されます。 
- 領収書情報を含むメッセージがデータベースに送信されて、顧客に対して請求書が生成されます。

この場合、_すべての_メッセージが確実に処理されるか、そうでなければ、どのメッセージも処理されないようにする必要があります。 クレジット カード メッセージが配信されずに、すべての注文内容が支払いなしに処理された場合、長くは営業を続けられなくなります。 このような問題は、2 つのメッセージをトランザクションにグループ化することによって回避できます。 メッセージ トランザクションは、データベースの場合と同様に、単一のユニットとして成功または失敗します。 クレジット カード情報のメッセージ配信が失敗した場合は、注文詳細のメッセージ配信も失敗します。

## <a name="which-service-should-i-choose"></a>どのサービスを選択すべきか
このアーキテクチャでの通信方法がメッセージである必要があることを理解できたら、Azure Storage キューと Service Bus のどちらを使用するかを選択する必要があります。これらは両者とも、コンポーネント間でメッセージを格納および配信するのに使用できます。 機能に若干の違いがあるため、解決する必要がある問題に応じて、どちらかを選択するか、または両方を使用することができます。

#### <a name="choose-service-bus-topics-if"></a>場合は、Service Bus トピックを選択します。

- 各メッセージを処理するために複数の受信者を作成する必要があります。


#### <a name="choose-service-bus-queues-if"></a>次の場合は、Service Bus キューを選択します。

- At-Most-Once 配信保証が必要である。
- FIFO 保証が必要である。
- メッセージをトランザクションにグループ化する必要がある。
- キューをポーリングせずにメッセージを受信する必要がある。
- キューにロール ベースのアクセス モデルを提供する必要がある。
- 64 KB を超えるが 256 KB 未満のメッセージを処理する必要がある。
- キューのサイズが 80 GB を超えることがない。
- バッチ メッセージを発行および使用できる必要がある。

Queue Storage は機能があまり豊富ではありませんが、これらのいずれの機能も必要ない場合は、より単純な方法として選択できます。 また、アプリが次のいずれかの要件を持つ場合、Queue Storage は最良のソリューションです。

#### <a name="choose-queue-storage-if"></a>次の場合は、Queue Storage を選択します。

- キューを通ったすべてのメッセージの監査証跡が必要である。
- キューのサイズが 80 GB を超えると予想される。
- キュー内のメッセージ処理の進行状況を追跡する必要がある。

## <a name="summary"></a>まとめ

キューは、分散アプリケーションのコンポーネント間で送信されるメッセージ用の一時的な簡易保存場所です。 キューを使用すると、メッセージを整理し、予測できない需要急増を適切に対処できます。 

簡単にコーディングできるシンプルなキュー システムが必要な場合は、Storage キューを使用します。 より高度なニーズに対しては、Service Bus キューを使用します。 1 つのメッセージに対して複数のターゲットがキューのような動作を必要な場合は、トピックを使用します。