<span data-ttu-id="76ee6-101">音楽共有アプリケーション用のアーキテクチャを計画中であるとします。</span><span class="sxs-lookup"><span data-stu-id="76ee6-101">Suppose you are planning the architecture for your music-sharing application.</span></span> <span data-ttu-id="76ee6-102">モバイル アプリから Web API に音楽ファイルが確実にアップロードされるようにし、その後、アーティストが新しい曲をそのコレクションに追加すると、新しい曲の詳細がアプリに直接配信されるようにします。</span><span class="sxs-lookup"><span data-stu-id="76ee6-102">You want to ensure that music files are uploaded to the web API reliably from the mobile app - we then want to deliver the details about new songs directly to the app when an artist adds new music to their collection.</span></span> <span data-ttu-id="76ee6-103">これは、メッセージ ベースのシステムの使用法として最適であり、Azure では、この問題に対して次の 2 つのソリューションが提供されています。</span><span class="sxs-lookup"><span data-stu-id="76ee6-103">This is a perfect use of a message-based system and Azure offers two solutions to this problem:</span></span>

- <span data-ttu-id="76ee6-104">Azure Queue Storage</span><span class="sxs-lookup"><span data-stu-id="76ee6-104">Azure Queue Storage</span></span>
- <span data-ttu-id="76ee6-105">Azure Service Bus</span><span class="sxs-lookup"><span data-stu-id="76ee6-105">Azure Service Bus</span></span>

## <a name="what-is-azure-queue-storage"></a><span data-ttu-id="76ee6-106">Azure Queue Storage とは</span><span class="sxs-lookup"><span data-stu-id="76ee6-106">What is Azure Queue Storage?</span></span>
<span data-ttu-id="76ee6-107">Queue Storage は、Azure Storage を使用して、REST ベースの単純なインターフェイスを介して世界中のどこからでも安全にアクセスできる多数のメッセージを格納するサービスです。</span><span class="sxs-lookup"><span data-stu-id="76ee6-107">Queue storage is a service that uses Azure Storage to store large numbers of messages that can be securely accessed from anywhere in the world using a simple REST-based interface.</span></span> <span data-ttu-id="76ee6-108">キューには数百万のメッセージを格納でき、それを所有するストレージ アカウントの容量のみが制限となります。</span><span class="sxs-lookup"><span data-stu-id="76ee6-108">Queues can contain millions of messages, limited only by the capacity of the storage account that owns it.</span></span>

## <a name="what-is-azure-service-bus-queues"></a><span data-ttu-id="76ee6-109">Azure Service Bus キューとは</span><span class="sxs-lookup"><span data-stu-id="76ee6-109">What is Azure Service Bus Queues?</span></span>
<span data-ttu-id="76ee6-110">Service Bus は、エンタープライズ アプリケーションを対象とするメッセージ ブローカー システムです。</span><span class="sxs-lookup"><span data-stu-id="76ee6-110">Service Bus is a message broker system intended for enterprise applications.</span></span> <span data-ttu-id="76ee6-111">多くの場合、これらのアプリは複数の通信プロトコルを利用し、さまざまなデータ コントラクトと、より高いセキュリティ要件を持ち、クラウドとオンプレミスの両方のサービスを含むことができます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-111">These apps often utilize multiple communication protocols, have different data contracts, higher security requirements, and can include both cloud and on-premises services.</span></span> <span data-ttu-id="76ee6-112">Service Bus は、こうしたシナリオに的を絞って設計された専用のメッセージング インフラストラクチャの上に構築されます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-112">Service Bus is built on top of a dedicated messaging infrastructure designed for exactly these scenarios.</span></span>

<span data-ttu-id="76ee6-113">これら両方のサービスは、送信されたメッセージを、ターゲットが受信できるようになるまで保持する "キュー" の概念に基づいています。</span><span class="sxs-lookup"><span data-stu-id="76ee6-113">Both of these services are based on the idea of a "queue" which holds sent messages until the target is ready to receive them.</span></span>

## <a name="what-are-azure-service-bus-topics"></a><span data-ttu-id="76ee6-114">Azure Service Bus トピックとは</span><span class="sxs-lookup"><span data-stu-id="76ee6-114">What are Azure Service Bus Topics?</span></span>
<span data-ttu-id="76ee6-115">Azure Service Bus トピックはキューと似ていますが、複数のサブスクライバーが存在できます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-115">Azure Service Bus topics are like queues, but can have multiple subscribers.</span></span> <span data-ttu-id="76ee6-116">キューではなくトピックにメッセージが送信されると、複数のコンポーネントが作業を行うようトリガーできます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-116">When a message is sent to a topic instead of a queue multiple components can be triggered to do their work.</span></span> <span data-ttu-id="76ee6-117">ユーザーが音楽共有アプリケーションで曲を聴いている場合を考えてみましょう。</span><span class="sxs-lookup"><span data-stu-id="76ee6-117">Imagine in a music sharing application, a user listening to a song.</span></span> <span data-ttu-id="76ee6-118">モバイル アプリによって "Listened" トピックにメッセージが送信されるとします。</span><span class="sxs-lookup"><span data-stu-id="76ee6-118">The mobile app might send a message to the "Listened" topic.</span></span> <span data-ttu-id="76ee6-119">そのトピックには、"UpdateUserListenHistory" のサブスクリプションと、それとは別個の "UpdateArtistsFanList" のサブスクリプションが存在します。</span><span class="sxs-lookup"><span data-stu-id="76ee6-119">That topic will have a subscription for "UpdateUserListenHistory" and a different subscription for "UpdateArtistsFanList".</span></span> <span data-ttu-id="76ee6-120">これらの各関数は、メッセージの独自のコピーを受信する別個のコンポーネントによって処理されます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-120">Each of those functions is handled by a different component that receives its own copy of the message.</span></span>

<span data-ttu-id="76ee6-121">内部的には、トピックではキューが使用されます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-121">Internally, topics use queues.</span></span> <span data-ttu-id="76ee6-122">トピックに投稿すると、メッセージがコピーされ、各サブスクリプションのキューにドロップされます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-122">When you post to a topic, the message is copied and dropped into the queue for each subscription.</span></span> <span data-ttu-id="76ee6-123">キューでは、サブスクリプションを処理するコンポーネントがビジー状態で対応できない場合でも、メッセージのコピーは**各サブスクリプション ブランチによって**処理されるまでキュー内に存在し続けます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-123">The queue means that the message copy will stay around to be processed **by each subscription branch** even if the component processing that subscription is too busy to keep up.</span></span>

## <a name="benefits-of-queues"></a><span data-ttu-id="76ee6-124">キューのメリット</span><span class="sxs-lookup"><span data-stu-id="76ee6-124">Benefits of queues</span></span>
<span data-ttu-id="76ee6-125">キューのインフラストラクチャではさまざまな高度な機能をサポートでき、非常に有用です。</span><span class="sxs-lookup"><span data-stu-id="76ee6-125">Queue infrastructures can support many advanced features that make them very useful in</span></span> 

### <a name="increased-reliability"></a><span data-ttu-id="76ee6-126">信頼性の向上</span><span class="sxs-lookup"><span data-stu-id="76ee6-126">Increased reliability</span></span>
<span data-ttu-id="76ee6-127">キューは、分散アプリケーションによって、宛先コンポーネントへの配信が保留されているメッセージの一時保管場所として使用されます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-127">Queues are used by distributed applications as a temporary storage location for messages pending delivery to a destination component.</span></span> <span data-ttu-id="76ee6-128">ソース コンポーネントでは、メッセージをキューに追加でき、宛先コンポーネントでは、そのメッセージをキューの先頭で取得して処理することができます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-128">The source component can add a message to the queue and destination components can retrieve the message at the front of the queue for processing.</span></span> <span data-ttu-id="76ee6-129">キューにより、メッセージ交換の信頼性が向上します。それは混み合っているときに、宛先コンポーネント側でメッセージを処理する準備が整うまで、メッセージを単純に待機させることができるからです。</span><span class="sxs-lookup"><span data-stu-id="76ee6-129">Queues increase the reliability of the message exchange because, at times of high demand, messages can simply wait until a destination component is ready to process them.</span></span>

### <a name="message-delivery-guarantees"></a><span data-ttu-id="76ee6-130">メッセージの配信保証</span><span class="sxs-lookup"><span data-stu-id="76ee6-130">Message delivery guarantees</span></span>
<span data-ttu-id="76ee6-131">キュー内の各メッセージを宛先コンポーネントに配信する処理は、通常、キュー システムによって保証されます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-131">Queuing systems usually guarantee delivery of each message in the queue to a destination component.</span></span> <span data-ttu-id="76ee6-132">ただし、このような保証は、次のようなさまざまなアプローチで実現できます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-132">However, these guarantees can take different approaches:</span></span>

- <span data-ttu-id="76ee6-133">**At-Least-Once 配信:** このアプローチでは、キューからメッセージを取得するコンポーネントの少なくとも 1 つへ、各メッセージが配信されることが保証されます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-133">**At-Least-Once Delivery:** In this approach, each message is guaranteed to be delivered to at least one of the components that retrieve messages from the queue.</span></span> <span data-ttu-id="76ee6-134">ただし、特定の状況では、同じメッセージが複数回配信される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="76ee6-134">Note, however, that in certain circumstances, it is possible that the same message may be delivered more than once.</span></span> <span data-ttu-id="76ee6-135">たとえば、キューからメッセージを取得する Web アプリのインスタンスが 2 つある場合、通常、各メッセージはこれらのインスタンスの 1 つだけに送信されます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-135">For example, if there are two instances of a web app retrieving messages from a queue, ordinarily each message goes to only one of those instances.</span></span> <span data-ttu-id="76ee6-136">ただし、一方のインスタンスでメッセージの処理に時間がかかり、タイムアウトになった場合、もう一方のインスタンスにもメッセージが送信される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="76ee6-136">However, if one instance takes a long time to process the message, and a time-out expires, the message may be sent to the other instance as well.</span></span> <span data-ttu-id="76ee6-137">ご自分の Web アプリ コードは、この可能性を考慮して設計する必要があります。</span><span class="sxs-lookup"><span data-stu-id="76ee6-137">Your web app code should be designed with this possibility in mind.</span></span>

- <span data-ttu-id="76ee6-138">**At-Most-Once 配信:** このアプローチでは、各メッセージの配信は保証されず、各メッセージが届かない可能性がごくわずかにあります。</span><span class="sxs-lookup"><span data-stu-id="76ee6-138">**At-Most-Once Delivery:** In this approach, each message is not guaranteed to be delivered, and there is a very small chance that it may not arrive.</span></span> <span data-ttu-id="76ee6-139">ただし、At-Least-Once 配信の場合とは異なり、同じメッセージが 2 回配信されることはありません。</span><span class="sxs-lookup"><span data-stu-id="76ee6-139">However, unlike At-Least-Once delivery, there is no chance that the message will be delivered twice.</span></span> <span data-ttu-id="76ee6-140">これは、"自動重複データ検出" と呼ばれる場合もあります。</span><span class="sxs-lookup"><span data-stu-id="76ee6-140">This is sometimes referred to as "automatic duplicate detection".</span></span>

- <span data-ttu-id="76ee6-141">**First-In-First-Out (FIFO):** ほとんどのメッセージング システムでは、通常、メッセージはキューに入れられたのと同じ順番でキューから出されますが、この順番が保証されているかどうかを検討する必要があります。</span><span class="sxs-lookup"><span data-stu-id="76ee6-141">**First-In-First-Out (FIFO):** In most messaging systems, messages usually leave the queue in the same order in which they were added, but you should consider whether this order is guaranteed.</span></span> <span data-ttu-id="76ee6-142">ご利用の分散アプリケーションにおいてメッセージが正しい順序で正確に処理される必要がある場合、FIFO 保証を含むキュー システムを選択する必要があります。</span><span class="sxs-lookup"><span data-stu-id="76ee6-142">If your distributed application requires that messages are processed in precisely the correct order, you must choose a queue system that includes a FIFO guarantee.</span></span>

### <a name="transactional-support"></a><span data-ttu-id="76ee6-143">トランザクションのサポート</span><span class="sxs-lookup"><span data-stu-id="76ee6-143">Transactional support</span></span>
<span data-ttu-id="76ee6-144">いくつかのメッセージ グループが密接に関連しているために、グループ内の 1 つのメッセージについて配信が失敗すると、問題が発生する場合があります。</span><span class="sxs-lookup"><span data-stu-id="76ee6-144">Some closely related groups of messages may cause problems when delivery fails for one message in the group.</span></span>

<span data-ttu-id="76ee6-145">たとえば、e コマース アプリケーションを考えてみます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-145">For example, consider an e-commerce application.</span></span> <span data-ttu-id="76ee6-146">ユーザーが**購入**ボタンをクリックすると、一連のメッセージが生成され、次のようにさまざまな処理を行う宛先に送信される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="76ee6-146">When the user clicks the **Buy** button, a series of messages might be generated and sent off to various processing destinations:</span></span>

- <span data-ttu-id="76ee6-147">注文の詳細を含むメッセージが、処理センターに送信されます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-147">A message with the order details is sent to a fulfillment center</span></span>
- <span data-ttu-id="76ee6-148">合計額と支払いの詳細を含むメッセージが、クレジット カード プロセッサに送信されます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-148">A message with the total and payment details is sent to a credit card processor.</span></span> 
- <span data-ttu-id="76ee6-149">領収書情報を含むメッセージがデータベースに送信されて、顧客に対して請求書が生成されます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-149">A message with the receipt information is sent to a database to generate an invoice for the customer</span></span>

<span data-ttu-id="76ee6-150">この場合、_すべての_メッセージが確実に処理されるか、そうでなければ、どのメッセージも処理されないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="76ee6-150">In this case, we want to make sure _all_ messages get processed, or none of them are processed.</span></span> <span data-ttu-id="76ee6-151">クレジット カード メッセージが配信されずに、すべての注文内容が支払いなしに処理された場合、長くは営業を続けられなくなります。</span><span class="sxs-lookup"><span data-stu-id="76ee6-151">We won't be in business long if the credit card message is not delivered, and all our orders are fulfilled without payment!</span></span> <span data-ttu-id="76ee6-152">このような問題は、2 つのメッセージをトランザクションにグループ化することによって回避できます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-152">You can avoid these kinds of problems by grouping the two messages into a transaction.</span></span> <span data-ttu-id="76ee6-153">メッセージ トランザクションは、データベースの場合と同様に、単一のユニットとして成功または失敗します。</span><span class="sxs-lookup"><span data-stu-id="76ee6-153">Message transactions succeed or fail as a single unit - just like in the database world.</span></span> <span data-ttu-id="76ee6-154">クレジット カード情報のメッセージ配信が失敗した場合は、注文詳細のメッセージ配信も失敗します。</span><span class="sxs-lookup"><span data-stu-id="76ee6-154">If the credit card details message delivery fails, then so will the order details message.</span></span>

## <a name="which-service-should-i-choose"></a><span data-ttu-id="76ee6-155">どのサービスを選択すべきか</span><span class="sxs-lookup"><span data-stu-id="76ee6-155">Which service should I choose?</span></span>
<span data-ttu-id="76ee6-156">このアーキテクチャでの通信方法がメッセージである必要があることを理解できたら、Azure Storage キューと Service Bus のどちらを使用するかを選択する必要があります。これらは両者とも、コンポーネント間でメッセージを格納および配信するのに使用できます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-156">Having understood that the communication strategy for this architecture should be a message, you must choose whether to use Azure Storage queues or Azure Service Bus, both of which can be used to store and deliver messages between your components.</span></span> <span data-ttu-id="76ee6-157">機能に若干の違いがあるため、解決する必要がある問題に応じて、どちらかを選択するか、または両方を使用することができます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-157">Each has a slightly different feature set, which means you can choose one or the other, or use both, depending on the problem you are solving.</span></span>

#### <a name="choose-service-bus-topics-if"></a><span data-ttu-id="76ee6-158">次の場合は、Service Bus トピックを選択します。</span><span class="sxs-lookup"><span data-stu-id="76ee6-158">Choose Service Bus Topics if</span></span>

- <span data-ttu-id="76ee6-159">各メッセージを処理する複数の受信側が必要である。</span><span class="sxs-lookup"><span data-stu-id="76ee6-159">you need multiple receivers to handle each message</span></span>


#### <a name="choose-service-bus-queues-if"></a><span data-ttu-id="76ee6-160">次の場合は、Service Bus キューを選択します。</span><span class="sxs-lookup"><span data-stu-id="76ee6-160">Choose Service Bus queues if:</span></span>

- <span data-ttu-id="76ee6-161">At-Most-Once 配信保証が必要である。</span><span class="sxs-lookup"><span data-stu-id="76ee6-161">You need an At-Most-Once delivery guarantee.</span></span>
- <span data-ttu-id="76ee6-162">FIFO 保証が必要である。</span><span class="sxs-lookup"><span data-stu-id="76ee6-162">You need a FIFO guarantee.</span></span>
- <span data-ttu-id="76ee6-163">メッセージをトランザクションにグループ化する必要がある。</span><span class="sxs-lookup"><span data-stu-id="76ee6-163">You need to group messages into transactions.</span></span>
- <span data-ttu-id="76ee6-164">キューをポーリングせずにメッセージを受信する必要がある。</span><span class="sxs-lookup"><span data-stu-id="76ee6-164">You want to receive messages without polling the queue.</span></span>
- <span data-ttu-id="76ee6-165">キューにロール ベースのアクセス モデルを提供する必要がある。</span><span class="sxs-lookup"><span data-stu-id="76ee6-165">You need to provide a role-based access model to the queues.</span></span>
- <span data-ttu-id="76ee6-166">64 KB を超えるが 256 KB 未満のメッセージを処理する必要がある。</span><span class="sxs-lookup"><span data-stu-id="76ee6-166">You need to handle messages larger than 64 KB but less than 256 KB.</span></span>
- <span data-ttu-id="76ee6-167">キューのサイズが 80 GB を超えることがない。</span><span class="sxs-lookup"><span data-stu-id="76ee6-167">Your queue size will not grow larger than 80 GB.</span></span>
- <span data-ttu-id="76ee6-168">バッチ メッセージを発行および使用できる必要がある。</span><span class="sxs-lookup"><span data-stu-id="76ee6-168">You would like to be able to publish and consume batches of messages.</span></span>

<span data-ttu-id="76ee6-169">Queue Storage は機能があまり豊富ではありませんが、これらのいずれの機能も必要ない場合は、より単純な方法として選択できます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-169">Queue storage isn't quite as feature-rich, but if you don't need any of those features, it can be a simpler choice.</span></span> <span data-ttu-id="76ee6-170">また、アプリが次のいずれかの要件を持つ場合、Queue Storage は最良のソリューションです。</span><span class="sxs-lookup"><span data-stu-id="76ee6-170">In addition, it's the best solution if your app has any of the following requirements.</span></span>

#### <a name="choose-queue-storage-if"></a><span data-ttu-id="76ee6-171">次の場合は、Queue Storage を選択します。</span><span class="sxs-lookup"><span data-stu-id="76ee6-171">Choose Queue storage if:</span></span>

- <span data-ttu-id="76ee6-172">キューを通ったすべてのメッセージの監査証跡が必要である。</span><span class="sxs-lookup"><span data-stu-id="76ee6-172">You need an audit trail of all messages that pass through the queue.</span></span>
- <span data-ttu-id="76ee6-173">キューのサイズが 80 GB を超えると予想される。</span><span class="sxs-lookup"><span data-stu-id="76ee6-173">You expect the queue to exceed 80 GB in size.</span></span>
- <span data-ttu-id="76ee6-174">キュー内のメッセージ処理の進行状況を追跡する必要がある。</span><span class="sxs-lookup"><span data-stu-id="76ee6-174">You want to track progress for processing a message inside of the queue.</span></span>

<span data-ttu-id="76ee6-175">キューは、分散アプリケーションのコンポーネント間で送信されるメッセージ用のシンプルで一時的な保存場所です。</span><span class="sxs-lookup"><span data-stu-id="76ee6-175">A queue is a simple, temporary storage location for messages sent between the components of a distributed application.</span></span> <span data-ttu-id="76ee6-176">キューを使用すると、メッセージを整理し、予測できない需要急増を適切に対処できます。</span><span class="sxs-lookup"><span data-stu-id="76ee6-176">Use a queue to organize messages and gracefully handle unpredictable surges in demand.</span></span> 

<span data-ttu-id="76ee6-177">簡単にコーディングできるシンプルなキュー システムを望んでいる場合は、Storage キューを使用します。</span><span class="sxs-lookup"><span data-stu-id="76ee6-177">Use Storage queues when you want a simple and easy-to-code queue system.</span></span> <span data-ttu-id="76ee6-178">より高度なニーズに対しては、Service Bus キューを使用します。</span><span class="sxs-lookup"><span data-stu-id="76ee6-178">For more advanced needs, use Service Bus queues.</span></span> <span data-ttu-id="76ee6-179">1 つのメッセージに対して複数の宛先が存在するが、キューのような動作が必要な場合は、トピックを使用します。</span><span class="sxs-lookup"><span data-stu-id="76ee6-179">If you have multiple destinations for a single message, but need queue-like behavior, use topics.</span></span>