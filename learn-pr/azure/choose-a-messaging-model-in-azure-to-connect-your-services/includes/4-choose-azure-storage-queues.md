音楽共有アプリケーション用のアーキテクチャを計画中であるとします。 モバイル アプリから Web API に音楽ファイルが確実にアップロードされるようにする方法を選択する必要があります。

この通信をメッセージのやりとりとする必要があることを理解したら、Azure Storage キューまたは Service Bus のいずれを使用するかを選択する必要があります。この両方を使用すると、それらが処理を待機しているときに、メッセージのキューを格納することができます。

## <a name="delivery-guarantees"></a>配信保証

キュー内の各メッセージを宛先コンポーネントに配信する処理は、通常、キュー システムによって保証されます。 ただし、このような保証は、次のようなさまざまなアプローチで実現できます。

- **At-Least-Once 配信。** このアプローチでは、キューからメッセージを取得するコンポーネントの少なくとも 1 つへ、各メッセージが配信されることが保証されます。 ただし、特定の状況では、同じメッセージが複数回配信される可能性があります。 たとえば、キューからメッセージを取得する Web アプリのインスタンスが 2 つある場合、通常、各メッセージはこれらのインスタンスの 1 つだけに送信されます。 ただし、一方のインスタンスでメッセージの処理に時間がかかり、タイムアウトになった場合、もう一方のインスタンスにもメッセージが送信される場合があります。 Web アプリ コードは、この可能性を考慮して設計する必要があります。
- **At-Most-Once 配信。** このアプローチでは、各メッセージの配信は保証されず、各メッセージが届かない可能性がごくわずかに存在します。 ただし、At-Least-Once 配信の場合のように、同じメッセージが 2 回配信されることはありません。
- **先入れ先出し法 (FIFO)。** ほとんどのメッセージング システムでは、通常、メッセージはキューに入れられたのと同じ順番でキューから出されますが、この順番が保証されているかどうかを検討する必要があります。 分散アプリケーションにおいてメッセージが正確に正しい順序で処理される必要がある場合、FIFO 保証を含むキュー システムを選択する必要があります。

## <a name="transactions"></a>トランザクション

いくつかのメッセージ グループが密接に関連しているために、グループ内の 1 つのメッセージについて配信が失敗すると、問題が発生する場合があります。

たとえば、e コマース アプリケーションを考えてみます。 ユーザーが "購入" ボタンがクリックすると、注文の詳細を含むメッセージが、クレジット カード情報を含むメッセージと共に送信されます。 クレジット カード メッセージが配信されない場合、支払いなしで注文内容が出荷される場合があります。

2 つのメッセージをトランザクションにグループ化することにより、このような種類の問題を回避できます。 トランザクションは単一のユニットとして成功または失敗します。 クレジット カード情報のメッセージ配信が失敗した場合は、注文詳細のメッセージ配信も失敗します。

## <a name="when-to-use-storage-queues"></a>ストレージ キューを使用する場合

キューは、メッセージに対して使用され、イベントに対しては使用されません。

Azure Storage アカウントにはキューが含まれています。分散アプリケーションでは、このキューを、メッセージ用の一時的な簡易保存場所として使用することができます。 ソース コンポーネントでは、キューにメッセージを追加することができます。 そのメッセージは宛先コンポーネントによって、キューの先頭で取得され、処理されます。 このようなキューにより、メッセージ交換の信頼性が向上します。それは混み合っているときに、宛先コンポーネント側でメッセージを処理する準備が整うまで、メッセージを単純に待機させることができるからです。

キューは、Azure Service Bus メッセージングの一部としても提供されます。 Azure 内で特定の通信向けにキューを使用することにした場合は、ストレージ キューまたは Service Bus キューのいずれを使用するかを決定する必要があります。

この選択を行うには、次の問題を検討してください。

- At-Most-Once 配信保証が必要ですか?
- FIFO 保証が必要ですか?
- メッセージをトランザクションにグループ化する必要がありますか?
- 64 KB を超えるメッセージを格納する必要がありますか?

これらの質問のいずれかに "はい" と答えた場合、Service Bus キューの使用を選択する必要があります。

さらに次のことを検討してください。

- キューを通ったすべてのメッセージのサーバー側のログが必要ですか?
- キューのサイズは 80 GB を超えると予想されますか?

これらの質問のいずれかに "はい" と答えた場合、ストレージ キューの使用を選択する必要があります。

## <a name="summary"></a>まとめ

キューは、分散アプリケーションのコンポーネント間で送信されるメッセージ用の一時的な簡易保存場所です。 キューを使用すると、メッセージを整理し、予測できない需要急増を適切に対処できます。

簡単にコーディングできるシンプルなキュー システムを望んでいる場合は、Azure Storage キューを使用します。 より高度なニーズに対しては、Azure Service Bus キューを使用します。