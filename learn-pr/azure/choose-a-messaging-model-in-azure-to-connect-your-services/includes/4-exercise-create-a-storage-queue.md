この演習では、Azure サブスクリプションで新しいストレージ アカウントを作成します。 次に Azure Cloud Shell を使用して新しいキューを作成し、それにメッセージを追加し、そのメッセージを読み、キューから削除します。

これらは、分散アプリケーションのコンポーネントによって行われる同じアクションです。 たとえば、モバイル アプリがメッセージをキューに追加し、Web サービスがメッセージを取得して処理するまで待機することがあります。

## <a name="create-a-storage-account"></a>ストレージ アカウントを作成する

Azure Storage キューは Azure 汎用ストレージ アカウントの一部なので、まずストレージ アカウントを作成する必要があります。

1. ブラウザーで [Azure portal](https://portal.azure.com?azure-portal=true) に移動し、通常の資格情報でサインインします。

1. 左上の **[すべてのサービス]** をクリックします。

1. 下へスクロールして **[ストレージ]** セクションを表示し、**[ストレージ アカウント]** をクリックします。

1. **[ストレージ アカウント]** ブレードの左上にある **[追加]** をクリックします。

  ![[追加] が強調表示されたストレージ アカウントのスクリーン ショット](../media-draft/4-create-a-storage-account-1.png)

1. 表示されるダイアログに次の情報を入力します。ポータルの各オプションには `(i)` アイコンが表示されます。このアイコンをクリックすると、オプションの実行内容について詳細が表示されます。

    - **[名前]** テキスト ボックスにストレージ アカウントの一意の名前を入力します。
    - **[デプロイ モデル]** で **[Resource Manager]** が選択されていることを確認します。
    - **[アカウントの種類]** ドロップダウン リストで **[ストレージ (汎用 v2)]** を選択します。
    - **[場所]** ドロップダウン リストで、近くのリージョンを選択します。
    - **[レプリケーション]** ドロップダウン リストで、**[ローカル冗長ストレージ (LRS)]** を選択します。
    - **[パフォーマンス]** で **[Standard]** を選択します。
    - **[アクセス層]** で **[クール]** を選択します。
    - **[安全な転送が必須]** で **[無効]** を選択します。
    - **[サブスクリプション]** でご使用のサブスクリプションを選択します。
    - **[リソース グループ]** で **[新規作成]** を選択します。 テキスト ボックスに「**MusicSharingResourceGroup**」と入力します。
    - **[仮想ネットワーク]** で **[無効]** を選択します。 

    ![[ストレージ アカウントを作成する] ダイアログ ボックスのスクリーンショット](../media-draft/4-create-a-storage-account-2.png)

1. **[作成]** をクリックします。Azure で新しいリソース グループとそれに関連付けられた新しいストレージ アカウントが作成されます。

    ![[作成] が強調表示された [ストレージ アカウントの作成] ダイアログ ボックスのスクリーンショット](../media-draft/4-create-a-storage-account-3.png)

## <a name="create-a-queue"></a>キューを作成する

ストレージ アカウントが作成されたので、それに新しいキューを追加できます。 PowerShell コマンドを使用してキューを作成する必要があります。

1. ポータルの上部で、**Cloud Shell** リンク `(>_)` をクリックします。

    ![[Cloud Shell] アイコンが強調表示された Azure portal のスクリーンショット](../media-draft/4-create-a-storage-queue-1.png)

1. **[Azure Cloud Shell へようこそ]** 画面で **[PowerShell (Linux)]** をクリックします。

1. **[ストレージがマウントされていません]** 画面が表示されたら、**[ストレージの作成]** をクリックします。

1. `PS Azure` プロンプトが表示されたら、ストレージ アカウントを取得するために次のコマンドを入力します。 `<storageaccountname>` を、前の手順で作成したストレージ アカウントの一意の名前に置き換え、**Enter** キーを押します。 結果のオブジェクトを `$storageaccount` という名前の変数に割り当てます。

    ```powershell
    $storageaccount = Get-AzureRmStorageAccount -Name <storageaccountname> -ResourceGroup  MusicSharingResourceGroup
    ```

1. 次に、ストレージ アカウント _context_ を取得する必要があります。これは返されたオブジェクトのプロパティです。 それを `$context` という別の変数に割り当てましょう。

    ```powershell
    $context = $storageaccount.Context
    ```

1. これでキューを作成する準備が整いました。 `New-AzureStorageQueue` コマンドを使用して `$messageQueue` 変数に割り当てます。
    - 値 `musicsharingmessages` を指定して `-Name` パラメーターを渡します。
    - 前の手順で取得した値を指定して `-Context` パラメーターを渡します。

    ```powershell
    $messageQueue = New-AzureStorageQueue -Name musicsharingmessages -Context $context
    ```

## <a name="add-a-message-to-the-queue"></a>メッセージをキューに追加する

これでストレージ アカウントにキューが作成されたので、それにメッセージを追加できます。

1. 新しいメッセージを作成するには、`New-Object` メソッドを使用し、文字列ベースの引数を指定して .NET `CloudQueueMessage` を作成します。

    ```powershell
    $newSongMessage = New-Object -TypeName Microsoft.WindowsAzure.Storage.Queue.CloudQueueMessage -ArgumentList "A new song has been added."
    ```

1. 新しいメッセージを新しいキューに追加するには、作成した `CloudQueueMessage` を `$messageQueue` キューの `AddMessageAsync` メソッドに渡します。

    ```powershell
    $messageQueue.CloudQueue.AddMessageAsync($newSongMessage)
    ```

## <a name="verify-the-message-was-queued"></a>メッセージがキューに追加されたことを確認する

**ストレージ エクスプローラー**を使用してキューを操作することができます。 2 種類の方法で利用できます。

- ダウンロードできる Linux、macOS、および Windows 用のクロスプラットフォーム デスクトップ アプリ。
- Azure portal のプレビュー Web バージョン。 ここではこの方法を使用しますが、好みに応じてデスクトップ バージョンをインストールすることもできます。手順は同様です。

1. Azure portal の左側のナビゲーションで **[すべてのリソース]** をクリックします。

1. リソースの一覧で、先に作成したストレージ アカウントをクリックします。

1. [ストレージ アカウント] ブレードで、**[ストレージ エクスプローラー (プレビュー)]** をクリックします。

1. ストレージ エクスプローラーの **[キュー]** の下で **[musicsharingmessages]** をクリックします。 ストレージ エクスプローラーには、追加したメッセージが表示されます。

## <a name="retrieve-and-remove-the-message"></a>メッセージの取得と削除

ストレージ キュー内のメッセージの宛先コンポーネントは、キューの先頭にあるメッセージを取得する必要があります。 次に、宛先コンポーネントはそのメッセージを処理してキューから削除し、他のコンポーネントがメッセージを取得しないようにする必要があります。

1. 最初の使用できるメッセージを取得するには、PowerShell でキューに対して `GetMessageAsync` メソッドを使用します。 `Result` プロパティを使用して戻り値を取得できるように待機する必要があるため、これは非同期の .NET メソッドです。 その結果、パラメーターに割り当てることができるメッセージを表すオブジェクトが返されます。

    ```powershell
    $retrievedMessage = $messageQueue.CloudQueue.GetMessageAsync().Result
    ```

1. `AsString` を呼び出してメッセージのテキスト バージョンを取得できます。その結果、コンソールに値が出力されます。

    ```powershell
    $retrievedMessage.AsString
    ```

1. また、変数名を入力して **Enter** キーを押すだけで、メッセージのすべてのプロパティを表示することもできます。

    ```powershell
    $retrievedMessage
    ```

1. `GetMessageAsync` を実行してもメッセージは削除*されません*。単にメッセージが返されるだけです。つまり、メッセージを再び処理することができます。 キューからメッセージを削除するには、キューに対して `DeleteMessageAsync` メソッドを使用できます。この場合、削除するメッセージを渡す必要があります。

    ```powershell
    $messageQueue.CloudQueue.DeleteMessageAsync($retrievedMessage)
    ```

1. メッセージが削除されたことを確認するには、[ストレージ アカウント] ブレードに移動し、**[概要] > [ストレージ エクスプローラー]** の順に選択して、Azure portal のキュー表示を更新します。 **[キュー]** の下で **[musicsharingmessages]** をクリックします。 メッセージのみを削除したため、ストレージ エクスプローラーにはキューが空であることが表示されます。


## <a name="summary"></a>まとめ
ストレージ アカウントのキューは、分散アプリケーションのコンポーネント間で_メッセージ_を渡す場合に最適なソリューションです。 これは、配信を保証したい場合や、送信した順序と同じ順序でメッセージを確実に配信したい場合に最適です。 ただし、キューは、送信者と受信者が、渡されるデータの形式を認識していることを前提としています。つまり、2 つの通信サービス間をある程度 "結合" する暗黙のデータ コントラクトがあります。

正しい形式のデータ ブロックを渡すことは、すべてのアーキテクチャにとって必須ではありません。メッセージの処理側が何かを認識していなくても、メッセージを送信し、後の処理には関知しない単純なメッセージが必要な場合もあります。 このようなシナリオの場合、キューは最適ではありません。 このようなスタイルの通信に適した別のメッセージング戦略を見てみましょう。