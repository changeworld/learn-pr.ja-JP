あなたは、写真共有サイトを運営しているとします。データは Azure Virtual Machines (VM) に格納され、SQL Server とカスタム アプリケーションを実行しています。 あなたは次の調整を行いたいと思っています。

- VM でディスク キャッシュ設定を変更する必要がある
- キャッシュを有効にして新しいデータ ディスクを VM に追加したい

あなたは、Azure portal でこれらの変更を行うことにしました。

この演習では、先に説明した VM に実際に変更を加えます。 まず、ポータルにサインインして、VM を作成しましょう。

## <a name="sign-in-to-the-azure-portal"></a>Azure portal にサインインする
<!---TODO: Update for sandbox?--->

1. [Azure portal](https://portal.azure.com/?azure-portal=true) にサインインします。

## <a name="create-a-virtual-machine"></a>仮想マシンの作成

この手順では、次のプロパティを持つ VM を作成します。

|プロパティ  |値  |
|---------|---------|
|イメージ     |   **Windows Server 2016 Datacenter**      |
|名前     |   **fotoshareVM**     |
|リソース グループ     |   **fotoshare-rg**      |


1. ポータルの左側のメニューで **[Virtual Machines]** を選択します。

1. 次に、**[Virtual Machines]** 画面の左上の **[+ 追加]** を選択します。 これにより作成プロセスが開始します。

1. 使用可能な VM イメージを一覧表示する [コンピューティング] パネルで、検索ボックスに「*Windows Server 2016 Datacenter*」と入力します。

1. 検索結果から **[Windows Server 2016 Datacenter]** を選択し、**[作成]** を選択して VM の作成プロセスを開始します。

1. **[基本]** パネルの **[名前]** ボックスに、「**fotoshareVM**」と入力します。

1. **[ユーザー名]** ボックスと **[パスワード]** ボックスに、このサーバーの管理者アカウントの名前とパスワードを入力します。

1. **[サブスクリプション]** ドロップダウンでご自分の Azure サブスクリプションを選択します。

1. **[リソース グループ]** で **[新規作成]** を選択し、ボックスに「**fotoshare-rg**」と入力します。

1. **[場所]** ドロップダウン リストで、近くのリージョンを選択します。

次に、入力後の **[基本]** 構成の例を示します。

![VM の入力後の基本構成のスクリーンショット。](../media-draft/vm-basics-settings.PNG)

1. **[OK]** を選択して、次のステップに進みます。

次は、VM のサイズを選択して、デプロイを開始する必要があります。

> [!IMPORTANT]
> L シリーズと B シリーズの仮想マシンのディスク キャッシュは変更できないことに注意してください。 別のサイズを選択します。

1. **[サイズの選択]** セクションで、**[F1s]** などの **[Standard]** SKU を選択してから、**[選択]** を選択します。

1. **[設定]** ウィンドウを下にスクロールして、ディスク キャッシュを構成するオプションがないことを確認します。 この手順では既定値をそのまま使用して、ウィンドウの下部で **[OK]** を選択します。

1. **[作成]** パネルで、概要を確認してから、**[作成]** を選択します。

1. VM の作成にはしばらく時間がかかることがあります。 VM がデプロイされるまで待ってから、演習を続けます。 プロセスが完了すると、Notification Hub にメッセージが表示されます。

> [!IMPORTANT]
> この VM は次のレッスンで使用するため、しばらくの間このままにしておきます。

## <a name="view-os-disk-cache-status-in-the-portal"></a>ポータルで OS ディスク キャッシュの状態を表示する

VM をデプロイすると、次の手順を使用して、OS ディスクのキャッシュ状態を確認できます。

1. 左側のメニューで、**[すべてのリソース]** をクリックし、ご自分の VM **[fotoshareVM]** を選択します。

1. **[仮想マシン]** 画面の **[設定]** で、**[ディスク]** を選択します。

1. **[ディスク]** ウィンドウでは、VM に 1 つのディスク (OS ディスク) があります。 そのキャッシュの種類は現在、既定値の **[読み取り/書き込み]** に設定されています。

![OS ディスクとデータ ディスクのスクリーンショットでは、どちらも読み取り専用キャッシュに設定されています。](../media-draft/os-disk-rw.PNG)

## <a name="change-the-cache-settings-of-the-os-disk-in-the-portal"></a>ポータルで OS ディスクのキャッシュ設定を変更する

1. **[ディスク]** ウィンドウで、画面の左上の **[編集]** を選択します。

1. OS ディスクの **[ホスト キャッシュ]** 値をドロップダウンを使用して **[読み取り専用]** に変更してから、画面の左上で **[保存]** を選択します。

1. この更新にはしばらく時間がかかります。 この理由は、Azure ディスクのキャッシュ設定を変更すると、対象となるディスクがデタッチされ再アタッチされるからです。 オペレーティング システム ディスクの場合は、VM も再起動されます。 更新が完了すると、次の通知のようなメッセージが表示されます。

![キャッシュ設定の更新が完了したときに表示される通知の例。](../media-draft/vm-disk-update-complete.PNG)

4. 完了すると、OS ディスクのキャッシュの種類が**読み取り専用**に設定されます。

データ ディスクのキャッシュの構成に進みましょう。 ディスクを構成するには、まずディスクを作成する必要があります。

## <a name="add-a-data-disk-to-the-vm-and-set-caching-type"></a>データ ディスクを VM に追加してキャッシュの種類を設定する

1. ポータルでご自分の VM の **[ディスク]** ビューに戻り、**[データ ディスクの追加]** を選択します。 **[名前]** フィールドには、このフィールドを空にできないことを示すエラーがすぐに表示されます。 データ ディスクがまだないので、1 つ作成しましょう。

1. **[名前]** ボックスの一覧をクリックして、**[ディスクの作成]** をクリックします。

1. **[マネージド ディスクの作成]** ウィンドウで、**[名前]** ボックスに「**fotosharesVM-data**」と入力します。

1. **[リソース グループ]** で **[既存のものを使用]** を選択し、ドロップダウン メニューから **[fotoshare rg]** を選択します。

1. 画面の下部にある **[作成]** を選択します。

1. ディスクが作成されるまで待ってから、次に進みます。

1. 新しいデータ ディスクの **[ホスト キャッシュ]** 値をドロップダウンを使用して **[読み取り専用]** に変更してから、画面の左上で **[保存]** を選択します。

1. VM が更新されるまで待ちます。 この設定を変更するため、Azure でデータ ディスクのデタッチと再アタッチが行われるため、更新にはしばらく時間がかかります。

1. 完了すると、データ ディスクのキャッシュの種類が**読み取り専用**に設定されます。

この演習では、Azure portal を使用して、新しい VM でキャッシュを構成し、既存ディスクのキャッシュ設定を変更し、新しいデータ ディスクでキャッシュを構成しました。 次のスクリーンショットは最終的な構成を示しています。 

![OS ディスクとデータ ディスクのスクリーンショットでは、どちらも読み取り専用キャッシュに設定されています。](../media-draft/disks-final-config-portal.PNG)