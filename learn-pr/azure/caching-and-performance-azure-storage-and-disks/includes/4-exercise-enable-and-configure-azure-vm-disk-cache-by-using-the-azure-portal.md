
あなたは、写真共有サイトを運営しているとします。データは Azure Virtual Machines (VM) に格納され、SQL Server とカスタム アプリケーションを実行しています。 あなたは次の調整を行いたいと思っています。

- VM でディスク キャッシュ設定を変更する必要がある。
- キャッシュを有効にして新しいデータ ディスクを VM に追加したい。

あなたは、Azure portal でこれらの変更を行うことにしました。

この演習では、先に説明した VM に実際に変更を加えます。 まず、ポータルにサインインして、VM を作成しましょう。

[!include[](../../../includes/azure-sandbox-activate.md)]

## <a name="create-a-virtual-machine"></a>仮想マシンの作成

この手順では、次のプロパティを持つ VM を作成します。

| プロパティ        | 値   |
|-----------------|---------|
| イメージ           | **Windows Server 2016 Datacenter** |
| 名前            | **fotoshareVM** |
| リソース グループ  |   **<rgn>[サンドボックス リソース グループ名]</rgn>** |
| 場所        | 次を参照してください。 |

1. サンドボックスをアクティブ化したときと同じアカウントを使用して、[Azure portal](https://portal.azure.com/learn.docs.microsoft.com?azure-portal=true) にサインインします。

1. 左のサイドバー メニューで、**[リソースの作成]** を選択します。

1. **[人気順]** Marketplace 要素の一覧に _Windows Server 2016 VM_ があるはずです。 ない場合は、上にある検索ボックスを使用して "Windows Server 2016 DataCenter" を検索してみてください。

1. Windows VM を選択し、**[作成]** をクリックして VM の作成プロセスを開始します。

1. **[基本]** パネルで、選択されている **[サブスクリプション]** が_コンシェルジェ サブスクリプション_であることを確認します。

1. **[リソース グループ]** で **[既存のものを使用]** を選択し、_<rgn>[サンドボックス リソース グループ名]</rgn>_ を選びます。

1. **[仮想マシン名]** ボックスに、「_fotoshareVM_」と入力します。

1. **[場所]** ドロップダウン リストで、次の一覧から最も近いリージョンを選択します。

    [!include[](../../../includes/azure-sandbox-regions-first-mention-note-friendly.md)]

1. VM の **[サイズ]** の既定値 **[DS1 v2]** では、1 つの CPU と 3.5 GB のメモリが提供されます。 この例ではそれで問題ありません。

1. **[管理者アカウント]** セクションで、**[ユーザー名]** と **[パスワード]**/**[パスワードの確認]** に新しい VM での管理者アカウントの値を入力します。

1. 次の図は、入力後の **[基本]** 構成の例です。残りのタブとフィールドは既定値のままにして、**[確認および作成]** をクリックします。

    ![説明した構成例が [基本] に入力された [仮想マシンの作成] ブレードを示す Azure portal のスクリーンショット。](../media/4-basics-vm.png)

1. 新しい VM の設定を確認した後、**[作成]** をクリックして新しい VM の展開を始めます。

仮想マシンをサポートするためのさまざまなリソース (ストレージ、ネットワーク インターフェイスなど) がすべて作成されるので、VM の作成には数分かかる場合があります。 VM が展開されるまで待ってから、演習を続けます。

## <a name="view-os-disk-cache-status-in-the-portal"></a>ポータルで OS ディスク キャッシュの状態を表示する

VM をデプロイすると、次の手順を使用して、OS ディスクのキャッシュ状態を確認できます。

1. ポータルで **fotoshareVM** リソースを選択して、VM の詳細を開きます。 または、左のサイドバーで **[すべてのリソース]** をクリックして、**fotoshareVM** を選択します。

1. **[設定]** で **[ディスク]** を選択します。

1. **[ディスク]** ウィンドウでは、VM に 1 つのディスク (OS ディスク) があります。 そのキャッシュの種類は現在、既定値の **[読み取り/書き込み]** に設定されています。

![[VM] ブレードの [ディスク] セクションで OS ディスクが読み取り専用キャッシュに設定されている Azure portal のスクリーンショット。](../media/4-os-disk-rw.PNG)

## <a name="change-the-cache-settings-of-the-os-disk-in-the-portal"></a>ポータルで OS ディスクのキャッシュ設定を変更する

1. **[ディスク]** ウィンドウで、画面の左上の **[編集]** を選択します。

1. OS ディスクの **[ホスト キャッシュ]** の値をドロップダウン リストを使用して **[読み取り専用]** に変更してから、画面の左上で **[保存]** を選択します。

1. この更新には時間がかかることがあります。 この理由は、Azure ディスクのキャッシュ設定を変更すると、対象となるディスクがデタッチされ再アタッチされるからです。 オペレーティング システム ディスクの場合は、VM も再起動されます。 操作が完了すると、VM ディスクが更新されたという通知が表示されます。

1. 完了すると、OS ディスクのキャッシュの種類が**読み取り専用**に設定されます。

データ ディスクのキャッシュの構成に進みましょう。 ディスクを構成するには、まずディスクを作成する必要があります。

## <a name="add-a-data-disk-to-the-vm-and-set-caching-type"></a>データ ディスクを VM に追加してキャッシュの種類を設定する

1. ポータルで VM の **[ディスク]** ビューに戻り、**[データ ディスクの追加]** をクリックします。 **[名前]** フィールドには、このフィールドを空にできないことを示すエラーがすぐに表示されます。 データ ディスクがまだないので、1 つ作成しましょう。

1. **[名前]** ボックスの一覧をクリックして、**[ディスクの作成]** をクリックします。

1. **[マネージド ディスクの作成]** ウィンドウで、**[名前]** ボックスに「**fotosharesVM-data**」と入力します。

1. **[リソース グループ]** で **[既存のものを使用]** を選択し、_<rgn>[サンドボックス リソース グループ名]</rgn>_ を選びます。

1. 残りのフィールドの既定値に注意してください。
    - Premium SSD
    - サイズ 1023 GB
    - VM と同じ場所 (変更不可)。
    - IOPS 制限 - 5000
    - スループット制限 (MB/秒) - 200

1. 画面の下部にある **[作成]** をクリックします。

    ディスクが作成されるまで待ってから、次に進みます。

1. 新しいデータ ディスクの **[ホスト キャッシュ]** の値をドロップダウン リストを使用して **[読み取り専用]** に変更してから (既に設定されているかもしれません)、画面の左上で **[保存]** をクリックします。

    VM で新しいデータ ディスクの更新が完了するまで待ちます。 完了すると、仮想マシン上に新しいデータ ディスクが存在するようになります。

この演習では、Azure portal を使用して、新しい VM でキャッシュを構成し、既存ディスクのキャッシュ設定を変更し、新しいデータ ディスクでキャッシュを構成しました。 次のスクリーンショットは最終的な構成を示しています。

![[VM] ブレードの [ディスク] セクションで両方とも読み取り専用キャッシュに設定された OS ディスクと新しいデータ ディスクが示されている Azure portal のスクリーンショット。](../media/disks-final-config-portal.PNG)
