<span data-ttu-id="e0ace-101">ここでは、Azure のディスク パフォーマンスに影響する要因と、キャッシュでパフォーマンスを最適化する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="e0ace-101">We're going to look at the factors that affect disk performance in Azure, and how caching can help optimize performance.</span></span> 

### <a name="disk-caching"></a><span data-ttu-id="e0ace-102">ディスク キャッシュ</span><span class="sxs-lookup"><span data-stu-id="e0ace-102">Disk caching</span></span>

<span data-ttu-id="e0ace-103">キャッシュは、高速にアクセスできるように、通常はメモリ内にデータを格納するコンピューター内の特殊なコンポーネントです。</span><span class="sxs-lookup"><span data-stu-id="e0ace-103">A cache is a specialized component in a computer that stores data so it can be accessed faster, typically in memory.</span></span> <span data-ttu-id="e0ace-104">キャッシュ内のデータは、多くの場合、以前に読み込まれたデータ、または以前の計算結果であるデータです。</span><span class="sxs-lookup"><span data-stu-id="e0ace-104">The data in a cache is often data that has been read previously, or is data that resulted from an earlier calculation.</span></span> <span data-ttu-id="e0ace-105">目標は、ディスクから取得するよりも速くデータにアクセスすることです。</span><span class="sxs-lookup"><span data-stu-id="e0ace-105">The goal is to access data faster than getting it from disk.</span></span>

<span data-ttu-id="e0ace-106">キャッシュは、特殊な、場合によってはコストが高い一時的なストレージであり、永続的なストレージよりも読み取り、書き込み、またはその両方のパフォーマンスが高速です。</span><span class="sxs-lookup"><span data-stu-id="e0ace-106">Caching uses specialized, and sometimes expensive, temporary storage that has faster read and/or write performance than permanent storage.</span></span> <span data-ttu-id="e0ace-107">このキャッシュ ストレージは限られていることが多いため、キャッシュのメリットが最も大きくなるデータ操作について判断する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e0ace-107">Because this cache storage is often limited, decisions need to be made as to what data operations will benefit most from caching.</span></span> <span data-ttu-id="e0ace-108">ただし、Azure のようにキャッシュを幅広く利用できる場合であっても、使用するキャッシュの種類を判断する前に各ディスクのワークロード パターンを把握しておくことは重要です。</span><span class="sxs-lookup"><span data-stu-id="e0ace-108">But even where the cache can be made widely available, such as in Azure, it's still important to know the workload patterns of each disk before deciding on what caching type to use.</span></span>

<span data-ttu-id="e0ace-109">**読み取りキャッシュ**は、データ取得を高速化する場合に使用します。</span><span class="sxs-lookup"><span data-stu-id="e0ace-109">**Read caching** tries to speed up data retrieval.</span></span> <span data-ttu-id="e0ace-110">データは永続的なストレージからではなく、高速なキャッシュから読み取られます。</span><span class="sxs-lookup"><span data-stu-id="e0ace-110">Instead of reading from permanent storage, the data is read from the faster cache.</span></span> <span data-ttu-id="e0ace-111">以下の条件の場合に、キャッシュからデータが読み取られます。</span><span class="sxs-lookup"><span data-stu-id="e0ace-111">Data reads hit the cache under the following conditions.</span></span>

- <span data-ttu-id="e0ace-112">データは以前に読み取られたことがあり、キャッシュ内に存在します。</span><span class="sxs-lookup"><span data-stu-id="e0ace-112">The data has been read before and exists in the cache.</span></span>
- <span data-ttu-id="e0ace-113">また、キャッシュは、このデータをすべて保持できる十分な大きさです。</span><span class="sxs-lookup"><span data-stu-id="e0ace-113">And the cache is large enough to hold all of this data.</span></span>

<span data-ttu-id="e0ace-114">読み取りキャッシュは、一連の順次読み取りのように、読み取りキューに対して何らかの_予測可能性_がある場合に役立つ点に留意してください。</span><span class="sxs-lookup"><span data-stu-id="e0ace-114">It's important to note that read caching helps when there is some _predictability_ to the read queue, such as a set of sequential reads.</span></span> <span data-ttu-id="e0ace-115">ランダム IO の場合、アクセスしているデータがストレージ全体に分散しているため、キャッシュのメリットはほとんどないかまったくありません。さらに、ディスクのパフォーマンスが低下する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="e0ace-115">For random IO, where the data you're accessing is scattered across storage, caching will be of little or no benefit, and can even reduce disk performance.</span></span>

<span data-ttu-id="e0ace-116">**書き込みキャッシュ** は、ストレージへのデータの書き込みを高速化する場合に使用します。</span><span class="sxs-lookup"><span data-stu-id="e0ace-116">**Write caching** tries to speed up writing data to storage.</span></span> <span data-ttu-id="e0ace-117">書き込みキャッシュを使用すると、アプリはデータを保存対象と見なすことができます。</span><span class="sxs-lookup"><span data-stu-id="e0ace-117">By using a write cache, the app can consider the data to be saved.</span></span> <span data-ttu-id="e0ace-118">実際には、永続的なストレージへの書き込みを待機するキャッシュのキューにデータが格納されます。</span><span class="sxs-lookup"><span data-stu-id="e0ace-118">In reality, the data is queued up in a cache waiting to be written to permanent storage.</span></span> <span data-ttu-id="e0ace-119">ご想像のとおり、このキャッシュされたデータがディスクにフラッシュされる前にシステムがシャットダウンした場合、このメカニズムは障害点になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="e0ace-119">As you can imagine, this mechanism can be a potential point of failure, if the system shuts down before this cached data is flushed to disk.</span></span> <span data-ttu-id="e0ace-120">SQL Server などの一部のシステムでは、キャッシュされたデータを永続的なディスク ストレージに書き込む処理が実行されます。</span><span class="sxs-lookup"><span data-stu-id="e0ace-120">Some systems, such as SQL Server, handle writing cached data to persistent disk storage themselves.</span></span>  

### <a name="azure-disk-caching"></a><span data-ttu-id="e0ace-121">Azure のディスク キャッシュ</span><span class="sxs-lookup"><span data-stu-id="e0ace-121">Azure disk caching</span></span>

<span data-ttu-id="e0ace-122">ディスク ストレージに関するディスク キャッシュには 2 つの種類があります。</span><span class="sxs-lookup"><span data-stu-id="e0ace-122">There are two types of disk caching that concern disk storage:</span></span>

- <span data-ttu-id="e0ace-123">Azure ストレージ キャッシュ</span><span class="sxs-lookup"><span data-stu-id="e0ace-123">Azure storage caching</span></span>
- <span data-ttu-id="e0ace-124">Azure 仮想マシン ディスク キャッシュ</span><span class="sxs-lookup"><span data-stu-id="e0ace-124">Azure virtual machine disk caching</span></span>

<span data-ttu-id="e0ace-125">Azure Storage キャッシュには、Azure Blob Storage、Azure Files などの Azure 内のコンテンツ向けにキャッシュ サービスがあります。</span><span class="sxs-lookup"><span data-stu-id="e0ace-125">Azure storage caching provides cache services for Azure Blob storage, Azure Files, and other content in Azure.</span></span> <span data-ttu-id="e0ace-126">このような種類のキャッシュの構成は、このモジュールの範囲外です。</span><span class="sxs-lookup"><span data-stu-id="e0ace-126">Configuration of these types of cache is beyond the scope of this module.</span></span>

<span data-ttu-id="e0ace-127">Azure 仮想マシンのディスク キャッシュは、Azure VM に接続された仮想ハード ディスク (VHD) ファイルへの読み取りおよび書き込みアクセスを最適化するものです。</span><span class="sxs-lookup"><span data-stu-id="e0ace-127">Azure virtual machine disk caching is about optimizing read and write access to the virtual hard disk (VHD) files attached to Azure VMs.</span></span> <span data-ttu-id="e0ace-128">このモジュールではディスク キャッシュに注目します。</span><span class="sxs-lookup"><span data-stu-id="e0ace-128">We'll focus on disk caching in this module.</span></span>

### <a name="azure-virtual-machine-disk-types"></a><span data-ttu-id="e0ace-129">Azure 仮想マシン ディスクの種類</span><span class="sxs-lookup"><span data-stu-id="e0ace-129">Azure virtual machine disk types</span></span>

<span data-ttu-id="e0ace-130">Azure Virtual Machines (VM) に使用されるディスクの種類は 3 つです。</span><span class="sxs-lookup"><span data-stu-id="e0ace-130">There are three types of disks used with Azure virtual machines (VM).</span></span>

- <span data-ttu-id="e0ace-131">**OS ディスク**: Azure VM を作成すると、Azure によってオペレーティング システム (OS) 用の VHD が自動的にアタッチされます。</span><span class="sxs-lookup"><span data-stu-id="e0ace-131">**OS disk**: When you create an Azure VM, Azure automatically attaches a VHD for the operating system (OS).</span></span> <span data-ttu-id="e0ace-132">VHD は、Azure Storage にページ BLOB として格納されます。</span><span class="sxs-lookup"><span data-stu-id="e0ace-132">The VHD is stored as a page blob in Azure storage.</span></span>
- <span data-ttu-id="e0ace-133">**一時ディスク**: Azure VM を作成すると、Azure によって一時ディスクも自動的に追加されます。</span><span class="sxs-lookup"><span data-stu-id="e0ace-133">**Temporary disk**: When you create an Azure VM, Azure also automatically adds a temporary disk.</span></span> <span data-ttu-id="e0ace-134">このディスクは、ページやスワップ ファイルなどのデータに使用されます。</span><span class="sxs-lookup"><span data-stu-id="e0ace-134">This disk is used for data such as page and swap files.</span></span> <span data-ttu-id="e0ace-135">このディスク上のデータは、メンテナンス時または VM の再デプロイ時に失われる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="e0ace-135">The data on this disk may be lost during maintenance or a VM redeploy.</span></span> <span data-ttu-id="e0ace-136">そのため、永続的なデータ (データベース ファイルやトランザクション ログなど) の保存には使用しないでください。</span><span class="sxs-lookup"><span data-stu-id="e0ace-136">So, don't use it for storing permanent data, such as database files or transaction logs.</span></span>
- <span data-ttu-id="e0ace-137">**データ ディスク**: データ ディスクは仮想マシンに取り付けられる VHD であり、ユーザーが保存しておく必要があるアプリケーションなどのデータを格納するためのものです。</span><span class="sxs-lookup"><span data-stu-id="e0ace-137">**Data disks**: A data disk is a VHD that's attached to a virtual machine to store application data, or other data you need to keep.</span></span>

<span data-ttu-id="e0ace-138">OS ディスクとデータ ディスクは、Azure VM ディスク キャッシュを利用しています。</span><span class="sxs-lookup"><span data-stu-id="e0ace-138">OS disks and data disks take advantage of Azure VM disk caching.</span></span> <span data-ttu-id="e0ace-139">VM ディスクのキャッシュ サイズは、VM インスタンスのサイズと、VM にマウントされているディスクの数によって変わります。</span><span class="sxs-lookup"><span data-stu-id="e0ace-139">The cache size for a VM disk depends on the VM instance size and on the number of disks mounted on the VM.</span></span> <span data-ttu-id="e0ace-140">キャッシュは、最大 4 つのデータ ディスクにのみ有効にすることができます。</span><span class="sxs-lookup"><span data-stu-id="e0ace-140">Caching can only be enabled for up to four data disks.</span></span>

## <a name="cache-options-for-azure-vms"></a><span data-ttu-id="e0ace-141">Azure VM のキャッシュ オプション</span><span class="sxs-lookup"><span data-stu-id="e0ace-141">Cache options for Azure VMs</span></span>

<span data-ttu-id="e0ace-142">VM ディスク キャッシュには 3 つの一般的なオプションがあります。</span><span class="sxs-lookup"><span data-stu-id="e0ace-142">There are three common options for VM disk caching.</span></span>

- <span data-ttu-id="e0ace-143">**読み取り/書き込み**: キャッシュを書き戻します。</span><span class="sxs-lookup"><span data-stu-id="e0ace-143">**Read/write** – write back cache.</span></span>  <span data-ttu-id="e0ace-144">アプリケーションが、キャッシュ データの永続ディスクへの書き込みを必要に応じて適切に処理できる場合にのみ、このオプションを使用します。</span><span class="sxs-lookup"><span data-stu-id="e0ace-144">Only use this option if your application properly handles writing cached data to persistent disks when needed</span></span>
- <span data-ttu-id="e0ace-145">**読み取り専用**: 読み取りはキャッシュから実行されます。</span><span class="sxs-lookup"><span data-stu-id="e0ace-145">**Read-only** - reads are performed from cache.</span></span>
- <span data-ttu-id="e0ace-146">**なし**: キャッシュなし。</span><span class="sxs-lookup"><span data-stu-id="e0ace-146">**None** - no cache.</span></span> <span data-ttu-id="e0ace-147">書き込み専用で書き込み負荷の高いディスクにこのオプションを選択します。</span><span class="sxs-lookup"><span data-stu-id="e0ace-147">Select this option for write-only and write-heavy disks.</span></span> <span data-ttu-id="e0ace-148">ログ ファイルは、書き込み負荷が高い操作なので適しています。</span><span class="sxs-lookup"><span data-stu-id="e0ace-148">Log files are a good candidate since they're write-heavy operations.</span></span>

<span data-ttu-id="e0ace-149">ディスクの各種類にすべてのキャッシュ オプションを使用できるわけではありません。</span><span class="sxs-lookup"><span data-stu-id="e0ace-149">Not every caching option is available for each type of disk.</span></span> <span data-ttu-id="e0ace-150">次の表は、ディスクの各種類のキャッシュ オプションを示しています。</span><span class="sxs-lookup"><span data-stu-id="e0ace-150">The following table shows you the caching options for each disk type:</span></span>

| |<span data-ttu-id="e0ace-151">**読み取り専用**</span><span class="sxs-lookup"><span data-stu-id="e0ace-151">**Read-only**</span></span>  |<span data-ttu-id="e0ace-152">**読み取り/書き込み**</span><span class="sxs-lookup"><span data-stu-id="e0ace-152">**Read/write**</span></span>  |<span data-ttu-id="e0ace-153">**なし**</span><span class="sxs-lookup"><span data-stu-id="e0ace-153">**None**</span></span>  |
|---------|---------|---------|---------|
|<span data-ttu-id="e0ace-154">OS ディスク</span><span class="sxs-lookup"><span data-stu-id="e0ace-154">OS disk</span></span>     |   <span data-ttu-id="e0ace-155">○</span><span class="sxs-lookup"><span data-stu-id="e0ace-155">yes</span></span>      |   <span data-ttu-id="e0ace-156">○ (既定値)</span><span class="sxs-lookup"><span data-stu-id="e0ace-156">yes (default)</span></span>     |   <span data-ttu-id="e0ace-157">○</span><span class="sxs-lookup"><span data-stu-id="e0ace-157">yes</span></span>      |
|<span data-ttu-id="e0ace-158">データ ディスク</span><span class="sxs-lookup"><span data-stu-id="e0ace-158">Data disk</span></span>     |   <span data-ttu-id="e0ace-159">○ (既定値)</span><span class="sxs-lookup"><span data-stu-id="e0ace-159">yes (default)</span></span>      |  <span data-ttu-id="e0ace-160">○</span><span class="sxs-lookup"><span data-stu-id="e0ace-160">yes</span></span>       |  <span data-ttu-id="e0ace-161">○</span><span class="sxs-lookup"><span data-stu-id="e0ace-161">yes</span></span>       |
|<span data-ttu-id="e0ace-162">一時ディスク</span><span class="sxs-lookup"><span data-stu-id="e0ace-162">Temporary disk</span></span>     |  <span data-ttu-id="e0ace-163">×</span><span class="sxs-lookup"><span data-stu-id="e0ace-163">no</span></span>       |   <span data-ttu-id="e0ace-164">×</span><span class="sxs-lookup"><span data-stu-id="e0ace-164">no</span></span>      |   <span data-ttu-id="e0ace-165">×</span><span class="sxs-lookup"><span data-stu-id="e0ace-165">no</span></span>      |

> [!NOTE]
> <span data-ttu-id="e0ace-166">L シリーズと B シリーズの仮想マシンのディスク キャッシュは変更できません。</span><span class="sxs-lookup"><span data-stu-id="e0ace-166">Disk caching options can't be changed for L-Series and B-series virtual machines.</span></span>

## <a name="performance-considerations-for-azure-vm-disk-caching"></a><span data-ttu-id="e0ace-167">Azure VM ディスク キャッシュのパフォーマンスに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="e0ace-167">Performance considerations for Azure VM disk caching</span></span>

<span data-ttu-id="e0ace-168">キャッシュ設定は、Azure VM 上で動作するワークロードのパフォーマンスにどのように影響するでしょうか。</span><span class="sxs-lookup"><span data-stu-id="e0ace-168">So how can your cache settings affect the performance of your workloads running on Azure VMs?</span></span>

### <a name="os-disk"></a><span data-ttu-id="e0ace-169">OS ディスク</span><span class="sxs-lookup"><span data-stu-id="e0ace-169">OS disk</span></span>

<span data-ttu-id="e0ace-170">VM OS ディスクの場合、既定の動作では、キャッシュは読み取り/書き込みモードで使用されます。</span><span class="sxs-lookup"><span data-stu-id="e0ace-170">For a VM OS disk, the default behavior is to use the cache in Read/write mode.</span></span> <span data-ttu-id="e0ace-171">OS ディスクにデータ ファイルを格納するアプリケーションがあり、アプリケーションがデータ ファイルに対するランダムな読み取り/書き込み操作を多数行う場合は、そのようなファイルをキャッシュがオフになっているデータ ディスクに移動することを検討してください。</span><span class="sxs-lookup"><span data-stu-id="e0ace-171">If you have applications that store data files on the OS disk, and the applications do lots of random read/write operations to data files, consider moving those files to a data disk, which has the caching turned off.</span></span> <span data-ttu-id="e0ace-172">その理由は、読み取りキューに順次読み取りが含まれていない場合、キャッシュのメリットがほとんどないか、まったくないためです。</span><span class="sxs-lookup"><span data-stu-id="e0ace-172">Why is that Well, if the read queue does not contain sequential reads, caching will be of little or no benefit.</span></span> <span data-ttu-id="e0ace-173">データが順次であるかのようにキャッシュを維持するオーバーヘッドで、ディスクのパフォーマンスが低下する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="e0ace-173">The overhead of maintaining the cache, as if the data was sequential, can reduce disk performance.</span></span>

### <a name="data-disks"></a><span data-ttu-id="e0ace-174">データ ディスク</span><span class="sxs-lookup"><span data-stu-id="e0ace-174">Data disks</span></span>

<span data-ttu-id="e0ace-175">パフォーマンスの影響を受けやすいアプリケーションの場合は、OS ディスクではなくデータ ディスクを使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="e0ace-175">For performance sensitive applications, you should use data disks, rather than the OS disk.</span></span> <span data-ttu-id="e0ace-176">別のディスクを使用すると、各ディスクに適切なキャッシュ設定を構成できます。</span><span class="sxs-lookup"><span data-stu-id="e0ace-176">Using separate disks allows you to configure the appropriate cache settings for each disk.</span></span>

<span data-ttu-id="e0ace-177">たとえば、SQL Server を実行している Azure VM 上で、(通常データおよび TempDB データ用に) データ ディスク上で**読み取り専用**キャッシュを有効にすると、パフォーマンスが大幅に改善する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="e0ace-177">For example, on Azure VMs running SQL Server, enabling **Read-only** caching on the data disks (for regular and TempDB data), can result in significant performance improvements.</span></span> <span data-ttu-id="e0ace-178">一方、ログ ファイルは、キャッシュがないデータ ディスクに適しています。</span><span class="sxs-lookup"><span data-stu-id="e0ace-178">Log files, on the other hand, are good candidates for data disks with no caching.</span></span>

> [!WARNING]
> <span data-ttu-id="e0ace-179">Azure ディスクのキャッシュ設定を変更すると、対象となるディスクをデタッチして再アタッチします。</span><span class="sxs-lookup"><span data-stu-id="e0ace-179">Changing the cache setting of an Azure disk detaches and re-attaches the target disk.</span></span> <span data-ttu-id="e0ace-180">オペレーティング システム ディスクの場合は、VM が再起動されます。</span><span class="sxs-lookup"><span data-stu-id="e0ace-180">If it's the operating system disk, the VM is restarted.</span></span> <span data-ttu-id="e0ace-181">ディスク キャッシュの設定を変更する前に、この中断の影響を受ける可能性があるすべてのアプリケーションまたはサービスを停止します。</span><span class="sxs-lookup"><span data-stu-id="e0ace-181">Stop all applications/services that might be affected by this disruption before changing the disk cache setting.</span></span>
>
>