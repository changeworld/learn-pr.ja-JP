ここでは、Azure のディスク パフォーマンスに影響する要因と、キャッシュでパフォーマンスを最適化する方法について説明します。 

### <a name="disk-caching"></a>ディスク キャッシュ

キャッシュは、高速にアクセスできるように、通常はメモリ内にデータを格納するコンピューター内の特殊なコンポーネントです。 キャッシュ内のデータは、多くの場合、以前に読み込まれたデータ、または以前の計算結果であるデータです。 目標は、ディスクから取得するよりも速くデータにアクセスすることです。

キャッシュは、特殊な、場合によってはコストが高い一時的なストレージであり、永続的なストレージよりも読み取り、書き込み、またはその両方のパフォーマンスが高速です。 このキャッシュ ストレージは限られていることが多いため、キャッシュのメリットが最も大きくなるデータ操作について判断する必要があります。 ただし、Azure のようにキャッシュを幅広く利用できる場合であっても、使用するキャッシュの種類を判断する前に各ディスクのワークロード パターンを把握しておくことは重要です。

**読み取りキャッシュ**は、データ取得を高速化する場合に使用します。 データは永続的なストレージからではなく、高速なキャッシュから読み取られます。 以下の条件の場合に、キャッシュからデータが読み取られます。

- データは以前に読み取られたことがあり、キャッシュ内に存在します。
- また、キャッシュは、このデータをすべて保持できる十分な大きさです。

読み取りキャッシュは、一連の順次読み取りのように、読み取りキューに対して何らかの_予測可能性_がある場合に役立つ点に留意してください。 ランダム IO の場合、アクセスしているデータがストレージ全体に分散しているため、キャッシュのメリットはほとんどないかまったくありません。さらに、ディスクのパフォーマンスが低下する可能性があります。

**書き込みキャッシュ** は、ストレージへのデータの書き込みを高速化する場合に使用します。 書き込みキャッシュを使用すると、アプリはデータを保存対象と見なすことができます。 実際には、永続的なストレージへの書き込みを待機するキャッシュのキューにデータが格納されます。 ご想像のとおり、このキャッシュされたデータがディスクにフラッシュされる前にシステムがシャットダウンした場合、このメカニズムは障害点になる可能性があります。 SQL Server などの一部のシステムでは、キャッシュされたデータを永続的なディスク ストレージに書き込む処理が実行されます。  

### <a name="azure-disk-caching"></a>Azure のディスク キャッシュ

ディスク ストレージに関するディスク キャッシュには 2 つの種類があります。

- Azure ストレージ キャッシュ
- Azure 仮想マシン ディスク キャッシュ

Azure Storage キャッシュには、Azure Blob Storage、Azure Files などの Azure 内のコンテンツ向けにキャッシュ サービスがあります。 このような種類のキャッシュの構成は、このモジュールの範囲外です。

Azure 仮想マシンのディスク キャッシュは、Azure VM に接続された仮想ハード ディスク (VHD) ファイルへの読み取りおよび書き込みアクセスを最適化するものです。 このモジュールではディスク キャッシュに注目します。

### <a name="azure-virtual-machine-disk-types"></a>Azure 仮想マシン ディスクの種類

Azure Virtual Machines (VM) に使用されるディスクの種類は 3 つです。

- **OS ディスク**: Azure VM を作成すると、Azure によってオペレーティング システム (OS) 用の VHD が自動的にアタッチされます。 VHD は、Azure Storage にページ BLOB として格納されます。
- **一時ディスク**: Azure VM を作成すると、Azure によって一時ディスクも自動的に追加されます。 このディスクは、ページやスワップ ファイルなどのデータに使用されます。 このディスク上のデータは、メンテナンス時または VM の再デプロイ時に失われる可能性があります。 そのため、永続的なデータ (データベース ファイルやトランザクション ログなど) の保存には使用しないでください。
- **データ ディスク**: データ ディスクは仮想マシンに取り付けられる VHD であり、ユーザーが保存しておく必要があるアプリケーションなどのデータを格納するためのものです。

OS ディスクとデータ ディスクは、Azure VM ディスク キャッシュを利用しています。 VM ディスクのキャッシュ サイズは、VM インスタンスのサイズと、VM にマウントされているディスクの数によって変わります。 キャッシュは、最大 4 つのデータ ディスクにのみ有効にすることができます。

## <a name="cache-options-for-azure-vms"></a>Azure VM のキャッシュ オプション

VM ディスク キャッシュには 3 つの一般的なオプションがあります。

- **読み取り/書き込み**: キャッシュを書き戻します。  アプリケーションが、キャッシュ データの永続ディスクへの書き込みを必要に応じて適切に処理できる場合にのみ、このオプションを使用します。
- **読み取り専用**: 読み取りはキャッシュから実行されます。
- **なし**: キャッシュなし。 書き込み専用で書き込み負荷の高いディスクにこのオプションを選択します。 ログ ファイルは、書き込み負荷が高い操作なので適しています。

ディスクの各種類にすべてのキャッシュ オプションを使用できるわけではありません。 次の表は、ディスクの各種類のキャッシュ オプションを示しています。

| |**読み取り専用**  |**読み取り/書き込み**  |**なし**  |
|---------|---------|---------|---------|
|OS ディスク     |   ○      |   ○ (既定値)     |   ○      |
|データ ディスク     |   ○ (既定値)      |  ○       |  ○       |
|一時ディスク     |  ×       |   ×      |   ×      |

> [!NOTE]
> L シリーズと B シリーズの仮想マシンのディスク キャッシュは変更できません。

## <a name="performance-considerations-for-azure-vm-disk-caching"></a>Azure VM ディスク キャッシュのパフォーマンスに関する考慮事項

キャッシュ設定は、Azure VM 上で動作するワークロードのパフォーマンスにどのように影響するでしょうか。

### <a name="os-disk"></a>OS ディスク

VM OS ディスクの場合、既定の動作では、キャッシュは読み取り/書き込みモードで使用されます。 OS ディスクにデータ ファイルを格納するアプリケーションがあり、アプリケーションがデータ ファイルに対するランダムな読み取り/書き込み操作を多数行う場合は、そのようなファイルをキャッシュがオフになっているデータ ディスクに移動することを検討してください。 その理由は、読み取りキューに順次読み取りが含まれていない場合、キャッシュのメリットがほとんどないか、まったくないためです。 データが順次であるかのようにキャッシュを維持するオーバーヘッドで、ディスクのパフォーマンスが低下する可能性があります。

### <a name="data-disks"></a>データ ディスク

パフォーマンスの影響を受けやすいアプリケーションの場合は、OS ディスクではなくデータ ディスクを使用することをお勧めします。 別のディスクを使用すると、各ディスクに適切なキャッシュ設定を構成できます。

たとえば、SQL Server を実行している Azure VM 上で、(通常データおよび TempDB データ用に) データ ディスク上で**読み取り専用**キャッシュを有効にすると、パフォーマンスが大幅に改善する可能性があります。 一方、ログ ファイルは、キャッシュがないデータ ディスクに適しています。

> [!WARNING]
> Azure ディスクのキャッシュ設定を変更すると、対象となるディスクをデタッチして再アタッチします。 オペレーティング システム ディスクの場合は、VM が再起動されます。 ディスク キャッシュの設定を変更する前に、この中断の影響を受ける可能性があるすべてのアプリケーションまたはサービスを停止します。
>
>