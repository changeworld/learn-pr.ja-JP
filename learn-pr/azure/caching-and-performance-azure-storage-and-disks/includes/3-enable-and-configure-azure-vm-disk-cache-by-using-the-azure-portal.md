ディスク パフォーマンスを予測するために選択できる設定とプロパティを確認しました。それでは、_キャッシュ_でディスク パフォーマンスを改善する方法を見てみましょう。

## <a name="disk-caching"></a>ディスク キャッシュ

キャッシュは、すばやくアクセスできるように、(一般的には) メモリにデータを格納する特殊なコンポーネントです。 キャッシュ内のデータは、多くの場合、以前に読み込まれたデータであるか、以前の計算結果であるデータです。 目標は、ディスクから取得するよりも速くデータにアクセスすることです。

キャッシュでは、特殊な、場合によってはコストが高い一時的なストレージが使用されますが、この一時的なストレージは、永続的なストレージよりも読み取り、書き込み、またはその両方のパフォーマンスが速くなります。 このキャッシュ ストレージは限られていることが多いため、キャッシュから最も大きな恩恵を受けるデータ操作は何であるかを判断しておく必要があります。 Azure のようにキャッシュを幅広く利用できる場合であっても、使用するキャッシュの種類を判断する前に各ディスクのワークロード パターンを把握しておくことは重要です。

**読み取りキャッシュ**では、データ_取得_の高速化が試行されます。 データは永続的なストレージからではなく、高速なキャッシュから読み取られます。 次の条件の下でキャッシュからデータが読み取られます。

- データは以前に読み取られたことがあり、キャッシュ内に存在します。
- また、キャッシュは、このデータをすべて保持できる十分な大きさです。

読み取りキャッシュは、一連の順次読み取りのように、読み取りキューに対して何らかの_予測可能性_がある場合に役立つ点に留意してください。 ランダム I/O の場合、アクセスしているデータがストレージ全体に分散しているため、キャッシュのメリットはほとんどないかまったくありません。さらに、ディスクのパフォーマンスが低下する可能性があります。

**書き込みキャッシュ**では、永続的ストレージへの_データ書き込み_の高速化が試行されます。 書き込みキャッシュを使用すると、アプリはデータを保存対象と見なすことができます。 実際には、データはキャッシュの待ち行列に入り、ディスクに書き込まれるのを待ちます。 ご想像のとおり、たとえば、キャッシュされたデータが書き込まれる前にシステムがシャットダウンした場合、このメカニズムは障害点になる可能性があります。 SQL Server などの一部のシステムでは、キャッシュされたデータを永続的なディスク ストレージに書き込む処理が実行されます。

### <a name="azure-disk-caching"></a>Azure のディスク キャッシュ

ディスク ストレージに関するディスク キャッシュには 2 つの種類があります。

- Azure ストレージ キャッシュ
- Azure 仮想マシン ディスク (VM) キャッシュ

Azure Storage キャッシュには、Azure Blob Storage、Azure Files などの Azure 内のコンテンツ向けにキャッシュ サービスがあります。 このような種類のキャッシュの構成は、このモジュールの範囲外です。

Azure 仮想マシンのディスク キャッシュは、Azure VM に接続された仮想ハード ディスク (VHD) ファイルへの読み取りおよび書き込みアクセスを最適化するものです。 このモジュールではディスク キャッシュに注目します。

### <a name="azure-virtual-machine-disk-types"></a>Azure 仮想マシン ディスクの種類

Azure VM に使用されるディスクの種類は 3 つです。

- **OS ディスク**: Azure VM を作成すると、Azure によってオペレーティング システム (OS) 用の VHD が自動的にアタッチされます。

- **一時ディスク**: Azure VM を作成すると、Azure によって一時ディスクも自動的に追加されます。 このディスクは、ページやスワップ ファイルなどのデータに使用されます。 このディスク上のデータは、メンテナンス時または VM の再デプロイ時に失われる可能性があります。 そのため、永続的なデータ (データベース ファイルやトランザクション ログなど) の保存には使用しないでください。

- **データ ディスク**: データ ディスクは仮想マシンに取り付けられる VHD であり、保存しておく必要があるアプリケーションなどのデータを格納します。

OS ディスクとデータ ディスクでは、Azure VM ディスク キャッシュが活用されます。 VM ディスクのキャッシュ サイズは、VM インスタンスのサイズと、VM にマウントされているディスクの数によって変わります。 キャッシュは、最大 4 つのデータ ディスクにのみ有効にすることができます。

## <a name="cache-options-for-azure-vms"></a>Azure VM のキャッシュ オプション

VM ディスク キャッシュには 3 つの共通オプションがあります。

- **読み取り/書き込み**: キャッシュを書き戻します。 キャッシュ データの永続ディスクへの書き込みがアプリケーションで必要に応じて適切に処理される場合にのみ、このオプションを使用します。
- **読み取り専用**: キャッシュから読み取られます。
- **なし**: キャッシュはありません。 書き込み専用で書き込み負荷の高いディスクにこのオプションを選択します。 ログ ファイルは、書き込み負荷が高い操作なので適しています。

ディスクの各種類にすべてのキャッシュ オプションを使用できるわけではありません。 次の表は、ディスクの各種類のキャッシュ オプションを示しています。

|               | **読み取り専用**  | **読み取り/書き込み** | **なし** |
|---------------|----------------|----------------|----------|
| OS ディスク       | ○            | ○ (既定値)  | ○      |
| データ ディスク     | ○ (既定値)  | ○            | ○      |
| 一時ディスク     | ×             | ×             | ×       |

> [!NOTE]
> **L シリーズ**と **B シリーズ**の仮想マシンの場合、ディスク キャッシュを変更できません。

## <a name="performance-considerations-for-azure-vm-disk-caching"></a>Azure VM ディスク キャッシュのパフォーマンスに関する考慮事項

キャッシュ設定は、Azure VM 上で動作するワークロードのパフォーマンスにどのように影響するでしょうか?

### <a name="os-disk"></a>OS ディスク

VM OS ディスクの場合、既定の動作では、キャッシュは読み取り/書き込みモードで使用されます。 OS ディスクにデータ ファイルを格納するアプリケーションがあり、アプリケーションがデータ ファイルに対するランダムな読み取り/書き込み操作を多数行う場合は、そのようなファイルをキャッシュがオフになっているデータ ディスクに移動することを検討してください。 なぜですか? 読み取りキューに順次読み取りが含まれていない場合、キャッシュのメリットがほとんどないか、まったくないためです。 データが順次であるかのようにキャッシュを維持するオーバーヘッドで、ディスクのパフォーマンスが低下する可能性があります。

### <a name="data-disks"></a>データ ディスク

パフォーマンスの影響を受けやすいアプリケーションの場合は、OS ディスクではなくデータ ディスクを使用することをお勧めします。 別のディスクを使用すると、各ディスクに適切なキャッシュ設定を構成できます。

たとえば、SQL Server を実行している Azure VM 上で、(通常データおよび TempDB データ用に) データ ディスク上で**読み取り専用**キャッシュを有効にすると、パフォーマンスが大幅に改善する可能性があります。 一方、ログ ファイルは、キャッシュがないデータ ディスクに適しています。

> [!WARNING]
> Azure ディスクのキャッシュ設定を変更すると、対象となるディスクがデタッチされ、再アタッチされます。 オペレーティング システム ディスクの場合は、VM が再起動されます。 ディスク キャッシュの設定を変更する前に、この中断の影響を受ける可能性があるすべてのアプリケーションまたはサービスを停止します。

次のいずれかのツールを使用して、仮想マシンのディスク キャッシュ設定を構成できます。

- Azure portal
- Azure CLI
- Azure PowerShell
- Resource Manager テンプレート

## <a name="using-the-azure-portal-to-configure-caching"></a>Azure portal を使用してキャッシュを構成する

Azure portal を使用して新しい VM をプロビジョニングする場合、VM がデプロイされるまで、OS ディスクの既定のキャッシュ構成を読み取り/書き込みから変更することはできません。

データ ディスクを既存の VM に追加する場合、ディスクを VM にデプロイする前にキャッシュ オプションを構成できます。

Azure ディスクのキャッシュ設定を変更すると、対象となるディスクをデタッチして再アタッチします。 オペレーティング システム ディスクの場合は、VM が再起動されます。 ディスク キャッシュの設定を変更する前に、この中断の影響を受ける可能性があるすべてのアプリケーションまたはサービスを停止します。

Azure portal を使用して VM を作成し、キャッシュ設定を変更してみましょう。
