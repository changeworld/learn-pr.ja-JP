<span data-ttu-id="6f92a-101">ディスク パフォーマンスを予測するために選択できる設定とプロパティを確認しました。それでは、_キャッシュ_でディスク パフォーマンスを改善する方法を見てみましょう。</span><span class="sxs-lookup"><span data-stu-id="6f92a-101">We've seen settings and properties you can select to predict your disk performance, now let's look at ways to improve that through _caching_.</span></span>

## <a name="disk-caching"></a><span data-ttu-id="6f92a-102">ディスク キャッシュ</span><span class="sxs-lookup"><span data-stu-id="6f92a-102">Disk caching</span></span>

<span data-ttu-id="6f92a-103">キャッシュは、すばやくアクセスできるように、(一般的には) メモリにデータを格納する特殊なコンポーネントです。</span><span class="sxs-lookup"><span data-stu-id="6f92a-103">A cache is a specialized component that stores data, typically in memory so that it can be accessed more quickly.</span></span> <span data-ttu-id="6f92a-104">キャッシュ内のデータは、多くの場合、以前に読み込まれたデータであるか、以前の計算結果であるデータです。</span><span class="sxs-lookup"><span data-stu-id="6f92a-104">The data in a cache is often data that has been read previously or is data that resulted from an earlier calculation.</span></span> <span data-ttu-id="6f92a-105">目標は、ディスクから取得するよりも速くデータにアクセスすることです。</span><span class="sxs-lookup"><span data-stu-id="6f92a-105">The goal is to access data faster than getting it from disk.</span></span>

<span data-ttu-id="6f92a-106">キャッシュでは、特殊な、場合によってはコストが高い一時的なストレージが使用されますが、この一時的なストレージは、永続的なストレージよりも読み取り、書き込み、またはその両方のパフォーマンスが速くなります。</span><span class="sxs-lookup"><span data-stu-id="6f92a-106">Caching uses specialized, and sometimes expensive, temporary storage that has faster read and write performance than permanent storage.</span></span> <span data-ttu-id="6f92a-107">このキャッシュ ストレージは限られていることが多いため、キャッシュから最も大きな恩恵を受けるデータ操作は何であるかを判断しておく必要があります。</span><span class="sxs-lookup"><span data-stu-id="6f92a-107">Because this cache storage is often limited, decisions need to be made as to what data operations will benefit most from caching.</span></span> <span data-ttu-id="6f92a-108">Azure のようにキャッシュを幅広く利用できる場合であっても、使用するキャッシュの種類を判断する前に各ディスクのワークロード パターンを把握しておくことは重要です。</span><span class="sxs-lookup"><span data-stu-id="6f92a-108">But even where the cache can be made widely available, such as in Azure, it's still important to know the workload patterns of each disk before deciding on what caching type to use.</span></span>

<span data-ttu-id="6f92a-109">**読み取りキャッシュ**では、データ_取得_の高速化が試行されます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-109">**Read caching** tries to speed up data _retrieval_.</span></span> <span data-ttu-id="6f92a-110">データは永続的なストレージからではなく、高速なキャッシュから読み取られます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-110">Instead of reading from permanent storage, the data is read from the faster cache.</span></span> <span data-ttu-id="6f92a-111">次の条件の下でキャッシュからデータが読み取られます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-111">Data reads hit the cache under the following conditions:</span></span>

- <span data-ttu-id="6f92a-112">データは以前に読み取られたことがあり、キャッシュ内に存在します。</span><span class="sxs-lookup"><span data-stu-id="6f92a-112">The data has been read before and exists in the cache.</span></span>
- <span data-ttu-id="6f92a-113">また、キャッシュは、このデータをすべて保持できる十分な大きさです。</span><span class="sxs-lookup"><span data-stu-id="6f92a-113">And the cache is large enough to hold all of this data.</span></span>

<span data-ttu-id="6f92a-114">読み取りキャッシュは、一連の順次読み取りのように、読み取りキューに対して何らかの_予測可能性_がある場合に役立つ点に留意してください。</span><span class="sxs-lookup"><span data-stu-id="6f92a-114">It's important to note that read caching helps when there is some _predictability_ to the read queue, such as a set of sequential reads.</span></span> <span data-ttu-id="6f92a-115">ランダム I/O の場合、アクセスしているデータがストレージ全体に分散しているため、キャッシュのメリットはほとんどないかまったくありません。さらに、ディスクのパフォーマンスが低下する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="6f92a-115">For random I/O, where the data you're accessing is scattered across storage, caching will be of little or no benefit, and can even reduce disk performance.</span></span>

<span data-ttu-id="6f92a-116">**書き込みキャッシュ**では、永続的ストレージへの_データ書き込み_の高速化が試行されます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-116">**Write caching** tries to speed up _writing data_ to persistent storage.</span></span> <span data-ttu-id="6f92a-117">書き込みキャッシュを使用すると、アプリはデータを保存対象と見なすことができます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-117">By using a write cache, the app can consider the data to be saved.</span></span> <span data-ttu-id="6f92a-118">実際には、データはキャッシュの待ち行列に入り、ディスクに書き込まれるのを待ちます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-118">In reality, the data is queued up in a cache, waiting to be written to disk.</span></span> <span data-ttu-id="6f92a-119">ご想像のとおり、たとえば、キャッシュされたデータが書き込まれる前にシステムがシャットダウンした場合、このメカニズムは障害点になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="6f92a-119">As you can imagine, this mechanism can be a potential point of failure, for example, if the system shuts down before the cached data is written.</span></span> <span data-ttu-id="6f92a-120">SQL Server などの一部のシステムでは、キャッシュされたデータを永続的なディスク ストレージに書き込む処理が実行されます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-120">Some systems, such as SQL Server, handle writing cached data to persistent disk storage themselves.</span></span>

### <a name="azure-disk-caching"></a><span data-ttu-id="6f92a-121">Azure のディスク キャッシュ</span><span class="sxs-lookup"><span data-stu-id="6f92a-121">Azure disk caching</span></span>

<span data-ttu-id="6f92a-122">ディスク ストレージに関するディスク キャッシュには 2 つの種類があります。</span><span class="sxs-lookup"><span data-stu-id="6f92a-122">There are two types of disk caching that concern disk storage:</span></span>

- <span data-ttu-id="6f92a-123">Azure ストレージ キャッシュ</span><span class="sxs-lookup"><span data-stu-id="6f92a-123">Azure storage caching</span></span>
- <span data-ttu-id="6f92a-124">Azure 仮想マシン ディスク (VM) キャッシュ</span><span class="sxs-lookup"><span data-stu-id="6f92a-124">Azure virtual machine (VM) disk caching</span></span>

<span data-ttu-id="6f92a-125">Azure Storage キャッシュには、Azure Blob Storage、Azure Files などの Azure 内のコンテンツ向けにキャッシュ サービスがあります。</span><span class="sxs-lookup"><span data-stu-id="6f92a-125">Azure storage caching provides cache services for Azure Blob storage, Azure Files, and other content in Azure.</span></span> <span data-ttu-id="6f92a-126">このような種類のキャッシュの構成は、このモジュールの範囲外です。</span><span class="sxs-lookup"><span data-stu-id="6f92a-126">Configuration of these types of cache is beyond the scope of this module.</span></span>

<span data-ttu-id="6f92a-127">Azure 仮想マシンのディスク キャッシュは、Azure VM に接続された仮想ハード ディスク (VHD) ファイルへの読み取りおよび書き込みアクセスを最適化するものです。</span><span class="sxs-lookup"><span data-stu-id="6f92a-127">Azure virtual machine disk caching is about optimizing read and write access to the virtual hard disk (VHD) files attached to Azure VMs.</span></span> <span data-ttu-id="6f92a-128">このモジュールではディスク キャッシュに注目します。</span><span class="sxs-lookup"><span data-stu-id="6f92a-128">We'll focus on disk caching in this module.</span></span>

### <a name="azure-virtual-machine-disk-types"></a><span data-ttu-id="6f92a-129">Azure 仮想マシン ディスクの種類</span><span class="sxs-lookup"><span data-stu-id="6f92a-129">Azure virtual machine disk types</span></span>

<span data-ttu-id="6f92a-130">Azure VM に使用されるディスクの種類は 3 つです。</span><span class="sxs-lookup"><span data-stu-id="6f92a-130">There are three types of disks used with Azure VMs:</span></span>

- <span data-ttu-id="6f92a-131">**OS ディスク**: Azure VM を作成すると、Azure によってオペレーティング システム (OS) 用の VHD が自動的にアタッチされます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-131">**OS disk**: When you create an Azure VM, Azure automatically attaches a VHD for the operating system (OS).</span></span>

- <span data-ttu-id="6f92a-132">**一時ディスク**: Azure VM を作成すると、Azure によって一時ディスクも自動的に追加されます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-132">**Temporary disk**: When you create an Azure VM, Azure also automatically adds a temporary disk.</span></span> <span data-ttu-id="6f92a-133">このディスクは、ページやスワップ ファイルなどのデータに使用されます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-133">This disk is used for data, such as page and swap files.</span></span> <span data-ttu-id="6f92a-134">このディスク上のデータは、メンテナンス時または VM の再デプロイ時に失われる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="6f92a-134">The data on this disk may be lost during maintenance, or a VM redeploy.</span></span> <span data-ttu-id="6f92a-135">そのため、永続的なデータ (データベース ファイルやトランザクション ログなど) の保存には使用しないでください。</span><span class="sxs-lookup"><span data-stu-id="6f92a-135">So, don't use it for storing permanent data, such as database files or transaction logs.</span></span>

- <span data-ttu-id="6f92a-136">**データ ディスク**: データ ディスクは仮想マシンに取り付けられる VHD であり、保存しておく必要があるアプリケーションなどのデータを格納します。</span><span class="sxs-lookup"><span data-stu-id="6f92a-136">**Data disks**: A data disk is a VHD that's attached to a virtual machine to store application data or other data you need to keep.</span></span>

<span data-ttu-id="6f92a-137">OS ディスクとデータ ディスクでは、Azure VM ディスク キャッシュが活用されます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-137">OS disks and data disks take advantage of Azure VM disk caching.</span></span> <span data-ttu-id="6f92a-138">VM ディスクのキャッシュ サイズは、VM インスタンスのサイズと、VM にマウントされているディスクの数によって変わります。</span><span class="sxs-lookup"><span data-stu-id="6f92a-138">The cache size for a VM disk depends on the VM instance size and the number of disks mounted on the VM.</span></span> <span data-ttu-id="6f92a-139">キャッシュは、最大 4 つのデータ ディスクにのみ有効にすることができます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-139">Caching can be enabled for only up to four data disks.</span></span>

## <a name="cache-options-for-azure-vms"></a><span data-ttu-id="6f92a-140">Azure VM のキャッシュ オプション</span><span class="sxs-lookup"><span data-stu-id="6f92a-140">Cache options for Azure VMs</span></span>

<span data-ttu-id="6f92a-141">VM ディスク キャッシュには 3 つの共通オプションがあります。</span><span class="sxs-lookup"><span data-stu-id="6f92a-141">There are three common options for VM disk caching:</span></span>

- <span data-ttu-id="6f92a-142">**読み取り/書き込み**: キャッシュを書き戻します。</span><span class="sxs-lookup"><span data-stu-id="6f92a-142">**Read/write** – Write-back cache.</span></span> <span data-ttu-id="6f92a-143">キャッシュ データの永続ディスクへの書き込みがアプリケーションで必要に応じて適切に処理される場合にのみ、このオプションを使用します。</span><span class="sxs-lookup"><span data-stu-id="6f92a-143">Use this option only if your application properly handles writing cached data to persistent disks when needed.</span></span>
- <span data-ttu-id="6f92a-144">**読み取り専用**: キャッシュから読み取られます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-144">**Read-only** - Reads are done from cache.</span></span>
- <span data-ttu-id="6f92a-145">**なし**: キャッシュはありません。</span><span class="sxs-lookup"><span data-stu-id="6f92a-145">**None** - No cache.</span></span> <span data-ttu-id="6f92a-146">書き込み専用で書き込み負荷の高いディスクにこのオプションを選択します。</span><span class="sxs-lookup"><span data-stu-id="6f92a-146">Select this option for write-only and write-heavy disks.</span></span> <span data-ttu-id="6f92a-147">ログ ファイルは、書き込み負荷が高い操作なので適しています。</span><span class="sxs-lookup"><span data-stu-id="6f92a-147">Log files are a good candidate because they're write-heavy operations.</span></span>

<span data-ttu-id="6f92a-148">ディスクの各種類にすべてのキャッシュ オプションを使用できるわけではありません。</span><span class="sxs-lookup"><span data-stu-id="6f92a-148">Not every caching option is available for each type of disk.</span></span> <span data-ttu-id="6f92a-149">次の表は、ディスクの各種類のキャッシュ オプションを示しています。</span><span class="sxs-lookup"><span data-stu-id="6f92a-149">The following table shows you the caching options for each disk type:</span></span>

|               | <span data-ttu-id="6f92a-150">**読み取り専用**</span><span class="sxs-lookup"><span data-stu-id="6f92a-150">**Read-only**</span></span>  | <span data-ttu-id="6f92a-151">**読み取り/書き込み**</span><span class="sxs-lookup"><span data-stu-id="6f92a-151">**Read/write**</span></span> | <span data-ttu-id="6f92a-152">**なし**</span><span class="sxs-lookup"><span data-stu-id="6f92a-152">**None**</span></span> |
|---------------|----------------|----------------|----------|
| <span data-ttu-id="6f92a-153">OS ディスク</span><span class="sxs-lookup"><span data-stu-id="6f92a-153">OS disk</span></span>       | <span data-ttu-id="6f92a-154">○</span><span class="sxs-lookup"><span data-stu-id="6f92a-154">yes</span></span>            | <span data-ttu-id="6f92a-155">○ (既定値)</span><span class="sxs-lookup"><span data-stu-id="6f92a-155">yes (default)</span></span>  | <span data-ttu-id="6f92a-156">○</span><span class="sxs-lookup"><span data-stu-id="6f92a-156">yes</span></span>      |
| <span data-ttu-id="6f92a-157">データ ディスク</span><span class="sxs-lookup"><span data-stu-id="6f92a-157">Data disk</span></span>     | <span data-ttu-id="6f92a-158">○ (既定値)</span><span class="sxs-lookup"><span data-stu-id="6f92a-158">yes (default)</span></span>  | <span data-ttu-id="6f92a-159">○</span><span class="sxs-lookup"><span data-stu-id="6f92a-159">yes</span></span>            | <span data-ttu-id="6f92a-160">○</span><span class="sxs-lookup"><span data-stu-id="6f92a-160">yes</span></span>      |
| <span data-ttu-id="6f92a-161">一時ディスク</span><span class="sxs-lookup"><span data-stu-id="6f92a-161">Temp disk</span></span>     | <span data-ttu-id="6f92a-162">×</span><span class="sxs-lookup"><span data-stu-id="6f92a-162">no</span></span>             | <span data-ttu-id="6f92a-163">×</span><span class="sxs-lookup"><span data-stu-id="6f92a-163">no</span></span>             | <span data-ttu-id="6f92a-164">×</span><span class="sxs-lookup"><span data-stu-id="6f92a-164">no</span></span>       |

> [!NOTE]
> <span data-ttu-id="6f92a-165">**L シリーズ**と **B シリーズ**の仮想マシンの場合、ディスク キャッシュを変更できません。</span><span class="sxs-lookup"><span data-stu-id="6f92a-165">Disk caching options can't be changed for **L-Series** and **B-series** virtual machines.</span></span>

## <a name="performance-considerations-for-azure-vm-disk-caching"></a><span data-ttu-id="6f92a-166">Azure VM ディスク キャッシュのパフォーマンスに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="6f92a-166">Performance considerations for Azure VM disk caching</span></span>

<span data-ttu-id="6f92a-167">キャッシュ設定は、Azure VM 上で動作するワークロードのパフォーマンスにどのように影響するでしょうか?</span><span class="sxs-lookup"><span data-stu-id="6f92a-167">So, how can your cache settings affect the performance of your workloads running on Azure VMs?</span></span>

### <a name="os-disk"></a><span data-ttu-id="6f92a-168">OS ディスク</span><span class="sxs-lookup"><span data-stu-id="6f92a-168">OS disk</span></span>

<span data-ttu-id="6f92a-169">VM OS ディスクの場合、既定の動作では、キャッシュは読み取り/書き込みモードで使用されます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-169">For a VM OS disk, the default behavior is to use the cache in read/write mode.</span></span> <span data-ttu-id="6f92a-170">OS ディスクにデータ ファイルを格納するアプリケーションがあり、アプリケーションがデータ ファイルに対するランダムな読み取り/書き込み操作を多数行う場合は、そのようなファイルをキャッシュがオフになっているデータ ディスクに移動することを検討してください。</span><span class="sxs-lookup"><span data-stu-id="6f92a-170">If you have applications that store data files on the OS disk, and the apps do lots of random read/write operations to data files, consider moving those files to a data disk that has the caching turned off.</span></span> <span data-ttu-id="6f92a-171">なぜですか?</span><span class="sxs-lookup"><span data-stu-id="6f92a-171">Why is that?</span></span> <span data-ttu-id="6f92a-172">読み取りキューに順次読み取りが含まれていない場合、キャッシュのメリットがほとんどないか、まったくないためです。</span><span class="sxs-lookup"><span data-stu-id="6f92a-172">Well, if the read queue does not contain sequential reads, caching will be of little or no benefit.</span></span> <span data-ttu-id="6f92a-173">データが順次であるかのようにキャッシュを維持するオーバーヘッドで、ディスクのパフォーマンスが低下する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="6f92a-173">The overhead of maintaining the cache, as if the data was sequential, can reduce disk performance.</span></span>

### <a name="data-disks"></a><span data-ttu-id="6f92a-174">データ ディスク</span><span class="sxs-lookup"><span data-stu-id="6f92a-174">Data disks</span></span>

<span data-ttu-id="6f92a-175">パフォーマンスの影響を受けやすいアプリケーションの場合は、OS ディスクではなくデータ ディスクを使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="6f92a-175">For performance-sensitive applications, you should use data disks rather than the OS disk.</span></span> <span data-ttu-id="6f92a-176">別のディスクを使用すると、各ディスクに適切なキャッシュ設定を構成できます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-176">Using separate disks allows you to configure the appropriate cache settings for each one.</span></span>

<span data-ttu-id="6f92a-177">たとえば、SQL Server を実行している Azure VM 上で、(通常データおよび TempDB データ用に) データ ディスク上で**読み取り専用**キャッシュを有効にすると、パフォーマンスが大幅に改善する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="6f92a-177">For example, on Azure VMs running SQL Server, enabling **Read-only** caching on the data disks (for regular and TempDB data) can result in significant performance improvements.</span></span> <span data-ttu-id="6f92a-178">一方、ログ ファイルは、キャッシュがないデータ ディスクに適しています。</span><span class="sxs-lookup"><span data-stu-id="6f92a-178">Log files, on the other hand, are good candidates for data disks with no caching.</span></span>

> [!WARNING]
> <span data-ttu-id="6f92a-179">Azure ディスクのキャッシュ設定を変更すると、対象となるディスクがデタッチされ、再アタッチされます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-179">Changing the cache setting of an Azure disk detaches and then reattaches the target disk.</span></span> <span data-ttu-id="6f92a-180">オペレーティング システム ディスクの場合は、VM が再起動されます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-180">If it's the operating system disk, the VM is restarted.</span></span> <span data-ttu-id="6f92a-181">ディスク キャッシュの設定を変更する前に、この中断の影響を受ける可能性があるすべてのアプリケーションまたはサービスを停止します。</span><span class="sxs-lookup"><span data-stu-id="6f92a-181">Stop all applications/services that might be affected by this disruption before changing the disk cache setting.</span></span>

<span data-ttu-id="6f92a-182">次のいずれかのツールを使用して、仮想マシンのディスク キャッシュ設定を構成できます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-182">You can configure virtual machine disk cache settings with any of the following tools:</span></span>

- <span data-ttu-id="6f92a-183">Azure portal</span><span class="sxs-lookup"><span data-stu-id="6f92a-183">Azure portal</span></span>
- <span data-ttu-id="6f92a-184">Azure CLI</span><span class="sxs-lookup"><span data-stu-id="6f92a-184">Azure CLI</span></span>
- <span data-ttu-id="6f92a-185">Azure PowerShell</span><span class="sxs-lookup"><span data-stu-id="6f92a-185">Azure PowerShell</span></span>
- <span data-ttu-id="6f92a-186">Resource Manager テンプレート</span><span class="sxs-lookup"><span data-stu-id="6f92a-186">Resource Manager templates</span></span>

## <a name="using-the-azure-portal-to-configure-caching"></a><span data-ttu-id="6f92a-187">Azure portal を使用してキャッシュを構成する</span><span class="sxs-lookup"><span data-stu-id="6f92a-187">Using the Azure portal to configure caching</span></span>

<span data-ttu-id="6f92a-188">Azure portal を使用して新しい VM をプロビジョニングする場合、VM がデプロイされるまで、OS ディスクの既定のキャッシュ構成を読み取り/書き込みから変更することはできません。</span><span class="sxs-lookup"><span data-stu-id="6f92a-188">When you provision a new VM using the Azure portal, you can't change the default caching configuration for the OS disk from read/write until the VM is deployed.</span></span>

<span data-ttu-id="6f92a-189">データ ディスクを既存の VM に追加する場合、ディスクを VM にデプロイする前にキャッシュ オプションを構成できます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-189">When you add a data disk to an existing VM, you can configure the cache option before the disk is deployed to the VM.</span></span>

<span data-ttu-id="6f92a-190">Azure ディスクのキャッシュ設定を変更すると、対象となるディスクをデタッチして再アタッチします。</span><span class="sxs-lookup"><span data-stu-id="6f92a-190">Changing the cache setting of an Azure disk detaches and reattaches the target disk.</span></span> <span data-ttu-id="6f92a-191">オペレーティング システム ディスクの場合は、VM が再起動されます。</span><span class="sxs-lookup"><span data-stu-id="6f92a-191">If it's the operating system disk, the VM is restarted.</span></span> <span data-ttu-id="6f92a-192">ディスク キャッシュの設定を変更する前に、この中断の影響を受ける可能性があるすべてのアプリケーションまたはサービスを停止します。</span><span class="sxs-lookup"><span data-stu-id="6f92a-192">Stop all applications/services that might be affected by this disruption before changing the disk cache setting.</span></span>

<span data-ttu-id="6f92a-193">Azure portal を使用して VM を作成し、キャッシュ設定を変更してみましょう。</span><span class="sxs-lookup"><span data-stu-id="6f92a-193">Let's create a VM and change the cache settings using the Azure portal.</span></span>
