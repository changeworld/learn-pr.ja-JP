高可用性 (HA) により、アーキテクチャによって障害に確実に対処することができます。 常に完全な動作状態になければならないシステムを担当しているとします。 障害はいつか発生する可能性があります。したがって、何か問題が発生しても、システムが確実にオンライン状態に維持されるようにするにはどうすればよいでしょうか。 サービスを中断せずにメンテナンスを実行するにはどうすればよいでしょうか。 

ここでは、高可用性の必要性を学習し、アプリケーションの高可用性の要件を評価し、可用性の目標を達成するために Azure プラットフォームがどのように役立つかを確認します。

## <a name="what-is-high-availability"></a>高可用性とは

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE2yEvc]

高可用性サービスは、依存型のサービスおよびハードウェアでの可用性および負荷の変動と、一時的な障害を緩和するサービスです。 アプリケーションは良好なパフォーマンスで動作しながら、オンラインのまま利用可能な状態 (またはその外観) が維持されます。 この可用性は、多くの場合、ビジネス要件、サービス レベル目標、またはサービス レベル アグリーメントによって定義されます。

高可用性は、最終的には、システムのコンポーネントの損失または大幅なパフォーマンス低下に対処する機能に関するものです。 このような状況になる原因としては、ホストで障害が発生したためにアプリケーションをホストしている仮想マシンがオフラインになることが考えられます。 システム アップグレードのための計画メンテナンスが原因となる可能性があります。 クラウド内でのサービスの障害によって発生する場合もあります。 システムで障害が発生していると考えられる場所を特定し、それらの障害に対処する機能を組み込むことで、顧客に提供しているサービスが確実にオンラインに維持されるようにすることができます。

通常、サービスの高可用性を実現するには、サービスを構成するコンポーネントの高可用性が必要です。 アイテムを購入するためのオンライン マーケットプレースを提供する Web サイトについて考えてみましょう。 顧客に提供しているサービスには、アイテムをオンラインで一覧表示、購入、および販売する機能が用意されています。 このサービスを提供するために、データベース、Web サーバー、アプリケーション サーバーなど複数のコンポーネントを備えることになります。 このような各コンポーネントでは障害が発生する可能性があるため、障害点がどこにどのように存在するかを識別し、アーキテクチャ内でそれらの障害点に対処する方法を決める必要があります。

## <a name="evaluate-high-availability-for-your-architecture"></a>自分のアーキテクチャの高可用性を評価する

アプリケーションの高可用性を評価するには 3 つの手順があります。

1. ご利用のアプリケーションのサービス レベル アグリーメントを特定する
1. アプリケーションの HA 機能を評価する
1. 依存するアプリケーションの HA 機能を評価する

これらの手順を詳しく見ていきましょう。

### <a name="determine-the-service-level-agreement-of-your-application"></a>ご利用のアプリケーションのサービス レベル アグリーメントを特定する

サービス レベル アグリーメント (SLA) は、サービス プロバイダーとサービス コンシューマーとの間で結ばれる契約であり、その中でサービス プロバイダーは、測定可能なメトリックと定義された責任に基づいてサービスの標準をコミットします。 SLA は、法律に従った厳密な契約上の合意であり、顧客による可用性の期待とみなすことができます。 サービスのメトリックでは、通常、サービスのスループット、容量、および可用性に重点が置かれ、そのすべてをさまざまな方法で測定することができます。 SLA を構成する特定のメトリックに関係なく、SLA を達成する過程で発生する障害は、サービス プロバイダーに対して財務的に深刻な影響を与えます。 サービス契約の一般的なコンポーネントでは、SLA が達成されなかった場合、財務的な払戻しが保証されます。

サービス レベル目標 (SLO) は、パフォーマンス、信頼性、または可用性の測定に使用されるターゲット メトリックの値です。 これらは、要求処理のパフォーマンス (ミリ秒)、1 月あたりのサービスの可用性 (分)、または処理された 1 時間あたりの要求の数を定義するメトリックの場合もあります。 アプリケーションによって公開されたメトリックを評価し、顧客が品質の指標として使用しているものを理解することで、これらの SLO の許容できる範囲と許容できない範囲を定義できます。 これらの目標を定義することで、サービスをサポートするチームと、これらのサービスを利用する顧客の両方に対して、目標と期待を明確に設定します。 これらの SLO は、SLA 全体が満たされているかどうかを判断するために使用されます。

次の表は、さまざまな SLA レベルで考えられる累積的なダウンタイムの一覧です。 

| SLA | 週あたりのダウンタイム | 月あたりのダウンタイム | 年あたりのダウンタイム |
| --- | --- | --- | --- |
| 99% |1.68 時間 |7.2 時間 |3.65 日 |
| 99.9% |10.1 分 |43.2 分 |8.76 時間 |
| 99.95% |5 分 |21.6 分 |4.38 時間 |
| 99.99% |1.01 分 |4.32 分 |52.56 分 |
| 99.999% |6 秒 |25.9 秒 |5.26 分 |

当然ながら高可用性が望ましく、他の項目は同じくらいです。 ただし、99.99...% の 9 の桁数を増やすにつれて、そのレベルの可用性を実現するためのコストと複雑さは増大します。 99.99% のアップタイムは、月あたりの合計ダウンタイムの約 5 分に換算されます。 5 つの 9 (99.999%) を実現するために、複雑さとコストが増大する価値はありますか。 その答えはビジネス要件によって変わります。 

SLA を定義する場合の他の考慮事項を次に示します。

* 4 つの 9 (99.99%) を実現するには、手動操作による障害からの復旧には依存できません。 アプリケーションには自己診断機能と自己復旧機能が必要です。 
* 4 つの 9 を超えると、SLA を満たすことができるほど迅速に障害を検出することは困難です。
* SLA を測定する時間枠について考慮します。 この時間枠を短くするほど、許容度は厳格になります。 時間単位または日単位のアップタイムという観点で SLA を定義することはおそらく意味がありません。 

ご自分のアーキテクチャで必要となる高可用性機能を決める場合は、SLA を明らかにすることが重要な第一ステップとなります。 これらの機能は、ご利用のアプリケーションを高可用性にするために使用する手法を形成するのに役立ちます。

### <a name="evaluate-the-ha-capabilities-of-the-application"></a>アプリケーションの HA 機能を評価する

使用するアプリケーションの HA 機能を評価するには、障害解析を実行します。 重点を置くのは、単一障害と重要なコンポーネント (これらに到達不可能な場合、構成が正しくない場合、または予期しない動作を開始した場合にアプリケーションに大きな影響を与える) です。 冗長性がある領域については、アプリケーションがエラー状態を検出して、自己復旧できるかどうかを判断します。

ご利用のアプリケーションのすべてのコンポーネントについて、慎重に評価する必要があります。たとえば、ロード バランサーなどの HA 機能を提供するように設計されている部分があります。 単一障害点は、HA 機能を統合するように変更するか、または HA 機能を提供できるサービスに置換する必要があります。

### <a name="evaluate-the-ha-capabilities-of-dependent-applications"></a>依存するアプリケーションの HA 機能を評価する

コンシューマーに対するご利用のアプリケーションの SLA 要件だけでなく、ご利用のアプリケーションが依存する場合がある任意のリソースの指定された SLA も理解する必要があります。 顧客に対して 99.9% のアップタイムをコミットしているが、ご利用のアプリケーションが依存しているサービスのアップタイム コミットメントが 99% しかない場合、顧客に対して SLA を満足できないリスクが発生する可能性があります。 依存サービスによって十分な SLA を提供することができない場合は、独自の SLA を変更するか、依存関係を別のものに置換するか、または依存関係が利用できない間に SLA を満たす方法を見つけることが必要な場合があります。 シナリオとの依存関係の性質によっては、キャッシュや作業キューなどのソリューションを使用して、失敗した依存関係を一時的に回避することができます。

## <a name="azures-highly-available-platform"></a>Azure の可用性の高いプラットフォーム

Azure クラウド プラットフォームは、そのすべてのサービスを通して高可用性を実現できるように設計されています。 システムの場合と同様に、アプリケーションもハードウェアとソフトウェアの両方のプラットフォーム イベントの影響を受ける場合があります。 障害に対処できるようにアプリケーション アーキテクチャを設計することの必要性は重要です。Azure クラウド プラットフォームには、アプリケーションの可用性を高めるためのツールおよび機能が用意されています。 Azure 上でご利用のアーキテクチャに HA を検討する場合は、いくつかの主要な概念を把握しておく必要があります。

* 可用性セット
* 可用性ゾーン
* 負荷分散
* サービスとしてのプラットフォーム (PaaS) HA 機能

### <a name="availability-sets"></a>可用性セット

可用性セットは、同じアプリケーション ワークロードに属する VM を分散することでハードウェア障害および予定メンテナンスから同時に影響を受けるのを防ぐ必要があることを Azure に通知する方法です。 可用性セットは、*更新ドメイン*と*障害ドメイン*で構成されています。

![3 つの可用性セットを示す図。 最初のセットには 1 つの更新ドメイン、2 番目のセットには 2 つの更新ドメイン、および 3 番目のセットには更新ドメインは含まれていません。](../media/AzAvailSets.png)

Azure データ センター内の仮想マシン ホストがメンテナンスのためにダウンタイムを必要とする場合でも、更新ドメインにより、ご利用のアプリケーションのサブセットは常に実行状態を確実に維持します。 ほとんどの更新プログラムは、それらに対して稼働している VM に影響を及ぼさずに実行することができますが、このことが不可能な場合があります。 更新プログラムがデータ センターに対して一度に実行されないようにするために、Azure データ センターは論理的に更新ドメイン (UD) に区分されています。 パフォーマンス更新プログラムやホストに適用する必要がある重要なセキュリティ パッチなどのメンテナンス イベントが発生した場合、更新プログラムは更新ドメインを経由してシーケンス処理されます。 更新ドメインを使用して更新プログラムをシーケンス処理することにより、プラットフォームの更新中およびパッチ適用中もデータセンター全体が利用不可能になることはありません。

更新ドメインがデータ センターの論理セクションを表す一方で、障害ドメイン (FD) はデータ センターの物理的なセクションを表し、これにより可用性セット内でのサーバーのラック多様性が確保されます。 障害ドメインは、データ センター内の共有ハードウェアの物理的な分離に合わせて整列されます。 これには、サーバー ラック内に設置された物理サーバーをサポートする電源、冷却装置、およびネットワーク ハードウェアが含まれます。 サーバー ラックをサポートするハードウェアが利用できなくなった場合は、そのサーバー ラックのみが障害の影響を受けます。 VM を可用性セット内に配置することで、ハードウェア障害が発生した場合に、一部の VM しか影響を受けないように、VM が複数の FD に自動的に分散されます。

可用性セットを使用すると、影響の大きいメンテナンス イベントが必要とされる場合やハードウェア障害が発生した場合でも、ご利用のアプリケーションがオンライン状態で確実に維持されるようにすることができます。

### <a name="availability-zones"></a>可用性ゾーン

可用性ゾーンは、独自の電源、冷却装置、およびネットワークを備えた、リージョン内にある独立した物理的なデータ センターの場所です。 リソースをデプロイする際に可用性ゾーンを考慮に入れることにより、特定のリージョンでのプレゼンスを維持しながら、データ センターの障害からワークロードを保護することができます。 仮想マシンのようなサービスは、*ゾーン サービス*です。これらは、リージョン内の特定のゾーンにデプロイすることができます。 他のサービスは*ゾーン冗長サービス*であり、特定の Azure リージョン内の複数の可用性ゾーンにわたってレプリケートされます。 両方の種類のサービスにより、Azure リージョン内では単一障害点が発生することはありません。

![Azure リージョン内の 3 つの可用性ゾーンを示す図。 各可用性ゾーンには、独自のリソースのセットがあり、ゾーン冗長サービスのレプリケーションのために相互接続されています。](../media/AzAvailZones.png)

サポートされているリージョンには、最低でも 3 つの可用性ゾーンが含まれています。 それらのリージョン内にゾーン サービス リソースを作成する場合は、リソースを作成する必要があるゾーンを選択することができます。 これにより、アプリケーションを別の Azure リージョンに退避させなくても済むように、ゾーンの障害に耐え、Azure リージョン内で引き続き動作可能なようにアプリケーションを設計することができます。

可用性ゾーンは、Azure リージョン向けのより新しい高可用性構成サービスであり、現時点では特定のリージョンで使用することができます。 この機能を検討する場合は、アプリケーションのデプロイ先に予定しているリージョン内で、このサービスの可用性を確認することが重要です。 可用性ゾーンは、仮想マシンを使用する場合のほか、いくつかの PaaS サービスを使用する場合もサポートされます。 可用性ゾーンは、可用性セットと相互に排他的です。 可用性ゾーンを使用する場合は、システムに可用性セットを定義する必要がなくなります。 データ センター レベルで多様性がもたらされ、複数の可用性ゾーンに対して更新プログラムが同時に実行されることがなくなります。

### <a name="load-balancing"></a>負荷分散

ロード バランサーでは、ネットワーク トラフィックをアプリケーション全体に分散する方法が管理されます。 ロード バランサーは、個々のコンポーネントでの障害に対するご利用のアプリケーションの回復力を維持する上で、また要求の処理でご利用のアプリケーションを確実に使用できるようにする上で不可欠です。 サービス検出が組み込まれていないアプリケーションの場合は、可用性セットと可用性ゾーンの両方に対して負荷分散が必要です。

Azure には 3 つの負荷分散テクノロジ サービスがあります。これらは、ネットワーク トラフィックをルーティングする機能で区別されます。

* **Azure Traffic Manager** は、グローバルな DNS 負荷分散機能を備えています。 Traffic Manager を使用して Azure リージョン内または Azure リージョン間での DNS エンドポイントの負荷分散を行うことを検討します。 Traffic Manager は、使用可能なエンドポイントに要求を分散し、エンドポイントの監視を使用して障害を起こしているエンドポイントを検出し、負荷から削除します。
* **Azure Application Gateway** では、着信トラフィックのラウンド ロビン分散、Cookie ベースのセッション アフィニティ、URL パス ベースのルーティング、および単一のアプリケーション ゲートウェイの背後で複数の Web サイトをホストする機能など、レイヤー 7 の負荷分散機能が用意されています。 既定では、Application Gateway はバック エンド プールにあるすべてのリソースの状態を監視して、異常とみなしたリソースをプールから自動的に削除します。 Application Gateway は異常なインスタンスを継続的に監視し、このインスタンスが利用可能になり正常性プローブに応答するようになると、正常バック エンド プールに戻します。
* **Azure Load Balancer** は、レイヤー 4 のロード バランサーです。 負荷分散されるパブリックおよび内部のエンドポイントを構成したり、TCP を使用して受信接続をバックエンド プールの送信先にマッピングする規則や、サービスの可用性を管理するための HTTP の正常性プローブ オプションを定義したりできます。

この 3 つの Azure 負荷分散テクノロジのいずれか 1 つまたは 3 つすべての組み合わせにより、ご利用のアプリケーションを介してネットワーク トラフィックをルーティングする高可用性のソリューションを構築する場合に必要なオプションを確実に利用できるようにすることができます。

![Azure 負荷分散オプション。Azureのさまざまな負荷分散テクノロジを示す図。 トラフィック マネージャーは、2 つのリージョン間の負荷を分散します。 各リージョンには、要求の種類に基づいて Web 層のさまざまな仮想マシン間で負荷を分散するアプリケーション ゲートウェイがあります。 すべてのイメージ要求はイメージ サーバー プールに送られ、他の要求はデフォルト サーバー プールに送られます。 デフォルトのサーバー プールからの以降の要求は、Azure Load Balancer によって処理され、データベース層の仮想マシンに分散されます。](../media/AzLBOptions.png)

### <a name="paas-ha-capabilities"></a>PaaS HA 機能

高可用性が組み込まれた PaaS サービス。 Azure SQL Database、Azure App Service、および Azure Service Bus などのサービスには、高可用性機能が含まれています。これにより、サービスの個々のコンポーネントの障害は、アプリケーションに対して確実にシームレスになります。 PaaS サービスを使用することは、ご利用のアーキテクチャが確実に高可用性になるようにするための最善の方法の 1 つです。

高可用性のための設計を行う場合は、顧客にコミットする SLA を理解することが必要です。 ご利用のアプリケーションで用意されている HA 機能と、依存システムの HA 機能および SLA をいずれも評価します。 それらが確定されたら、可用性セット、可用性ゾーン、およびさまざまな負荷分散テクノロジを使用して、ご利用のアプリケーションに HA 機能を追加します。 任意の PaaS サービスを使用するように選択すると、HA 機能が組み込まれます。
