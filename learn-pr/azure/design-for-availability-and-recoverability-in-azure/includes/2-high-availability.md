高可用性 (HA) では、アーキテクチャによって障害に確実に対処することができます。 自分が完全に動作を常にする必要があるシステムの責任を想像してください。 障害はいつか発生する可能性があります。したがって、何か問題が発生しても、システムが確実にオンライン状態に維持されるようにするにはどうすればよいでしょうか。 メンテナンス イベントの処理方法 

ここでは、高可用性の必要性を説明し、アプリケーションの高可用性の要件を評価し、さらに設定した可用性の目標を満たすソリューションに、Azure プラットフォームによって対応し、それを実現する方法について説明します。

## <a name="what-is-high-availability"></a>高可用性とは

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE2yEvc]

高可用性サービスは、可用性、負荷、および一時的な障害をサービスとハードウェアの変動を吸収するサービスです。 アプリケーションは良好なパフォーマンスで動作しながら、オンラインのまま利用可能な状態 (またはその外観) が維持されます。 この可用性は多くの場合、ビジネス要件やサービス レベル目標では、サービス レベル アグリーメントで定義されています。

高可用性は、最終的には、システムのコンポーネントの損失または大幅なパフォーマンス低下に対処する機能に関するものです。 仮想マシン、ホストが失敗したため、オフラインにしてアプリケーションをホストしている可能性があります。 システム アップグレードのための計画メンテナンスが原因となる可能性があります。 クラウド内でのサービスの障害によって発生する場合もあります。 システムで障害が発生していると考えられる場所を特定し、それらの障害に対処する機能を組み込むことで、顧客に提供しているサービスが確実にオンラインに維持されるようにすることができます。

通常、サービスの高可用性を実現するには、サービスを構成するコンポーネントの高可用性が必要です。 アイテムを購入のオンライン マーケットプ レースを提供する web サイトと考えてください。 お客様に提供されるサービスを一覧表示、購入、およびオンライン アイテムを販売する機能があります。 このサービスを提供するために、データベース、Web サーバー、アプリケーション サーバーなど複数のコンポーネントを備えることになります。 アーキテクチャでこれらの障害点に対処する方法を決定し、障害点と方法を確認する必要があるため、失敗の各コンポーネントでした。

## <a name="evaluate-high-availability-for-your-architecture"></a>ご利用のアーキテクチャの高可用性を評価する

アプリケーションの高可用性を評価するには 3 つの手順があります。 

1. ご利用のアプリケーションのサービス レベル アグリーメントを特定する
1. アプリケーションの HA 機能を評価する
1. 依存するアプリケーションの HA 機能を評価する

これらの手順を詳しく見ていきましょう。

### <a name="determine-the-service-level-agreement-of-your-application"></a>ご利用のアプリケーションのサービス レベル アグリーメントを特定する

サービス レベル アグリーメント (SLA) は、サービス プロバイダーとサービス コンシューマーとの間で結ばれる契約であり、その中でサービス プロバイダーは、測定可能なメトリックと定義された責任に基づいてサービスの標準をコミットします。 SLA は、法律に従った厳密な契約上の合意であり、顧客による可用性の期待と見なすことができます。 サービスのメトリックでは、通常、サービスのスループット、容量、および可用性に重点が置かれ、そのすべてをさまざまな方法で測定することができます。 SLA を構成する特定のメトリックに関係なく、SLA を達成できないということは、サービス プロバイダーに対して財務的に深刻な影響を与えます。 サービス契約の一般的なコンポーネントでは、SLA が達成されなかった場合、財務的な払戻しが保証されます。

サービス レベル目標 (SLO) は、パフォーマンス、信頼性、可用性の測定に使用されるターゲット メトリックの値です。 これらは、要求の処理 (ミリ秒)/月、数分でサービスの可用性や 1 時間ごとに処理された要求の数のパフォーマンスを定義するメトリックで可能性があります。 アプリケーションと理解の品質の指標として使用して、どのような顧客によって公開されるメトリックを評価するには、これらの Slo の許容可能および許容範囲を定義できます。 これらの目標を定義すると、明確に設定する目標や予想サービスとこれらのサービスを使用しているお客様をサポートしている、両方のチームとします。 全体的な SLA が満たされているかどうかを決定する、これらの Slo が使用されます。

次の表は、さまざまな SLA レベルで考えられる累積的なダウンタイムの一覧です。 

| SLA | 週あたりのダウンタイム | 月あたりのダウンタイム | 年あたりのダウンタイム |
| --- | --- | --- | --- |
| 99% |1.68 時間 |7.2 時間 |3.65 日 |
| 99.9% |10.1 分 |43.2 分 |8.76 時間 |
| 99.95% |5 分 |21.6 分 |4.38 時間 |
| 99.99% |1.01 分 |4.32 分 |52.56 分 |
| 99.999% |6 秒 |25.9 秒 |5.26 分 |

当然ながら高可用性が望ましく、他の項目は同じくらいです。 ただし、99.99...% の 9 の桁数を増やすにつれて、そのレベルの可用性を実現するためのコストと複雑さは増大します。 99.99% のアップタイムは、月あたりの合計ダウンタイムの約 5 分に換算されます。 5 つの 9 (99.999%) を実現するために、複雑さとコストが増大する価値はありますか。 その答えはビジネス要件によって変わります。 

SLA を定義する場合の他の考慮事項を次に示します。

* 4 つの 9 (99.99%) を実現するには、手動操作による障害からの復旧には依存できません。 アプリケーションには自己診断機能と自己復旧機能が必要です。 
* 4 つの 9 を超えると、SLA を満たすことができるほど迅速に障害を検出することは困難です。
* SLA を測定する時間枠について考慮します。 この時間枠を短くするほど、許容度は厳格になります。 時間単位または日単位のアップタイムという観点で SLA を定義することはおそらく意味がありません。 

重要な最初の手順は、アーキテクチャを必要とする高可用性機能を決定するときに Sla を識別します。 これらの機能は、ご利用のアプリケーションの可用性を高めるために使用する手法を形成するのに役立ちます。

### <a name="evaluate-the-ha-capabilities-of-the-application"></a>アプリケーションの HA 機能を評価する

使用するアプリケーションの HA 機能を評価するには、障害解析を実行します。 重点を置くのは、単一障害と重要なコンポーネント (これらに到達不可能な場合、構成が正しくない場合、または予期しない動作を開始した場合にアプリケーションに大きな影響を与える) です。 冗長性がある領域については、アプリケーションがエラー状態を検出して、自己復旧できるかどうかを判断します。

ご利用のアプリケーションのすべてのコンポーネントについて、慎重に評価する必要があります。たとえば、ロード バランサーなどの HA 機能を提供するように設計されている部分があります。 単一障害点は、HA 機能を統合するように変更するか、または HA 機能を提供できるサービスに置換する必要があります。

### <a name="evaluate-the-ha-capabilities-of-dependent-applications"></a>依存するアプリケーションの HA 機能を評価する

コンシューマーもに、アプリケーションが依存する任意のリソースの指定された Sla だけでなく、アプリケーションの SLA の要件を理解する必要があります。 アップタイム 99.9% の顧客にコミットする場合は、アプリケーションが依存サービスにしかの 99% の稼働時間コミットメントは、お客様に SLA を満たしていないのは危険にこれをでした。 依存サービスによって十分な SLA を提供することができない場合は、独自の SLA を変更するか、依存関係を別のものに置換するか、または依存関係が利用できない間に SLA を満たす方法を見つけることが必要な場合があります。 シナリオとの依存関係の性質によっては、キャッシュや作業キューなどのソリューションを使用して、失敗した依存関係を一時的に回避することができます。

## <a name="azures-highly-available-platform"></a>Azure の可用性の高いプラットフォーム

Azure クラウド プラットフォームは、そのすべてのサービスを通して高可用性を実現できるように設計されています。 システムの場合と同様に、アプリケーションもハードウェアとソフトウェアの両方のプラットフォーム イベントの影響を受ける場合があります。 エラーを処理するアプリケーションのアーキテクチャを設計する必要が重要と、Azure クラウド プラットフォームを提供するツールとアプリケーションの高可用性を確保する機能を使用します。 Azure 上でご利用のアーキテクチャ用の HA を検討する場合は、いくつかの主要な概念を把握しておく必要があります。

* 可用性セット
* 可用性ゾーン
* 負荷分散
* サービス (PaaS) の HA 機能としてのプラットフォーム

### <a name="availability-sets"></a>可用性セット

可用性セットは、同じアプリケーション ワークロードに属する VM を分散させることでハードウェア障害および予定メンテナンスから同時に影響を受けるのを防ぐ必要があることを Azure に通知する方法です。 可用性セットは、*更新ドメイン*と*障害ドメイン*で構成されています。

![可用性セット](../media/AzAvailSets.png)

Azure データ センター内の仮想マシン ホストがメンテナンスのためにダウンタイムを必要とする場合でも、更新ドメインにより、ご利用のアプリケーションのサーバーのサブセットは常に実行状態を確実に維持します。 上で実行するには、Vm に影響を及ぼさずに更新プログラムのほとんどを実行できますが、これが不可能な場合があります。 更新プログラムがデータ センター全体を一度に発生しないように、Azure データ センターが論理的に単位で区分更新ドメイン (UD)。 パフォーマンスの更新プログラムや、ホストに適用する必要がある重要なセキュリティ修正プログラムなどのメンテナンス イベント時に、更新プログラムは更新ドメインをシーケンス処理します。 更新ドメインを使用して更新プログラムをシーケンス処理の使用により、プラットフォームの更新中に利用不可と修正プログラムの適用、データ センター全体ではないこと。

更新ドメインは、データ センターの論理セクションを表す、中に、障害ドメイン (FD) は、データ センターの物理的なセクションを表すし、可用性セット内のサーバーのラックの多様性を確認します。 障害ドメインは、データ センターで共有ハードウェアの物理的な分離に揃えます。 これには、サーバー ラック内に設置された物理サーバーをサポートする電源、冷却装置、およびネットワーク ハードウェアが含まれます。 サーバー ラックをサポートするハードウェアが利用できなくなった場合は、そのサーバー ラックのみが停止の影響を受けます。 可用性セットの Vm を配置すると、Vm が自動的に分散される複数の障害ドメイン、ハードウェア障害が発生した場合、Vm の一部のみが影響を受けるようにします。

可用性セットを使用すると、影響の大きいメンテナンス イベントが必要とされる場合やハードウェア障害が発生した場合でも、ご利用のアプリケーションがオンライン状態で確実に維持されるようにすることができます。

### <a name="availability-zones"></a>可用性ゾーン

可用性ゾーンは、独自の電源、冷却装置、およびネットワークを備えた、リージョン内にある独立した物理的なデータ センター場所です。 リソースをデプロイする際に可用性ゾーンを考慮に入れることにより、特定のリージョンでのプレゼンスを維持しながら、データ センターの停止からワークロードを保護することができます。 仮想マシンのようなサービスは、*ゾーン サービス*です。これらは、リージョン内の特定のゾーンにデプロイすることができます。 他のサービスは*ゾーン冗長サービス*であり、特定の Azure リージョン内の複数の可用性ゾーンにわたってレプリケートされます。 両方の種類のサービスにより、Azure リージョン内では単一障害点が発生することはありません。

![可用性ゾーン](../media/AzAvailZones.png)

サポートされているリージョンには、最低でも 3 つの可用性ゾーンが含まれています。 これらのリージョンでゾーン ベースのサービス リソースを作成するときに、リソースを作成するゾーンを選択する権限が必要があります。 これにより、アプリケーションを別の Azure リージョンに退避させなくても済むように、ゾーンの停止に耐え、Azure リージョン内で引き続き動作可能なようにアプリケーションを設計することができます。

可用性ゾーンは、Azure リージョン向けのより新しい高可用性構成サービスであり、現時点では特定のリージョンで使用することができます。 この機能を検討する場合は、アプリケーションをデプロイすることを計画しているリージョンでは、このサービスの可用性を確認する重要です。 可用性ゾーンは、仮想マシンを使用する場合のほか、いくつかの PaaS サービスを使用する場合もサポートされます。 可用性ゾーンは、可用性セットで相互に排他的です。 可用性ゾーンを使用する場合は、システムの可用性セットを定義する必要がなくなります。 データ センター レベルでは、多様性を必要があり、同時に、更新プログラムが複数の可用性ゾーンに実行されません。

### <a name="load-balancing"></a>負荷分散

ロード バランサーでは、ネットワーク トラフィックをアプリケーション全体に分散する方法が管理されます。 ロード バランサーは、個々 のコンポーネントのエラーと、アプリケーションが要求の処理に使用できるようにアプリケーションを回復力のある状態に保つに不可欠です。 サービスの検出が組み込まれていないアプリケーションの場合は、負荷分散は、可用性セットと可用性ゾーンの両方の必要があります。

Azure には 3 つの負荷分散テクノロジ サービスがあります。これらは、ネットワーク トラフィックをルーティングする機能で区別されます。

* **Azure Traffic Manager** は、グローバルな DNS 負荷分散機能を備えています。 Traffic Manager を使用して Azure リージョン内または Azure リージョン間での DNS エンドポイントの負荷分散を行うことを検討します。
* **Azure Application Gateway**ラウンド ロビン分散の受信トラフィック、cookie ベースのセッション アフィニティ、URL パスベースのルーティング、および 1 つの背後にある複数の web サイトをホストする機能など、レイヤー 7 負荷分散機能を提供します。アプリケーション ゲートウェイです。
* **Azure Load Balancer** は、レイヤー 4 のロード バランサーです。 負荷分散されるパブリックおよび内部のエンドポイントを構成したり、TCP を使用して受信接続をバックエンド プールの送信先にマッピングする規則や、サービスの可用性を管理するための HTTP の正常性プローブ オプションを定義したりできます。

1 つまたはすべて次の 3 つの Azure 負荷分散テクノロジの組み合わせは、アプリケーションを使ってネットワーク トラフィックをルーティングする高可用性ソリューションを構築するために必要な選択肢があることを確認できます。

![Azure 負荷分散のオプション](../media/AzLBOptions.png)

### <a name="paas-ha-capabilities"></a>PaaS HA 機能

高可用性が組み込まれた PaaS サービス。 Azure SQL Database、Azure App Service では、Azure Service Bus などのサービスの高可用性機能が含まれて、サービスの個々 のコンポーネントの障害をアプリケーションにシームレスになることを確認してください。 PaaS サービスを使用することは、ご利用のアーキテクチャの可用性を確実に高めるための最善の方法の 1 つです。

高可用性のための設計時に、お客様にコミットすることが SLA を理解する必要あります。 アプリケーションが所有する HA 機能と HA 機能と依存システムの Sla を評価します。 ものが確立された後は、可用性セット、可用性ゾーンでは、さまざまな負荷分散テクノロジなどの Azure の機能を使用して、HA 機能をアプリケーションに追加します。 任意の PaaS サービスを使用するように選択すると、HA 機能が組み込まれます。
