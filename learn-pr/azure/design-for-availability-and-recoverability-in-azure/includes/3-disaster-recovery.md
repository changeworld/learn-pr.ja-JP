高可用性のための設計は、好ましくないイベントや悪条件にもかかわらずアプリケーションまたはプロセスの稼働を継続するために役立ちます。 しかし、何らかの重大事象が発生してデータが失われ、アプリやプロセスがダウンすることを回避できない場合はどうしますか? 災害に見舞われたときに必要なのはプランです。 目標や予想されるか、回復するコストと、プランの制限事項とその上で実行する方法を把握する必要があります。

## <a name="what-is-disaster-recovery"></a>ディザスター リカバリーとは

ディザスター リカバリーは*影響の大きいイベントから復旧*ダウンタイムと損失やデータが発生します。 災害は、高可用性のためのアプリケーション設計によって軽減できる範囲をはるかに超えた長期的な影響を生じさせる単一の大きなイベントです。

「障害」は多くの場合の考えを想起*自然*災害と外部イベント (地震、洪水、古代ストーム、およびなど) が、災害の他の多くの種類にも存在します。 デプロイまたはアップグレードの致命的な失敗によって、アプリが認識不能な状態に陥る可能性があります。 悪意のあるハッカーは、暗号化またはデータを削除してアプリをオフラインにするか、その機能の一部を排除する他の種類の損害を与えることができます。

その原因にかかわらず、いったん発生した災害に対する唯一の対処法は、明確に定義されていてテスト済みのディザスター リカバリー プランと、その設計を通じてディザスター リカバリーの取り組みを積極的にサポートするアプリケーションです。

## <a name="how-to-create-a-disaster-recovery-plan"></a>ディザスター リカバリー プランの作成方法

ディザスター リカバリー計画は、データが失われると、障害によって発生するダウンタイムから回復するために必要な手順の詳細を示す 1 つのドキュメントし、それらの手順を指示する責任はだれを識別します。 オペレーターは、災害発生後にアプリケーションの接続を復元してデータを復旧するためのマニュアルとしてこのプランを使用できる必要があります。 詳細な記述のプラン専用のディザスター リカバリーでは、有利な結果を確保するのには重要です。 プランを作成するプロセスは、アプリケーションの全体像をアセンブルするのに役立ちます。 結果として得られる手順は、障害イベントのパニック、混沌強力で、適切な意思決定およびいたらないを昇格します。

ディザスター リカバリー プランの作成には、アプリケーションのワークフロー、データ、インフラストラクチャ、および依存関係に関する専門知識が必要です。

### <a name="risk-assessment-and-process-inventory"></a>リスク評価とプロセス インベントリ

ディザスター リカバリー プラン作成の最初のステップは、さまざまな種類の災害がアプリケーションに及ぼす影響を調べるリスク分析の実行です。 リスク分析にとっては、災害の性質そのものよりも、データ損失やアプリケーションのダウンタイムという形で現れる災害の潜在的な影響のほうが重要です。 さまざまな種類の仮想的な災害を調べ、その影響について考えるときに特定するようにしてください。 たとえば、悪意のある攻撃対象となるには、コードまたは別の種類のネットワーク接続とデータ センターの可用性を中断する地震より影響になるデータを変更できます。

リスク評価では、際限のないダウンタイムが許されない*すべての*プロセスと、際限のない損失が許されないすべてのデータ カテゴリを検討する必要があります。 複数のアプリケーション コンポーネントに影響を及ぼす災害が発生したときに、プランの所有者がそのプランを使用して、注意が必要な事項、および各項目の優先順位を決める方法の完全なインベントリを実行できることが重要です。

一部のアプリは、単一のプロセスまたはデータ分類を構成するだけの場合があります。 アプリケーションは、組織の複数のアプリケーションを含むより大規模なディザスター リカバリー プランの構成要素の 1 つになる可能性が高いため、これはやはり重要な注意点です。

### <a name="recovery-objectives"></a>復旧目標

完全なプランでは、アプリケーションによって実装されるプロセスごとに、2 つの重要なビジネス要件を指定する必要があります。

* **目標復旧時点 (RPO)**: 許容されるデータ損失の最大継続時間。 RPO はボリュームではなく時間単位で測定されます:「30 分間のデータ」、「データの 4 つの時間」など。 RPO はデータの*損失*の限定および復旧に関連した概念であり、データの*盗難*には関連しません。
* **目標復旧時間 (RTO)**: 許容されるダウンタイムの最大継続時間。「ダウンタイム」は仕様によって定義する必要があります。 たとえば、許容されるダウンタイム期間が 8 時間、災害が発生した場合は 8 時間は、RPO に。

![RTO と RPO](../media/rto-rpo.png)

各メジャーのプロセスまたはアプリケーションによって実装されているワークロードには、RPO と RTO の個別の値がある場合があります。 異なるプロセスに対して値が同じになったとしても、それぞれの値は、災害シナリオのリスクと潜在的な復旧戦略をプロセスごとに精査する個別の分析に基づいて算出されたものである必要があります。

RPO と RTO を指定するプロセスによって、アプリケーションのディザスター リカバリー要件が実質的に作成されます。 これは、各ワークロードの優先度とカテゴリのデータを確立して、費用便益分析を実行する必要があります。 分析には、実装、および保守のコスト、運用費が、プロセス オーバーヘッド、パフォーマンスに与える影響、およびダウンタイムとデータ損失の影響などの問題が含まれています。 場合によっては、さまざまなレベルの機能に対して、複数の RPO および RTO の値を確立することし、正確にどのような「ダウンタイム」は、アプリケーションのことを意味を定義する必要があります。 RPO と RTO の指定は、単に任意の値を選べばよいというものではありません。 ディザスター リカバリー プランの価値の多くは、災害の潜在的な影響やリスク軽減のコストの算定にまで踏み入った調査と分析から生み出されます。

### <a name="detailing-recovery-steps"></a>復旧手順の詳述

最終的なプランでは、失われたデータやアプリケーションの接続性を復元するために実施すべき正確な手順を詳しく記述する必要があります。 手順には多くの場合、以下に関する情報が含まれます。

* **バックアップ**: 作成されたどのくらいの頻度、保存されている場合、およびそれらからデータを復元する方法。
* **データのレプリカ**: レプリカ、レプリケートされたデータの性質と整合性の特性と、別のレプリカに切り替える方法の場所と数。
* **展開**: 展開の実行方法、ロールバックが発生するしくみとデプロイのエラー シナリオ。
* **インフラストラクチャ**: オンプレミスとクラウド リソース、ネットワーク インフラストラクチャ、ハードウェア インベントリされます。
* **依存関係**: 連絡先情報および Sla を含め、アプリケーションによって使用される外部のサービスです。
* **構成と通知**: フラグまたはアプリケーションを低下させることが設定できるオプションとサービス アプリケーションへの影響のユーザーに通知するために使用します。

必要とされる正確な手順は、計画の更新を保持する重要なので、アプリの実装の詳細によって大きく異なります。 プランの定期的なテストは、ギャップや古くなった内容を特定するために役立ちます。

## <a name="designing-for-disaster-recovery"></a>ディザスター リカバリーのための設計

ディザスター リカバリーは自動的な機能ではありません。 設計し、構築し、テストする必要があります。 強固なディザスター リカバリー戦略をサポートする必要があるアプリは、最初からディザスター リカバリーを念頭に置いて構築する必要があります。 Azure は、ディザスター リカバリーをサポートするアプリの作成に役立つサービス、機能、およびガイダンスを提供しますが、それらを設計に組み込むことは開発者の責任です。

ディザスター リカバリーのための設計には、2 つの主な懸念事項があります。

* **データ復旧**: バックアップとレプリケーションを使用して失われたデータを復元する。
* **プロセス復旧**: サービスを復旧し、コードをデプロイすることによって障害から復旧する。

### <a name="data-recovery-and-replication"></a>データの復旧とレプリケーション

レプリケーションは、保存されたデータを複数のデータ ストア レプリカに複製します。 *バックアップ*では、復旧に使用するデータの読み取り専用スナップショットが作成され、長期間保持されますが、レプリケーションではそれと異なり、ライブ データのリアルタイムまたはほぼリアルタイムのコピーが作成されます。 レプリケーションの目標は、アプリケーションの応答性を維持しながら、できるだけ少ない待機時間でレプリカを同期し続けることです。 レプリケーションは、高可用性とディザスター リカバリーを設計するための重要なコンポーネントであり、実稼働グレードのアプリケーションの一般的な機能です。

レプリケーションは、*フェールオーバー*を実行することによって、データ ストアの障害または到達不能の影響を緩和するために使用されます。フェールオーバーとは、アプリケーションの構成を変更して、正常動作中のレプリカにデータ要求をルーティングすることです。 多くの場合、フェールオーバーは自動化され、データ ストレージ製品に組み込まれたエラー検出、または独自の監視ソリューションを使用して独自に実装する検出によってトリガーされます。 実装およびシナリオによっては、システム オペレーターが手動でフェールオーバーを実行する必要があります。

レプリケーションはゼロから実装するものではありません。 ほとんどのフル機能のデータベース システムやその他のデータ ストレージ製品およびサービスには、それらに求められる機能面およびパフォーマンス面の要件を満たすために、何らかの種類のレプリケーションが、密接に統合された機能として含まれています。 ただし、アプリケーションの設計にこれらの機能を組み込んで適切に利用することは開発者の役割です。

各種の Azure サービスで、さまざまなレベルおよび概念のレプリケーションがサポートされます。 例:

* **Azure Storage**レプリケーション機能依存のレプリケーションの種類のストレージ アカウント用に選択します。 このレプリケーションは、ローカル (内のデータ センター) (データ センター間のリージョン内で)、ゾーン ベース、またはリージョン (リージョン) の間。 アプリケーションもオペレーターも、直接的に操作することはありません。 フェールオーバーは自動的かつ透過的であり、必要なのは、コストとリスクのバランスが取れたレプリケーション レベルを選択することだけです。
* **Azure SQL Database** レプリケーションは、小規模であれば自動的ですが、Azure データセンターまたはリージョンの全面的な障害からの復旧には geo レプリケーションが必要です。 手動、geo レプリケーションの設定ですが、サービスおよびドキュメントでサポートされているもの優れた機能です。
* **Cosmos DB** はグローバル分散データベース システムであり、レプリケーションはその実装の中心です。 Azure Cosmos db で直接、レプリケーションを構成する代わりにオプションを構成するパーティション分割とデータの整合性に関連します。

データの整合性、パフォーマンス、およびコストに異なった優先順位を付ける、さまざまなレプリケーション設計が存在します。 *アクティブ* レプリケーションでは、複数のレプリカで同時に更新が行われることが必須であり、スループットを犠牲に整合性を保証します。 これに対し、*パッシブ*レプリケーションは、アプリケーションのパフォーマンスを制約としてレプリケーションの削除が RPO を増やす、バック グラウンドで同期を実行します。 *アクティブ-アクティブ*または*マルチマスター* レプリケーションでは、複数のレプリカの同時使用を可能にすることで負荷分散を実現しますが、代償としてデータ整合性が複雑化します。一方、*アクティブ-パッシブ* レプリケーションでは、フェールオーバー中に限ったライブ使用のためにレプリカを予約します。

![Azure SQL Database geo レプリケーション](../media/geo-replication.png)

> [!IMPORTANT]
> **レプリケーションもバックアップも、単独では完全なディザスター リカバリー ソリューションではありません**。 データ復旧はディザスター リカバリーの一部でしかなく、レプリケーションは多くの種類のディザスター リカバリーのシナリオを完全に満たすものではありません。 たとえば、データ破損のシナリオでは、破損の性質によっては、プライマリ データ ストアからレプリカに破損が広がり、すべてのレプリカが役に立たなくなって復旧用のバックアップが必要になる可能性があります。

### <a name="process-recovery"></a>プロセス復旧

災害発生後、復旧が必要な資産はビジネス データだけではありません。 災害のシナリオでは、ネットワーク接続の問題、データセンターの障害、VM インスタンスまたはソフトウェア デプロイの損害など、原因はさまざまですが、結果的にダウンタイムも発生するのが一般的です。 正常稼働の状態に復元できるようにアプリケーションを設計する必要があります。

ほとんどの場合、プロセスの復元は、正常稼働している別のデプロイへのフェールオーバーを伴います。 シナリオによっては、重要な側面が地理的な場所にあります。 たとえば、Azure リージョン全体オフラインをもたらす大規模な自然災害が必要になります別のリージョンでサービスを復元します。 アプリケーションのディザスター リカバリーの要件、特に RTO は、する必要がありますドライブの設計と実行の準備完了状態で維持する必要がありますかする必要がありますかと、配置されている必要がある場合が必要数の複製環境を判断するのに役立ちます障害が発生した場合の展開を受け入れるように準備できます。

アプリケーションの設計によってはいくつかの異なる戦略および Azure サービスと機能の利用を行うには、障害発生後の復旧のプロセス、アプリのサポートを向上させるためにします。

#### <a name="azure-site-recovery"></a>Azure Site Recovery

Azure Site Recovery とは、専用のプロセスの復旧、物理サーバーで実行されている Vm を Azure にデプロイされた Vm で実行されているワークロードと物理サーバー上で直接実行されているワークロードを管理するサービスです。 Site Recovery はワークロードを別の場所にレプリケートし、障害発生時にフェールオーバーを支援し、ディザスター リカバリー プランのテストをサポートします。

![Azure Site Recovery](../media/asr.png)

Site Recovery は、個別の*ワークロード*に加えて VM 全体および物理サーバー イメージのレプリケーションをサポートします。このワークロードは、個別のアプリケーションを指す場合もあれば、VM またはオペレーティング システムとそのアプリケーションの全体を指す場合もあります。 任意のアプリケーション ワークロードをレプリケート可能ですが、Site Recovery の特色は、SQL Server、SharePoint などの多数の Microsoft サーバー アプリケーションや、SAP などの一部のサード パーティ製アプリケーションの統合サポートです。

Vm または物理サーバーで実行されているすべてのアプリは、Azure Site Recovery の使用を少なくとも調べる必要があります。 理解し、検証のシナリオとプロセスの復旧の可能性に優れた方法です。

#### <a name="service-specific-features"></a>サービス固有の機能

App Service のような Azure PaaS 製品で動作するアプリについては、ディザスター リカバリーをサポートするための機能およびガイダンスがほとんどのサービスで提供されます。 特定のシナリオでは、サービス固有の機能を使用して高速復旧を実現できます。 たとえば、Azure SQL Server は、別のリージョンにサービスを迅速に復元するための geo レプリケーションをサポートしています。 Azure App Service にはバックアップと復元の機能があり、ドキュメントには、Azure Traffic Manager を使用してセカンダリ リージョンにトラフィックをルーティングするためのガイダンスが含まれています。

![リージョンのペア](../media/AzRegionPairs.png)

## <a name="testing-a-disaster-recovery-plan"></a>ディザスター リカバリー プランのテスト

ディザスター リカバリーの計画は、プランを完成させるだけで終わるわけではありません。 プランをテストし、指示や説明が明確かつ最新であることを確認することは、ディザスター リカバリーの重要な側面です。

間隔を選択し、さまざまな種類や範囲のテストを実行します。たとえば、バックアップとフェールオーバーのメカニズムを毎月テストし、ディザスター リカバリーの完全シミュレーションを 6 か月おきに実行します。 次の手順と詳細がいる、プランに記載されているとおりに常をわかりやすくを何も観点を提供するプランに不慣れな人を検討してください。 テストを実行すると、ギャップの向上、および自動化し、プランにこれらの拡張機能を追加する場所の領域を特定します。

テストを同様に、監視システムを含めるに確認します。 たとえば、アプリケーションで自動フェールオーバーをサポートしている場合、依存要素またはその他の重要コンポーネントに障害を発生させて、アプリケーションが完全に正しく動作することを確認します。たとえば、自動フェールオーバーの失敗が検出されること、自動フェールオーバーが正しくトリガーされることなどを確認します。

 要件を注意深く識別してプランを作成することによって、復旧の目標を達成するためにはどのような種類のサービスを使用する必要があるかを判断できます。 Azure では、これらの目標を達成するために役立つ、さまざまなサービスおよび機能を提供しています。
