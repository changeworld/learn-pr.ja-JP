高可用性を考慮した設計は、好ましくないイベントや悪条件にもかかわらずアプリケーションまたはプロセスの稼働を継続するのに役立ちます。 しかし、何らかの重大なイベントが発生してデータが失われ、アプリやプロセスがダウンすることを回避できない場合はどうしますか。 災害が発生した場合に備えて、サービスを再び稼働させるために必要なプランを策定しておく必要があります。 復旧の目標と期待、プランのコストと制限、およびプランの実行方法を知っておく必要があります。

## <a name="what-is-disaster-recovery"></a>ディザスター リカバリーとは

ディザスター リカバリーは、ダウンタイムやデータ損失につながる*影響の大きいイベントからの復旧*に関連するものです。 災害は、高可用性のためのアプリケーション設計によって軽減できる範囲をはるかに超えた長期的な影響を生じさせる単一の大きなイベントです。

多くの場合、"災害" という言葉は、(地震、洪水、台風などの) *自然*災害や外的イベントを連想させますが、他にも多くの種類の災害が存在します。 デプロイやアップグレードの失敗によって、アプリが認識不能な状態になる可能性があります。 悪意のあるハッカーによってデータが暗号化または削除され、その他の種類の損害が与えられることで、アプリがオフラインになったり、一部の機能が除去される可能性があります。

その原因にかかわらず、いったん発生した災害に対する最善の対処法は、明確に定義されていてテスト済みのディザスター リカバリー プランと、その設計を通じてディザスター リカバリーの取り組みを積極的にサポートするアプリケーションです。

## <a name="how-to-create-a-disaster-recovery-plan"></a>ディザスター リカバリー プランの作成方法

ディザスター リカバリー プランは、災害によって発生したデータ損失やダウンタイムから復旧するために必要な手順を詳しく記述し、それらの手順を指揮する責任者を特定する単一のドキュメントです。 オペレーターは、災害発生後にアプリケーションの接続を復元してデータを復旧するためのマニュアルとして、プランを使用できる必要があります。 良好な結果を得るには、ディザスター リカバリー専用の詳細な書面のプランが重要です。 プランを作成するプロセスは、アプリケーションの全体像を把握するのに役立ちます。 作成された書面の手順は、適切な意思決定と、障害発生直後の混乱したパニック状態への適切な対応を促進します。

ディザスター リカバリー プランの作成には、アプリケーションのワークフロー、データ、インフラストラクチャ、および依存関係に関する専門知識が必要です。

### <a name="risk-assessment-and-process-inventory"></a>リスク評価とプロセス インベントリ

ディザスター リカバリー プラン作成の最初のステップは、さまざまな種類の災害がアプリケーションに及ぼす影響を調べるリスク分析の実行です。 リスク分析では、災害の本質よりも、データ損失やアプリケーションのダウンタイムという形で現れる災害の潜在的な影響の方が重要です。 さまざまな種類の災害を想定し、できるだけ具体的にそれらの影響を検討します。 たとえば、ターゲット型の悪質な攻撃によってコードまたはデータが改変された結果、地震によりネットワーク接続が中断されたり、データセンターを利用できなくなるというものとは異なる種類の影響が生じる可能性があります。

リスク評価では、際限のないダウンタイムが許されない*すべての*プロセスと、際限のない損失が許されないすべてのデータ カテゴリを検討する必要があります。 複数のアプリケーション コンポーネントに影響を及ぼす災害が発生したときに、プランの所有者がそのプランを使用して、注意が必要な項目と各項目の優先順位を決める方法に関する完全なインベントリを作成できることが重要です。

一部のアプリでは、データの単一のプロセスまたは分類のみが構成される場合があります。 アプリケーションは、組織の複数のアプリケーションを含むより大規模なディザスター リカバリー プランの構成要素の 1 つになる可能性が高いため、これはやはり重要な注意点です。

### <a name="recovery-objectives"></a>復旧目標

完全なプランでは、アプリケーションによって実装されるプロセスごとに、2 つの重要なビジネス要件を指定する必要があります。

* **回復ポイントの目標 (RPO)**: 許容されるデータ損失の最大継続時間。 RPO は "30 分のデータ"、"4 時間のデータ" のように、数量ではなく時間の単位で計測されます。 RPO はデータの*損失*の限定や復旧に関連するものであり、データの*盗難*には関連しません。
* **回復時刻の目標 (RTO)**: 許容されるダウンタイムの最大継続時間。"ダウンタイム" は指定内容に従って定義する必要があります。 たとえば、障害のイベントで許容されるダウンタイムの継続時間が 8 時間の場合、RPO は 8 時間です。

![災害発生時間からの回復ポイントの目標と回復時刻の目標を時間単位で示した図。](../media/rto-rpo.png)

アプリによって実装される主なプロセスまたはワークロードごとに、個別の RPO 値と RTO 値を定義する必要があります。 異なるプロセスに対して値が同じになったとしても、それぞれの値は、災害シナリオのリスクと潜在的な復旧戦略をプロセスごとに検討する個別の分析に基づいて生成されたものである必要があります。

RPO と RTO を指定するプロセスによって、アプリケーションのディザスター リカバリー要件が実質的に作成されます。 データの各ワークロードとカテゴリの優先順位を確定する必要があります。 この分析には、実装とメンテナンスのコスト、運用費、プロセスのオーバーヘッド、パフォーマンスへの影響、ダウンタイムと失われたデータの影響などの懸案事項が含まれます。 アプリケーションにとっての "ダウンタイム" の意味を正確に定義する必要があります。場合によっては、異なる機能レベルに対して別個の RPO 値や RTO 値を確立します。 RPO と RTO の指定は、単に任意の値を選べばよいというものではありません。 ディザスター リカバリー プランに関する値の多くは、災害の潜在的な影響やリスク軽減のコストの算定にまで踏み入った調査と分析に基づくものです。

### <a name="detailing-recovery-steps"></a>復旧手順の詳述

最終的なプランでは、失われたデータやアプリケーションの接続性を復元するために行う必要がある正確な手順について詳しく記述する必要があります。 手順には多くの場合、以下に関する情報が含まれます。

* **バックアップ**: 作成頻度、保存場所、バックアップからのデータ復元方法。
* **データ レプリカ**: レプリカの数と場所、レプリケートされたデータの性質および整合性の特性、別のレプリカへの切り替え方法。
* **デプロイ**: デプロイの実行方法、ロールバックの発生のしくみ、デプロイの失敗シナリオ。
* **インフラストラクチャ**: オンプレミスおよびクラウドのリソース、ネットワーク インフラストラクチャ、ハードウェア インベントリ。
* **依存関係**: アプリケーションで使用される外部サービス (SLA や連絡先情報など)。
* **構成と通知**: アプリケーションのグレースフル デグレーションのために設定可能なフラグまたはオプション、アプリケーションへの影響をユーザーに通知するために使用されるサービス。

具体的に必要な手順はアプリの実装の詳細によって大きく異なるため、プランを継続的に更新することが重要です。 プランの定期的なテストは、ギャップや古くなったセクションを特定するのに役立ちます。

## <a name="designing-for-disaster-recovery"></a>ディザスター リカバリーを考慮した設計

ディザスター リカバリーは自動的な機能ではありません。 これは設計し、構築し、テストする必要があります。 強固なディザスター リカバリー戦略をサポートする必要があるアプリは、ディザスター リカバリーを考慮して最初から構築する必要があります。 Azure では、ディザスター リカバリーをサポートするアプリの作成に役立つサービス、機能、およびガイダンスが提供されますが、それらを設計に組み込むことはユーザーの役割です。

ディザスター リカバリーを考慮した設計には、次の 2 つの主な懸念事項があります。

* **データの回復**: バックアップとレプリケーションを使用して失われたデータを復元する。
* **プロセスの回復**: サービスを復旧させ、コードをデプロイすることによって障害から復旧する。

### <a name="data-recovery-and-replication"></a>データの回復とレプリケーション

レプリケーションでは、複数のデータ ストア レプリカ間で格納されたデータを複製します。 *バックアップ*では、復旧に使用するデータの読み取り専用スナップショットが作成され、長期間保持されますが、レプリケーションではそれとは異なり、ライブ データのリアルタイムまたはほぼリアルタイムのコピーが作成されます。 レプリケーションの目標は、アプリケーションの応答性を維持しながら、できるだけ短い待機時間でレプリカを同期し続けることです。 レプリケーションは、高可用性とディザスター リカバリーを考慮して設計するための重要な要素であり、運用グレードのアプリケーションの一般的な機能です。

レプリケーションは、*フェールオーバー*を実行することによって、データ ストアの障害または到達不能の影響を緩和するために使用されます。フェールオーバーとは、アプリケーションの構成を変更して、稼働中のレプリカにデータ要求をルーティングすることです。 多くの場合、フェールオーバーは自動化され、データ ストレージ製品に組み込まれたエラー検出、または独自の監視ソリューションを使用して独自に実装する検出によってトリガーされます。 実装およびシナリオによっては、システム オペレーターが手動でフェールオーバーを実行する必要があります。

レプリケーションはゼロから実装するものではありません。 ほとんどのフル機能のデータベース システムやその他のデータ ストレージ製品およびサービスには、それらに求められる機能面およびパフォーマンス面の要件を満たすために、何らかの種類のレプリケーションが、緊密に統合された機能として含まれています。 しかし、アプリケーションの設計にこれらの機能を組み込んで適切に利用することはユーザーの役割です。

各種の Azure サービスで、さまざまなレベルおよび概念のレプリケーションがサポートされます。 例:

* **Azure Storage** のレプリケーション機能は、ストレージ アカウント用に選択されたレプリケーションの種類に依存します。 このレプリケーションは、ローカル (データセンター内)、ゾーン (リージョン内のデータセンター間)、またはリージョン (リージョン間) で実行できます。 アプリケーションやオペレーターによって、直接操作されることはありません。 フェールオーバーは自動的かつ透過的であり、必要なのは、コストとリスクのバランスが取れたレプリケーション レベルを選択することだけです。
* **Azure SQL Database** レプリケーションは、小規模であれば自動ですが、Azure のデータセンターまたはリージョンの全面的な障害からの復旧には geo レプリケーションが必要です。 geo レプリケーションの設定は手動ですが、サービスの優れた機能であり、ドキュメントで十分にサポートされています。
* **Cosmos DB** はグローバル分散データベース システムであり、レプリケーションはその実装の中核となります。 Azure Cosmos DB では、レプリケーションを直接構成するのではなく、パーティション分割とデータの整合性に関するオプションを構成します。

データの整合性、パフォーマンス、およびコストに異なる優先順位を付ける、さまざまなレプリケーション設計が存在します。 *アクティブ* レプリケーションでは、複数のレプリカで同時に更新を行う必要があり、スループットの代償として整合性が保証されます。 一方、*パッシブ* レプリケーションではバックグラウンドで同期が行われるので、レプリケーションによってアプリケーションのパフォーマンスが制約されることはありませんが、RPO は増加します。 *アクティブ/アクティブ*または*マルチマスター* レプリケーションでは、複数のレプリカの同時使用を可能にすることで負荷分散を実現しますが、その代償としてデータ整合性が複雑になります。一方、*アクティブ/パッシブ* レプリケーションでは、フェールオーバー中のみのライブ使用のためにレプリカを予約します。

![地理的レプリケーションの例を示す図。 更新可能なプライマリ データベースは米国中南部に置かれていますが、読み取り可読なセカンダリ データベースは米国西部と米国東部の 2 つの場所に配置されています。](../media/geo-replication.png)

> [!IMPORTANT]
> **レプリケーションもバックアップも、単独では完全なディザスター リカバリー ソリューションではありません**。 データの回復はディザスター リカバリーの一部でしかなく、レプリケーションは多くの種類のディザスター リカバリーのシナリオを完全に満たすものではありません。 たとえば、データ破損のシナリオでは、破損の性質によっては、プライマリ データ ストアからレプリカに破損が広がり、すべてのレプリカが役に立たなくなって復旧用のバックアップが必要になる可能性があります。

### <a name="process-recovery"></a>プロセスの回復

災害発生後、復旧が必要な資産はビジネス データだけではありません。 災害のシナリオでは、ネットワーク接続の問題、データセンターの障害、VM インスタンスまたはソフトウェア デプロイに関する損害など、原因はさまざまですが、結果的にダウンタイムも発生するのが一般的です。 稼働状態に復元できるようにアプリケーションを設計する必要があります。

ほとんどの場合、プロセスの復元は、稼働している別のデプロイへのフェールオーバーを伴います。 シナリオによっては、地理的位置が重要な側面になる場合があります。 たとえば、大規模自然災害によって Azure リージョン全体がオフラインになった場合、別のリージョンにサービスを復元する必要があります。 アプリケーションのディザスター リカバリー要件 (特に RTO) によって、設計の方向性が決まります。この要件は、レプリケート先の環境をいくつ用意するのか、どの地域に環境を置くのか、すぐに稼働できる状態で環境を維持するのか、それとも災害発生時にデプロイを受け入れる準備をしておく必要があるかを判断するのに役立ちます。

アプリケーションの設計によっては、災害後のプロセスの回復に対するアプリのサポートを向上させるために利用できる、何種類かの戦略と Azure のサービスおよび機能が存在します。

#### <a name="azure-site-recovery"></a>Azure Site Recovery

Azure Site Recovery は、Azure にデプロイされた VM 上で動作するワークロード、物理サーバー上で動作する VM、および物理サーバー上で直接動作するワークロードのプロセスの回復の管理に特化したサービスです。 Site Recovery ではワークロードが別の場所にレプリケートされ、障害発生時にフェールオーバーするのに役立ち、ディザスター リカバリー プランのテストがサポートされます。

![米国東部から米国西部に位置する 3 つの仮想マシンのワークロードをレプリケートする Azure Site Recovery の役割を示す図。](../media/asr.png)

Site Recovery では、個々の*ワークロード*だけでなく、VM および物理サーバー イメージ全体のレプリケーションがサポートされます。このワークロードは、個々のアプリケーションを指す場合もあれば、VM またはオペレーティング システムとそのアプリケーションの全体を指す場合もあります。 任意のアプリケーション ワークロードをレプリケートできますが、Site Recovery の優れた点は、SQL Server や SharePoint などの多くの Microsoft サーバー アプリケーション、および SAP のような一部のサード パーティ製アプリケーションの統合サポートが提供されることです。

VM または物理サーバー上で実行されるアプリについては、少なくとも Azure Site Recovery の使用を検討することをお勧めします。 これは、プロセスの回復のシナリオと可能性を発見および追求するための優れた方法です。

#### <a name="service-specific-features"></a>サービス固有の機能

App Service のような Azure PaaS 型サービスで実行されるアプリについては、ディザスター リカバリーをサポートするための機能およびガイダンスがほとんどのサービスで提供されます。 特定のシナリオでは、サービス固有の機能を使用して高速回復がサポートされます。 たとえば、Azure SQL Server では、別のリージョンにサービスを迅速に復元するための geo レプリケーションがサポートされます。 Azure App Service にはバックアップと復元の機能があり、ドキュメントには、Azure Traffic Manager を使用してセカンダリ リージョンにトラフィックをルーティングするためのガイダンスが含まれています。

![個々のデータセンターからなる地理内のリージョン ペアを示す図。](../media/AzRegionPairs.png)

## <a name="testing-a-disaster-recovery-plan"></a>ディザスター リカバリー プランのテスト

ディザスター リカバリーの計画は、プランを完成させたら終わりというわけではありません。 プランをテストすることは、指示や説明が明確かつ最新であることを確認するためのディザスター リカバリーの重要な側面です。

バックアップおよびフェールオーバーのメカニズムの毎月のテストや、完全なディザスター リカバリー シミュレーションの 6 か月ごとの実行など、さまざまな種類と範囲のテストを実行する間隔を選択します。 常に、プランに記述されているとおりの手順および詳細に従ってください。また、プランにあまり詳しくない人には、内容をより明確にするための見方を示すことを検討してください。 テストの実行時に、食い違い、改善できる領域、および自動化できる場所を特定し、それらをプランに追加します。

必ず、独自の監視システムもテストに含めてください。 たとえば、アプリケーションで自動フェールオーバーをサポートしている場合、依存関係またはその他の重要なコンポーネントで障害を発生させて、アプリケーションが完全に正しく動作することを確認します。たとえば、自動フェールオーバーの失敗やトリガーが検出されることを確認します。

 慎重に要件を識別してプランを作成することによって、回復の目標を達成するためにはどのような種類のサービスを使用する必要があるかを判断できます。 Azure では、これらの目標を達成するのに役立つ、さまざまなサービスや機能が提供されます。
