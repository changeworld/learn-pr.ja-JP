Azure 内のいくつかを含め、分散アプリケーションの信頼性向上に役立つ通信プラットフォームは多数あります。 これらのツールはそれぞれ別の目的で動作します。適切なものを選択できるように Azure 内の各ツールを確認しましょう。

ピザの注文と追跡アプリケーションのアーキテクチャでは、Web サイト、データ ストレージ、バックエンド サービスなどいくつかのコンポーネントが必要です。 アプリケーションのコンポーネントはさまざまな方法でまとめてバインドでき、1 つのアプリケーションで複数の手法を利用できます。 

Contoso Slices アプリケーションでは、どの手法を使用するかを決定する必要があります。 最初の手順は、複数のパート間に通信が存在する場所それぞれを評価することです。 アプリケーションがそのジョブを実行するために一部のコンポーネントは、適切なタイミングで実行する_必要があります_。 時間はある程度重要ですが、クリティカルではありません。 最後に、モバイル アプリ通知など、他のコンポーネントは、さらに若干随意的です。

ここでは、Azure で使用できる通信プラットフォームについて学習し、アプリケーションの各要件にあったプラットフォームを選択できるようにします。

## <a name="decide-between-messages-and-events"></a>メッセージとイベントを決定する

メッセージとイベントの両方が**データグラム**: 1 つのコンポーネントから別のコンポーネントに送信されたデータのパッケージ。 これらの違いは一見したところわずかなようですが、アプリケーションを設計する方法には大きな違いとなる場合があります。 

### <a name="messages"></a>メッセージ

アプリケーションの全体的な整合性は受信するメッセージによって異なる場合があります。これは分散アプリケーションの用語において、メッセージの特性をよく表しています。 メッセージを送信することを、ワークフローのバトンを別のコンポーネントに渡す1つのコンポーネントとして考えることができます。 ワークフロー全体が重要なビジネス プロセスとなる可能性があり、メッセージはコンポーネントをまとめて保持するモルタルです。

一般的にメッセージはデータそのものを含み、(ID や URL のような) 単なるデータの参照ではありません。 データをデータグラムの一部として送信することは、参照を送信することよりも不安定さは軽減されます。 メッセージングのアーキテクチャはメッセージの配信を保証し、追加の参照は不要であるため、メッセージは確実に処理されます。 ただし、アプリケーションの送信では、含めるデータが正確に何であるかを知り、大量データ送信を回避する必要があるため、受信側のコンポーネントは不必要な作業を実行する必要があります。 この意味で、メッセージの送信者と受信者は、多くの場合、厳格なデータ コントラクトで結合されます。

Contoso Slice の新しいアーキテクチャでは、ピザの注文を入力する場合、注文者はメッセージを使用するに違いありません。 Web フロントエンドまたはモバイル アプリはバックエンド処理コンポーネントにメッセージを送信します。 顧客近くのストアへのルーティングやクレジット カードへの課金などのバックエンドの手順が実行されます。

### <a name="events"></a>イベント

イベントは、何かが発生したことを通知します。 イベントはメッセージよりも軽量で、ほとんどの場合はブロードキャスト通信に使用されます。
イベントには次の特性があります。
* 送信されたイベントの受信者が複数のこともあれば、まったくいないこともあります。
* 多くの場合、イベントは "ファンアウト" を意図しています。つまり、パブリッシャーのそれぞれに対して多数のサブスクライバーが存在します。
* イベントのパブリッシャーは、受信側コンポーネントがどのようなアクションを実行するかについて何も想定していません。

ピザのチェーン店は、イベントを使用して、状態変更をユーザーに通知できます。 状態変更イベントは、Azure Event Grid に送信でき、次に Azure 関数、そして通知ハブへと送信され、完全に_サーバーレス_なソリューションです。

通信プラットフォームは一般的にどちらか一方を処理するように設計されているため、このイベントとメッセージの違いは根本的なものです。 Service Bus はメッセージを処理するように設計されています。 イベントを送信する場合、Event Grid を選択することになるでしょう。 

Azure には Azure イベント ハブもありますが、これは分析のために使用される通信の高フロー・ストリームの特定タイプで使用されることがほとんどです。 たとえば、ピザ オーブンにネットワーク接続されたセンサーを取り付けていた場合、Azure Stream Analytics と結合された Event Hub を使用して、望ましくない火災やコンポーネントの摩耗を示す温度変化のパターンを監視できます。

## <a name="service-bus-topics-queues-and-relays"></a>Service Bus のトピック、キュー、リレー

Azure Service Bus は、キュー、トピック、およびリレーを通じた、3 つの異なる方法でメッセージを交換することができます。

### <a name="what-is-a-queue"></a>キューとは何ですか。

**キュー**はメッセージの単純な一時記憶の場所です。 コンポーネントを送信することで、キューにメッセージが追加されます。 宛先コンポーネントは、キューの先頭にあるメッセージを取得します。 通常の状況では、メッセージはそれぞれ、1 人の受信者のみが受信します。

![Azure Service Bus キュー](../media-draft/2-service-bus-queue.png)

キューは、非常に込み合っている状況から送信先コンポーネントを隔離するために、送信元と送信先のコンポーネントを分離します。 

ピーク時間帯では、メッセージは送信先コンポーネントが処理できるよりも速く着信する場合があります。 送信元コンポーネントには、送信先への直接的な接続がないため、送信元が影響を受けることはなく、キューが増大します。 送信先コンポーネントは、処理が可能になるとキューからメッセージを削除します。 混み具合が解消すると、送信先コンポーネントは追いつくことができ、キューが短くなります。 

キューは、システムにリソースを追加することなく、このように込み合った状況に対応します。 ただし、比較的迅速に処理する必要があるメッセージについては、送信先コンポーネントにインスタンスを追加することで負荷を共有させることができます。 各メッセージは 1 つのインスタンスのみで処理されます。 これは、実際に必要なコンポーネントのみにリソースを追加しながら、アプリケーション全体を拡張する効果的な方法です。

### <a name="what-is-a-topic"></a>トピックとは何ですか。

**トピック**はキューに似ていますが、複数のサブスクリプションを持つことができます。 つまり、複数の送信先コンポーネントは、1 つのトピックにサブスクライブできるため、各メッセージは複数の受信者に配信されます。 サブスクリプションでは、トピック内のメッセージをフィルター処理して関連するメッセージのみを受信することもできます。 サブスクリプションはキューと同じ分離された通信を提供し、込み合った状況にも同じ方法で対応します。 各メッセージを複数の送信先コンポーネントに配信する場合はトピックを使用します。

トピックは Basic 価格レベルでは、サポートされていません。

![Azure Service Bus Topic](../media-draft/2-service-bus-topic.png)

### <a name="what-is-a-relay"></a>リレーとは何ですか?

**リレー**とはアプリケーション間の同期双方向通信を実行するオブジェクトです。 キューやトピックなどの一時記憶域の場所ではありません。 代わりに、ファイアウォールなどのネットワーク境界越しにバッファーなしの双方向の接続を提供します。 同じネットワーク セグメントに配置されているが、ネットワーク セキュリティ デバイスで区切られているかのように、コンポーネント間での直接通信する場合はリレーを使用します。

> [!NOTE]
> リレーには、Azure Service Bus の一部ですが、疎結合メッセージング ワークフローを実装せず、このモジュールではこれ以上は言及しません。

## <a name="service-bus-queues-and-storage-queues"></a>Service Bus キューと Storage キューの比較

メッセージ キューを含む Azure 機能には Service Bus と Storage Account の 2 つがあります。 一般的なガイドラインとして、Storage キューの方が簡単に使用できますが、あまり高度ではなく、Service Bus キューより柔軟です。

Service Bus キューの主な利点は次のとおりです。

* 大きなメッセージ サイズ (メッセージあたり 64 KB に対して 256 KB) をサポートしています
* At-Least-Once と At-Most-Once の両方の配信をサポートしています。メッセージが失われるという極めて低い可能性と、メッセージが 2 回処理されるという極めて低い可能性のいずれかを選択します。
* **最初先出し (FIFO)** 順序を保証 - メッセージは追加された順序で処理されます (ただし FIFO はキューの通常の動作であり、すべてのメッセージに保証されてはいません)
* トランザクションに複数のメッセージをグループ化できます - トランザクションの 1 つのメッセージの配信に失敗すると、トランザクションのすべてのメッセージが配信されません。
* ロールベースのセキュリティをサポート
* 継続的にキューをポーリングするために送信先コンポーネントは不要です。

Storage キューの利点は次のとおりです。

* 無制限のキュー サイズ (これに対して Service Bus キューは 80 GB に制限されている) をサポートしています
* すべてのメッセージのログを維持します。

## <a name="how-to-choose-a-communications-technology"></a>通信テクノロジを選択する方法

Azure が提供するまざまな概念と実装について説明しました。 ここからは通信毎に私たちの意思決定プロセスがどのようにあるべきかについて説明します。

#### <a name="consider-the-following-questions"></a>次のクエリについて考えてみましょう。

1. 通信イベントですか。 その場合は、Event Grid またはイベント ハブの使用を検討してください。

1. 1 つのメッセージを複数の送信先に配信する必要がありますか。 その場合は、Service Bus トピックを使用します。 それ以外の場合はキューを使用します。

キューが必要であると判断した場合：

#### <a name="choose-service-bus-queues-if"></a>次の場合は、Service Bus キューを選択します。

- At-Most-Once 配信保証が必要である
- FIFO 保証が必要である
- メッセージをトランザクションにグループ化する必要がある
- キューをポーリングせずにメッセージを受信する必要がある
- キューにロール ベースのアクセスを提供する必要がある
- 64 KB を超えるが 256 KB 未満のメッセージを処理する必要がある
- キューのサイズが 80 GB を超えることがない
- バッチ メッセージを発行および使用できる必要がある

#### <a name="choose-queue-storage-if"></a>次の場合は、Queue Storage を選択します。
- 特定の追加要件のない単純なキューが必要である
- キューを通ったすべてのメッセージの監査証跡が必要である
- キューのサイズが 80 GB を超えると予想される
- キュー内のメッセージ処理の進行状況を追跡する必要がある

分散アプリケーションのコンポーネントは、直接通信できますが、多くの場合、Azure Service Bus や Event Grid など、中間通信プラットフォームを使用してその通信の信頼性を高めることができます。

Event Grid はイベント向けに設計されており、イベントの受信者に通知して、そのイベントに関連付けられた生データを含みません。 イベント ハブは高フローの分析タイプ イベント向けに設計されています。 Azure Service Bus と Storage キューはメッセージ用であり、アプリケーションのワークフローの中核部分をバインドするために使用できます。

要件が単純な場合、1 つの宛先のみに各メッセージを送信する場合、または可能な限り早くコードを記述する場合は、Storage キューが最善の選択肢となります。 それ以外では、Service Bus キューが、より多くのオプションや柔軟性を備えています。

複数のサブスクライバーにメッセージを送信する場合は、Service Bus トピックを使用します。
