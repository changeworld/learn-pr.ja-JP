Azure 内でさまざまな分散アプリケーションの信頼性を向上させるのに役立つ多くの通信プラットフォームがあります。 これらのツールはそれぞれ別の目的で動作します。適切なものを選択できるように Azure 内の各ツールを確認しましょう。

ピザの順序付けと管理アプリケーションのアーキテクチャには、いくつかのコンポーネントが必要です。 web サイト、データ ストレージ、バックエンド サービスなどです。アプリケーションのコンポーネントはさまざまな方法でまとめてバインドでき、1 つのアプリケーションで複数の手法を利用できます。 

Contoso Slices アプリケーションでは、どの手法を使用するかを決定する必要があります。 最初の手順は、複数のパート間に通信が存在する場所それぞれを評価することです。 アプリケーションがそのジョブを実行するために一部のコンポーネントは、適切なタイミングで実行する_必要があります_。 いくつかは、重要ですが、時間の重要でない可能性があります。 最後に、モバイル アプリ通知など、他のコンポーネントは、さらに若干随意的です。

ここでは、Azure で使用できる通信プラットフォームについて学習し、アプリケーションの各要件にあったプラットフォームを選択できるようにします。

## <a name="decide-between-messages-and-events"></a>メッセージとイベントを決定する

メッセージとイベントの両方が**データグラム**: 1 つのコンポーネントから別のコンポーネントに送信されたデータのパッケージ。 これらの違いは一見したところわずかなようですが、アプリケーションを設計する方法には大きな違いとなる場合があります。 

### <a name="messages"></a>メッセージ

アプリケーションの全体的な整合性は受信するメッセージによって異なる場合があります。これは分散アプリケーションの用語において、メッセージの特性をよく表しています。 メッセージを送信することを、ワークフローのバトンを別のコンポーネントに渡す1つのコンポーネントとして考えることができます。 ワークフロー全体が重要なビジネス プロセスとなる可能性があり、メッセージはコンポーネントをまとめて保持するモルタルです。

メッセージには、だけでなく、ID または URL) (などデータへの参照、データ自体には、一般に含まれています。 データをデータグラムの一部として送信することは、参照を送信することよりも不安定さは軽減されます。 メッセージングのアーキテクチャは、メッセージの配信を保証し、メッセージが確実に処理された必要な追加の参照がないため、します。 ただし、送信元アプリケーションに含める、不要な作業を行う、受信側のコンポーネントを必要とする大量のデータの送信を回避するためにデータを正確に把握する必要があります。 この意味で、メッセージの送信者と受信者は、多くの場合、厳格なデータ コントラクトで結合されます。

Contoso のスライスの新しいアーキテクチャでは、ピザの注文を入力したら、それらは可能性がありますメッセージを使用してください。 Web フロント エンドまたはモバイル アプリは、バックエンド処理コンポーネントにメッセージを送信します。 バックエンドで、顧客の近くのストアにルーティングし、クレジット_カードに課金のような手順が行われます。

### <a name="events"></a>イベント

イベントは、何かが発生したことの通知をトリガーします。 イベントは、「軽量」メッセージよりもブロードキャストの通信に使用されるほとんどの場合。

イベントには次の特性があります。
* 送信されたイベントの受信者が複数のこともあれば、まったくいないこともあります。
* 多くの場合、イベントは "ファンアウト" を意図しています。つまり、パブリッシャーのそれぞれに対して多数のサブスクライバーが存在します。
* イベントのパブリッシャーは、受信側コンポーネントがどのようなアクションを実行するかについて何も想定していません。

ピザのチェーン店は、イベントを使用して、状態変更をユーザーに通知できます。 状態変更イベントは、Azure Functions にログオンし、Azure Event grid との Azure Notification Hubs に送信でしたを完全に_サーバーレス_ソリューション。

通信プラットフォームは一般的にどちらか一方を処理するように設計されているため、このイベントとメッセージの違いは根本的なものです。 Service Bus はメッセージを処理するように設計されています。 イベントを送信する場合、Event Grid を選択することになるでしょう。 

Azure Event Hubs もありますは、特定の種類の分析のために使用される通信の高フロー ストリームでよく使用されます。 たとえば、ピザ レンジのセンサーをネットワークいますが場合、は、可能性が、不要な火災やコンポーネント wear 気温の変化のパターンを監視する Azure Stream Analytics と組み合わせると、Event Hubs を使用します。

## <a name="service-bus-topics-queues-and-relays"></a>Service Bus のトピック、キュー、およびリレー

Azure Service Bus は、次の 3 つの異なる方法でメッセージを交換できます。 キュー、トピック、およびリレーします。

### <a name="what-is-a-queue"></a>キューは何ですか。

**キュー**はメッセージの単純な一時記憶の場所です。 コンポーネントを送信することで、キューにメッセージが追加されます。 宛先コンポーネントは、キューの先頭にあるメッセージを取得します。 通常の状況では、各メッセージは、1 つだけのレシーバーによって受信されます。

![Azure Service Bus キュー](../media/2-service-bus-queue.png)

キューは、非常に込み合っている状況から送信先コンポーネントを隔離するために、送信元と送信先のコンポーネントを分離します。 

ピーク時間帯にメッセージは変換先コンポーネントが処理できるよりも高速は可能性があります。 変換元コンポーネントがある、変換先に直接接続はありません、ため、ソースが影響を受ける、キューが拡張されます。 送信先コンポーネントは、処理が可能になるとキューからメッセージを削除します。 混み具合が解消すると、送信先コンポーネントは追いつくことができ、キューが短くなります。 

キューは、システムにリソースを追加することなく、このように込み合った状況に対応します。 ただし、比較的迅速に処理する必要があるメッセージについては、送信先コンポーネントにインスタンスを追加することで負荷を共有させることができます。 各メッセージは 1 つのインスタンスのみで処理されます。 これは、実際に必要なコンポーネントのみにリソースを追加しながら、アプリケーション全体を拡張する効果的な方法です。

### <a name="what-is-a-topic"></a>トピックとは何ですか。

**トピック**はキューに似ていますが、複数のサブスクリプションを持つことができます。 つまり、複数の送信先コンポーネントは、1 つのトピックにサブスクライブできるため、各メッセージは複数の受信者に配信されます。 サブスクリプションでは、トピック内のメッセージをフィルター処理して関連するメッセージのみを受信することもできます。 サブスクリプションはキューと同じ分離された通信を提供し、込み合った状況にも同じ方法で対応します。 各メッセージを複数の送信先コンポーネントに配信する場合はトピックを使用します。

トピックは Basic 価格レベルでは、サポートされていません。

![Azure Service Bus トピック](../media/2-service-bus-topic.png)

### <a name="what-is-a-relay"></a>リレーとは何ですか。

**リレー**とはアプリケーション間の同期双方向通信を実行するオブジェクトです。 キューやトピックなどの一時記憶域の場所ではありません。 代わりに、双方向、ファイアウォールなどのネットワーク境界を越えてバッファリングされていない接続を提供します。 これらが同じネットワーク セグメント上にあるがネットワーク セキュリティ デバイスで区切られたかのようにコンポーネント間で直接通信する場合は、リレーを使用します。

> [!NOTE]
> リレーには、Azure Service Bus の一部が、疎結合メッセージング ワークフローを実装しないと、このモジュールでは考慮されません。

## <a name="service-bus-queues-and-storage-queues"></a>Service Bus キューとストレージ キュー

メッセージ キューを含む 2 つの Azure 機能があります。 Service Bus と Azure Storage アカウント。 一般的なガイドラインとしてストレージ キューは簡単に使用しますが、低い高度で Service Bus のキューよりも柔軟性。

Service Bus キューの主な利点は次のとおりです。

* 大きなメッセージ サイズ (メッセージあたり 64 KB に対して 256 KB) をサポートしています
* At-Least-Once と At-Most-Once の両方の配信をサポートしています。メッセージが失われるという極めて低い可能性と、メッセージが 2 回処理されるという極めて低い可能性のいずれかを選択します。
* 保証**最初先出し (FIFO)** 順序 - メッセージが追加されたのと同じ順序で処理されます (FIFO キューの通常の動作ですが、保証はありませんすべてのメッセージに対して)
* トランザクションに複数のメッセージをグループ化できます - トランザクションの 1 つのメッセージの配信に失敗すると、トランザクションのすべてのメッセージが配信されません。
* ロールベースのセキュリティをサポート
* 継続的にキューをポーリングするために送信先コンポーネントは不要です。

ストレージ キューの利点があります。

* 無制限のキュー サイズ (と Service Bus キューの 80 GB の制限) をサポートしています
* すべてのメッセージのログを維持します。

## <a name="how-to-choose-a-communications-technology"></a>通信テクノロジを選択する方法

Azure が提供するまざまな概念と実装について説明しました。 ここからは通信毎に私たちの意思決定プロセスがどのようにあるべきかについて説明します。

#### <a name="consider-the-following-questions"></a>次のクエリについて考えてみましょう。

1. 通信イベントですか。 そうである場合は、Event Grid または Event Hubs の使用を検討してください。

1. 1 つのメッセージを複数の送信先に配信する必要がありますか。 その場合は、Service Bus トピックを使用します。 それ以外の場合、キューを使用します。

キューが必要であると判断した場合：

#### <a name="choose-service-bus-queues-if"></a>次の場合は、Service Bus キューを選択します。

- ほとんどの 1 回の配信保証する必要があります。
- FIFO 保証が必要である
- メッセージをトランザクションにグループ化する必要がある
- キューをポーリングせずにメッセージを受信する必要がある
- キューにロールベースのアクセスを提供する必要があります。
- 256 KB 未満ですが 64 KB を超えるメッセージを処理する必要があります。
- キューのサイズが 80 GB を超えることがない
- バッチ メッセージを発行および使用できる必要がある

#### <a name="choose-queue-storage-if"></a>場合は、キュー ストレージを選択します。
- 特定の追加要件のない単純なキューが必要である
- キューを通ったすべてのメッセージの監査証跡が必要である
- キューのサイズが 80 GB を超えると予想される
- キュー内のメッセージ処理の進行状況を追跡する必要がある

分散アプリケーションのコンポーネントは、直接通信できるよう、Azure Service Bus または Azure Event Grid など、中間通信プラットフォームを使用してその通信の信頼性を緩和することができます多くの場合。

Event Grid は、イベントのイベントのみの受信者に通知し、そのイベントに関連付けられた生データが含まれていない場合に設計されています。 Azure Event Hubs は、イベントの種類の高フローの分析に適しています。 Azure Service Bus と Storage キューはメッセージ用であり、アプリケーションのワークフローの中核部分をバインドするために使用できます。

お客様の要件は、単純な場合、1 つだけ先には、各メッセージを送信する場合、または可能な限り早くコードを記述する場合、ストレージ キューが最善の方法にあります。 それ以外では、Service Bus キューが、より多くのオプションや柔軟性を備えています。

複数のサブスクライバーにメッセージを送信する場合は、Service Bus トピックを使用します。
