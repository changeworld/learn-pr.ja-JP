Azure 内のいくつかを含め、分散アプリケーションの信頼性向上に役立つ通信プラットフォームは数多くあります。 これらのツールはそれぞれ別の目的で動作します。適切なものを選択できるように Azure 内の各ツールを確認しましょう。

ピザの注文と追跡アプリケーションのアーキテクチャでは、Web サイト、データ ストレージ、バックエンド サービスなどいくつかのコンポーネントが必要です。アプリケーションのコンポーネントはさまざまな方法でまとめてバインドでき、単一のアプリケーションで複数の手法を利用できます。 

Contoso Slices アプリケーションでは、どの手法を使用するかを決定する必要があります。 最初の手順は、複数のパート間に通信が存在する場所それぞれを評価することです。 アプリケーションでそのジョブを実行するには、一部のコンポーネントが適切なタイミングで実行される_必要があります_。 時間はある程度重要ですが、クリティカルではありません。 最後に、モバイル アプリ通知などの他のコンポーネントです。これらはもう少し任意的になります。

ここでは、Azure で使用できる通信プラットフォームについて学習し、アプリケーションの各要件にあったプラットフォームを選択できるようにします。

## <a name="decide-between-messages-and-events"></a>メッセージとイベントを決定する

メッセージとイベントの両方が**データグラム**: 1 つのコンポーネントから別のコンポーネントに送信されたデータのパッケージ。 これらの違いは一見したところわずかなようですが、アプリケーションを設計する方法には大きな違いとなる場合があります。

### <a name="messages"></a>メッセージ

アプリケーションの全体的な整合性は受信するメッセージによって異なる場合があります。これは分散アプリケーションの用語において、メッセージの特性をよく表しています。 メッセージを送信することを、ワークフローのバトンを別のコンポーネントに渡す1つのコンポーネントとして考えることができます。 ワークフロー全体が重要なビジネス プロセスとなる可能性があり、メッセージはコンポーネントをまとめて保持するモルタルです。

一般的にメッセージはデータそのものを含み、(ID や URL のような) 単なるデータの参照ではありません。 データをデータグラムの一部として送信することは、参照を送信することよりも不安定さが軽減されます。 メッセージングのアーキテクチャではメッセージの配信が保証され、追加の参照は不要であるため、メッセージが確実に処理されます。 しかし、アプリケーションの送信では、含めるデータを正確に把握し、過度のデータ送信を回避する必要があるため、受信側のコンポーネントで不要な作業を行う必要があります。 このような意味で、メッセージの送信側と受信側は、多くの場合、厳格なデータ コントラクトで結合されます。

Contoso Slices の新しいアーキテクチャでは、ピザの注文を入力する場合、メッセージが使用されることが考えられます。 Web フロントエンドまたはモバイル アプリでは、バックエンド処理コンポーネントにメッセージが送信されます。 顧客の近くの店へのルーティングやクレジット カードへの課金などのバックエンドの手順が行われます。

### <a name="events"></a>イベント

イベントによって、何かが発生したことを知らせる通知がトリガーされます。 イベントはメッセージよりも "軽量" で、ほとんどの場合はブロードキャスト通信に使用されます。

イベントには次の特性があります。

* 送信されたイベントの受信者が複数のこともあれば、まったくいないこともあります。
* 多くの場合、イベントは "ファンアウト" を意図しています。つまり、パブリッシャーのそれぞれに対して多数のサブスクライバーが存在します。
* イベントのパブリッシャーは、受信側コンポーネントがどのようなアクションを実行するかについて何も想定していません。

ピザのチェーン店では、イベントを使用して状態変更をユーザーに通知することが考えられます。 状態変更イベントは、Azure Event Grid に送信でき、その後、Azure Functions、Azure Notification Hubs の順に送信され、完全に_サーバーレス_なソリューションが実現します。

通信プラットフォームは一般的にどちらか一方を処理するように設計されているため、このイベントとメッセージの違いは根本的なものです。 Service Bus はメッセージを処理するように設計されています。 イベントを送信する場合は、Event Grid を選択することが考えられます。

Azure には Azure Event Hubs もありますが、これは分析のために使用される通信の特定の種類の高フロー ストリームで使用されることがほとんどです。 たとえば、ピザ オーブンにネットワーク接続されたセンサーを取り付けていた場合、Azure Stream Analytics と結合された Event Hubs を使用して、望ましくない火災やコンポーネントの摩耗を示す可能性のある温度変化のパターンを監視できます。

## <a name="service-bus-topics-queues-and-relays"></a>Service Bus のトピック、キュー、リレー

Azure Service Bus では、キュー、トピック、およびリレーという 3 つの異なる方法でメッセージを交換することができます。

### <a name="what-is-a-queue"></a>キューとは

**キュー**はメッセージ用のシンプルな一時保存場所です。 コンポーネントを送信することで、キューにメッセージが追加されます。 送信先コンポーネントでは、キューの先頭にあるメッセージが取得されます。 通常の状況では、メッセージはそれぞれ 1 人の受信者のみが受信します。

![1 人の送信者がキューにメッセージを送信し、1 人の受信者がキューから 1 つずつメッセージを受信している、メッセージ キューの例を示す図。](../media/2-service-bus-queue.png)

キューでは、需要が高い状況から送信先コンポーネントを隔離するために、送信元と送信先のコンポーネントを分離します。 

ピーク時間帯では、送信先コンポーネントで処理できるよりも速くメッセージが着信する場合があります。 送信元コンポーネントは送信先に直接接続されないため、送信元が影響を受けることはなく、キューが増大します。 送信先コンポーネントでは、メッセージの処理が可能になると、キューからそのメッセージが削除されます。 混み具合が解消すると、送信先コンポーネントは追いつくことができ、キューが短くなります。

キューは、システムにリソースを追加することなく、このように込み合った状況に対応します。 ただし、比較的迅速に処理する必要があるメッセージについては、送信先コンポーネントにインスタンスを追加することで負荷を共有させることができます。 各メッセージは 1 つのインスタンスのみで処理されます。 これは、実際に必要なコンポーネントのみにリソースを追加しながら、アプリケーション全体をスケーリングする効果的な方法です。

### <a name="what-is-a-topic"></a>トピックとは

**トピック**はキューに似ていますが、複数のサブスクリプションを持つことができます。 つまり、複数の送信先コンポーネントは、1 つのトピックにサブスクライブできるため、各メッセージは複数の受信者に配信されます。 サブスクリプションでは、トピック内のメッセージをフィルター処理して関連するメッセージのみを受信することもできます。 サブスクリプションはキューと同じ分離された通信を提供し、込み合った状況にも同じ方法で対応します。 各メッセージを複数の送信先コンポーネントに配信する場合はトピックを使用します。

トピックは Basic 価格レベルではサポートされていません。

![1 人の送信者が、3 つのサブスクリプションを含むトピックを介して、複数の受信者にメッセージを送信しているようすを示す図。 これらのサブスクリプションは、関連メッセージを取得するために 3 人の受信者によって使用されます。](../media/2-service-bus-topic.png)

### <a name="what-is-a-relay"></a>リレーとは

**リレー**とは、アプリケーション間の同期双方向通信を実行するオブジェクトです。 キューやトピックのような、メッセージ用の一時保存場所ではありません。 代わりに、ファイアウォールなどのネットワーク境界越しにバッファーなしの双方向の接続が提供されます。 同じネットワーク セグメントに配置されているが、ネットワーク セキュリティ デバイスで区切られているかのように、コンポーネント間での直接通信する場合はリレーを使用します。

> [!NOTE]
> リレーは Azure Service Bus の一部ですが、疎結合メッセージング ワークフローは実装されず、このモジュールではこれ以上触れません。

## <a name="service-bus-queues-and-storage-queues"></a>Service Bus キューとストレージ キュー

メッセージ キューを含む Azure 機能には Service Bus と Azure ストレージ アカウントの 2 つがあります。 一般的なガイドとして、Service Bus キューに比べると、ストレージ キューの方が使用は簡単ですが、あまり洗練されておらず、柔軟性に欠けます。

Service Bus キューの主な利点は次のとおりです。

* 大きなメッセージ サイズ (メッセージあたり 64 KB に対して 256 KB) をサポートしています
* At-Least-Once と At-Most-Once の両方の配信がサポートされます。メッセージが失われるという極めて低い可能性と、メッセージが 2 回処理されるという極めて低い可能性のいずれかを選択できます
* **最初先出し (FIFO)** 順序を保証 - メッセージは追加された順序で処理されます (FIFO はキューの通常の動作ですが、すべてのメッセージに対して保証されるわけではありません)
* トランザクションに複数のメッセージをグループ化できます - トランザクションの 1 つのメッセージの配信に失敗すると、トランザクションのすべてのメッセージが配信されなくなります
* ロールベースのセキュリティをサポート
* 送信先コンポーネントで継続的にキューをポーリングする必要はありません

ストレージ キューの利点は次のとおりです。

* 無制限のキュー サイズがサポートされます (これに対して、Service Bus キューでは 80 GB に制限されています)
* すべてのメッセージのログが維持されます

## <a name="how-to-choose-a-communications-technology"></a>通信テクノロジを選択する方法

Azure が提供するまざまな概念と実装について説明しました。 ここからは通信毎に私たちの意思決定プロセスがどのようにあるべきかについて説明します。

#### <a name="consider-the-following-questions"></a>次のクエリについて考えてみましょう。

1. 通信はイベントですか?  そうである場合は、Event Grid または Event Hubs の使用を検討してください。

1. 単一のメッセージを複数の送信先に配信する必要がありますか?  必要がある場合は、Service Bus トピックを使用します。 それ以外の場合は、キューを使用します。

キューが必要であると判断した場合:

#### <a name="choose-service-bus-queues-if"></a>次の場合は、Service Bus キューを選択します。

* At-Most-Once 配信保証が必要である
* FIFO 保証が必要である
* メッセージをトランザクションにグループ化する必要がある
* キューをポーリングせずにメッセージを受信する必要がある
* キューへのロールベースのアクセスを提供する必要がある
* 64 KB より大きいが 256 KB よりも小さいメッセージを処理する必要がある
* キューのサイズが 80 GB より大きくなることはない
* バッチ メッセージを発行および使用できる必要がある

#### <a name="choose-queue-storage-if"></a>次の場合は、キュー ストレージを選択します。

* 特定の追加要件のないシンプルなキューが必要である
* キューを通ったすべてのメッセージの監査証跡が必要である
* キューのサイズが 80 GB を超えると予想される
* キュー内のメッセージ処理に関する進行状況を追跡する必要がある

分散アプリケーションのコンポーネントで直接通信できますが、多くの場合、Azure Service Bus や Azure Event Grid など、中間通信プラットフォームを使用してその通信の信頼性を高めることができます。

Event Grid はイベント向けに設計されており、イベントは受信者のみに通知され、そのイベントに関連付けられた生データは含まれません。 Azure Event Hubs は高フローの分析タイプ イベント向けに設計されています。 Azure Service Bus とストレージ キューはメッセージ用であり、アプリケーション ワークフローの中核部分をバインドするために使用できます。

要件がシンプルな場合、1 つの送信先のみに各メッセージを送信する場合、または可能な限り早くコードを記述する場合は、ストレージ キューが最適なオプションである可能性があります。 それ以外の場合、Service Bus キューによって、より多くのオプションや柔軟性が提供されます。

複数のサブスクライバーにメッセージを送信する場合は、Service Bus トピックを使用します。
