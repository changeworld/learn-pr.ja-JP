お客様の会社で、VM を使用して Azure 内の交通カメラからビデオ データを管理することになりました。 複数のコーデックを実行するために、まず VM を作成する必要があります。 また、VM に接続して操作する必要もあります。 このユニットでは、 Azure portal を使用して VM を作成する方法について説明します。 リモートアクセス用に VM を構成し、VM イメージを選択して、適切なストレージ オプションを選びます。

## <a name="introduction-to-windows-virtual-machines-in-azure"></a>Azure における Windows 仮想マシンの概要

Azure VM は、オンデマンドのスケーラブルなクラウド コンピューティング リソースです。 これは、Windows Hyper-V でホストされている仮想マシンと類似したものです。 これにはプロセッサ、メモリ、ストレージ、およびネットワーク リソースが含まれます。 Hyper-V のように自由に仮想マシンを開始および停止し、Azure portal から、または Azure CLI を使用して仮想マシンを管理できます。 また、リモート デスクトップ プロトコル (RDP) クライアントを使用して、ローカルの Windows コンピューターにサインインするのと同じように、直接 Windows デスクトップのユーザー インターフェイス (UI) に接続して VM を使用することもできます。

## <a name="creating-an-azure-vm"></a>Azure VM の作成

VM を定義して Azure にデプロイするには、いくつかの方法があります。つまり、Azure portal、スクリプト (Azure CLI または Azure PowerShell を使用)、Azure Resource Manager テンプレートのいずれかを使用します。 いずれの場合も、いくつかの情報を指定する必要があります。それについては、この後すぐに説明します。

Azure Marketplace には、OS と特定のシナリオ用にインストールされた一般的なソフトウェア ツールの両方を含む、事前構成済みのイメージも用意されています。

![Azure Marketplace の仮想マシン](../media-drafts/2-marketplace-vm-choices.png)

## <a name="resources-used-in-a-windows-vm"></a>Windows VM で使用されるリソース

Azure 内にWindows VM を作成する場合、VM をホストするためのリソースも作成します。 これらのリソースが連携することによってコンピューターが仮想化され、Windows オペレーティング システムが実行されます。 これらのリソースは、存在しているか (VM の作成時に選択します)、または VM と共に作成する必要があります。

- CPU とメモリリソースを提供する仮想マシン。
- 仮想ハード ディスクを保持する Azure Storage アカウント。
- OS、アプリケーション、およびデータを保持する仮想ディスク。
- 他の Azure サービスや独自のオンプレミスのハードウェアに VM を接続する仮想ネットワーク (VNet)。
- VNet と通信するためのネットワーク インターフェイス。
- VM にアクセスできるようにするためのパブリック IP アドレス。 これは省略可能です。

他の Azure サービスと同様に、VM を含む**リソース グループ**が必要になります (さらに、これらのリソースを管理するために必要に応じてグループ化します)。 新しい VM を作成する場合、既存のリソース グループを使用することも、新しいリソース グループを作成することもできます。

## <a name="choose-the-vm-image"></a>VM イメージを選択する

イメージの選択は、VM を作成するときに行う最初の最も重要な決定事項の 1 つです。 イメージとは、VM の作成に使用するテンプレートです。 これらのテンプレートには、OS と、多くの場合はその他のソフトウェア (開発ツールや Web ホスティング環境など) が含まれています。

コンピューターにインストールできるものはすべて、イメージに含めることができます。 イメージから VM を作成できます。このイメージは、ASP.Net Core アプリのホスティングなど、必要なタスクに対して正確に事前に構成されています。

> [!TIP]
> 独自のイメージをアップロードすることもできます。詳細については、ドキュメントを参照してください。

## <a name="sizing-your-vm"></a>VM のサイズを変更する
物理マシンに一定量のメモリや CPU 電源があるように、仮想マシンにも同様にあります。 Azure では、さまざまな価格ポイントで異なるサイズの VM が提供されます。 選択したサイズによって、VM の処理能力、メモリ、および最大ストレージ容量が決まります。

> [!WARNING]
> 各サブスクリプションには、VM の作成に影響するクォータ制限があります。 既定では、1 つのリージョン内のすべての VM 全体で、20 を超える数の仮想_コア_を使用することはできません。 VM を複数のリージョンに分割するか、制限を引き上げる[オンライン要求](https://docs.microsoft.com/azure/azure-supportability/resource-manager-core-quotas-request)を申請することができます。

VM のサイズは、基本的なテストと運用向けの B シリーズから、大規模なコンピューティング タスク向けの H シリーズまで、複数のカテゴリに分類されています。 実行する必要があるワークロードに基づいて VM サイズを選択する必要があります。 VM 作成後に VM のサイズを変更することは可能ですが、そのためにはまず VM を停止する必要があるので、可能であれば最初から適切なサイズを選択することをお勧めします。

#### <a name="here-are-some-guidelines-based-on-the-scenario-you-are-targeting"></a>対象となるシナリオに基づいたガイドラインを以下に示します。

| シナリオ | 考慮するサイズ
|-------|------------------|
| **汎用コンピューティング/Web**: テストと開発、小規模から中規模のデータベース、軽度から中程度のトラフィックの Web サーバー。 | B、Dsv3、Dv3、DSv2、Dv2 |
| **高負荷のコンピューティング タスク**中アクセス規模のウェブ サーバー、ネットワーク アプライアンス、バッチ処理、およびアプリケーション サーバー。 | Fsv2、Fs、F |
| **大容量のメモリ使用量**リレーショナル データベース サーバー、中規模から大規模のキャッシュ、およびメモリ内分析。 | Esv3、Ev3、M、GS、G、DSv2、Dv2 |
| **データ ストレージと処理**高いディスク スループットと IO を必要とするビッグ データ、SQL、NoSQL データベース。 | Ls |
| **負荷の高いグラフィックスのレンダリング**やビデオ編集、ディープ ラーニングを使用したモデル トレーニングと推論 (ND)。 | NV、NC、NCv2、NCv3、ND |
| **ハイ パフォーマンス コンピューティング (HPC)**: 高スループットのネットワーク インターフェイスのオプションを備えた、最も高速かつ強力な CPU 仮想マシンが必要な場合。 | H |

## <a name="choosing-storage-options"></a>ストレージ オプションを選択する

次にストレージに関する一連の決定事項を示します。 まず、ディスク テクノロジを選択することができます。 オプションには、従来の円盤状の記憶媒体ベースのハード ディスク ドライブ (HDD) や、より最新のソリッドステート ドライブ (SSD) が含まれます。 ハードウェアを購入する場合と同じように、SSD ストレージは高コストですがパフォーマンスに優れています。

> [!TIP]
> SSD ストレージには、standard と premium という 2 つのレベルがあります。 Standard SSD ディスクは、ワークロードは標準的であるが、パフォーマンスを向上させたい場合に選択します。 I/O 集中型ワークロードまたは非常に迅速にデータを処理する必要があるミッション クリティカルなシステムの場合は、Premium SSD ディスクを選択します。

### <a name="mapping-storage-to-disks"></a>ディスクへのストレージ のマッピング

Azure では、VM 用の物理ディスクを表すために仮想ハード ディスク (VHD) が使用されます。 VHD は、論理形式とディスク ドライブのデータをレプリケートしますが、Azure Storage アカウントにページ BLOB として格納されます。 ディスクごとに使用するストレージの種類（SSD または HDD）を選択することができます。 これにより、一般にはディスクで実行する予定の I/O に基づいて、各ディスクのパフォーマンスを制御することができます。

既定では、2 個の仮想ハード ディスク (VHD) が Windows VM に作成されます。

1. **オペレーティング システム ディスク**。 これはプライマリまたは C: ドライブであり、最大容量は 2048 GB です。

1. **一時ディスク**。 これは、OS または任意のアプリ用の、一時的なストレージを提供します。 既定では D: ドライブとして構成されており、VM サイズに基づいてサイズが決定します。そのため、Windows ページング ファイル用の場所として最適です。

> [!WARNING]
> 一時ディスクは永続的ではありません。 このディスクには、いつ失われてもかまわないデータのみを書き込むようにしてください。

#### <a name="what-about-data"></a>データについて。

データは、OS と一緒に C: ドライブに保存することもできますが、より優れたアプローチは、専用の_データ ディスク_を作成することです。 追加のディスクを作成して VM にアタッチできます。 各ディスクは最大 4095 GB のデータを保存でき、ストレージの最大容量は、選択した VM サイズによって決まります。

> [!NOTE]
> 興味深い機能として、実際のディスクから VHD イメージを作成する機能が挙げられます。 これによって、オンプレミスのコンピュータからクラウドへ、_既存の_情報を容易に移行できます。

### <a name="unmanaged-vs-managed-disks"></a>アンマネージドまたはマネージド ディスク

最後に行うストレージの選択は、**アンマネージド** ディスクを使用するか、または**マネージド** ディスクを使用するかです。

アンマネージド ディスクを使用する場合、VM ディスクに対応する VHD を保持するために使用するストレージ アカウントを自分で管理する必要があります。 使用するスペースの容量に対応したストレージ アカウント料金を支払うことになります。 1 つのストレージ アカウントには、I/O 操作数 20,000/秒という固定レート制限があります。これは、1 つのストレージ アカウントが最大スロットルで 40 個の標準仮想ハード ディスクをサポートできることを意味します。 スケールアウトを行う必要がある場合は、複数のストレージ アカウントが必要となります。これは複雑な状況をもたらす場合があります。

マネージド ディスクはより新しく、推奨されるディスク ストレージ モデルです。 Azure にストレージ アカウント管理の負荷を担わせることにより、この複雑性を適切に解決します。 ユーザーはディスクの種類 (Premium または Standard) とディスクのサイズを指定し、ディスクおよびディスク用ストレージの "_両方_" の作成と管理は Azure によって行われます。 ストレージ アカウントの制限について心配する必要はなく、これによりスケールアウトがより容易なものとなります。また、他にも様々な利点があります。

- **信頼性の向上**: Azure では、高信頼性の VM に関連付けられた VHD が Azure ストレージのさまざまな部分に配置されて、同等のレベルの回復力が提供されます。
- **セキュリティの向上**： マネージド ディスクは、リソースグループ内で実際に管理対象リソースとなります。 つまり、ロールベースのアクセス制御を使用して、VHD データを使用できるユーザーを制限することができます。
- **スナップショットサポート**： VHD の読み取り専用コピーの作成にスナップショットが利用可能です。 所有する VM をシャットダウンする必要がありますが、スナップショットの作成に要する時間はわずか数秒です。 完了したら VM の電源をオンにし、スナップショットを使って重複した VM を作成して、運用の問題のトラブルシューティングを行うことや、スナップショットが取得された特定の時点まで VM をロールバックすることができます。
- **バックアップのサポート**: Azure Backup を使用して、ディザスター リカバリーのために、マネージド ディスクを異なるリージョンに自動的にバックアップできます。VM のサービスに影響はありません。

## <a name="network-communication"></a>ネットワーク通信

仮想マシンは仮想ネットワーク（VNet）を用いて外部リソースと通信を行います。 VNet は、リソースが通信を行う単一領域内のプライベート ネットワークを表します。 仮想ネットワークは、ユーザーがオンプレミスで管理するネットワークと同じようなものです。 サブネットに分割してリソースを分離したり、他のネットワーク (オンプレミスのネットワークを含む) に接続したり、トラフィック規則を適用して受信および送信接続を管理したりできます。

### <a name="planning-your-network"></a>ネットワークの計画

新しい VM を作成するとき、新しい仮想ネットワークを作成するか、リージョン内の既存の VNet を使用するかを選択できます。

Azure によって VM とネットワークが作成されるようにすると簡単ですが、おそらくほとんどのシナリオにおいては最適ではありません。 アーキテクチャ内のすべてのコンポーネントに対するネットワーク要件を_前もって_計画し、必要な VNet 構造を別個に作成することをお勧めします。 その後、VM を作成して、既に作成されている VNet に配置します。

このモジュールでは、後でもう少し詳しく仮想ネットワークについて説明します。 それでは、今までに得た知識を活用して Azure 内に VM を作成しましょう。