ここまでで、カスタム ソフトウェアのインストール、FTP サーバーの設定、ビデオ ファイルを受信する VM の構成が完了しました。 ただし、FTP を使用してパブリック IP アドレスに接続しようとすると、その接続がブロックされることがわかります。 

オンプレミス環境内の機器では、サーバーの構成を調整することは、一般によく行われています。 この意味で、Azure VM はその環境の拡張機能だと考えることができます。 構成の変更、ネットワークの管理、トラフィックの開放またはブロックなどを、Azure portal、Azure CLI、または Azure PowerShell ツールを使って行うことができます。

仮想マシンの **[概要]** パネルに示される基本的な情報と管理オプションについては、既に確認しました。 ネットワーク構成をもう少し詳しく見ていきましょう。

## <a name="opening-ports-in-azure-vms"></a>Azure VM でポートを開く

既定では、新しい Vm をロック ダウンします。 

アプリは、発信方向の要求を行うことができますが、許可される受信トラフィックは、仮想ネットワーク (例: その他のリソースと同じローカル ネットワーク上)、および Azure のロード バランサー (プローブ チェック) から。

FTP をサポートする構成を調整するには、2 つのステップがあります。 新しい VM を作成するときに、いくつかの一般的なポート (RDP、HTTP、HTTPS、SSH) を開く機会があります。 ただし、ファイアウォールに対するその他の変更が必要な場合は、自分で行う必要があります。

このプロセスには、2 つのステップが含まれます。

1. ネットワーク セキュリティ グループを作成します。
2. アクティブ FTP をサポートするために、ポート 20 と 21 のトラフィックを許可する受信規則を作成します。

### <a name="what-is-a-network-security-group"></a>ネットワーク セキュリティ グループについて

Azure ネットワーク モデルの基盤である仮想ネットワーク (VNet) によって、分離と保護が提供されます。 ネットワーク セキュリティ グループ (NSG) は、ネットワーク レベルでネットワーク トラフィック規則を適用するために使う主なツールです。 NSG は、VNet 上で受信トラフィックと送信トラフィックをフィルター処理することによってソフトウェア ファイアウォールを提供する、オプションのセキュリティ レイヤーです。 

セキュリティ グループは、ネットワーク インターフェイス (ホストごとの規則) に関連付けるか、仮想ネットワーク内のサブネットに関連付けるか (複数のリソースに適用するため)、または両方のレベルに関連付けることができます。 

#### <a name="security-group-rules"></a>セキュリティ グループ規則

NGS では、_規則_を使って、ネットワークを経由して移動するトラフィックを許可または拒否します。 各規則は、ソースと宛先のアドレス (または範囲)、プロトコル、ポート (または範囲)、方向 (受信または送信)、数値の優先度を識別し、規則に合致するトラフィックを許可するか拒否するかを決定します。 次の図は、サブネットとネットワーク インターフェイスのレベルで適用された NSG 規則を示したものです。

![2 つの異なるサブネットでのネットワーク セキュリティ グループのアーキテクチャを示す図。 1 つのサブネットには 2 つの仮想マシンがあり、それぞれに独自のネットワーク インターフェイス規則があります。  サブネット自体には、両方の仮想マシンに適用される規則のセットがあります。](../media/7-nsg-rules.png)

各セキュリティ グループには既定のセキュリティ規則があり、上記で説明した既定のネットワーク規則が適用されます。 これらの既定の規則は変更できませんが、"_オーバーライド_" することはできます。

#### <a name="how-azure-uses-network-rules"></a>Azure によってネットワーク規則が使用される方法

受信トラフィックの場合は、サブネットに関連付けられているセキュリティ グループが処理され、次にネットワーク インターフェイスに適用されているセキュリティ グループが処理されます。 送信トラフィックは、逆の順番に処理されます (最初にネットワーク インターフェイス、その後にサブネット)。

> [!WARNING]
> 両方のレベルでセキュリティ グループはオプションであることに注意してください。 セキュリティ グループが適用されていない場合、Azure によって**すべてのトラフィックが許可されます**。 これは、VM にパブリック IP がある場合、特に OS に何らかのファイアウォールが用意されていない場合に、重大なリスクになる可能性があります。

規則は "_優先度順_" に評価されます (**最も低い優先度**の規則から開始されます)。 拒否規則は常に評価を**停止**します。 たとえば、送信要求がネットワーク インターフェイス規則によってブロックされている場合、サブネットに適用されている規則はチェックされません。 セキュリティ グループを経由するトラフィックが許可されるためには、適用されている "_すべての_" グループをトラフィックが通過する必要があります。

最後の規則は常に**すべて拒否**の規則です。 これは、受信トラフィックと送信トラフィックの両方を対象に、すべてのセキュリティ グループに優先度 65500 として追加される既定の規則です。 つまり、トラフィックがセキュリティ グループを通過するようにするには、"_許可規則_" を設定する必要があります。そうしないと、既定の最後の規則によってブロックされます。

> [!NOTE]
> SMTP (ポート 25) は特殊なケースであり、サブスクリプション レベルによって、およびアカウントがいつ作成されたかによって、送信 SMTP トラフィックがブロックされる可能性があります。 ビジネス上の妥当性がある場合には、この制限の解除を要求することができます。

この VM ではセキュリティ グループを作成しなかったため、作成して適用してみましょう。

## <a name="creating-network-security-groups"></a>ネットワーク セキュリティ グループの作成

セキュリティ グループは、Azure のほとんどすべてと同様の管理対象リソースです。Azure portal またはコマンド ライン スクリプト ツールを使用して作成することができます。 規則を定義することが課題になります。 FTP アクセスを許可する新しい規則の定義を見てみましょう。