<span data-ttu-id="9a7e0-101">社内のすべての VM に Azure Disk Encryption (ADE) を実装することに決まったとします。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-101">Suppose your company has decided to implement Azure Disk Encryption (ADE) across all VMs.</span></span> <span data-ttu-id="9a7e0-102">既存の VM ボリュームに暗号化をロールアウトする方法を評価する必要があります。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-102">You need to evaluate how to roll out encryption to existing VM volumes.</span></span>

<span data-ttu-id="9a7e0-103">ここでは、ADE の要件と、既存の Windows VM のディスクを暗号化するための手順を紹介します。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-103">Here, we'll look at the requirements for ADE, and the steps involved in encrypting disks on existing Windows VMs.</span></span>

## <a name="azure-disk-encryption-prerequisites"></a><span data-ttu-id="9a7e0-104">Azure Disk Encryption の前提条件</span><span class="sxs-lookup"><span data-stu-id="9a7e0-104">Azure Disk Encryption Prerequisites</span></span>

<span data-ttu-id="9a7e0-105">最初の VM ディスクを暗号化する前に、次を行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-105">Before you can encrypt your first VM disk, you need to</span></span>

1. <span data-ttu-id="9a7e0-106">キー コンテナーを作成する</span><span class="sxs-lookup"><span data-stu-id="9a7e0-106">Create a key vault</span></span>
1. <span data-ttu-id="9a7e0-107">Azure AD アプリケーションとサービス プリンシパルを設定する</span><span class="sxs-lookup"><span data-stu-id="9a7e0-107">Set up an Azure AD application and service principal</span></span>
1. <span data-ttu-id="9a7e0-108">Azure AD アプリのキー コンテナー アクセス ポリシーを設定する</span><span class="sxs-lookup"><span data-stu-id="9a7e0-108">Set the key vault access policy for the Azure AD app</span></span>
1. <span data-ttu-id="9a7e0-109">キー コンテナーの高度なアクセス ポリシーを設定する</span><span class="sxs-lookup"><span data-stu-id="9a7e0-109">Set key vault advanced access policies</span></span>

### <a name="azure-key-vault"></a><span data-ttu-id="9a7e0-110">Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="9a7e0-110">Azure Key Vault</span></span>

<span data-ttu-id="9a7e0-111">ADE によって使用される暗号化キーは、Azure Key Vault に格納できます。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-111">The encryption keys used by ADE can be stored in an Azure Key Vault.</span></span> <span data-ttu-id="9a7e0-112">Azure Key Vault は、シークレットを安全に保管し、それにアクセスするためのツールです。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-112">Azure Key Vault is a tool for securely storing and accessing secrets.</span></span> <span data-ttu-id="9a7e0-113">シークレットは、API キー、パスワード、証明書など、アクセスを厳密に制御する必要がある任意のものです。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-113">A secret is anything that you want to tightly control access to, such as API keys, passwords, or certificates.</span></span> <span data-ttu-id="9a7e0-114">これにより、Federal Information Processing Standards (FIPS) 140-2 レベル 2 で検証済みのハードウェア セキュリティ モジュール (HSM) において、可用性が高くスケーラブルで安全なストレージが提供されます。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-114">This provides highly available and scalable secure storage in Federal Information Processing Standards (FIPS) 140-2 Level 2 validated Hardware Security Modules (HSMs).</span></span> <span data-ttu-id="9a7e0-115">キー コンテナーを使用して、データの暗号化に使用されるキーを全面的に制御し、キーの使用方法を管理して監査できます。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-115">Using Key Vault, you keep full control of the keys used to encrypt your data, and you can manage and audit your key usage.</span></span> <span data-ttu-id="9a7e0-116">キー コンテナーの構成と管理には、Azure Portal、Azure PowerShell、および Azure CLI を使用します。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-116">You can configure and manage your key vault using the Azure portal, Azure PowerShell, and Azure CLI.</span></span>

>[!NOTE]
> <span data-ttu-id="9a7e0-117">Azure Disk Encryption では、暗号化シークレットがリージョン境界を超えないするため、キー コンテナーと VM が同じ Azure リージョンにあることが必要です。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-117">Azure Disk Encryption requires that your Key Vault and your VMs are in the same Azure region; this ensures that encryption secrets do not cross regional boundaries.</span></span>

### <a name="azure-ad-application-and-service-principal"></a><span data-ttu-id="9a7e0-118">Azure AD アプリケーションとサービス プリンシパル</span><span class="sxs-lookup"><span data-stu-id="9a7e0-118">Azure AD application and service principal</span></span>

<span data-ttu-id="9a7e0-119">スクリプトまたはコードを使用して、VM の暗号化構成などのリソースにアクセスしたり変更したりするには、まず、**Azure Active Directory (AD) アプリケーション** を設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-119">To access or modify resources, such as the encryption configuration for a VM with scripts or code, you must first set up an **Azure Active Directory (AD) application**.</span></span> <span data-ttu-id="9a7e0-120">Azure Active Directory (Azure AD) は、マルチテナントに対応したクラウドベースのディレクトリおよび ID 管理サービスで、中核となるディレクトリ サービス、アプリケーションのアクセス管理機能、ID の保護機能が 1 つのソリューションに統合されています。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-120">Azure Active Directory (Azure AD) is a multi-tenant, cloud-based directory, and identity management service that combines core directory services, application access management, and identity protection into a single solution.</span></span>

<span data-ttu-id="9a7e0-121">Azure **サービス プリンシパル**も必要になります。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-121">You'll also need an Azure **service principal**.</span></span> <span data-ttu-id="9a7e0-122">サービス プリンシパルは、スクリプトまたはコードを実行するために使用するサービス アカウントです。これによって、特定の Azure リソースに対してタスクを実行するために必要なアクセス許可とスコープを割り当てることができます。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-122">Service principals are the service accounts you use to run the script or code, and allow you to assign the specific permissions and scope that are needed to run the task against a particular Azure resource.</span></span>

<span data-ttu-id="9a7e0-123">Azure AD には 2 つの要素があります。アプリケーション オブジェクトはアプリケーションの**_定義_** です (どのようなアプリケーション化)。サービス プリンシパルはアプリケーションの**_特定のインスタンス_** です。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-123">There are two elements in Azure AD; the application object is the **_definition_** of the application (what it does), and the service principal is the **_specific instance_** of the application.</span></span>

<span data-ttu-id="9a7e0-124">この方法は**最小限の特権**の原則と一致しており、アプリに割り当てられるアクセス許可は、アプリがタスクを実行するための必要最小限に制限されます。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-124">This approach aligns with the principle of **least privilege**, where the permissions assigned to the app are restricted to the bare minimum required to enable the app to perform its tasks.</span></span>

<span data-ttu-id="9a7e0-125">Azure AD アプリケーションとサービス プリンシパルの構成と管理には、Azure Portal、Azure PowerShell、および Azure CLI を使用します。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-125">You can configure and manage Azure AD applications and service principals using the Azure portal, Azure PowerShell, and Azure CLI.</span></span>

### <a name="key-vault-access-policies"></a><span data-ttu-id="9a7e0-126">キー コンテナー アクセス ポリシー</span><span class="sxs-lookup"><span data-stu-id="9a7e0-126">Key vault access policies</span></span>

<span data-ttu-id="9a7e0-127">キー コンテナーに暗号化キーを格納するには、事前に、Azure Active Directory アプリケーションの**クライアント ID** と**クライアント シークレット**の詳細を ADE に指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-127">Before you can store encryption keys in a Key Vault, ADE requires details on the **Client ID** and the **Client Secret** of the Azure Active Directory application that is permitted to write to the Key Vault.</span></span>

<span data-ttu-id="9a7e0-128">キー コンテナー内の暗号化キーへのアクセス権を Azure に付与する必要もあります。これにより、ボリュームをブートして暗号化する際に、それらの情報を VM に提供できるようになります。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-128">You'll also need to provide Azure access to the encryption keys in your key vault, so they are made available to the VM for booting and decrypting the volumes.</span></span>

## <a name="set-key-vault-advanced-access-policies"></a><span data-ttu-id="9a7e0-129">キー コンテナーの高度なアクセス ポリシーを設定する</span><span class="sxs-lookup"><span data-stu-id="9a7e0-129">Set key vault advanced access policies</span></span>

<span data-ttu-id="9a7e0-130">**高度なアクセス ポリシー**を使用すると、キー コンテナーに対するディスク暗号化が可能になります。これを使用しないと、暗号化のデプロイが失敗します。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-130">**Advanced access policies** enable disk encryption on the key vault, and without them, encryption deployments will fail.</span></span> 

<span data-ttu-id="9a7e0-131">次の 3 つのポリシーを有効にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-131">There are three policies that need to be enabled:</span></span>

- <span data-ttu-id="9a7e0-132">**キー コンテナーのディスク暗号化**: Azure Disk Encryption で必須です。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-132">**Key Vault for disk encryption** Required for Azure Disk encryption.</span></span>
- <span data-ttu-id="9a7e0-133">**キー コンテナーのデプロイ**: Microsoft.Compute リソース プロバイダーが、キー コンテナーからシークレットを取得できるようになります。このポリシーは VM を作成するときに必要です。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-133">**Key Vault for deployment** Enables the Microsoft.Compute resource provider to retrieve secrets from the key vault; this policy is needed when creating a VM.</span></span>
- <span data-ttu-id="9a7e0-134">**キー コンテナーのテンプレートのデプロイ (必要な場合)**: Azure Resource Manager がこのキー コンテナーからシークレットを取得できるようになります。このポリシーは VM のデプロイ時に ARM を使用するときに必要です。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-134">**Key Vault for template deployment, if needed** Enables Azure Resource Manager to get secrets from the key vault; this policy is required when using ARM templates for VM deployment.</span></span>

<span data-ttu-id="9a7e0-135">キー コンテナー アクセス ポリシーの構成と管理には、Azure Portal、Azure PowerShell、または Azure CLI を使用します。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-135">Key vault access policies can be configured and managed using the Azure portal, Azure PowerShell, or the Azure CLI.</span></span>

### <a name="what-is-the-azure-disk-encryption-prerequisites-configuration-script"></a><span data-ttu-id="9a7e0-136">Azure Disk Encryption の前提条件構成スクリプトとは</span><span class="sxs-lookup"><span data-stu-id="9a7e0-136">What is the Azure Disk Encryption Prerequisites Configuration Script</span></span>

<span data-ttu-id="9a7e0-137">**Azure Disk Encryption の前提条件構成スクリプト**は、暗号化の前提条件をすべて (または必要なだけ) 設定します。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-137">The **Azure Disk Encryption Prerequisites Configuration Script** sets up all (or as many as you want) of the encryption prerequisites.</span></span> <span data-ttu-id="9a7e0-138">また、このスクリプトにより、暗号化しようとしている VM と同じリージョンにキー コンテナーが配置されます。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-138">The script also ensures that your Key Vault is in the same region as the VM you are going to encrypt.</span></span> <span data-ttu-id="9a7e0-139">これにより、リソース グループとキー コンテナーが作成され、キー コンテナーのアクセス ポリシーが設定されます。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-139">It will create a resource group, a key vault, and set the key vault access policy.</span></span> <span data-ttu-id="9a7e0-140">また、このスクリプトでは、誤って削除されるのを防ぐため、キー コンテナーに対するリソース ロックも作成されます。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-140">The script also creates a resource lock on the key vault to help protect it from accidental deletion.</span></span>

## <a name="encrypting-an-existing-vm-disk"></a><span data-ttu-id="9a7e0-141">既存の VM ディスクの暗号化</span><span class="sxs-lookup"><span data-stu-id="9a7e0-141">Encrypting an existing VM disk</span></span>

<span data-ttu-id="9a7e0-142">**Azure Disk Encryption 前提条件構成スクリプト**を使用して既存の VM ディスクを暗号化するには 2 つの手順があります。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-142">There are two steps for encrypting an existing VM disk, when using the **Azure Disk Encryption Prerequisites Configuration Script**:</span></span>

1. <span data-ttu-id="9a7e0-143">Azure Disk Encryption の前提条件構成スクリプトを実行します。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-143">Run the Azure disk encryption prerequisites configuration script.</span></span>
1. <span data-ttu-id="9a7e0-144">PowerShell で Azure 仮想マシンを暗号化します。</span><span class="sxs-lookup"><span data-stu-id="9a7e0-144">Encrypt the Azure virtual machine in PowerShell</span></span>
