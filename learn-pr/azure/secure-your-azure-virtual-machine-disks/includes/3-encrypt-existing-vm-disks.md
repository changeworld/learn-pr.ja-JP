社内のすべての VM に Azure Disk Encryption (ADE) を実装することに決まったとします。 既存の VM ボリュームに暗号化をロールアウトする方法を評価する必要があります。

ここでは、ADE の要件と、既存の Windows VM のディスクを暗号化するための手順を紹介します。

## <a name="azure-disk-encryption-prerequisites"></a>Azure Disk Encryption の前提条件

最初の VM ディスクを暗号化する前に、次を行う必要があります。

1. キー コンテナーを作成する
1. Azure AD アプリケーションとサービス プリンシパルを設定する
1. Azure AD アプリのキー コンテナー アクセス ポリシーを設定する
1. キー コンテナーの高度なアクセス ポリシーを設定する

### <a name="azure-key-vault"></a>Azure Key Vault

ADE によって使用される暗号化キーは、Azure Key Vault に格納できます。 Azure Key Vault は、シークレットを安全に保管し、それにアクセスするためのツールです。 シークレットは、API キー、パスワード、証明書など、アクセスを厳密に制御する必要がある任意のものです。 これにより、Federal Information Processing Standards (FIPS) 140-2 レベル 2 で検証済みのハードウェア セキュリティ モジュール (HSM) において、可用性が高くスケーラブルで安全なストレージが提供されます。 キー コンテナーを使用して、データの暗号化に使用されるキーを全面的に制御し、キーの使用方法を管理して監査できます。 キー コンテナーの構成と管理には、Azure Portal、Azure PowerShell、および Azure CLI を使用します。

>[!NOTE]
> Azure Disk Encryption では、暗号化シークレットがリージョン境界を超えないするため、キー コンテナーと VM が同じ Azure リージョンにあることが必要です。

### <a name="azure-ad-application-and-service-principal"></a>Azure AD アプリケーションとサービス プリンシパル

スクリプトまたはコードを使用して、VM の暗号化構成などのリソースにアクセスしたり変更したりするには、まず、**Azure Active Directory (AD) アプリケーション** を設定する必要があります。 Azure Active Directory (Azure AD) は、マルチテナントに対応したクラウドベースのディレクトリおよび ID 管理サービスで、中核となるディレクトリ サービス、アプリケーションのアクセス管理機能、ID の保護機能が 1 つのソリューションに統合されています。

Azure **サービス プリンシパル**も必要になります。 サービス プリンシパルは、スクリプトまたはコードを実行するために使用するサービス アカウントです。これによって、特定の Azure リソースに対してタスクを実行するために必要なアクセス許可とスコープを割り当てることができます。

Azure AD には 2 つの要素があります。アプリケーション オブジェクトはアプリケーションの**_定義_** です (どのようなアプリケーション化)。サービス プリンシパルはアプリケーションの**_特定のインスタンス_** です。

この方法は**最小限の特権**の原則と一致しており、アプリに割り当てられるアクセス許可は、アプリがタスクを実行するための必要最小限に制限されます。

Azure AD アプリケーションとサービス プリンシパルの構成と管理には、Azure Portal、Azure PowerShell、および Azure CLI を使用します。

### <a name="key-vault-access-policies"></a>キー コンテナー アクセス ポリシー

キー コンテナーに暗号化キーを格納するには、事前に、Azure Active Directory アプリケーションの**クライアント ID** と**クライアント シークレット**の詳細を ADE に指定する必要があります。

キー コンテナー内の暗号化キーへのアクセス権を Azure に付与する必要もあります。これにより、ボリュームをブートして暗号化する際に、それらの情報を VM に提供できるようになります。

## <a name="set-key-vault-advanced-access-policies"></a>キー コンテナーの高度なアクセス ポリシーを設定する

**高度なアクセス ポリシー**を使用すると、キー コンテナーに対するディスク暗号化が可能になります。これを使用しないと、暗号化のデプロイが失敗します。 

次の 3 つのポリシーを有効にする必要があります。

- **キー コンテナーのディスク暗号化**: Azure Disk Encryption で必須です。
- **キー コンテナーのデプロイ**: Microsoft.Compute リソース プロバイダーが、キー コンテナーからシークレットを取得できるようになります。このポリシーは VM を作成するときに必要です。
- **キー コンテナーのテンプレートのデプロイ (必要な場合)**: Azure Resource Manager がこのキー コンテナーからシークレットを取得できるようになります。このポリシーは VM のデプロイ時に ARM を使用するときに必要です。

キー コンテナー アクセス ポリシーの構成と管理には、Azure Portal、Azure PowerShell、または Azure CLI を使用します。

### <a name="what-is-the-azure-disk-encryption-prerequisites-configuration-script"></a>Azure Disk Encryption の前提条件構成スクリプトとは

**Azure Disk Encryption の前提条件構成スクリプト**は、暗号化の前提条件をすべて (または必要なだけ) 設定します。 また、このスクリプトにより、暗号化しようとしている VM と同じリージョンにキー コンテナーが配置されます。 これにより、リソース グループとキー コンテナーが作成され、キー コンテナーのアクセス ポリシーが設定されます。 また、このスクリプトでは、誤って削除されるのを防ぐため、キー コンテナーに対するリソース ロックも作成されます。

## <a name="encrypting-an-existing-vm-disk"></a>既存の VM ディスクの暗号化

**Azure Disk Encryption 前提条件構成スクリプト**を使用して既存の VM ディスクを暗号化するには 2 つの手順があります。

1. Azure Disk Encryption の前提条件構成スクリプトを実行します。
1. PowerShell で Azure 仮想マシンを暗号化します。
