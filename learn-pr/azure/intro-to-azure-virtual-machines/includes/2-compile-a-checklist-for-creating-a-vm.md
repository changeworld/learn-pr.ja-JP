オンプレミス サーバーから Azure への移行を実行するには、計画と考慮が必要です。 すべてを一度に移行することも、小さいバッチに分けることもできます。個別に移行することもできます。 VM を 1 つでも作成する前に、少し時間を取って現在のインフラストラクチャ モデルの概略を描き、そのモデルがクラウドにどのように対応するかを確認する必要があります。

考慮事項のチェックリストを見てみましょう。

- [ネットワークから始める](#Network)
- [VM に名前を付ける](#Name_VM)
- [VM の場所を決定する](#VM_Location)
- [VM のサイズを決定する](#VM_Size)
- [価格モデルについて理解する](#VM_Cost)
- [VM 用のストレージ](#VM_Storage)
- [オペレーティング システムを選択する](#VM_OS)

<a name="Network" />

## <a name="start-with-the-network"></a>ネットワークから始める

最初に考慮することは仮想マシンではなく、ネットワークです。

仮想ネットワーク (VNet) は、Azure において、Azure Virtual Machines と他の Azure サービスの間をプライベート接続で結ぶために使用されます。 同じネットワークの一部である VM とサービスの間では、相互アクセスが可能です。 既定では、仮想ネットワーク外部のサービスから、仮想ネットワーク内部のサービスへの接続はできません。 ただし、ネットワークは、オンプレミス サーバーを含む外部サービスへのアクセスを許可するように構成できます。

この後者のポイントが、ある程度時間をかけてネットワークの構成について考慮する必要がある理由になっています。 ネットワーク アドレスとサブネットは、いったん設定した後に変更するのは簡単ではありません。また、企業のプライベート ネットワークを Azure サービスに接続することを計画している場合は、VM を導入する前に必ずトポロジを考慮することをお勧めします。

仮想ネットワークを設定するときに、使用できるアドレス空間、サブネット、セキュリティを指定します。 VNet を他の VNet に接続する場合は、重複しないアドレス範囲を選択する必要があります。 この範囲が、ネットワーク内の VM とサービス用に使用できるプライベート アドレスの範囲です。 10.0.0.0/8、172.16.0.0/12、192.168.0.0/16 などのルーティング不可能な IP アドレスを使用するか、独自の範囲を定義することができます。 Azure では、どのアドレス範囲も、VNet 内、相互接続された VNet 内、オンプレミスの場所からのみ到達可能なプライベート VNet IP アドレス空間の一部として扱われます。 自分が内部ネットワークの担当者ではない場合、アドレス空間を選ぶ前に、内部ネットワークの担当者と協力して重複がないことを確認し、自分がどの空間を使用したいかを伝えて、自分以外の担当者が同じ範囲の IP アドレスを使わないようにする必要があります。

### <a name="segregate-your-network"></a>ネットワークの分離

仮想ネットワーク アドレス空間を決定した後、仮想ネットワークに 1 つまたは複数のサブネットを作成できます。 これを行う目的は、より管理しやすいセクションにネットワークを分割することです。 たとえば、10.1.0.0 を VM に、10.2.0.0 をバックエンド サービスに、10.3.0.0 を SQL Server VM に割り当てます。

> [!NOTE]
> 各サブネットの先頭から 4 個のアドレスと最後のアドレスは、Azure による使用のために予約されています。

### <a name="secure-the-network"></a>ネットワークのセキュリティ保護

既定ではサブネット間にセキュリティ境界がないため、各サブネットのサービスは互いに通信できます。 ただし、ネットワーク セキュリティ グループ (NSG) を設定して、サブネット間と VM 間のトラフィック フローを制御できます。 NSG は、ネットワーク インターフェイスとサブネット レベルで各受信要求または各送信要求にカスタム規則を適用することで、ソフトウェア ファイアウォールとして機能します。 これにより、VM に出入りするすべてのネットワーク要求を完全に制御できます。

## <a name="plan-each-vm-deployment"></a>各 VM デプロイの計画

通信とネットワークの要件を対応付けたら、作成する VM についての検討を開始できます。 進め方として、サーバーを選択し、次の点を点検することをお勧めします。

- サーバーの通信相手
- 開いているポート
- 使用する OS
- 使用中のディスク領域の量
- 使用するデータの種類 オンプレミスに存在しないことによる (法的またはその他の) 制約の有無
- サーバーの CPU、メモリ、ディスク I/O の負荷の種類 考慮する必要があるバースト トラフィックの有無

次に、Azure の側から見た新しい仮想マシンに関する質問への回答を始めることができます。

<a name="Name_VM" />

### <a name="name-the-vm"></a>VM に名前を付ける

VM の**名前**は、十分な考慮がなされないことが多い情報の 1 つです。 VM 名は、オペレーティング システムの一部として構成されるコンピューター名として使用されます。 Windows VM には最大 15 文字、Linux VM には最大 64 文字の名前を指定することができます。

また、これは管理可能な **Azure リソース**を定義する名前でもあり、後から変更するのは容易ではありません。 つまり、VM が何を行うのかを簡単に識別できるように、わかりやすく一貫性のある名前を選択する必要があります。 お勧めの規則は、名前に次の情報を含めることです。

| 要素 | 例 | メモ |
| --- | --- | --- |
| 環境 |dev、prod、QA |リソースの環境を識別 |
| 場所 |uw (米国西部)、ue (米国東部) |リソースのデプロイ先のリージョンを識別 |
| インスタンス |01、02 |複数の名前付きインスタンスが存在するリソースの場合 (Web サーバーなど) |
| 製品またはサービス |service |リソースがサポートする製品、アプリケーション、サービスを識別 |
| ロール |sql、web、messaging |関連付けられているリソースのロールを識別 | 

たとえば、`devusc-webvm01` は、米国中南部の場所でホストされている最初の開発 Web サーバーを表すことができます。 

#### <a name="what-is-an-azure-resource"></a>Azure リソースとは

**Azure リソース**とは Azure で管理可能な項目です。 データセンターの中にある物理コンピューターと同じように、VM には、ジョブを実行するために必要な複数の要素があります。

- VM 自体
- ディスク用のストレージ アカウント
- 仮想ネットワーク (他の VM およびサービスとの共有)
- ネットワークで通信するためのネットワーク インターフェイス
- ネットワーク トラフィックをセキュリティで保護するためのネットワーク セキュリティ グループ
- パブリック インターネット アドレス (オプション)

これらのすべてのリソースは、Azure によって必要に応じて作成されます。または、デプロイ プロセスの過程で既存のリソースを自分で指定できます。 各リソースには名前が必要です。名前はリソースを識別するために使用されます。 リソースが Azure によって作成される場合は、VM 名を使用してリソース名が生成されます。これは、VM 名との一貫性が高くなるもう 1 つの理由です。

<a name="VM_Location" />

### <a name="decide-the-location-for-the-vm"></a>VM の場所を決定する

Azure には、サーバーとディスクが配置されたデータセンターが世界中にあります。 それらのデータセンターは、地理的な "_リージョン_" ('米国西部'、'北ヨーロッパ'、'東南アジア' など) にグループ化されていて、冗長性と可用性が確保されています。

仮想マシンを作成してデプロイするときは、リソース (CPU、ストレージなど) を割り当てるリージョンを選択する必要があります。 これにより、ユーザーのできるだけ近くに VM を配置できるため、パフォーマンスを高め、法令、コンプライアンス、または税金の要件を満たすことができます。

<a name="VM_Size" />

### <a name="determine-the-size-of-the-vm"></a>VM のサイズを決定する

名前と場所を設定したら、VM のサイズを決定する必要があります。 Azure では、処理能力、メモリ、ストレージ容量を個別に指定するのではなく、これらの要素を異なるサイズのバリエーションで提供するさまざまな "_VM サイズ_" の中から選択するようになっています。 Azure には、広範囲の VM サイズ オプションが用意されていて、実行したいことに応じたコンピューティング能力、メモリ、ストレージの適切な組み合わせを選択します。

適切な VM サイズを決定する最良の方法は、VM で実行する必要があるワークロードの種類を考慮することです。 ワークロードに基づいて、利用可能な VM サイズのサブセットから選択することができます。 Azure のワークロードのオプションは、次のように分類されています。

| オプション              | 説明 |
|---------------------|-------------|
| **汎用** | 汎用 VM は、バランスの取れた CPU 対メモリ比を提供するように設計されています。 テストと開発、小規模から中規模のデータベース、軽度から中程度のトラフィックの Web サーバーに最適です。 |
| **コンピューティング最適化** | コンピューティング最適化 VM は、高い CPU 対メモリ比を提供するように設計されています。 トラフィックが中程度の Web サーバー、ネットワーク アプライアンス、バッチ処理、アプリケーション サーバーに適しています。 |
| **メモリ最適化** | メモリ最適化 VM は、高いメモリ対 CPU 比を提供するように設計されています。 リレーショナル データベース サーバー、中規模から大規模のキャッシュ、メモリ内分析に適しています。 |
| **ストレージ最適化** | ストレージ最適化 VM は、高いディスク スループットと IO を提供するように設計されています。 データベースを実行する VM に最適です。 |
| **GPU** | GPU VM は、負荷の高いグラフィックスのレンダリングやビデオ編集に特化した仮想マシンです。 これらの VM は、ディープ ラーニングを使用したモデル トレーニングと推論に最適なオプションです。 |
| **ハイ パフォーマンス コンピューティング** | ハイ パフォーマンス コンピューティングは、高スループットのネットワーク インターフェイスのオプションを備えた、最も高速かつ強力な CPU 仮想マシンです。 |

Azure で VM サイズを構成するとき、ワークロードの種類でフィルター処理することができます。 選択したサイズがサービスのコストに直接影響します。 より多くの CPU、メモリ、GPU が必要なほど、価格ポイントは高くなります。

<a name="VM_Cost" />

### <a name="understanding-the-pricing-model"></a>価格モデルについて理解する

どの VM の場合も、サブスクリプションに対してコンピューティングとストレージという 2 種類の別々のコストが課金されます。

**コンピューティング コスト** - コンピューティングの費用は、時間単位で課金されますが、分単位で請求されます。 たとえば、VM が 55 分間デプロイされていた場合、55 分間の使用に対してのみ課金されます。 VM を停止して割り当てを解除した場合、ハードウェアが解放されるため、コンピューティング能力については課金されません。 時間単位の料金は、選択した VM サイズと OS によって異なります。 VM のコストには、Windows オペレーティング システムの料金が含まれます。 オペレーティング システムのライセンス料金は発生しませんので、Linux ベースのインスタンスの費用が安くなります。

> [!TIP]
> **Azure ハイブリッド特典**により、Windows の既存のライセンスを再利用してコストを削減できる場合があります。

**ストレージ コスト** - VM で使用するストレージは別途課金されます。 VM の状態と、発生するストレージの料金は関係ありません。VM が停止または割り当て解除されていて、実行中の VM に対する課金が発生しない場合でも、ディスクに使用しているストレージは課金されます。

コンピューティング コストについては、2 つの支払いオプションから選ぶことができます。

| オプション | 説明 |
|--------|-------------|
| **従量課金制** | **従量課金制**オプションでは、コンピューティング容量に対して秒単位で支払います。長期契約や事前の支払いは不要です。 いつでも起動または停止できるだけでなく、需要に応じてコンピューティング容量を増やしたり減らしたりできます。 このオプションは、実行するアプリケーションのワークロードが短期間である場合、または予想不可能で中断が許容されない場合に適しています。 これは、たとえば VM で簡単なテストを行う場合やアプリを開発する場合に適したオプションです。 |
| **Reserved Virtual Machine Instances** | Reserved Virtual Machine Instances (RI) オプションは、特定のリージョンにおける 1 年間から 3 年間分の仮想マシンの予約購入です。 前払いでの契約により、重量課金制の料金に比べて最大 72% の割引が受けられます。 **RI** は柔軟性があり、簡単に交換することや、早期解約料金を支払って返却することができます。 VM を継続して実行する必要がある場合、または予算を予測できるようにする必要があり、**しかも** 少なくとも 1 年間は VM を使用する契約ができる場合は、このオプションが適しています。 |

<a name="VM_Storage" />

### <a name="storage-for-the-vm"></a>VM 用のストレージ

すべての Azure 仮想マシンには、少なくとも 2 個の仮想ハード ディスク (VHD) があります。 1 つ目のディスクにはオペレーティング システムが格納され、2 つ目のディスクは一時ストレージとして使用されます。 アプリケーションのデータを格納する追加のディスクを付加できます。最大数は、選択した VM サイズによって異なります (通常は CPU ごとに 2 個)。 特に OS ディスクが非常に小さくなる傾向があることから、1 つまたは複数のデータ ディスクを作成するのが一般的です。 また、データを他の VHD に分離することで、ディスクのセキュリティ、信頼性、パフォーマンスを別個に管理できます。

各 VHD のデータは、**Azure Storage** にページ BLOB として保持されます。これにより Azure では、使用するストレージに対してのみ領域が割り当てられます。 また、それはストレージ コストを測定する方法でもあります。使った分だけのストレージの料金を支払います。

#### <a name="what-is-azure-storage"></a>Azure Storage とは

Azure Storage は、Microsoft のクラウドベースのデータ ストレージ ソリューションです。 ほぼあらゆる種類のデータをサポートし、セキュリティ、冗長性、格納されたデータへのスケーラブルなアクセスを提供します。 ストレージ アカウントは、特定のサブスクリプション向けに、Azure Storage 内のオブジェクトへのアクセスを提供します。 VM には常に、接続された各仮想ディスクを保持するために、1 つまたは複数のストレージ アカウントを設定します。

仮想ディスクは、**Standard** または **Premium** ストレージ アカウントのいずれかで使用できます。 Azure Premium Storage は、ソリッド ステート ドライブ (SSD) を利用して、I/O を集中的に行うワークロードを実行する VM の高パフォーマンスと少ない待ち時間を実現します。 Azure Premium Storage は運用環境のワークロードに使用します。特に、パフォーマンスの変動の影響を受けやすいワークロードや、I/O を集中的に行うワークロードに向いています。 開発またはテスト用には、Standard ストレージで十分です。

ディスクを作成するとき、ストレージ アカウントと各 VHD との関係を管理するためのオプションが 2 つあります。 **アンマネージド ディスク**または**マネージド ディスク**。

| オプション | 説明 |
|--------|-------------|
| **アンマネージド ディスク** | アンマネージド ディスクを使用する場合、VM ディスクに対応する VHD を保持するために使用するストレージ アカウントを自分で管理する必要があります。 使用する領域の容量に対応したストレージ アカウントの料金を負担します。 1 つのストレージ アカウントには、I/O 操作数 20,000/秒という固定レート制限があります。これは、1 つのストレージ アカウントが最大使用率で 40 個の標準仮想ハード ディスクをサポートできることを意味します。 ディスクを増加してスケールアウトする必要がある場合は、ストレージ アカウントを増やす必要があり、複雑になる可能性があります。 |
| **マネージド ディスク** | マネージド ディスクは、**より新しい、お勧めのディスク ストレージ モデル**です。 ストレージ アカウントを管理する負担を Azure に移すことで、この複雑さを適切に解決します。 4 TB までのディスク サイズを指定します。Azure により、ディスクとストレージの "_両方_" が作成、管理されます。 ストレージ アカウント制限について気にする必要がないため、マネージド ディスクは簡単にスケールアウトできます。 |

<a name="VM_OS" />

### <a name="select-an-operating-system"></a>オペレーティング システムを選択する

Azure には、Windows の複数のバージョンと Linux の複数のフレーバーを含む、VM にインストールできるさまざまな OS イメージが用意されています。 既に説明したように、Azure では OS ライセンスのコストが価格に組み込まれているため、OS の選択は時間単位のコンピューティング価格に影響します。

求めているものが基本的な OS イメージだけではない場合は、Azure Marketplace で、OS と特定のシナリオ用にインストールされた一般的なソフトウェア ツールを含む、より高度なインストール イメージを検索できます。 たとえば、新しい WordPress サイトが必要な場合、標準的なテクノロジ スタックは Linux サーバー、Apache Web サーバー、MySQL データベース、PHP で構成されます。 各コンポーネントをセットアップして構成するのではなく、Marketplace イメージを利用して、そのスタック全体を一度にインストールできます。

最後に、適切な OS イメージが見つからない場合は、必要なものを含む自分のディスク イメージを作成して Azure ストレージにアップロードし、それを使用して Azure VM を作成できます。 Azure では 64 ビット オペレーティング システムのみがサポートされることに注意してください。