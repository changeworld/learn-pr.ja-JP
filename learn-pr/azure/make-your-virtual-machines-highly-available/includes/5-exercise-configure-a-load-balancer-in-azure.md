オンライン銀行アーキテクチャに関する重要なリソースを既に作成しました。 この演習では、セキュリティ設定の構成、バック エンド アドレス プール、正常性プローブ ルール、および負荷分散規則でセットアップを完了します。 セットアップが完了すると、プールから VM を削除して、この VM にクライアント要求を送信できなくするかを確認して、ロード バランサーをテストします。

## <a name="inbound-rules"></a>受信の規則

ポート 80 を使用するインバウンドの HTTP 接続を許可する、受信セキュリティ規則を作成します。

1. [Azure portal](https://portal.azure.com/?azure-portal=true)、左側のメニューでクリックして**すべてのリソース**します。 次に、リソースの一覧で次のようにクリックします。 **woodgrove NSG**します。

1. **Woodgrove NSG**ブレードで、**設定**、 をクリックして**受信セキュリティ規則**、順にクリックします**追加**します。

1. **受信セキュリティ規則の追加**ブレードで、次の情報を入力します。
    - ソース:**サービス タグ**
    - ソース サービス タグ:**インターネット**
    - ソース ポート範囲: **\***
    - 移行先:**任意**
    - 宛先ポート範囲: **80**
    - プロトコル: **TCP**
    - アクション:**を許可します。**
    - 優先順位: **100**
    - 名前: **woodgrove-HTTP の規則**

1. **[追加]** をクリックします。

ポート 3389 を使用する受信 RDP 接続を許可するように、受信セキュリティ規則を作成します。

1. **Woodgrove NSG の受信セキュリティ規則**ブレードで、をクリックして**追加**します。

1. **受信セキュリティ規則の追加**ブレードで、次の情報を入力します。
    - ソース:**サービス タグ**
    - ソース サービス タグ:**インターネット**
    - ソース ポート範囲: **\***
    - 移行先:**任意**
    - 宛先ポート範囲: **3389**
    - プロトコル: **TCP**
    - アクション:**を許可します。**
    - 優先順位: **200**
    - 名前: **woodgrove-RDP ルール**

1. **[追加]** をクリックします。

## <a name="prepare-a-script-to-install-and-configure-iis-on-the-vms"></a>インストールして、Vm 上で IIS を構成するスクリプトを準備します。

1. 次の PowerShell コマンドをテキスト エディターにコピーします。

    ```powershell
    # install IIS server role
    Install-WindowsFeature -name Web-Server -IncludeManagementTools

    # remove default htm file
    remove-item  C:\inetpub\wwwroot\iisstart.htm

    # Add a new htm file that displays server name
    Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Web page from <b>" + $env:computername + "</b>")
    ```

1. としてファイルをローカル保存**ConfigureIIS.ps1**します。

### <a name="install-and-configure-iis-on-vms"></a>インストールし、Vm で IIS を構成します。

1. 左側のメニューで、Azure portal で次のようにクリックします。**すべてのリソース**します。 次に、リソースの一覧で次のようにクリックします。 **woodgrove SVR01**します。

1. [概要] ページで、次のようにクリックします。 **Connect**します。

1. **仮想マシンへの接続**ブレードで、をクリックして**Download RDP File**します。 次に、ポップアップで、次のようにクリックします。**オープン**します。

1. **[リモート デスクトップ接続]** ウィンドウで **[接続]** をクリックします。

1. **Windows セキュリティ**ダイアログ ボックスで、をクリックして**より多くの選択肢**、順にクリックします**別のアカウントを使用して、** します。

1. **Windows セキュリティ**ダイアログ ボックスでは、Vm をプロビジョニングしたときに使用した資格情報を入力し、順にクリックします**OK**します。

1. 表示された場合、**リモート デスクトップ接続**証明書の警告をクリックします**はい**します。

1. ローカル コンピューターでは、スクリプトを含むフォルダーを開きます。

1. コピー **ConfigureIIS.ps1**をクリップボードにします。

1. RDP セッションに切り替えます。 Windows エクスプ ローラーを開きし、貼り付けます**ConfigureIIS.ps1**に**c:\\**します。

1. RDP セッションで次のようにクリックします。**開始**、を開き**Windows PowerShell**します。

1. PowerShell プロンプトで次のコマンドを入力し、キーを押します **」と入力します。**

    ```powershell
    cd \
    ```

1. PowerShell プロンプトで次のコマンドを入力し、キーを押します **」と入力します。**

    ```powershell
    .\ConfigureIIS.ps1
    ```

1. RDP 接続を閉じます。

1. 手順 1-13 の**woodgrove SVR02**と**woodgrove SVR03**します。

## <a name="create-a-back-end-address-pool"></a>バックエンド アドレス プールを作成する

次に、ポータルを使用してパブリック ロード バランサーのバックエンド アドレス プールを作成します。

1. 左側のメニューで、Azure portal で次のようにクリックします。**すべてのリソース**します。 次に、リソースの一覧で次のようにクリックします。 **woodgrove LB**します。

1. **Woodgrove LB**ブレードで、**設定**、 をクリックして**バックエンド プール**、順にクリックします**追加**します。

1. **バックエンド プールの追加**ブレードで、次の情報を追加します。
    - 名前: **woodgrove BEP**
    - 関連付けられている: 選択**可用性セット**
    - 可用性セット: **woodgrove-AS**

1. クリックして**ターゲット ネットワーク IP 構成の追加**します。 次に、**ターゲット仮想マシン**一覧で、 **woodgrove SVR01**します。 **ネットワーク IP 構成**一覧で、VM の IP アドレス プールを選択します。

1. クリックして**ターゲット ネットワーク IP 構成の追加**します。 その後、、**ターゲット仮想マシン**一覧で、 **woodgrove SVR02**、し、**ネットワーク IP 構成**一覧で、VM の IP アドレス プールを選択します。

1. クリックして**ターゲット ネットワーク IP 構成の追加**します。 その後、、**ターゲット仮想マシン**一覧で、 **woodgrove SVR03**、し、**ネットワーク IP 構成**一覧で、VM の IP アドレス プールを選択します。

1. **バックエンド プールの追加**ブレードで、をクリックして**OK**。

1. この演習に進む前に、ロード バランサーの構成が更新されるまで待ちます。

## <a name="create-a-health-probe-for-the-load-balancer"></a>Load balancer の正常性プローブを作成します。

次に、ポート 80 で HTTP の正常性プローブを追加します。

1. **Woodgrovelb**ブレードで、**設定**、 をクリックして**正常性プローブ**、順にクリックします**追加**します。

1. **正常性プローブの追加**ブレードで、次の情報を追加します。
    - 名前: **woodgrove HP**
    - プロトコル: **HTTP**
    - ポート: **80**
    - パス: **/**
    - 間隔: **15**
    - 異常のしきい値: **2**

1. **正常性プローブの追加**ブレードで、をクリックして**OK**します。

1. この演習に進む前に、ロード バランサーの構成が更新されるまで待ちます。

## <a name="create-a-load-balancer-rule"></a>ロード バランサー規則の作成

最後に、正常性プローブ、バックエンド プールに関連付けるポート 80 経由で HTTP の負荷分散ルールを作成します。

1. **Woodgrove LB**ブレードで、**設定**、 をクリックして**負荷分散規則**、順にクリックします**追加**します。

1. **負荷分散規則の追加**ブレードで、**名前**ボックスに「 **woodgrove-HTTP-LBRule**します。 次の情報が自動的に入力されたことを確認します。
    - IP バージョン: **IPv4**
    - フロント エンド IP アドレス: **LoadBalancerFrontEnd**
    - プロトコル: **TCP**
    - ポート: **80**
    - バック エンド ポート: **80**
    - バック エンド プール: **woodgrove BEP**
    - 正常性プローブ: **woodgrove HP**
    - セッション永続化:**なし**
    - アイドル タイムアウト: **4 分**
    - Floating IP:**無効になっています。**

1. **負荷分散規則の追加**ブレードで、をクリックして**OK**。

1. この演習に進む前に、ロード バランサーの構成が更新されるまで待ちます。

## <a name="test-the-load-balancer"></a>ロード バランサーをテストする

1. 左側のメニューで、Azure portal で次のようにクリックします。**すべてのリソース**、リソースの一覧をクリックして**woodgrove-ip LB**します。

1. **概要**ブレードで、 **IP アドレス**、順にクリックします、**コピー**ボタンをクリックします。

1. 新しいブラウザー タブでは、IP アドレス、ブラウザーのアドレス バーに貼り付けます。 サーバーの名前をメモし、このタブを開いたままにしておきます。

1. 左側のメニューで、Azure portal で次のようにクリックします。**すべてのリソース**します。 次に、リソースの一覧では、上でメモしたサーバーをクリックします。

1. **概要**ブレードで、をクリックして**停止**、順にクリックします**はい**。

1. VM が停止するまで待機し、手順 3 で表示 タブに切り替えます。 ページを更新します。

1. ロード バランサーは、その他の Vm のいずれかに、HTTP 要求を送信するはようになりました。

この演習では、バックエンド Vm とロード バランサーの展開を完了しました。
