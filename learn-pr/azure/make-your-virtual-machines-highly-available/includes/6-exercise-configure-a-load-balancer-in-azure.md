オンライン バンク アーキテクチャの主要なリソースを作成しました。 この演習では、負荷分散規則を構成し、セットアップを完了します。

セットアップが完了したら、プールから VM を削除し、その VM にクライアント要求が送信されなくなったことを確認するという手順でロード バランサーをテストします。

最初にロード バランサーでバックエンド プールを定義します。 これにより受信要求の経路が決定されます。

## <a name="create-a-backend-address-pool"></a>バックエンド アドレス プールの作成

1. [Azure portal](https://portal.azure.com/learn.docs.microsoft.com?azure-portal=true) で、左側のメニューにある **[すべてのリソース]** を選択します。 次に、リソースの一覧で、ロード バランサー (**woodgrove-LB**) を選択します。

1. **[設定]**、**[バックエンド プール]** の順に選択します。 まだ何も定義されていないことに注目してください。

1. **[追加]** をクリックし、新しいバックエンド プールを追加します。

    ![バックエンド プールの追加方法を示すスクリーンショット。](../media/6-backend-pools.png)

1. **[バックエンド プールの追加]** ブレードで、次の情報を追加します。
    - それに _woodgrove-BEP_ という名前を付けます。
    - **可用性セット**にプールを関連付けます。
    - 可用性セットについては、_[woodgrove-AS]_ を選択します。

1. **[ターゲット ネットワーク IP 構成の追加]** をクリックします。

1. **[ターゲット仮想マシン]** 一覧で、_[woodgrove-VM1]_ を選択します。

1. VM の **[ネットワーク IP 構成]** 一覧で、VM の IP アドレス プールを選択します。

1. 以上の手順を繰り返し、_[woodgrove-VM2]_ と _[woodgrove-VM3]_ をバックエンド プールに追加します。

    ![[バックエンド プールの追加] ブレードのスクリーンショット。VM が 3 つすべて選択されています。](../media/6-add-backend-pool.png)

1. **[OK]** をクリックしてブレードを閉じます。

ロード バランサーの構成が更新されるのを待ち、更新後、演習に進みます。

## <a name="create-a-health-probe-for-the-load-balancer"></a>ロード バランサーの正常性プローブを作成する

次に、ポート 80 で HTTP に対して正常性プローブを追加します。

1. **[woodgrove-LB]** ブレードの **[設定]** で **[正常性プローブ]** をクリックします。 現在のところ、空になっていることに注目してください。

1. **[追加]** をクリックして新しい正常性プローブを追加します。

1. **[正常性プローブの追加]** ブレードで、次の構成を設定します。
    - **名前:** _woodgrove-HP_
    - **プロトコル:** _HTTP_
    - **ポート:** _80_
    - **パス:** _/_
    - **間隔:** _15_
    - **異常なしきい値:** _2_

1. **[OK]** をクリックして変更を保存します。

ロード バランサーの構成が更新されるのを待ち、更新後、演習に進みます。

## <a name="create-a-load-balancer-rule"></a>ロード バランサー規則の作成

最後に、バックエンド プールを正常性プローブに関連付ける HTTP の負荷分散規則をポート 80 で作成します。

1. **[woodgrove-LB]** ブレードの **[設定]** で、**[負荷分散規則]** をクリックします。

1. **[追加]** をクリックして新しい規則を追加します。

1. **[負荷分散規則の追加]** ブレードで **[名前]** を _woodgrove-HTTP-LBRule_ にします。

1. 以下の情報が自動的に入力されていることを確認します。
    - IP バージョン: **IPv4**
    - フロントエンド IP アドレス: **LoadBalancerFrontEnd**
    - プロトコル: **TCP**
    - ポート: **80**
    - バックエンド ポート: **80**
    - バックエンド プール: **woodgrove-BEP**
    - 正常性プローブ: **woodgrove-HP**
    - セッション永続化: **なし**
    - アイドル タイムアウト: **4 分**
    - Floating IP: **無効**

1. **[OK]** をクリックして規則を保存します。

ロード バランサーの構成が更新されるのを待ち、更新後、演習に進みます。

## <a name="test-the-load-balancer"></a>ロード バランサーをテストする

1. ロード バランサーの **[概要]** ページに切り替え、そのページの **[パブリック IP アドレス]** リンクをクリックし、割り当てられている IP アドレスを表示します。 あるいは、**[すべてのリソース]** を使用し、リソースの一覧で **[woodgrove-LB-ip]** を選択できます。

1. **[概要]** ブレードで **[IP アドレス]** を選択し、その隣にある **[コピー]** ボタンをクリックします。 これはロード バランサーの_パブリック_ IP アドレスです。

    ![パブリック IP アドレスの概要パネルを示すスクリーンショット](../media/6-public-ip.png)

1. 新しいブラウザー タブを開き、ブラウザーのアドレス バーに IP アドレスを貼り付けます。 サーバーの名前を書き留めます。このタブは開いたままにしておいてください。

1. Azure portal で、左側のメニューの **[すべてのリソース]** をクリックします。 次に、リソース リストで、先ほど書き留めたサーバーをクリックします。

1. **[概要]** ブレードで **[停止]** をクリックし、**[はい]** をクリックします。

1. VM が停止するまで待って、手順 3. で表示したタブに切り替えます。 ページを更新します。

1. これでロード バランサーは HTTP 要求を他のいずれかの VM に送信するようになりました。

この演習では、バックエンド VM とロード バランサーのデプロイを完了しました。
