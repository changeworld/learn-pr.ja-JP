<span data-ttu-id="d6f0a-101">オンプレミス環境内の機器では、サーバーの構成を調整することは、一般によく行われています。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-101">Making adjustments to server configuration is commonly performed with equipment in your on-premises environment.</span></span> <span data-ttu-id="d6f0a-102">この意味で、Azure VM はその環境の拡張機能だと考えることができます。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-102">In this sense, you can consider Azure VMs to be an extension of that environment.</span></span> <span data-ttu-id="d6f0a-103">構成の変更、ネットワークの管理、トラフィックの開放またはブロックなどを、Azure portal、Azure CLI、または Azure PowerShell ツールを使って行うことができます。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-103">You can alter configuration, manage networks, open or block traffic, and more through the Azure portal, the Azure CLI, or Azure PowerShell tools.</span></span>

<span data-ttu-id="d6f0a-104">サーバーは実行中の状態で、Apache はインストールされ、ページを提供しています。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-104">We've got our server running, and Apache is installed and serving up pages.</span></span> <span data-ttu-id="d6f0a-105">当社のセキュリティ チームは、すべてのサーバーをロック ダウンすることを必須にしていますが、この VM にはまだ何もしていません。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-105">Our security team mandates that we lock down all our servers, and we've not done anything to this VM yet.</span></span> <span data-ttu-id="d6f0a-106">何も実行していないので、Apache はまだポート 80 をリッスンできます。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-106">We didn't do anything, and it let Apache listen on port 80.</span></span> <span data-ttu-id="d6f0a-107">Azure のネットワーク構成を調べ、組み込みのセキュリティ サポートを使用してサーバーを強化する方法を見てみましょう。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-107">Let's explore the Azure network configuration to see how to use the built-in security support to harden our server.</span></span>

## <a name="opening-ports-in-azure-vms"></a><span data-ttu-id="d6f0a-108">Azure VM でポートを開く</span><span class="sxs-lookup"><span data-stu-id="d6f0a-108">Opening ports in Azure VMs</span></span>

<span data-ttu-id="d6f0a-109">既定では、新しい VM はロック ダウンされます。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-109">By default, new VMs are locked down.</span></span> 

<span data-ttu-id="d6f0a-110">アプリは発信要求を行うことはできますが、許可される受信トラフィックは、仮想ネットワーク (同じローカル ネットワーク上の他のリソースなど) と Azure Load Balancer (プローブ チェック) からのものだけです。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-110">Apps can make outgoing requests, but the only inbound traffic allowed is from the virtual network (e.g., other resources on the same local network) and from Azure Load Balancer (probe checks).</span></span>

<span data-ttu-id="d6f0a-111">ネットワーク上の複数のプロトコルをサポートするように構成を調整するには、2 つの手順があります。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-111">There are two steps to adjusting the configuration to support different protocols on the network.</span></span> <span data-ttu-id="d6f0a-112">新しい VM を作成するときに、いくつかの一般的なポート (RDP、HTTP、HTTPS、SSH) を開く機会があります。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-112">When you create a new VM, you have an opportunity to open a few common ports (RDP, HTTP, HTTPS, and SSH).</span></span> <span data-ttu-id="d6f0a-113">ただし、ファイアウォールに対するその他の変更が必要な場合は、手動で調整する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-113">However, if you require other changes to the firewall, you will need to adjust them manually.</span></span>

<span data-ttu-id="d6f0a-114">このプロセスには、2 つのステップが含まれます。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-114">The process for this involves two steps:</span></span>

1. <span data-ttu-id="d6f0a-115">ネットワーク セキュリティ グループを作成します。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-115">Create a network security group.</span></span>
2. <span data-ttu-id="d6f0a-116">必要なポートでのトラフィックを許可する受信規則を作成します。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-116">Create an inbound rule allowing traffic on the ports you need.</span></span>

### <a name="what-is-a-network-security-group"></a><span data-ttu-id="d6f0a-117">ネットワーク セキュリティ グループとは</span><span class="sxs-lookup"><span data-stu-id="d6f0a-117">What is a network security group?</span></span>

<span data-ttu-id="d6f0a-118">Azure ネットワーク モデルの基盤である仮想ネットワーク (VNet) によって、分離と保護が提供されます。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-118">Virtual networks (VNets) are the foundation of the Azure networking model and provide isolation and protection.</span></span> <span data-ttu-id="d6f0a-119">ネットワーク セキュリティ グループ (NSG) は、ネットワーク レベルでネットワーク トラフィック規則を適用するために使う主要なツールです。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-119">Network security groups (NSGs) are the primary tool you use to enforce and control network traffic rules at the networking level.</span></span> <span data-ttu-id="d6f0a-120">NSG は、VNet 上で受信トラフィックと送信トラフィックをフィルター処理することによってソフトウェア ファイアウォールを提供する、オプションのセキュリティ レイヤーです。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-120">NSGs are an optional security layer that provides a software firewall by filtering inbound and outbound traffic on the VNet.</span></span> 

<span data-ttu-id="d6f0a-121">セキュリティ グループは、ネットワーク インターフェイス (ホストごとの規則) に関連付けるか、仮想ネットワーク内のサブネットに関連付けるか (複数のリソースに適用するため)、または両方のレベルに関連付けることができます。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-121">Security groups can be associated to a network interface (for per host rules), a subnet in the virtual network (to apply to multiple resources), or both levels.</span></span> 

#### <a name="security-group-rules"></a><span data-ttu-id="d6f0a-122">セキュリティ グループ規則</span><span class="sxs-lookup"><span data-stu-id="d6f0a-122">Security group rules</span></span>

<span data-ttu-id="d6f0a-123">NGS では、_規則_を使って、ネットワークを経由して移動するトラフィックを許可または拒否します。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-123">NGSs use _rules_ to allow or deny traffic moving through the network.</span></span> <span data-ttu-id="d6f0a-124">各規則は、ソースと宛先のアドレス (または範囲)、プロトコル、ポート (または範囲)、方向 (受信または送信)、数値の優先度を識別し、規則に合致するトラフィックを許可するか拒否するかを決定します。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-124">Each rule identifies the source and destination address (or range), protocol, port (or range), direction (inbound or outbound), a numeric priority, and whether to allow or deny the traffic that matches the rule.</span></span>

![<span data-ttu-id="d6f0a-125">2 つの異なるサブネットでのネットワーク セキュリティ グループのアーキテクチャを示す図。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-125">An illustration showing the architecture of network security groups in two different subnets.</span></span> <span data-ttu-id="d6f0a-126">1 つのサブネットには 2 つの仮想マシンがあり、それぞれに独自のネットワーク インターフェイス規則があります。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-126">In one subnet, there are two virtual machines, each with their own network interface rules.</span></span>  <span data-ttu-id="d6f0a-127">サブネット自体には、両方の仮想マシンに適用される規則のセットがあります。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-127">The subnet itself has a set of rules that applies to both the virtual machines.</span></span> ](../media/7-nsg-rules.png)

<span data-ttu-id="d6f0a-128">各セキュリティ グループには既定のセキュリティ規則があり、上記で説明した既定のネットワーク規則が適用されます。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-128">Each security group has a set of default security rules to apply the default network rules described above.</span></span> <span data-ttu-id="d6f0a-129">これらの既定の規則は変更できませんが、"_オーバーライド_" することはできます。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-129">These default rules cannot be modified but _can_ be overridden.</span></span>

#### <a name="how-azure-uses-network-rules"></a><span data-ttu-id="d6f0a-130">Azure によってネットワーク規則が使用される方法</span><span class="sxs-lookup"><span data-stu-id="d6f0a-130">How Azure uses network rules</span></span>

<span data-ttu-id="d6f0a-131">受信トラフィックの場合は、サブネットに関連付けられているセキュリティ グループが処理され、次にネットワーク インターフェイスに適用されているセキュリティ グループが処理されます。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-131">For inbound traffic, Azure processes the security group associated to the subnet and then the security group applied to the network interface.</span></span> <span data-ttu-id="d6f0a-132">送信トラフィックは、逆の順番に処理されます (最初にネットワーク インターフェイス、その後にサブネット)。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-132">Outbound traffic is handled in the opposite order (the network interface first, followed by the subnet).</span></span>

> [!WARNING]  
> <span data-ttu-id="d6f0a-133">両方のレベルでセキュリティ グループはオプションであることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-133">Keep in mind that security groups are optional at both levels.</span></span> <span data-ttu-id="d6f0a-134">セキュリティ グループが適用されていない場合、Azure によって**すべてのトラフィックが許可されます**。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-134">If no security group is applied, then **all traffic is allowed** by Azure.</span></span> <span data-ttu-id="d6f0a-135">これは、VM にパブリック IP がある場合、特に OS に組み込みのファイアウォールが用意されていない場合に、重大なリスクになる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-135">If the VM has a public IP, this could be a serious risk, particularly if the OS doesn't provide a built-in firewall.</span></span>

<span data-ttu-id="d6f0a-136">規則は "_優先度順_" に評価されます (**最も低い優先度**の規則から開始されます)。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-136">The rules are evaluated in _priority order_, starting with the **lowest priority** rule.</span></span> <span data-ttu-id="d6f0a-137">拒否規則は常に評価を**停止**します。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-137">Deny rules always **stop** the evaluation.</span></span> <span data-ttu-id="d6f0a-138">たとえば、送信要求がネットワーク インターフェイス規則によってブロックされている場合、サブネットに適用されている規則はチェックされません。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-138">For example, if a network interface rule blocks an outbound request, any rules applied to the subnet will not be checked.</span></span> <span data-ttu-id="d6f0a-139">セキュリティ グループを経由するトラフィックが許可されるためには、適用されている_すべての_グループをトラフィックが通過する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-139">For traffic to be allowed through the security group, it must pass through _all_ applied groups.</span></span>

<span data-ttu-id="d6f0a-140">最後の規則は常に**すべて拒否**の規則です。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-140">The last rule is always a **Deny All** rule.</span></span> <span data-ttu-id="d6f0a-141">これは、受信トラフィックと送信トラフィックの両方を対象に、すべてのセキュリティ グループに優先度 65500 として追加される既定の規則です。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-141">This is a default rule added to every security group for both inbound and outbound traffic with a priority of 65500.</span></span> <span data-ttu-id="d6f0a-142">つまり、トラフィックがセキュリティ グループを通過するようにするには、"_許可規則_" を設定する必要があります。そうしないと、既定の最後の規則によってブロックされます。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-142">That means to have traffic pass through the security group, _you must have an allow rule_, or the final default rule will block it.</span></span>

> [!NOTE]  
> <span data-ttu-id="d6f0a-143">SMTP (ポート 25) は特殊なケースです。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-143">SMTP (port 25) is a special case.</span></span> <span data-ttu-id="d6f0a-144">サブスクリプション レベルによって、およびアカウントがいつ作成されたかによって、送信 SMTP トラフィックがブロックされる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-144">Depending on your subscription level and when your account was created, outbound SMTP traffic may be blocked.</span></span> <span data-ttu-id="d6f0a-145">ビジネス上の妥当性がある場合には、この制限の解除を要求することができます。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-145">You can request to remove this restriction with business justification.</span></span>

<span data-ttu-id="d6f0a-146">この VM ではセキュリティ グループを作成しなかったため、作成して適用してみましょう。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-146">Since we didn't create a security group for this VM, let's do that and apply it.</span></span>

## <a name="creating-network-security-groups"></a><span data-ttu-id="d6f0a-147">ネットワーク セキュリティ グループの作成</span><span class="sxs-lookup"><span data-stu-id="d6f0a-147">Creating network security groups</span></span>

<span data-ttu-id="d6f0a-148">セキュリティ グループは、Azure のほとんどすべてと同様の管理対象リソースです。Azure portal またはコマンド ライン スクリプト ツールを使用して作成することができます。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-148">Security groups are managed resources like most everything in Azure; you can create them in the Azure portal or through command-line scripting tools.</span></span> <span data-ttu-id="d6f0a-149">規則を定義することが課題になります。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-149">The challenge is in defining the rules.</span></span> <span data-ttu-id="d6f0a-150">HTTP アクセスを許可し、他のすべてをブロックする新しい規則を定義する方法を見てみましょう。</span><span class="sxs-lookup"><span data-stu-id="d6f0a-150">Let's look at defining a new rule to allow HTTP access and block everything else.</span></span>