オンプレミス環境内の機器では、サーバーの構成を調整することは、一般によく行われています。 この意味で、Azure VM はその環境の拡張機能だと考えることができます。 構成を変更したり、ネットワーク、オープンまたはトラフィックをブロックして、Azure portal、Azure CLI、または Azure PowerShell ツールによって管理できます。

サーバーは実行中の状態で、Apache はインストールされ、ページを提供しています。 セキュリティ チームには、こと、すべてのサーバーをロックダウンしまだ行っていないんこの VM にまだが定められています。 何も実行していないので、Apache はまだポート 80 をリッスンできます。 Azure のネットワーク構成を調べ、組み込みのセキュリティ サポートを使用してサーバーを強化する方法を見てみましょう。

## <a name="opening-ports-in-azure-vms"></a>Azure VM でポートを開く

既定では、新しい Vm をロック ダウンします。 

アプリは、発信方向の要求を行うことができますが、許可される受信トラフィックは、仮想ネットワーク (同じローカル ネットワーク上のリソースなど) および Azure Load Balancer (プローブ チェック) から。

ネットワーク上の複数のプロトコルをサポートするように構成を調整するには、2 つの手順があります。 新しい VM を作成するときに、いくつかの一般的なポート (RDP、HTTP、HTTPS、SSH) を開く機会があります。 ただし、ファイアウォールに対するその他の変更が必要な場合は、手動で調整する必要があります。

このプロセスには、2 つのステップが含まれます。

1. ネットワーク セキュリティ グループを作成します。
2. 必要なポートでのトラフィックを許可する受信規則を作成します。

### <a name="what-is-a-network-security-group"></a>ネットワーク セキュリティ グループとは何ですか。

Azure ネットワーク モデルの基盤である仮想ネットワーク (VNet) によって、分離と保護が提供されます。 ネットワーク セキュリティ グループ (Nsg) は、適用および制御のネットワーク レベルでネットワーク トラフィック規則を使用するプライマリ ツールです。 NSG は、VNet 上で受信トラフィックと送信トラフィックをフィルター処理することによってソフトウェア ファイアウォールを提供する、オプションのセキュリティ レイヤーです。 

セキュリティ グループのネットワーク インターフェイスに関連付けることができます (のホストの規則に従って)、(複数のリソースに適用されます) を仮想ネットワーク内のサブネットまたは 2 つのレベル。 

#### <a name="security-group-rules"></a>セキュリティ グループ規則

NGS では、_規則_を使って、ネットワークを経由して移動するトラフィックを許可または拒否します。 各規則は、ソースと宛先のアドレス (または範囲)、プロトコル、ポート (または範囲)、方向 (受信または送信)、数値の優先度を識別し、規則に合致するトラフィックを許可するか拒否するかを決定します。

![2 つの異なるサブネットでのネットワーク セキュリティ グループのアーキテクチャを示す図。 1 つのサブネットには 2 つの仮想マシンがあり、それぞれに独自のネットワーク インターフェイス規則があります。  サブネット自体には、両方の仮想マシンに適用される規則のセットがあります。 ](../media/7-nsg-rules.png)

各セキュリティ グループには既定のセキュリティ規則があり、上記で説明した既定のネットワーク規則が適用されます。 これらの既定の規則を変更することはできませんが、_できます_をオーバーライドします。

#### <a name="how-azure-uses-network-rules"></a>Azure によってネットワーク規則が使用される方法

受信トラフィックは、セキュリティ グループがサブネットとし、セキュリティ グループに関連付けられている Azure のプロセスは、ネットワーク インターフェイスに適用されます。 送信トラフィックは、逆の順番に処理されます (最初にネットワーク インターフェイス、その後にサブネット)。

> [!WARNING]  
> 両方のレベルでセキュリティ グループはオプションであることに注意してください。 セキュリティ グループが適用されていない場合、し**のすべてのトラフィックが許可されている**Azure によって。 VM にパブリック IP がある場合は、られます、深刻なリスク、OS は、組み込みのファイアウォールを提供しない場合に特にです。

ルールの評価では_優先順位_以降の**最も低い優先順位**ルール。 拒否規則は常に評価を**停止**します。 たとえば、送信要求がネットワーク インターフェイス規則によってブロックされている場合、サブネットに適用されている規則はチェックされません。 セキュリティ グループを経由するトラフィックが許可されるためには、適用されている_すべての_グループをトラフィックが通過する必要があります。

最後の規則は常に**すべて拒否**の規則です。 これは、受信トラフィックと送信トラフィックの両方を対象に、すべてのセキュリティ グループに優先度 65500 として追加される既定の規則です。 トラフィック、セキュリティ グループを通過することを意味する_許可規則があります_、または最後の既定のルールがブロックされます。

> [!NOTE]  
> SMTP (ポート 25) では、特殊なケースです。 によって、サブスクリプション レベルと、アカウントの作成時に、送信 SMTP トラフィックをブロックする可能性があります。 ビジネス上の妥当性がある場合には、この制限の解除を要求することができます。

この VM ではセキュリティ グループを作成しなかったため、作成して適用してみましょう。

## <a name="creating-network-security-groups"></a>ネットワーク セキュリティ グループの作成

セキュリティ グループは、Azure のほとんどすべてと同様の管理対象リソースです。Azure portal またはコマンド ライン スクリプト ツールを使用して作成することができます。 規則を定義することが課題になります。 HTTP アクセスを許可し、他のすべてをブロックする新しい規則を定義する方法を見てみましょう。