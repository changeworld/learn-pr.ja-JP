ローカルの Ubuntu Linux サーバーで実行中の既存のWeb サイトが存在しています。 最新の Ubuntu イメージを使って Azure 仮想マシン（VM）を作成し、サイトをクラウドへ移行することが目標です。 このユニットでは、Azure で仮想マシンを作成する際に決定が必要になるオプションについて学習します。

## <a name="introduction-to-azure-virtual-machines"></a>Azure Virtual Machines の概要

Azure VM は、オンデマンドのスケーラブルなクラウド コンピューティング リソースです。 プロセッサ、メモリ、ストレージ、およびネットワーク リソースが含まれます。 自由に仮想マシンを開始および停止し、Azure portal から、または Azure CLI を使用して仮想マシンを管理できます。 また、リモート Secure Shell (SSH) を使用して実行中の VM に直接接続し、ローカル コンピューターの場合と同じようにコマンドを実行することもできます。

### <a name="running-linux-in-azure"></a>Azure での Linux の実行

Azure で Linux ベースの VM を作成することは簡単です。 Microsoft は主要な Linux ベンダーと提携し、ディストリビューションが Azure プラットフォーム用に確実に最適化されるようにしています。 SUSE、Red Hat、Ubuntu などのさまざまな人気のある Linux ディストリビューションの事前構築済みイメージから仮想マシンを作成することも、クラウドで実行するように独自の Linux ディストリビューションを構築することもできます。

## <a name="creating-an-azure-vm"></a>Azure VM の作成

VM は、Azure Portal、スクリプト（Azure CLI または Azure PowerShell を使用）、または Azure Resourse Manager テンプレートなどの複数の方法で Azure での定義およびデピロイが行えます。 いずれの場合も、いくつかの情報を指定する必要があります。それについては、この後すぐに説明します。

Azure Marketplace には、OS と特定のシナリオ用にインストールされた人気のあるソフトウェア ツールの両方を含む、事前構成済みのイメージも用意されています。

![Azure Marketplace の仮想マシン](../media-drafts/2-marketplace-vm-choices.png)

## <a name="resources-used-in-a-linux-vm"></a>Linux VM で使用されるリソース

Azure で Linux VM を作成する場合、VM をホストするためにリソースも作成します。 これらのリソースが連携することによってコンピューターが仮想化され、Linux オペレーティング システムが実行されます。 これらのリソースは、存在しているか (VM の作成時に選択します)、または VM と共に作成する必要があります。

- CPU およびメモリリソースを提供する仮想マシン
- 仮想ハード ディスクを保持する Azure Storage アカウント
- OS、アプリケーション、およびデータを保持する仮想ディスク
- 他の Azure サービスやオンプレミスのハードウェアに VM を接続する仮想ネットワーク (VNet)
- VNet と通信するためのネットワーク インターフェイス
- VM へのアクセスを可能にする省略可能なパブリック IP アドレス

他の Azure サービスと同じように、VM を格納する (および、必要に応じて管理のためにこれらのリソースをグループ化する) ための**リソース グループ**が必要です。 新しい VM を作成する場合、既存のリソース グループを使用することも、新しいリソース グループを作成することもできます。

## <a name="choose-the-vm-image"></a>VM イメージを選択する

イメージの選択は、VM を作成するときに行う最初の最も重要な決定事項の 1 つです。 イメージとは、VM の作成に使用するテンプレートです。 これらのテンプレートには、OS と、多くの場合はその他のソフトウェア (開発ツールや Web ホスティング環境など) が含まれています。

コンピューターにインストールできるものはすべて、イメージに含めることができます。 Apache サーバーでの Web アプリのホスティングなど、必要なタスクに正確に対応するように事前構成されたイメージから、VM を作成できます。

> [!TIP]
> カスタム ディスク イメージを作成してアップロードすることもできます。詳しくは、ドキュメントをご覧ください。

## <a name="sizing-your-vm"></a>VM のサイズ設定
物理マシンに一定量のメモリや CPU 電源があるように、仮想マシンにも同様にあります。 Azure では、さまざまな価格ポイントで異なるサイズの VM が提供されます。 選択したサイズによって、VM の処理能力、メモリ、および最大ストレージ容量が決まります。

> [!WARNING]
> 各サブスクリプションには、VM の作成に影響するクォータ制限があります。 既定では、1 つのリージョン内のすべての VM 全体で、20 を超える数の仮想_コア_を使用することはできません。 領域にまたがる VM を分割するか、制限を引き上げる[オンライン リクエスト](https://docs.microsoft.com/azure/azure-supportability/resource-manager-core-quotas-request)を送信することができます。

VM のサイズは、基本的なテストと運用向けの B シリーズから、大規模なコンピューティング タスク向けの H シリーズまで、複数のカテゴリに分類されています。 実行するワークロードに基づいて VM のサイズを選択する必要があります。 VM 作成後に VM のサイズを変更することは可能ですが、そのためにはまず VM を停止する必要があるので、可能であれば最初から適切なサイズを選択することをお勧めします。

#### <a name="here-are-some-guidelines-based-on-the-scenario-you-are-targeting"></a>対象とするシナリオに基づいたガイドラインを以下に示します。

| 操作内容 | 考慮するサイズ
|-------|------------------|
| **汎用コンピューティング/Web**: テストと開発、小規模から中規模のデータベース、軽度から中程度のトラフィックの Web サーバー。 | B、Dsv3、Dv3、DSv2、Dv2 |
| **高負荷のコンピューティング タスク**中アクセス規模のウェブ サーバー、ネットワーク アプライアンス、バッチ処理、およびアプリケーション サーバー。 | Fsv2、Fs、F |
| **大容量のメモリ使用量**リレーショナル データベース サーバー、中規模から大規模のキャッシュ、およびメモリ内分析。 | Esv3、Ev3、M、GS、G、DSv2、Dv2 |
| **データ ストレージと処理**高いディスク スループットと IO を必要とするビッグ データ、SQL、NoSQL データベース。 | Ls |
| **負荷の高いグラフィックスのレンダリング**やビデオ編集、ディープ ラーニングを使用したモデル トレーニングと推論 (ND)。 | NV、NC、NCv2、NCv3、ND |
| **ハイ パフォーマンス コンピューティング (HPC)**: 高スループットのネットワーク インターフェイスのオプションを備えた、最も高速かつ強力な CPU 仮想マシンが必要な場合。 | H |

## <a name="choosing-storage-options"></a>ストレージ オプションを選択する

次にストレージに関する一連の決定事項を示します。 まず、ディスク テクノロジを選択することができます。 オプションには、従来の円盤状の記憶媒体ベースのハード ディスク ドライブ (HDD) や、より最新のソリッドステート ドライブ (SSD) が含まれます。 ハードウェアを購入する場合と同じように、SSD ストレージは高コストですがパフォーマンスに優れています。

> [!TIP]
> SSD ストレージには、standard と premium という 2 つのレベルがあります。 Standard SSD ディスクは、ワークロードは標準的であるが、パフォーマンスを向上させたい場合に選択します。 I/O 集中型ワークロードまたは非常に迅速にデータを処理する必要があるミッション クリティカルなシステムの場合は、Premium SSD ディスクを選択します。

### <a name="mapping-storage-to-disks"></a>ディスクへのストレージ のマッピング

Azure では、VM 用の物理ディスクを表すために仮想ハード ディスク (VHD) が使用されます。 VHD は、論理形式とディスク ドライブのデータをレプリケートしますが、Azure Storage アカウントにページ BLOB として格納されます。 ディスクごとに使用するストレージの種類（SSD または HDD）を選択することができます。 これにより、一般にはディスクで実行する予定の I/O に基づいて、各ディスクのパフォーマンスを制御することができます。

既定では、2 個の仮想ハード ディスク (VHD) が Linux VM に作成されます。

1. **オペレーティング システム ディスク**。 これはプライマリ ドライブであり、最大容量は 2,048 GB です。 既定のラベルは `/dev/sda` です。

1. **一時ディスク**。 このディスクは、OS またはアプリ用の一時的なストレージを提供します。 Linux 仮想マシンでは、このディスクは `/dev/sdb` であり、Azure Linux エージェントによりフォーマットされて、`/mnt` にマウントされます。 サイズは、VM のサイズに基づいて設定され、スワップ ファイルの格納に使用されます。 

> [!WARNING]
> 一時ディスクは永続的ではありません。 このディスクには、システムにとって重大ではないデータのみを書き込む必要があります。

#### <a name="what-about-data"></a>データについて

プライマリ ドライブに OS だけでなくデータを格納することもできますが、専用の "_データ ディスク_" を作成する方がよい方法です。 追加のディスクを作成して VM にアタッチできます。 各ディスクは最大 4095 GB のデータを保存でき、ストレージの最大容量は、選択した VM サイズによって決まります。

> [!NOTE]
> 興味深い機能として、実際のディスクから VHD イメージを作成する機能が挙げられます。 これによって、オンプレミスのコンピュータからクラウドへ、_既存の_情報を容易に移行できます。

### <a name="unmanaged-vs-managed-disks"></a>アンマネージド vs マネージド ディスク

最後に行うストレージの選択は、**アンマネージド** ディスクを使用するか、または**マネージド** ディスクを使用するかです。

アンマネージド ディスクを使用する場合、VM ディスクに対応する VHD を保持するために使用するストレージ アカウントを自分で管理する必要があります。 使用するスペースの容量に対応したストレージ アカウント料金を支払うことになります。 1 つのストレージ アカウントには、I/O 操作数 20,000/秒という固定レート制限があります。これは、1 つのストレージ アカウントが最大スロットルで 40 個の標準仮想ハード ディスクをサポートできることを意味します。 スケールアウトを行う必要がある場合は、複数のストレージ アカウントが必要となります。これは複雑な状況をもたらす場合があります。

マネージド ディスクはより新しく、推奨されるディスク ストレージ モデルです。 ストレージ アカウントを管理する負担を Azure に移すことで、この複雑さを適切に解決します。 ユーザーはディスクの種類 (Premium または Standard) とディスクのサイズを指定し、ディスクとそれが使用するストレージ "_両方_" の作成と管理は Azure によって行われます。 ストレージ アカウント制限について気にする必要がないため、簡単にスケールアウトできます。また、他にも様々な利点があります。

- **信頼性の向上**: Azure では、高信頼性の VM に関連付けられた VHD が Azure ストレージのさまざまな部分に配置されて、同等のレベルの回復力が提供されます。
- **セキュリティの向上**: マネージド ディスクは、リソース グループ内の実際の管理対象リソースです。 つまり、ロールベースのアクセス制御を使用して、VHD データを使用できるユーザーを制限することができます。
- **スナップショットサポート**： VHD の読み取り専用コピーの作成にスナップショットが利用可能です。 所有している VM をシャットダウンする必要がありますが、スナップショットの作成に要する時間はわずか数秒です。 完了したら、VM の電源を入れ、スナップショットを使用して重複する VM を作成し、運用環境の問題をトラブルシューティングしたり、スナップショットが作成された時点に VM をロールバックしたりできます。
- **バックアップのサポート**: Azure Backup を使用して、ディザスター リカバリーのために、マネージド ディスクを異なるリージョンに自動的にバックアップできます。VM のサービスに影響はありません。

## <a name="network-communication"></a>ネットワーク通信

仮想マシンは仮想ネットワーク（VNet）を用いて外部リソースと通信を行います。 VNet は、リソースが通信を行う単一領域内のプライベート ネットワークを表します。 仮想ネットワークは、ユーザーがオンプレミスで管理するネットワークと同じようなものです。 サブネットに分割してリソースを分離したり、他のネットワーク (オンプレミスのネットワークを含む) に接続したり、トラフィック規則を適用して受信および送信接続を管理したりできます。

### <a name="planning-your-network"></a>ネットワークの計画

新しい VM を作成するときは、新しい仮想ネットワークの作成、またはリージョン内の既存の VNet の使用を選択できます。

VM と一緒に Azure でネットワークを自動的に作成するとシンプルですが、ほとんどのシナリオに適していない可能性が高くなります。 アーキテクチャ内のすべてのコンポーネントに対するネットワーク要件を_前もって_計画し、必要な VNet 構造を別個に作成することをお勧めします。 その後、VM を作成して、既に作成されている VNet に配置します。 このモジュールでは、後で詳しく仮想ネットワークについて説明します。

仮想マシンを作成する前に、VM の望ましい管理方法を決定する必要があります。 そのオプションを見てみましょう。