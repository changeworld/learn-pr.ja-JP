この演習では、ASP.NET Core アプリケーションを Azure にアップロードします。

## <a name="create-a-staging-deployment-slot"></a>ステージング デプロイ スロットを作成する

1. 左側のナビゲーションで **[デプロイ スロット]** メニュー項目を見つけてクリックします。

1. 次に示すように **[デプロイ スロット]** ブレードが開きます。

    ![デプロイ スロット](../media-draft/7-deployment-slot-blade.png)

1. [デプロイ スロット] ブレードの上部ナビゲーション バーで **[+ スロットの追加]** ボタンを見つけてクリックします。

1. 次に示すような **[スロットの追加]** ブレードが開きます。

    ![スロットの追加](../media-draft/7-new-deployment-slot-blade.png)

    デプロイ スロットの名前を指定します。 この例では、**Staging** という名前を使用します。

    **[構成のソース]** を選択するには、2 つのオプションがあります。

    1. 他のスロットから、または Azure で作成された Web アプリから、構成要素を選択して複製します。

    1. 複製しない構成要素を選択できます。 この例では、**[既存のスロットから構成を複製しない]** オプションを選択します。

    2 番目のオプション **[既存のスロットから構成を複製しない]** を選択します。

1. ブレードの下部にある **[OK]** ボタンをクリックします。

1. デプロイ スロットが正常に作成されると、Web アプリの **[デプロイ スロット]** ブレードに表示が戻ります。

    ここで、先ほど作成した新しいデプロイ スロットを確認できます。

    ![作成されたデプロイ スロット](../media-draft/7-deployment-slot-created.png)

1. 新しいデプロイ スロットを探してクリックします。

1. 新しく作成されたデプロイ スロットの **[概要]** ページに表示が変わります。

    ![ステージング デプロイ スロット](../media-draft/7-deployment-slot-staging.png)

    ステージング デプロイ スロットの **URL** に注意してください。 このユニットを始めるときに見たものとまったく同じ URL です。

    デプロイ スロットは、Azure 内の Web アプリとして扱われます。 ただし、元の Web アプリの子という特別な種類であり、元の Web アプリとスワップすることができます。

    **URL** をクリックすると、Azure portal で初めて作成した Web アプリに対して Azure で作成されたものと同じ既定のページが表示されます。

ステージング デプロイ スロットが正常に作成されたので、次に、**デプロイ資格情報**を構成する必要があります。

## <a name="create-deployment-credentials"></a>デプロイ資格情報を作成する

Azure では、実際のデプロイ プロセスを始める前に、デプロイ資格情報を設定する必要があります。 そのため、独自のデプロイ資格情報を作成する方法を学習します。

1. 左側のナビゲーションで **[デプロイ資格情報]** メニュー項目を見つけてクリックします。

1. 次に示すような **[デプロイ資格情報]** ブレードに表示が変わります。

    ![デプロイ資格情報](../media-draft/7-deployment-credentials.png)

    適切な**ユーザー名**と**パスワード**を入力し、パスワードをもう一度入力して確認します。

    > 忘れないように、ユーザー名とパスワードを書き留めておきます。 後で Azure へのコードのアップロードとデプロイを始めるときに必要になります。

    ユーザー名とパスワードを決めた後、**[デプロイ資格情報]** ブレードの上部にある **[保存]** ボタンをクリックします。

デプロイ資格情報が正常に作成されたので、次に、**デプロイ オプション**を構成する必要があります。

## <a name="use-a-local-git-repository-as-your-deployment-option"></a>デプロイ オプションとしてローカル Git リポジトリを使用する

ここでは、コードのアップロード プロセスを開始できるように、Azure にローカル Git リポジトリを作成します。

1. 左側のナビゲーションで **[デプロイ オプション]** メニュー項目を見つけてクリックします。

1. 次に示すような **[デプロイ オプション]** ブレードに表示が変わります。

    ![デプロイ オプション](../media-draft/7-deployment-options.png)

1. **[ソースの選択] > [必要な設定の構成]** をクリックします。

    ![デプロイ資格情報](../media-draft/7-deployment-sources.png)

1. 構成して使用できるオプションが表示されます。 この例では、**[ローカル Git リポジトリ]** オプションを選択します。

    ![ローカル Git リポジトリ](../media-draft/7-local-git-repo.png)

1. ブレードの下部にある **[OK]** ボタンをクリックします。

1. 左側のナビゲーションで **[概要]** メニュー項目を見つけてクリックします。

    ![Git が構成されたデプロイ スロット](../media-draft/7-staging-after-setting-git.png)

    2 つの重要な情報に注意してください。
    - **[Git/デプロイメント ユーザー名]**: 後で Azure 上のローカル Git リポジトリに接続するときに使用する資格情報です。

    - **[Git クローン URL]**: ローカル Web アプリケーション リポジトリに対する**リモート**として使用するローカル Git リポジトリの URL です。

ここで、ステージング デプロイ スロットへのコードのアップロードを始めます。

## <a name="install-git-on-your-machine"></a>コンピューターに Git をインストールする

Ubuntu 18.04 コンピューターに Git をインストールします。

1. 新しい**ターミナル** ウィンドウを開きます。

1. 次のコマンドを入力します。 Ubuntu のユーザー パスワードの入力を求めるプロンプトが表示されます。

    ```console
    sudo apt-get update
    ```

1. 更新が成功したら、次のコマンドを入力して Git をローカルにインストールします。 コンピューターへの Git のインストールに同意するように求められます。

    ```console
    sudo apt-get install git-core
    ```

1. Git がインストールされたことを確認するには、次のコマンドを入力します。

    ```console
    git --version
    ```

   インストールが成功した場合、次の出力が表示されます。

    ```console
    git version 2.17.1
    ```

1. ユーザーの名前とメール アドレスを提供することで、Git の設定を構成するのが常によい方法です。 そのためには、次のコマンドを発行する必要があります。名前とメール アドレスのプレースホルダーを置き換えます。中かっこ (`{}`) は省きます。

    ```console
    git config --global user.name "{your name}"
    git config --global user.email "{your email}"
    ```

1. Git によってユーザーの情報が記録されたことを確認するには、次のコマンドを入力します。

    ```console
    cat ~/.gitconfig
    ```

   次のように、名前とメール アドレスが表示されるはずです。

    ```console
    [user]
        name = {your name}
        email = {your email}
    ```

## <a name="initialize-a-local-git-repository-for-your-web-app"></a>Web アプリ用にローカル Git リポジトリを初期化する

Git を使い始めるには、Web アプリ用にローカル Git リポジトリを初期化する必要があります。

1. 新しい**ターミナル** ウィンドウを開きます。

1. Web アプリのコンテンツ ルート フォルダーに移動します。 次のように入力します。

    ```console
    cd ~/Documents/BestBikeApp/
    ```

    ![Web アプリのコンテンツ ルート フォルダー](../media-draft/7-web-app-content-root-folder.png)

1. 次のコマンドを発行して、新しい Git リポジトリを初期化します。

    ```console
    git init
    ```

    コマンドが成功すると、次のようなメッセージが表示されます。

    ```console
    Initialized empty Git repository in /home/your-user/Documents/BestBikeApp/.git/
    ```

1. すべての Web アプリ ファイルを Git にステージングします。

   次に、Git に Web アプリ ファイルを認識させます。 そのためには、Git によって**ステージング**されるように、作業ディレクトリのすべてのファイルを追加します。 次のコマンドを入力します。

    ```console
    git add .
    ```

    上のコマンドでは、"." によって表されるすべてのファイルが、Git のステージング状態に追加されます。

1. 次に、Git に変更をコミットする必要があります。

   Git にファイルをステージングした後は、ローカル コンピューター上の **Git コミット履歴**にファイルをコミットする必要があります。 そのためには、次のコマンドを入力します。

   `git commit -m "Initial create"`

   `commit` コマンドでは、作成しているコミットに関するメッセージを含めるための `-m` 引数が受け付けられます。 後で、コードを Azure にプッシュするときに、この特定のコミットに格納されている同じメッセージを見ることができます。

## <a name="add-a-remote-for-the-local-git-repository"></a>ローカル Git リポジトリに対するリモートを追加する

この時点では、新しいローカル Git リポジトリが正常に初期化されています。 さらに、すべての Web アプリ ファイルを Git にコミットしてあります。 残っているのは、ローカル Git リポジトリを Azure でホストされているリポジトリに接続するための**リモート**を追加することです。

そのためには、以下のことを行う必要があります。

1. 前の手順で表示された **Git クローン URL** をコピーします。

1. コピーした後、**ターミナル** ウィンドウに戻り、次の Git コマンドを発行します。

    ```console
    git remote add origin https://BESTBIKE-git@BESTBIKE-staging.scm.azurewebsites.net:443/BESTBIKE.git
    ```

    上の Git コマンドでは、ローカル Git リポジトリが Azure でホストされているリポジトリにフックされます。 これで、ローカル Git リポジトリとリモート Git リポジトリの間でプッシュとプルを始めることができます。

1. 上記のコマンドを確認するには、次の Git コマンドを入力します。

    ```
    git remote -v
    ```

    上のコマンドでは、次の出力が生成されます。

    ```console
    origin  https://BESTBIKE-git@BESTBIKE-staging.scm.azurewebsites.net:443/BESTBIKE.git (fetch)
    origin  https://BESTBIKE-git@BESTBIKE-staging.scm.azurewebsites.net:443/BESTBIKE.git (push)
    ```

## <a name="push-your-code-to-azure"></a>コードを Azure にプッシュする

ローカル Git リポジトリを Azure 上のリモート Git リポジトリにフックしたので、アプリを開発してビルドした後、Azure に Web アプリをプッシュします。

1. **master** ブランチを Azure 上のリモート Git リポジトリにプッシュするには、次の Git コマンドを入力します。

    ```console
    git push origin master
    ```

1. 前に **[デプロイ資格情報]** セクションで構成したパスワードの入力を求められます。 パスワードを入力して Enter キーを押します。 Git で、ステージング デプロイ スロットに構成されている Azure リモート Git リポジトリへのコミットされたファイルのアップロードが開始されます。

## <a name="verify-the-web-app-is-uploaded-to-azure"></a>Web アプリが Azure にアップロードされたことを確認する

1. Azure portal にログインします。

1. 左側のナビゲーションで **[すべてのリソース]** メニュー項目を見つけてクリックします。

1. それまでに Azure で作成されたすべてのリソースの一覧が表示されます。

1. 上で作成したステージング スロットを見つけてクリックします。 デプロイ スロットは Web アプリと見なされることを思い出してください。そのため、**[すべてのリソース]** では Web アプリ リソースとして表示されます。

1. ステージング デプロイ スロットのブレードが表示されたら、**[デプロイ オプション]** に移動します。

    ![Web アプリをアップロードした後のステージング デプロイ スロット](../media-draft/7-staging-deployment-slot-after-uploading-files.png)

    コンピューター上にローカルに存在していた最初のコミットが、Azure portal にアップロードされていることがわかります。

    Azure 上でホストされているリモート Git リポジトリにコードをローカルにプッシュすると、Azure によってこの操作が記録されます。

    Azure にコードをプッシュするたびに、新しいレコードと、コンピューター上でローカルに変更をコミットするときに入力したメッセージが表示されます。

1. **ステージング スロット**の URL にアクセスしてみましょう。 URL については上で説明しましたが、その URL を忘れた場合は、いつでも、ステージング デプロイ スロットの **[概要]** ページに移動して、URL を選択できます。

1. ブラウザーのアドレス バーに次の URL を入力します。[https://BESTBIKE-staging.azurewebsites.net/](https://BESTBIKE-staging.azurewebsites.net/)

    ![オンラインでホストされているステージング スロット](../media-draft/7-staging-slot-hosted-online.png)

ローカル Web アプリのファイルを Azure 上のステージング デプロイ スロットに正しくアップロードできました。

## <a name="swapping-the-staging-and-production-deployment-slots"></a>ステージング デプロイ スロットと運用デプロイ スロットのスワップ

Azure でホストされているステージング デプロイ スロットでアプリケーションが起動されて実行されるようになったので、次にこのスロットを運用スロットとスワップします。 これを行うには、次の手順のようにします。

1. ユニット 2 で作成した元の Web アプリ ブレードを探してそこに移動します。

1. 左側のナビゲーションで **[デプロイ スロット]** メニュー項目を見つけてクリックします。

    ![Web アプリ デプロイ スロット ブレード](../media-draft/7-web-app-slots.png)

1. ブレードの上部にある **[スワップ]** ボタンをクリックします。

1. Azure portal の表示が **[スワップ]** ブレードに変わります。

    ![[スワップ] ブレード](../media-draft/7-swap-blade.png)

1. **[スワップ]** フィールドで、**[スワップ]** を選択します。

1. **[ソース]** フィールドで、**[ステージング]** を選択します。

1. **[ターゲット]** フィールドで、**[運用]** を選択します。

1. ブレードの下部にある **[OK]** ボタンをクリックします。

1. Azure でスワップ プロセスが開始されます。 スワップする Web アプリのサイズにもよりますが、通常、この操作には数秒かかります。

1. 操作が終了したら、Web アプリの URL [https://bestbike.azurewebsites.net/](https://bestbike.azurewebsites.net/) にアクセスします。

    ![Web アプリ ページ](../media-draft/7-web-app-page.png)

    スワップ操作が正常に完了しました。 ステージング デプロイ スロットにアップロードされ、運用スロットでもホストされるようになった、コードを確認できます。

1. 次に、ステージング スロットの URL [https://bestbike-staging.azurewebsites.net/](https://bestbike-staging.azurewebsites.net/) にアクセスします。

    ![ステージング Web アプリ](../media-draft/7-staging-after-swapping.png)

    これで、ステージング デプロイ スロットには、以前は運用スロットでホストされていた元の既定の Web アプリケーション ファイルが含まれています。

お疲れさまでした。 Azure に Web アプリが正常にアップロードされました。
