この演習では、ASP.NET Core アプリケーションを Azure Web アプリにアップロードします。

## <a name="create-a-staging-deployment-slot"></a>ステージング デプロイ スロットを作成する

1. 以前に作成した Web アプリ リソースを開きます。 リソース ブレードを閉じた場合は、**[すべてのリソース]** でアプリを検索するか、**[リソース グループ]** でアプリが属するリソース グループを検索することでもう一度見つけることができます。

1. 左側のナビゲーションで **[デプロイ スロット]** メニュー項目をクリックします。

1. **[デプロイ スロット]** ブレードで、上部ナビゲーション バーの **[スロットの追加]** ボタンをクリックします。

1. 次に示すような **[スロットの追加]** ブレードが開きます。

    1. デプロイ スロットに名前を付けます。 ここでは `staging` を使用します。

    2. **[構成のソース]** を選択するときは、2 つのオプションがあります。

        * 既存のデプロイ スロット、または Azure で作成された Web アプリから構成要素を複製します。
        * または、構成要素を複製しないことを選択します。 **[既存のスロットから構成を複製しない]** を選択します。

        このデプロイ スロットでは、2 番目のオプションの **[既存のスロットから構成を複製しない]** を選択します。 スロットを直接構成します。

    ![新しいステージング デプロイ スロットの構成を示す Azure portal のスクリーンショット。](../media/7-new-deployment-slot-blade.png)

1. ブレードの下部にある **[OK]** をクリックして、新しいデプロイ スロットを作成します。

1. デプロイ スロットが正常に作成されると、Web アプリの **[デプロイ スロット]** ブレードに表示が戻ります。

    ここで、先ほど作成した新しいデプロイ スロットを確認できます。

    ![作成した新しいスロットが含まれた [デプロイ スロット] ブレードを示す Azure portal のスクリーンショット。](../media/7-deployment-slot-created.png)

1. 新しいデプロイ スロットを選択します。

1. 新しく作成されたデプロイ スロットの **[概要]** ページが表示されます。

    ![ステージング デプロイ スロット](../media/7-deployment-slot-staging.png)

    ステージング デプロイ スロットの **URL** に注意してください。 スロット名が追加され、以前に表示されていたものとは異なる URL になっています。

    デプロイ スロットは、Azure 内で完全な Web アプリとして扱われます。 ただし、元の Web アプリの子という特別な種類であり、元の Web アプリとスワップすることができます。

    **URL** をクリックすると、Azure portal で初めて作成した Web アプリに対して Azure で作成されたものと同じ既定のページが表示されます。

ステージング デプロイ スロットが正常に作成されたので、次に、**デプロイ資格情報**を構成する必要があります。

## <a name="create-deployment-credentials"></a>デプロイ資格情報を作成する

Azure では、実際のデプロイ プロセスを始める前に、デプロイ資格情報を設定する必要があります。 そのため、独自のデプロイ資格情報を作成する方法を学習します。

1. 左側のナビゲーションで、**[デプロイ資格情報]** メニュー項目をクリックします。

1. 次に示すような **[デプロイ資格情報]** ブレードが表示されます。

    任意の**ユーザー名**と**パスワード**を入力し、パスワードをもう一度入力して確認します。

    > [!NOTE]
    > 忘れないように、ユーザー名とパスワードを書き留めておきます。 後で Azure へのコードのアップロードとデプロイを始めるときに必要になります。

    ![必須フィールドに資格情報の例が入力された、ステージング スロットの [デプロイ資格情報] ブレードを示す Azure portal のスクリーンショット。](../media/7-deployment-credentials.png)

1. **[デプロイ資格情報]** ブレードの上部にある **[保存]** ボタンをクリックします。

デプロイ資格情報が正常に作成されたので、次に、他のデプロイ オプションを構成する必要があります。

## <a name="use-a-local-git-repository-as-your-deployment-option"></a>デプロイ オプションとしてローカル Git リポジトリを使用する

次に、コードのアップロードを開始できるように、Azure でローカル Git リポジトリを作成します。

1. **staging** デプロイ スロット Web アプリ内で、左側のナビゲーションの **[デプロイ オプション]** メニュー項目をクリックします。

1. **[デプロイ オプション]** ブレードが表示されます。

1. **[ソースの選択]** をクリックして必要な設定を構成します。

1. 構成して使用できるオプションが表示されます。 この例では、**[ローカル Git リポジトリ]** を選択します。

1. 自動的に **[デプロイ オプション]** ブレードに戻ります。 ブレードの下部にある **[OK]** をクリックしてデプロイ ソースを設定します。

1. 次に、左側のナビゲーションの **[デプロイ センター (プレビュー)]** セクションに移動して、新しいデプロイの詳細を表示します。

    ![スロットの Git Clone URI が強調表示された、デプロイ スロットの [デプロイ センター] ブレードを示す Azure portal のスクリーンショット。](../media/7-staging-after-setting-git.png)

    ここで注意すべき重要な情報は **Git Clone URI** です。これは、ローカル Web アプリケーション リポジトリで**リモート**として使用するローカル Git リポジトリの URL です。

次に、ステージング デプロイ スロットへのコードのアップロードを開始します。

## <a name="install-git-on-your-machine"></a>コンピューターに Git をインストールする

Linux マシンに Git をインストールします (まだインストールしていない場合)。

> [!NOTE]
> 以下の手順は Ubuntu 18.04 向けです。Git をインストールする手順は、ディストリビューションとバージョンによって異なる場合があります。 適切な手順については、[Linux Git のインストール手順](https://git-scm.com/download/linux)に関するページをご覧ください。

1. 新しい**ターミナル** ウィンドウを開きます。

1. 次のコマンドを入力します。 Ubuntu のユーザー パスワードの入力を求めるプロンプトが表示されます。

    ```console
    sudo apt-get update
    ```

1. 更新が成功したら、次のコマンドを入力して Git をローカルにインストールします。 コンピューターへの Git のインストールに同意するように求められます。

    ```console
    sudo apt-get install git-core
    ```

1. Git がインストールされたことを確認するには、次のコマンドを入力します。

    ```console
    git --version
    ```

   インストールが成功した場合、次の出力が表示されます。

    ```console
    git version 2.17.1
    ```

1. 自分の名前とメール アドレスを入力して Git の設定を構成することをお勧めします。 そのためには、次のコマンドを発行する必要があります。プレースホルダー `{your name}` と `{your email}` を、自分の名前とメール アドレスに置き換えます (中かっこ (`{}`) は不要です)。

    ```console
    git config --global user.name "{your name}"
    git config --global user.email "{your email}"
    ```

1. Git によって情報が記録されたことを確認するには、次のコマンドを入力します。

    ```console
    cat ~/.gitconfig
    ```

   次のように、名前とメール アドレスが表示されるはずです。

    ```console
    [user]
        name = {your name}
        email = {your email}
    ```

## <a name="initialize-a-local-git-repository-for-your-web-app"></a>Web アプリ用にローカル Git リポジトリを初期化する

Git を使い始めるには、Web アプリ用にローカル Git リポジトリを初期化する必要があります。

1. 新しい**ターミナル** ウィンドウを開きます。

1. 以前に作成した Web アプリのコンテンツ ルート フォルダーに移動します。 次のように入力します。

    ```console
    cd ~/Documents/BestBikeApp/
    ```

1. 次のコマンドを発行して、新しい Git リポジトリを初期化します。

    ```console
    git init
    ```

    コマンドが成功すると、次のようなメッセージが表示されます。

    ```console
    Initialized empty Git repository in /home/{your-user}/Documents/BestBikeApp/.git/
    ```

1. すべての Web アプリ ファイルを Git にステージングします。

   次に、Git に Web アプリ ファイルを認識させます。 そのためには、Git によって**ステージング**されるように、作業ディレクトリのすべてのファイルを追加します。 次のコマンドを入力します。

    ```console
    git add .
    ```

    上のコマンドでは、"." によって表されるすべてのファイルが、Git のステージング状態に追加されます。

1. 次に、Git に変更をコミットする必要があります。

   Git にファイルをステージングした後は、ローカル コンピューター上の **Git コミット履歴**にファイルをコミットする必要があります。 そのためには、次のコマンドを入力します。

    ```console
   git commit -m "Initial create"
    ```

   `commit` コマンドでは、作成しているコミットに関するメッセージを含めるための `-m` 引数が受け付けられます。 後で、コードを Azure にプッシュするときに、この特定のコミットに格納されている同じメッセージを見ることができます。

## <a name="add-a-remote-for-the-local-git-repository"></a>ローカル Git リポジトリに対するリモートを追加する

この時点では、新しいローカル Git リポジトリが正常に初期化されています。 さらに、すべての Web アプリ ファイルを Git にコミットしてあります。 残っているのは、ローカル Git リポジトリを Azure でホストされているリポジトリに接続するための**リモート**を追加することです。

そのためには、以下のことを行う必要があります。

1. 前の手順で表示された **Git クローン URL** をコピーします。

1. コピーした後、**ターミナル** ウィンドウに戻り、次の Git コマンドを発行します。

    ```console
    git remote add origin https://BESTBIKE-git@BESTBIKE-staging.scm.azurewebsites.net:443/BESTBIKE.git
    ```

    上の Git コマンドでは、ローカル Git リポジトリが Azure でホストされているリポジトリにフックされます。 これで、ローカル Git リポジトリとリモート Git リポジトリの間でプッシュとプルを始めることができます。

1. 上記のコマンドを確認するには、次の Git コマンドを入力します。

    ```console
    git remote -v
    ```

    上のコマンドでは、次の出力が生成されます。

    ```console
    origin  https://BESTBIKE-git@BESTBIKE-staging.scm.azurewebsites.net:443/BESTBIKE.git (fetch)
    origin  https://BESTBIKE-git@BESTBIKE-staging.scm.azurewebsites.net:443/BESTBIKE.git (push)
    ```

## <a name="push-your-code-to-azure"></a>コードを Azure にプッシュする

ローカル Git リポジトリを Azure 上のリモート Git リポジトリにフックしたので、アプリを開発してビルドした後、Azure に Web アプリをプッシュします。

1. **master** ブランチを Azure 上のリモート Git リポジトリにプッシュするには、次の Git コマンドを入力します。

    ```console
    git push origin master
    ```

1. 前に **[デプロイ資格情報]** セクションで構成したパスワードの入力を求められます。 パスワードを入力して Enter キーを押します。 Git で、ステージング デプロイ スロットに構成されている Azure リモート Git リポジトリへのコミットされたファイルのアップロードが開始されます。

## <a name="verify-the-web-app-is-uploaded-to-azure"></a>Web アプリが Azure にアップロードされたことを確認する

1. Azure portal にサインインします。

1. 左側のナビゲーションで、**[すべてのリソース]** メニュー項目をクリックします。

1. これまでに Azure で作成されたすべてのリソースの一覧が表示されます。

1. 上記で作成したステージング スロットをクリックします。 デプロイ スロットは Web アプリと見なされるため、**[すべてのリソース]** に Web アプリ リソースとして表示されます。

1. ステージング デプロイ スロットのブレードが表示されたら、**[デプロイ オプション]** に移動します。

    コンピューター上にローカルに存在する最初のコミットが、Azure portal にアップロードされていることがわかります。

    Azure でホストされているリモート Git リポジトリにローカルでコードをプッシュすると、Azure によってこの操作が記録されます。

    Azure にコードをプッシュするたびに、新しいレコードと、コンピューター上でローカルに変更をコミットするときに入力したメッセージが表示されます。

    ![[デプロイ オプション] ブレードの最近の Git リポジトリ デプロイを示す Azure portal のスクリーンショット。](../media/7-staging-deployment-slot-after-uploading-files.png)

1. **ステージング スロット**の URL にアクセスしてみましょう。 URL については既に説明しましたが、その URL を忘れた場合は、いつでも、ステージング デプロイ スロットの **[概要]** ページに移動して、URL を選択できます。

1. ブラウザーのアドレス バーに、URL として [https://BESTBIKE-staging.azurewebsites.net/](https://BESTBIKE-staging.azurewebsites.net/) を入力します。

    ![ステージング デプロイ スロット Web サイトの Web ブラウザー ビューを示すスクリーンショット。](../media/7-staging-slot-hosted-online.png)

ローカル Web アプリのファイルが、Azure 上のステージング デプロイ スロットに正常にアップロードされました。

## <a name="swapping-the-staging-and-production-deployment-slots"></a>ステージング デプロイ スロットと運用デプロイ スロットのスワップ

Azure でホストされているステージング デプロイ スロットでアプリケーションが起動されて実行されるようになったので、次にこのスロットを運用スロットとスワップします。 これを行うには、次の手順に従います。

1. 以前に作成した元の Web アプリ ブレードに移動します。 元の Web アプリは、**[すべてのリソース]** ブレードで見つかります。

1. 左側のナビゲーションで **[デプロイ スロット]** メニュー項目をクリックします。

1. ブレードの上部にある **[スワップ]** ボタンをクリックします。

1. **[スワップ]** ブレードが表示されます。

1. **[スワップ]** フィールドで、**[スワップ]** を選択します。

1. **[ソース]** フィールドで、**[ステージング]** を選択します。

1. **[ターゲット]** フィールドで、**[運用]** を選択します。

    ![デプロイ スロットのスワップ ブレードを示す Azure portal のスクリーンショット。](../media/7-swap-blade.png)

1. ブレードの下部にある **[OK]** をクリックします。

1. スワップ プロセスが開始されます。 スワップする Web アプリのサイズにもよりますが、通常、この操作には数秒かかります。

1. 操作が終了したら、Web アプリの URL ([https://bestbike.azurewebsites.net/](https://bestbike.azurewebsites.net/)) にアクセスします。

    ![プライマリ Web アプリとしてホストされるようになった以前のステージング デプロイ スロットの Web ブラウザー ビューを示すスクリーンショット。](../media/7-web-app-page.png)

    スワップ操作が正常に完了しました。 ステージング デプロイ スロットにアップロードされ、運用スロットでホストされるようになったコードを確認できます。

1. 次に、ステージング スロットの URL ([https://bestbike-staging.azurewebsites.net/](https://bestbike-staging.azurewebsites.net/)) にアクセスします。

    ![ステージング デプロイ スロット Web アプリとしてホストされるようになった以前のプライマリ デプロイ スロットの Web ブラウザー ビューを示すスクリーンショット。](../media/7-staging-after-swapping.png)

    ステージング デプロイ スロットに、以前は運用スロットでホストされていた元の既定の Web アプリケーション ファイルが含まれるようになりました。

お疲れさまでした。 Azure に Web アプリが正常にアップロードされ、デプロイ スロットがスワップされました。
