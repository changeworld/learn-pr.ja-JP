オンプレミス環境を Azure と統合するには、暗号化された接続を作成できる必要があります。 パブリック インターネット経由で、または専用リンク経由で接続できます。 ここでは、オンプレミス環境からの受信接続に対するエンドポイントを提供する、Azure VPN Gateway について説明します。

Azure 仮想ネットワークを設定し、Azure からサイトへのデータ転送と Azure 仮想ネットワーク間のデータ転送がすべて暗号化されている必要があります。 また、リージョンとサブスクリプション間で仮想ネットワークを接続する方法を知っている必要があります。

## <a name="describe-a-vpn-gateway"></a>VPN ゲートウェイの説明

Azure VPN Gateway では、オンプレミスの場所から Azure への、インターネット経由での暗号化された受信接続に対するエンドポイントが提供されます。 また、異なるリージョンの Azure データ センターをリンクしている Microsoft の専用ネットワークを経由して、Azure 仮想ネットワーク間で暗号化されたトラフィックを送信することもできます。 この構成を使用すると、異なるリージョンの仮想マシンとサービスを安全にリンクできます。

各仮想ネットワークには VPN ゲートウェイを 1 つだけ作成できます。 その VPN ゲートウェイへのすべての接続は、使用可能なネットワーク帯域幅を共有します。

各仮想ネットワーク ゲートウェイの内部には、2 つ以上の仮想マシン (VM) があります。 これらの VM は、自身で指定する _ゲートウェイ サブネット_ という特別なサブネットにデプロイされています。 これらには、特定のゲートウェイ サービスと共に、他のネットワークに接続するためのルーティング テーブルが含まれます。 これらの VM とゲートウェイ サブネットは、強化されたネットワーク デバイスに似ています。 これらの VM を直接構成する必要はありませんし、ゲートウェイ サブネットに追加リソースをデプロイする必要はありません。

仮想ネットワーク ゲートウェイの作成は完了までに時間がかかる場合があるため、適切な計画を立てることが不可欠です。 仮想ネットワーク ゲートウェイを作成すると、プロビジョニング プロセスによってゲートウェイの VM が生成され、それがゲートウェイ サブネットにデプロイされます。 これらの VM では、ゲートウェイで構成した設定が使用されます。

重要な設定は **_ゲートウェイの種類_** です。VPN ゲートウェイの場合、この種類は "vpn" となります。 VPN ゲートウェイのオプションには以下が含まれます。

- IPsec/IKE VPN トンネリング経由の VNet 間接続。VPN ゲートウェイを他の VPN ゲートウェイとリンクします。

- クロスプレミス IPsec/IKE VPN トンネリング。専用の VPN デバイスを通じてオンプレミス ネットワークを Azure と接続し、サイト間接続を作成します。

- IKEv2 または SSTP 経由のポイント対サイト接続。クライアント コンピューターを Azure のリソースにリンクします。

ここで、VPN ゲートウェイを計画するために考慮する必要がある要素を見てみましょう。

## <a name="plan-a-vpn-gateway"></a>VPN ゲートウェイの計画

VPN ゲートウェイを計画するときは、3 つのアーキテクチャを考慮する必要があります。

- インターネット経由でのポイント対サイト
- インターネット経由でのサイト間
- 専用ネットワーク経由でのサイト間 (Azure ExpressRoute など)

### <a name="planning-factors"></a>計画における要素

計画プロセスの間で検討する必要がある要素には、以下が含まれます。

- スループット - Mbps または Gbps
- バックボーン - インターネットかプライベートか
- パブリック (静的) IP アドレスの可用性
- VPN デバイスの互換性
- 複数のクライアント接続か、またはサイト間のリンクか
- VPN ゲートウェイの種類
- Azure VPN Gateway の SKU

計画に関するこれらの問題の一部をまとめたものを、次の表に示します。 残りの部分については後ほど説明します。

|                           |  ポイント対サイト            | サイト間                          |  ExpressRoute                 |
| -------------             | -------------             | -------------                         | ---------                     |
| Azure でサポートされるサービス  | クラウド サービスと VM    | クラウド サービスと VM                | サポートされているすべてのサービス        |
| 一般的な帯域幅         | ゲートウェイの SKU によって異なります    | 集計を含む最大 1 Gbps         | 50 Mbps から 10 Gbps       |
| サポート対象プロトコル       | SSTP および IPSec            | IPSec                                 | 直接接続、VLAN      |
| ルーティング                   | RouteBased (動的)      | PolicyBased (静的) および RouteBased   | BGP                           |
| 接続の回復性     | アクティブ/パッシブ            | アクティブ/パッシブまたはアクティブ/アクティブ       | アクティブ/アクティブ                 |
| ユース ケース                  | テストとプロトタイプ作成   | 開発、テスト、小規模の運用  | エンタープライズ/ミッション クリティカル   |

### <a name="gateway-skus"></a>ゲートウェイの SKU

Azure には、ゲートウェイ サービス用に次の SKU が用意されています。

| SKU              |  S2S/VNet 間トンネル | P2S 接続  |  合計スループット ベンチマーク   | 用途                         |
| -------------    | -------------             | -------------    | ---------                         | ---------                       |
| Basic            | 最大 10                    | 最大 128          | 100 Mbps                          | 開発/テスト/POC                    |
| VpnGw1           | 最大 30                    | 最大 128          | 650 Mbps                          | 運用/重要なワークロード   |
| VpnGw2           | 最大 30                    | 最大 128          | 1 Gbps                            | 運用/重要なワークロード   |
| VpnGw3           | 最大 30                    | 最大 128          | 1.25 Gbps                          | 運用/重要なワークロード   |

> [!Note] 
> 正しい SKU を選択することが重要です。誤った SKU で VPN ゲートウェイを設定した場合、ゲートウェイを停止させて再構築する必要が発生します。これには時間がかかる場合があります。

## <a name="workflow"></a>ワークフロー

Azure での仮想プライベート ネットワークを使用するクラウド接続の計画を立てるときは、次のワークフローを適用する必要があります。

1. 接続するすべてのネットワークのアドレス空間をリストする、接続トポロジを設計します。

1. Azure 仮想ネットワークを作成します。

1. 仮想ネットワークの VPN ゲートウェイを作成します。

1. 必要に応じて、オンプレミス ネットワークやその他の仮想ネットワークへの接続を作成および構成します。

1. 必要に応じて、Azure VPN ゲートウェイのポイント対サイト接続を作成および構成します。

### <a name="design-considerations"></a>設計上の考慮事項

仮想ネットワークに接続する VPN ゲートウェイを設計するときは、次の要素を考慮する必要があります。

- サブネットを重複させることはできません。1 つの場所にあるサブネットが、別の場所にあるものと同じアドレス空間を含まないことが不可欠です。

- IP アドレスは一意である必要があります。異なる場所に同じ IP アドレスを持つホストを 2 つ持つことはできません。この 2 つのホスト間でトラフィックをルーティングすることができなくなり、VNet 間接続が失敗します。

- VPN ゲートウェイには、**GatewaySubnet** と呼ばれるゲートウェイ サブネットが必要です。ゲートウェイが機能するためには必ずこの名前にする必要があり、その他のリソースを含めることはできません。

### <a name="create-an-azure-virtual-network"></a>Azure 仮想ネットワークの作成

VPN ゲートウェイを作成する前に、Azure vNet を作成する必要があります。

### <a name="create-a-vpn-gateway"></a>VPN ゲートウェイの作成

作成する VPN ゲートウェイの種類は、アーキテクチャによって異なります。 オプションは次のとおりです。

- RouteBased ルート ベース VPN デバイスは、あらゆる (ワイルドカード) トラフィック セレクターを使用し、ルーティング/転送テーブルによってトラフィックをさまざまな IPsec トンネルに転送させます。 ルート ベースの接続は、通常、それぞれの IPsec トンネルがネットワーク インターフェイスまたは VTI (仮想トンネル インターフェイス) としてモデル化されるルーターのプラットフォームに基づいて構築されます。

- PolicyBased ポリシー ベース VPN デバイスは、両方のネットワークのプレフィックスの組み合わせを使用して、トラフィックがどのように IPsec トンネルを介して暗号化/復号化されるかを定義します。 ポリシー ベースの接続は、通常、パケット フィルタリングを実行するファイアウォール デバイスに基づいて構築されます。 IPsec トンネルの暗号化と復号化は、パケット フィルタリングと処理エンジンに追加されます。

## <a name="set-up-a-vpn-gateway"></a>VPN ゲートウェイの設定

実行する必要がある手順は、インストールする VPN ゲートウェイの種類によって異なります。 たとえば、Azure Portal を使用してポイント対サイト VPN ゲートウェイを作成するには、次の手順を実行します。

1. 仮想ネットワークの作成

2. ゲートウェイ サブネットの追加

3. DNS サーバーの指定 (省略可能)

4. 仮想ネットワーク ゲートウェイの作成

5. 証明書の生成

6. クライアント アドレス プールの追加

7. トンネルの種類の構成

8. 認証の種類の構成

9. ルート証明書の公開証明書データのアップロード

10. エクスポートしたクライアント証明書のインストール

11. VPN クライアント構成パッケージの生成とインストール

12. Azure への接続

Azure VPN ゲートウェイを構成するためにはいくつかの方法があり、そのそれぞれが複数のオプションを含んでいるため、すべての設定をこのコースで網羅することはできません。 詳細については、その他のリソースに関するセクションをご覧ください。

## <a name="configure-the-gateway"></a>ゲートウェイの構成

ゲートウェイを作成したら、それを構成する必要があります。  いくつかの構成設定を指定する必要があります (名前、場所、DNS サーバーなど)。演習では、これらについて詳しく説明します。

## <a name="summary"></a>まとめ

Azure VPN ゲートウェイとは、ポイント対サイト、サイト間、または VNet 間の接続を可能にする、Azure VNet 内のコンポーネントです。 Azure VPN ゲートウェイを使用すると、個々のクライアント コンピューターを Azure のリソースに接続したり、オンプレミスのネットワークを Azure に拡張したり、異なるリージョンやサブスクリプション内の VNet 間での接続を容易にしたりすることができます。