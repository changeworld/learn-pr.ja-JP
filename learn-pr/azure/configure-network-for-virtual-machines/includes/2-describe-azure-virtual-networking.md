維持する予定のオンプレミスのデータ センターがありますが、Azure でホストされる仮想マシン (VM) を使用してピーク時のトラフィックをオフロードするために、Azure を使用する必要があります。 既存の IP アドレス指定スキームとネットワーク アプライアンスを維持できるのかどうか把握する必要がある一方、すべてのデータ転送がセキュリティで保護される必要があります。

## <a name="what-is-azure-virtual-networking"></a>Azure 仮想ネットワークとは

**Azure 仮想ネットワーク**を使用すると、仮想マシン、Web アプリ、データベースなどの Azure リソースが、各 Azure リソース、インターネット上のユーザー、オンプレミスのクライアント コンピューターと通信できるようになります。 Azure ネットワークは、他の Azure リソースとリンクするリソースのセットと見なすことができます。

Azure 仮想ネットワークには、次の主要なネットワーク機能が含まれます。

- 分離とセグメント化
- インターネット通信
- Azure リソース間の通信
- オンプレミス リソースとの通信
- ネットワーク トラフィックのルーティング
- ネットワーク トラフィックのフィルター処理
- 仮想ネットワークの接続

### <a name="isolation-and-segmentation"></a>分離とセグメント化

Azure では、分離された仮想ネットワークを複数作成できます。 仮想ネットワークを設定するときに、プライベートのインターネット プロトコル (IP) アドレス空間を定義します。これにはパブリックまたはプライベートの IP アドレス範囲を使用します。 次に、その IP アドレス空間をサブネットに分割し、定義されたアドレス空間の一部をそれぞれの名前付きサブネットに割り当てることができます。

名前を解決するためには、Azure の組み込みの名前解決サービスを使用するか、または仮想ネットワークを構成して、内部または外部のドメイン ネーム システム (DNS) サーバーを使用することができます。

### <a name="internet-communications"></a>インターネット通信

Azure 内の VM は、既定でインターネットに接続できます。 ただし、Azure コマンド ライン インターフェイス (CLI)、リモート デスクトップ プロトコル (RDP)、または Secure Shell (SSH) のいずれかを使用して、その VM に接続して制御する必要があります。 パブリック IP アドレスまたはパブリック ロード バランサーを定義することで、受信の通信を有効にできます。

### <a name="communicate-between-azure-resources"></a>Azure リソース間の通信

Azure リソースが相互に安全に通信できるようにする必要があります。 次の 2 つの方法のいずれかでこれを実現します。

- **仮想ネットワーク**。仮想ネットワークでは、VM だけではなく、App Service Environment、Azure Kubernetes Service、Azure Virtual Machine Scale Sets など、その他の Azure リソースも接続できます。

- **サービス エンドポイント**。サービス エンドポイントを使用して、Azure SQL データベースやストレージ アカウントなど、他の Azure リソースの種類に接続することができます。 この方法を使用すると、複数の Azure リソースを仮想ネットワークにリンクすることが可能になり、セキュリティの向上とリソース間の最適なルーティングを実現できます。

### <a name="communicate-with-on-premises-resources"></a>オンプレミス リソースとの通信

Azure 仮想ネットワークを使用すると、オンプレミス環境と Azure サブスクリプション内でリソースを実質的にリンクできるため、ローカル環境とクラウド環境にまたがるネットワークを作成できます。 この接続を実現するためのメカニズムが 3 つあります。

- **ポイント対サイト VPN**。この方法は、VPN 接続 (組織外のコンピューターが、反対方向で動作することを除いて企業ネットワークに戻る) に似ています。 この場合、クライアント コンピューターが、そのコンピューターを Azure 仮想ネットワークに接続して、Azure への暗号化された VPN 接続を開始します。

- **サイト間 VPN**。サイト間 VPN では、オンプレミスの VPN デバイスまたはゲートウェイが、仮想ネットワーク内で Azure VPN Gateway にリンクされます。 実際には、Azure 内のデバイスはローカル ネットワーク上にあるものとして表示できます。 接続は暗号化され、インターネット経由で動作します。

- **Azure ExpressRoute**。より広い帯域幅とさらに高いレベルのセキュリティが必要な環境に対しては、Azure ExpressRoute が最適な方法です。 Azure ExpressRoute には、インターネットを経由しない Azure への専用プライベート接続が用意されています。

### <a name="route-network-traffic"></a>ネットワーク トラフィックのルーティング

Azure では、サブネット、接続されている仮想ネットワーク、オンプレミス ネットワーク、インターネット間で、トラフィックが既定でルーティングされます。 ただし、次のようにルーティングを制御して各設定をオーバーライドできます。

- **ルート テーブル**。ルート テーブルでは、トラフィックが送信される方向に関する規則を定義できます。 サブネット間でパケットがルーティングされる方法を制御する、カスタム ルート テーブルを作成できます。

- **Border Gateway Protocol** Border Gateway Protocol (BGP) は、Azure VPN Gateway または ExpressRoute と共に動作して、オンプレミスの BGP ルートを Azure 仮想ネットワークに反映させます。

### <a name="filter-network-traffic"></a>ネットワーク トラフィックのフィルター処理

Azure 仮想ネットワークでは、次の方法を使用してサブネット間のトラフィックをフィルター処理できます。

- **ネットワーク セキュリティ グループ**。ネットワーク セキュリティ グループは、受信と送信に関するセキュリティ規則を複数含めることができる Azure リソースです。 送信元と送信先の IP アドレス、ポート、プロトコルなどの要素に基づいて、トラフィックを許可またはブロックする各規則を定義できます。

- **ネットワーク仮想アプライアンス**。ネットワーク仮想アプライアンスは、堅牢化されたネットワーク アプライアンスに対応する特殊な VM です。 ネットワーク仮想アプライアンスでは、ファイアウォールの実行などの特定のネットワーク機能が実行されるか、または WAN の最適化が実行されます。

## <a name="connect-virtual-networks"></a>仮想ネットワークの接続

仮想ネットワークの _ピアリング_ を使用して、仮想ネットワークをリンクできます。 ピアリングを使用すると、各仮想ネットワーク内のリソースを相互に通信させることができます。 異なるリージョンに各仮想ネットワークを配置し、Azure を通じてグローバルに相互接続されたネットワークを作成できます。

## <a name="azure-virtual-network-settings"></a>Azure 仮想ネットワークの設定

ローカル コンピューター上の Azure Portal や Azure PowerShell から、または Azure Cloud Shell を使用して、Azure 仮想ネットワークの作成と構成を実行できます。

### <a name="create-a-virtual-network"></a>仮想ネットワークの作成

Azure 仮想ネットワークを作成するときに、基本的な設定をいくつか構成します。 また、複数のサブネット、分散型サービス拒否 (DDoS) の保護、サービス エンドポイントなど、高度な設定を構成することもできます。

![仮想ネットワークの作成](../media-draft/2-create-virtual-network.PNG)

基本的な仮想ネットワークでは、次の設定を構成する必要があります。

- **ネットワーク名**。この名前は、サブスクリプション内で一意である必要がありますが、グローバルに一意である必要はありません。 記憶したり、他の仮想ネットワークから区別したりするのが簡単になる、説明的な名前を付けます。

- **アドレス空間**。仮想ネットワークを設定するときに、クラスレス ドメイン間ルーティング (CIDR) 形式で内部のアドレス空間を定義します。 このアドレス空間はサブスクリプション内で一意である必要があります。このため、たとえばある仮想ネットワークに対して 10.0.0.0/24 のアドレス空間を定義した後、別の仮想ネットワークに対して 10.1.0.0/8 を定義することはできません。10.1.0.0/8 のネットワークが 10.0.0.0/24 と重複するためです。 しかし、10.0.0.0/16 と 10.1.0.0/16 などは指定できます。 
    > [!NOTE] 
    > 仮想ネットワークを作成したら、アドレス空間を追加できます。

- **サブスクリプション**。選択するサブスクリプションが複数ある場合にのみ適用されます。

- **リソース グループ**。他の Azure リソースと同様、仮想ネットワークはリソース グループ内に配置する必要があります。 既存の RG を選択するか、新しく作成することができます。
- **場所**。仮想ネットワークを配置する場所を選択します。

- **サブネット**。各仮想ネットワークのアドレス範囲内で、仮想ネットワークのアドレス空間をパーティション分割するサブネットを、1 つまたは複数作成できます。 次に、サブネット間のルーティングは既定のトラフィックのルーティングに依存するか、またはカスタム ルートを定義できます。 または、すべての仮想ネットワークのアドレス範囲を含む 1 つのサブネットを定義できます。

    > [!NOTE]
    >サブネット名は、先頭にはアルファベットまたは数字、末尾にはアルファベット、数字、またはアンダースコアを使用する必要があります。また、使用できるのは、アルファベット、数字、アンダースコア、ピリオド、ハイフンのみです。

- **DDoS 保護**。Basic または Standard の DDoS 保護を選択できます。 Standard の DDoS Protection はプレミアム サービスです。 Standard の DDoS 保護の詳細。

- **サービス エンドポイント**。ここでは、サービス エンドポイントを有効にした後、有効にする Azure サービス エンドポイントを一覧から選択します。 オプションには、Azure Cosmos DB、Azure Service Bus、Key Vault などが含まれます。

これらの設定を構成したら、**[作成]** ボタンをクリックします。

### <a name="define-additional-settings"></a>追加設定の定義

仮想ネットワークを作成したら、さらに追加設定を定義できます。 次に例を示します。

- **ネットワーク セキュリティ グループ**。ネットワーク セキュリティ グループに含まれるセキュリティ規則を使用して、仮想ネットワーク サブネットとネットワーク インターフェイスに出入りできるネットワーク トラフィックの種類をフィルター処理できます。 ネットワーク セキュリティ グループを個別に作成した後、これを仮想ネットワークに関連付けます。

- **ルート テーブル**。Azure では、Azure 仮想ネットワーク内の各サブネットにルート テーブルが自動的に作成され、既定のシステム ルートがテーブルに追加されます。 ただし、カスタム ルート テーブルを追加して、仮想ネットワーク間のトラフィックを変更できます。

また、サービス エンドポイントを修正することもできます。

![仮想ネットワークの設定](../media-draft/2-virtual-network-additional-settings.PNG)

### <a name="configure-virtual-networks"></a>仮想ネットワークの構成

仮想ネットワークを作成したら、さらなる設定はすべて Azure Portal の [仮想ネットワーク] ブレードから変更できます。 または、PowerShell コマンドや Cloud Shell の CLI コマンドを使用して変更を加えることもできます。

![仮想ネットワークの構成](../media-draft/2-configure-virtual-network.PNG)

次に、さらなるサブ ブレードで設定の確認と変更を行うことができます。 これらの設定には、以下が含まれます。

- アドレス空間   最初の定義にさらなるアドレス空間を追加できます

- 接続されたデバイス   仮想ネットワークを使用してマシンを接続します

- サブネット   さらにサブネットを追加します

- ピアリング   ピアリングの配置で仮想ネットワークをリンクします

また、仮想ネットワークの監視やトラブルシューティングを行ったり、現在の仮想ネットワークを生成するために自動化スクリプトを作成したりすることもできます。

## <a name="summary"></a>まとめ

仮想ネットワークは、Azure 内のエンティティを接続するための強力なメカニズムであり、自由に構成することができます。 Azure リソースを相互に接続したり、またはオンプレミスのリソースに接続したりできます。 ネットワーク トラフィックの分離、フィルター処理、ルーティングを実行できます。また、必要に応じて Azure でセキュリティを強化することができます。