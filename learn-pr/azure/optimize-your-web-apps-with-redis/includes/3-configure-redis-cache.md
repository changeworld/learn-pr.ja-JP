自社のスポーツ統計情報の開発チームにより、キャッシュが最近要求されたデータのパフォーマンスを大幅に向上させる可能性があると判断されました。 次の手順として、Azure Redis Cache インスタンスを作成および構成します。

## <a name="create-and-configure-the-azure-redis-cache-instance"></a>Azure Redis Cache インスタンスの作成および構成

Redis キャッシュは、Azure portal、Azure CLI、または Azure PowerShell を使用して作成できます。 目的に合わせてキャッシュを正しく構成する目的で、いくつかのパラメーターを決定する必要があります。

### <a name="name"></a>名前

Redis キャッシュには、グローバルで一意の名前が必要になります。 この名前は Azure 内で一意にする必要があります。サービスに接続し、通信する目的で公開 URL の生成に使用されるためです。

この名前は 1 から 63 文字で作成し、数字、英字、"-" 文字のみを使用する必要があります。 キャッシュ名の先頭と末尾には "-" 文字を使用できません。また、連続する "-" 文字は無効です。

### <a name="resource-group"></a>リソース グループ

Azure Redis Cache はマネージド リソースであり、_リソース グループ_の所有者を必要とします。 新しいリソース グループを作成するか、加入しているサブスクリプションの既存のリソース グループを使用できます。

### <a name="location"></a>場所

Azure リージョンを選択し、Redis キャッシュが物理的に置かれる場所を決定する必要があります。 キャッシュ インスタンスとアプリケーションは常に同じリージョンに配置してください。 異なるリージョンのキャッシュに接続すると、待ち時間が大幅に増加し、信頼性が低下する可能性があります。 Azure の外部にあるキャッシュに接続する場合は、データを使用するアプリケーションが実行されている場所に近い場所を選択します。

> [!IMPORTANT]
> Redis キャッシュは、データ _コンシューマー_のできるだけ近くに配置してください。

### <a name="pricing-tier"></a>価格レベル

前回のユニットで述べたように、Azure Redis Cache には 3 つの価格レベルがあります。

- **Basic**: Basic キャッシュは開発/試験に最適です。 1 台のサーバー、53 GB のメモリ、接続数は 20,000 に限定されます。 このサービス レベルには SLA がありません。
- **Standard**: 複製をサポートし、99.99% SLA が含まれる運用キャッシュ。 2 つのサーバー (マスター/スレーブ) をサポートします。メモリ/接続数の制限は Basic レベルと同じになります。
- **Premium**: Standard レベルをベースとする企業向けレベルであり、永続化、クラスタリング、スケールアウトをキャッシュで提供します。 メモリが最大 530 GB で同時接続数が 40,000 という最高の性能を誇るレベルです。

各レベルで利用できるキャッシュ メモリの量を制御できます。Basic/Standard の場合は C0-C6 から、Premium の場合は P0-P4 からキャッシュ レベルを選択します。 詳細については[価格ページ](https://azure.microsoft.com/pricing/details/cache/)をご覧ください。

> [!TIP]
> 運用システムでは常に Standard レベルまたは Premium レベルを使用することをお勧めします。 Basic レベルは単一ノード システムであり、データ レプリケーション機能や SLA がありません。 また、C1 以上のキャッシュを使用してください。 C0 キャッシュは CPU コアが共有であり、メモリも非常に少量であるため、単純な開発/テスト シナリオにしか適していません。

Premium レベルでは、ディザスター リカバリーを提供するために、次の 2 つの方法でデータを永続化できます。

1. RDB 永続化では、定期的にスナップショットが作成されます。エラーが発生した場合には、このスナップショットを使用してキャッシュを再構築できます。

    ![新しい Redis Cache インスタンスでの RDB 永続化オプションを示す Azure portal のスクリーンショット。](../media/3-redis-persistence-1.png)

2. AOF 永続化では、すべての書き込み操作がログに最低 1 秒に一度保存されます。 これでは、ファイル サイズが RDB よりも大きくなるものの、データの損失は少なくなります。

    ![Azure portal のスクリーンショット。新しい Redis Cache インスタンスの AOF 永続化オプションが示されています。](../media/3-redis-persistence-2.png)

**Premium** レベルでのみ利用できる設定が他にいくつかあります。

### <a name="virtual-network-support"></a>仮想ネットワークのサポート

Premium レベルの Redis キャッシュを作成する場合、クラウドの仮想ネットワークにそれをデプロイします。 キャッシュは同じ仮想ネットワーク内の他の仮想マシンやアプリケーションのみが使用できます。 サービスとキャッシュがいずれも Azure でホストされているか、Azure 仮想ネットワーク VPN 経由で接続されているとき、セキュリティのレベルが上がります。

### <a name="clustering-support"></a>クラスター化のサポート

Premium レベルの Redis Cache では、クラスタリングを実装して、複数のノードに自動的にデータセットが分割されるようにできます。 クラスタリングを実装するには、シャードの数を最大の 10 に指定します。 発生するコストは、元のノードのコストにシャード数を掛けたものです。

## <a name="accessing-the-redis-instance"></a>Redis インスタンスへのアクセス

Redis は、[既知のコマンド](https://redis.io/commands)のセットをサポートしています。 コマンドは、通常、`COMMAND parameter1 parameter2 parameter3` として発行されます。

使用できるいくつかの一般的なコマンドを次に示します。

| コマンド | 説明 |
|---------|-------------|
| `ping` | サーバーへの ping を実行します。 "PONG" を返します。 |
| `set [key] [value]` | キャッシュのキー/値を設定します。 成功したら "OK" を返します。 |
| `get [key]` | キャッシュから値を取得します。 |
| `exists [key]` | **キー**がキャッシュに存在する場合は "1"、存在しない場合は "0" を返します。 |
| `type [key]` | 指定された**キー**の値に関連付けられている型を返します。 |
| `incr [key]` | **キー**に関連付けられている指定された値を "1" だけ増分します。 値は整数または倍精度値にする必要があります。 新しい値を返します。 |
| `incrby [key] [amount]` | **キー**に関連付けられている指定された値を、指定された量だけ増分します。 値は整数または倍精度値にする必要があります。 新しい値を返します。 |
| `del [key]` | **キー**に関連付けられている値を削除します。 |
| `flushdb` | データベース内の "_すべての_" キーと値を削除します。 |

Redis には、これらのコマンドを直接試すために使用できるコマンドライン ツール (**redis-cli**) が用意されています。 次に例をいくつか示します。

```output
> set somekey somevalue
OK
> get somekey
"somevalue"
> exists somekey
(string) 1
> del somekey
(string) 1
> exists somekey
(string) 0
```

以下に、`INCR` コマンドの操作例を示します。 これらは、キャッシュを使用している "_複数のアプリケーションにわたる_" アトミック増分を提供するので便利です。

```output
> set counter 100
OK
> incr counter
(integer) 101
> incrby counter 50
(integer) 151
> type counter
(integer)
```

### <a name="adding-an-expiration-time-to-values"></a>値への有効期限の追加

キャッシュは、よく使用される値をメモリに格納することができるため、重要です。 ただし、値が古くなったときに期限切れにする手段も必要です。 Redis では、キーに _Time to Live_ (TTL) を適用することによって、それが行われます。

TTL が経過すると、DEL コマンドが発行されたかのように、キーが自動的に削除されます。 TTL の有効期限には、以下の注意事項があります。

- 有効期限は、秒またはミリ秒の精度で設定することができます。
- 有効期限切れの時刻の精度は、常に 1 ミリ秒です。
- 期限切れに関する情報は、ディスクに複製され、永続的に保管されます。Redis サーバーが停止しているときは、時間は仮想的に経過します (つまり、キーが期限切れになる日付が Redis によって保存されます)。

次に、有効期間の例を示します。

```output
> set counter 100
OK
> expire counter 5
(integer) 1
> get counter
100
... wait ...
> get counter
(nil)
```

## <a name="accessing-a-redis-cache-from-a-client"></a>クライアントから Redis キャッシュへのアクセス

Azure Redis Cache インスタンスに接続するには、いくつかの情報が必要です。 クライアントでホスト名、ポート、キャッシュのアクセス キーが必要になります。 この情報は、Azure portal で **[設定]、[アクセス キー]** ページの順に進み、取得できます。 

- ホスト名は、キャッシュのパブリック インターネット アドレスです。このアドレスは、キャッシュの名前を使用して作成されたものです。 たとえば、`sportsresults.redis.cache.windows.net` のようなものです。

- アクセス キーは、キャッシュのパスワードとして動作します。 プライマリとセカンダリの 2 つのキーが作成されます。 どちらのキーも使用できますが、2 つ用意されているのは、プライマリ キーを変更する必要があるときのためです。 すべてのクライアントをセカンダリ キーに切り替えて、プライマリ キーを再生成することができます。 こうすると、元のプライマリ キーを使用しているすべてのアプリケーションがブロックされます。 Microsoft では、個人用のパスワードと同じように、定期的にキーを再生成することを推奨しています。

> [!WARNING]
> アクセス キーは機密情報であると見なして、パスワードと同じように取り扱う必要があります。 アクセス キーを入手した人は、キャッシュに対して任意の操作を実行できてしまいます。
