スポーツ統計情報の開発チームにより、キャッシュが最近要求されたデータのパフォーマンスを大幅に向上させる可能性があると判断されました。 次の手順として、Azure Redis Cache インスタンスを作成および構成します。

## <a name="create-and-configure-the-azure-redis-cache-instance"></a>Azure Redis Cache インスタンスの作成および構成

Azure portal、Azure CLI、または Azure PowerShell を使用して Redis cache を作成することができます。 これは、いくつかのパラメーターは、目的のキャッシュを正しく構成するために決定する必要があります。

### <a name="name"></a>名前

Redis cache は、グローバルに一意の名前を必要があります。 名は、接続、サービスと通信して、公開 URL を生成するために Azure 内で一意である必要があります。

名前があります 1 ~ 63 文字、数字で構成される間、アルファベット、および '-' 文字。 キャッシュ名の先頭と末尾には '-' 文字を使用できません。また、連続する '-' 文字は無効です。

### <a name="resource-group"></a>リソース グループ

Azure Redis Cache は、マネージ リソースとニーズを_リソース グループ_所有者。 新しいリソース グループを作成するか、参加している susbcription で既存のものを使用します。

### <a name="location"></a>場所

Redis cache に物理的に位置する Azure リージョンを選択して、決定する必要があります。 常に、同じリージョンに、キャッシュ インスタンスと、アプリケーションを配置する必要があります。 別のリージョンでのキャッシュに接続することができますが大幅に待ち時間が長くなると信頼性を削減します。 Azure の外部でキャッシュに接続する場合は、データを消費するアプリケーションが実行されている近くの場所を選択します。

> [!IMPORTANT]
> Redis cache にデータの近くに配置_コンシューマー_できます。

### <a name="pricing-tier"></a>[価格レベル] 

前述の最後のユニットで、Azure Redis Cache の使用可能な 3 つの価格レベルがあります。

- **基本的な**: 開発/テスト用に最適な Basic キャッシュ。 1 台のサーバー、53 GB のメモリ、および 20,000 接続に制限されます。 このサービス層では、SLA はありません。
- **標準**: 実稼働のキャッシュのレプリケーションのサポートおよび SLA には 99.99% が含まれています。 2 つのサーバー (マスター/スレーブ) をサポートし、Basic レベルと同じメモリ/接続の制限があります。
- **Premium**: エンタープライズ レベル、Standard レベルでビルドし、永続化、クラスタ リング、およびスケール アウト キャッシュのサポートが含まれています。 これは、最大 530 GB のメモリと同時に 40,000 で最高のパフォーマンス レベルです。

各階層で使用可能なキャッシュ メモリの量を制御できます: Basic または Standard と Premium の P0-P4、C0 C6 からキャッシュ レベルを選択してこのオプションを選択します。 チェック、[価格のページ](https://azure.microsoft.com/en-us/pricing/details/cache/)の完全な詳細情報。

> [!TIP]
> 常に Standard または Premium レベルを実稼働システムで使用することをお勧めします。 Basic レベルは単一ノード システムであり、データ レプリケーション機能や SLA がありません。 また、C1 以上のキャッシュを使用してください。 C0 キャッシュは共有の CPU コアと非常に少量のメモリがあるために、非常に単純な開発/テスト シナリオのものです。

Premium レベルでは、ディザスター リカバリーを実現する 2 つの方法でデータを保持できます。

1. RDB 永続化では、定期的にスナップショットが撮られます。エラーが発生した場合には、このスナップショットを使用してキャッシュを再構築できます。

    ![新しい Redis Cache インスタンスの RDB 永続化オプションを示す Azure portal のスクリーンショット。](../media/3-redis-persistence-1.png)

2. AOF 永続化では、すべての書き込み操作がログに最低 1 秒に一度保存されます。 これでは、ファイル サイズが RDB よりも大きくなりますが、データの損失は少ないです。

    ![新しい Redis Cache インスタンスの AOF 永続化オプションを示す Azure portal のスクリーンショット。](../media/3-redis-persistence-2.png)

のみに使用できるその他のいくつかの設定がある、 **Premium**層。

### <a name="virtual-network-support"></a>Virtual Network のサポート

Premium レベルの Redis cache を作成する場合は、クラウド内の仮想ネットワークにデプロイできます。 キャッシュは同じ仮想ネットワーク内の他の仮想マシンやアプリケーションのみが使用できます。 これにより、両方は、Azure でホストされている、サービスとキャッシュ、または Azure virtual network VPN 経由で接続しているとき、高いレベルのセキュリティを提供します。

### <a name="clustering-support"></a>クラスタ リングのサポート

Premium レベルの Redis Cache では、クラスタリングを実装して、複数のノードに自動的にデータセットが分割されるようにできます。 クラスタリングを実装するには、最大を 10 とし、シャードの数値を指定します。 発生するコストは、シャードの数を乗算して、元のノードのコストです。

## <a name="accessing-the-redis-instance"></a>Redis インスタンスにアクセスします。

Redis セットがサポートする[既知のコマンド](https://redis.io/commands)します。 通常、コマンドとして発行`COMMAND parameter1 parameter2 parameter3`します。

使用できるいくつかの一般的なコマンドを次に示します。

| コマンド | 説明 |
|---------|-------------|
| `ping` | サーバーの ping を実行します。 "PONG"を返します。 |
| `set [key] [value]` | キャッシュのキー/値を設定します。 成功した場合に、"OK"を返します。 |
| `get [key]` | キャッシュから値を取得します。 |
| `exists [key]` | 場合 '1' を返します、**キー**開かない場合は、キャッシュ、'0' に存在します。 |
| `type [key]` | 値に関連付けられている型を返します、指定された**キー**します。 |
| `incr [key]` | 関連付けられている指定された値をインクリメント**キー** '1' です。 値は、整数または double 値である必要があります。 これは、新しい値を返します。 |
| `incrby [key] [amount]` | 関連付けられている指定された値をインクリメント**キー**指定の量。 値は、整数または double 値である必要があります。 これは、新しい値を返します。 |
| `del [key]` | 関連付けられている値を削除、**キー**します。 |
| `flushdb` | 削除_すべて_キーと、データベース内の値。 |

Redis がコマンド ライン ツール (**redis cli**) これらのコマンドを直接実験に使用することができます。 次に例をいくつか示します。

```output
> set somekey somevalue
OK
> get somekey
"somevalue"
> exists somekey
(string) 1
> del somekey
(string) 1
> exists somekey
(string) 0
```

次の操作の例に示します、`INCR`コマンド。 これらは、分割不可能なインクリメントを提供するため、便利な_複数のアプリケーションで_キャッシュを使用しています。

```output
> set counter 100
OK
> incr counter
(integer) 101
> incrby counter 50
(integer) 151
> type counter
(integer)
```

### <a name="adding-an-expiration-time-to-values"></a>値に有効期限を追加します。

値がメモリ内ストアは一般的に使用することができますので、キャッシュが重要です。 ただし、値が古いと期限切れにする方法も必要です。 Redis で適用することでこれは、 _time-to-live_ (TTL) キーにします。

TTL が経過すると、キーは自動的に削除、DEL コマンドが発行された場合とまったく同様です。 TTL の有効期限で次の事項を示します。

- 有効期限の設定は、秒またはミリ秒の精度を使用して設定できます。
- 有効期間の精度は、常に 1 ミリ秒です。
- に関する情報の有効期限が切れるのレプリケートおよび永続化ディスクで、時間事実上渡します Redis サーバーのままです (つまり、Redis はキーが期限切れになる日付を保存します) を停止したときにします。

有効期限の例を次に示します。

```output
> set counter 100
OK
> expire counter 5
(integer) 1
> get counter
100
... wait ...
> get counter
(nil)
```

## <a name="accessing-a-redis-cache-from-a-client"></a>クライアントから Redis cache へのアクセス

Azure Redis Cache インスタンスに接続するには、いくつかの情報を必要があります。 クライアントには、キャッシュのホスト名、ポート、およびアクセス キーが必要があります。 を通じて、Azure portal でこの情報を取得することができます、**設定 > アクセス キー**ページ。 

- ホスト名は、キャッシュの名前を使用して作成された、キャッシュのパブリック インターネット アドレスです。 たとえば、「 `sportsresults.redis.cache.windows.net` 」のように指定します。

- アクセス キーは、ご自分のキャッシュのパスワードとして動作します。 作成された 2 つのキーがある: プライマリとセカンダリ。 どちらのキーを使用できますが、プライマリ キーを変更する必要がある場合を提供 2 されます。 すべてのクライアントをセカンダリ キーに切り替えるし、プライマリ キーを再生成できます。 これは、元のプライマリ キーを使用しているアプリケーションをブロックします。 個人、パスワードの場合と同様に定期的にキー - を再生成することをお勧めします。

> [!WARNING]
> アクセス キーが扱うをパスワードと同じように、機密情報を検討してください。 キャッシュで操作を実行、アクセス キーを持つユーザーことができます。
