アプリケーションに必要なクライアント ライブラリを追加し、Azure ストレージ アカウントに接続する準備が整いました。

ストレージ アカウントでデータを操作するには、アプリで次の 2 つのデータが必要になります。

1. [アクセス キー](#access-key)
1. [REST API エンドポイント](#rest-endpoint)

<a name="access-key"></a>

## <a name="security-access-keys"></a>セキュリティ アクセス キー

各ストレージ アカウントには、ストレージ アカウントをセキュリティで保護するために使用される一意の_アクセス キー_が 2 つあります。 アプリで複数のストレージ アカウントに接続する必要がある場合、そのアプリでは各ストレージ アカウント用のアクセス キーが必要になります。

![クラウド内の異なる 2 つのストレージ アカウントに接続されているアプリケーションを示す図。 各ストレージ アカウントには一意のキーを使用してアクセスできます。](..\media\6-multiple-accounts.png)

<a name="rest-endpoint"></a>

## <a name="rest-api-endpoint"></a>REST API エンドポイント

ストレージ アカウントに対する認証用のアクセス キーに加え、アプリでは、REST 要求を発行するためのストレージ サービス エンドポイントを認識する必要があります。 

REST エンドポイントは、ストレージ アカウントの_名前_、データ型、および既知のドメインを組み合わせたものです。 例:

| データ型 | エンドポイント例 |
|-----------|------------------|
| BLOB     | `https://[name].blob.core.windows.net/` |
| キュー    | `https://[name].queue.core.windows.net/` |
| テーブル     | `https://[name].table.core.windows.net/` |
| ファイル     | `https://[name].file.core.windows.net/` |

Azure にカスタム ドメインを関連付けている場合は、エンドポイント用のカスタム ドメイン URL を作成することもできます。

## <a name="connection-strings"></a>接続文字列

この情報を処理する最もシンプルな方法は、**ストレージ アカウントの接続文字列**を使用することです。接続文字列では、単一のテキスト文字列に必要なすべての接続情報が提供されます。

Azure Storage の接続文字列は、下の例と似ていますが、アクセス キーとアカウント名はご利用の特定のストレージ アカウントのものとなります。

```
DefaultEndpointsProtocol=https;AccountName={your-storage};
   AccountKey={your-access-key};
   EndpointSuffix=core.windows.net
```

## <a name="security"></a>セキュリティ

アクセス キーは、ストレージ アカウントにアクセスするために重要で、ストレージ アカウントにアクセスを許可したくないシステムまたはユーザーには知らせないようにする必要があります。 アクセス キーは、コンピューターにアクセスするためのユーザー名とパスワードと同じです。

通常、ストレージ アカウントの接続情報は、環境変数、データベース、または構成ファイル内に格納されます。

> [!IMPORTANT]
> この情報を構成ファイルに格納すると、そのファイルがソース管理に含められてパブリック リポジトリに格納された場合に危険であることに注意してください。 これはよくある間違いであり、すべてのユーザーがパブリック リポジトリのソース コードと、ストレージ アカウントの接続情報を参照できることを意味します。

各ストレージ アカウントには、アクセス キーが 2 つあります。 これは、ストレージ アカウントを安全に保つためのセキュリティ上のベスト プラクティスの一部として、キーを定期的にローテーション (再生成) できるようにするためです。 このプロセスは、Azure portal または Azure CLI / PowerShell コマンド ライン ツールから実行できます。

キーをローテーションすると元のキーの値がするに無効になり、キーを不正に取得したユーザーのアクセスが取り消されます。 2 つのキーがサポートされているため、キーのローテーション時に、キーを使用するアプリケーションでダウンタイムが発生しないようにできます。 アプリで別のアクセス キーを使用するように切り替えて、その間にもう 1 つのキーを再生成します。 このストレージ アカウントを使用するアプリが複数ある場合、すべて同じキーを使用して、この手法をサポートする必要があります。 基本的な考え方を以下に示します。

1. ストレージ アカウントのセカンダリ アクセス キーを参照するように、アプリケーション コードの接続文字列を更新します。
2. Azure portal またはコマンド ライン ツールを使用して、ストレージ アカウント用のプライマリ アクセス キーを再生成します。
3. 新しいプライマリ アクセス キーを参照するように、コードの接続文字列を更新します。
4. 同様に、セカンダリ アクセス キーを再生成します。

> [!TIP]
> アクセス キーを定期的にローテーションし、パスワードを変更する場合と同じように、プライベートな状態を保つことを強くお勧めします。 サーバー アプリケーションでキーを使用する場合は、**Azure Key Vault** を利用してアクセス キーを自動的に格納することができます。 Key Vault には、ストレージ アカウントに直接同期し、キーを定期的に自動でローテーションするためのサポートが含まれています。 Key Vault を使用すると、セキュリティ層が追加されるため、ご利用のアプリでアクセス キーを直接操作する必要はありません。

### <a name="shared-access-signatures-sas"></a>共有アクセス署名 (SAS)

アクセス キーは、ストレージ アカウントへのアクセスを認証する最も簡単な方法ですが、コンピューター上のルート パスワードと同様に、ストレージ アカウント内のすべてのものに対するフル アクセスが提供されます。 

ストレージ アカウントでは、_共有アクセス署名_と呼ばれる別の認証メカニズムが提供され、制限付きアクセスを許可する必要があるシナリオにおいて制限付きのアクセス許可と有効期限がサポートされます。 ご自分のストレージ アカウントに他のユーザーがデータを読み書きできるようにする場合は、この方法を使用する必要があります。 モジュールの最後にこの高度なトピックに関するドキュメントへのリンクがあります。
