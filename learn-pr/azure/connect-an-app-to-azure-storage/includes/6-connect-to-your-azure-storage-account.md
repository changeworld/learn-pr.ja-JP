アプリケーションに必要なクライアント ライブラリを追加し、Azure ストレージ アカウントに接続する準備が整いました。 ただ、接続するアカウントと、そのストレージ アカウントの存在領域を、アプリはどのように把握するのでしょうか? 正しく構成しないと、アプリは Azure ストレージ アカウントに接続する方法がわかりません。 

ここでは、Azure portal でストレージ アカウントの接続情報を検索し、アプリケーションの構成に追加して、アプリが Azure ストレージ アカウントに接続できるようにします。

## <a name="access-keys"></a>アクセス キー

各ストレージ アカウントには、ストレージ アカウントへのアクセスが許可されるアクセス キーのセットがあります。 アプリが複数のストレージ アカウントに接続する必要がある場合、アプリには各ストレージ アカウント用にアクセス キーが必要です。

![複数のアカウント](..\media-draft\6-multiple-accounts.png)

Azure はクラウド プロバイダーであるため、ストレージ アカウントへの認証用のアクセス キーに加え、インターネットからストレージ アカウントにアクセスするためのストレージ サービスのエンドポイントを認識している必要があります。 この情報を処理する最もシンプルな方法は、1 つの文字列に必要なすべての接続情報が含まれるストレージ アカウント接続文字列を使用することです。

Azure Storage 接続文字列は、下の例と類似していますが、ご利用の特定のストレージ アカウントのアクセス キーとアカウント名が使用されたものである必要があります。

```csharp
DefaultEndpointsProtocol=https;AccountName={your-storage};AccountKey={your-access-key};EndpointSuffix=core.windows.net
```

## <a name="security"></a>セキュリティ

アクセス キーは、ストレージ アカウントにアクセスするために重要で、ストレージ アカウントにアクセスを許可したくないシステムまたはユーザーには知らせないようにする必要があります。 アクセス キーは、コンピューターにアクセスするためのユーザー名とパスワードと同じです。

通常、ストレージ アカウントの接続情報は、環境変数、データベース、または構成ファイルに格納されます。

この情報を構成ファイルに格納した場合、そのファイルがソース コントロールに含められ、パブリック リポジトリに格納された場合も危険であることに注意をすることが重要です。 これはよく行われる間違いで、パブリック リポジトリにあるソース コードのストレージ アカウントの接続情報は、すべてのユーザーが参照できてしまいます。

ストレージ アカウントには、共有アクセス署名と呼ばれる、有効期限と、アクセスを制限したいシナリオでの制限付きのアクセス許可の付与をサポートする別の認証メカニズムがあります。 このトピックはここでは取り上げません。このモジュールに必要な知識ではないためです。 ただし、詳細については、[こちら](https://docs.microsoft.com/azure/storage/common/storage-dotnet-shared-access-signature-part-1)で確認できます。

各ストレージ アカウントには、アクセス キーが 2 つあります。 これは、ストレージ アカウントを安全に保つためのセキュリティ上のベスト プラクティスとして、キーを定期的にローテーション (再生成) するためです。 この手順は、Azure portal または Azure CLI から実行できます。

キーをローテーションすると元のキー値が即座に無効になり、キーを不正に取得したユーザーのアクセスが取り消されます。 2 つのキーがサポートされているため、キーのローテーション時に、キーを使用するアプリケーションでダウンタイムが発生しないようにできます。 アプリで別のアクセス キーを使用するように切り替えて、その間にもう 1 つのキーを再生成します。 このストレージ アカウントを使用するアプリが複数ある場合、このテクニックを使用するために、すべてで同じキーを使用するようにする必要があります。 詳細については、[こちらを](https://docs.microsoft.com/azure/storage/common/storage-create-storage-account#manage-your-storage-access-keys)を参照してください。

## <a name="advanced-security-options"></a>高度なセキュリティ オプション

Azure には、アクセス キー、パスワードや証明書など、すべての形式のシークレットを安全に格納するよう設計されている、Azure Key Vault と呼ばれる優秀なセキュリティ ストアがあります。 この機能を使用すると、アクセス キーを安全に格納して、自動的にローテーションされるようにできます。

この機能は、このモジュールでは扱いません。詳細については、[こちら](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-storage-keys)を参照してください。

## <a name="summary"></a>まとめ

Azure ストレージ アカウントに接続するには、次の 2 つが必要です。 アクセス キーはユーザー名およびパスワードと似ていて、機密にする必要があります。 また、サービス エンドポイントも必要です。これは接続文字列によって表されます。
