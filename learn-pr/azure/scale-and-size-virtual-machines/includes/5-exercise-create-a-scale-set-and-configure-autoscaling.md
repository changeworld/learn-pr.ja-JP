この課題では Azure portal を使用し、仮想マシン スケール セットと自動スケール規則を作成します。

## <a name="create-a-virtual-machine-scale-set"></a>仮想マシン スケール セットを作成する

1. Azure Portal で、**[リソースの作成]** をクリックします。

1. 検索ボックスに「**スケール セット**」と入力し、Enter キーを押します。 **[結果]** ブレードで**仮想マシン スケール セット**をクリックし、**[仮想マシン スケール セット]** ブレードで **[作成]** をクリックします｡

1. **[仮想マシン スケール セットの作成]** ブレードで次の値を入力し､(`<your initials>`、 `<date>`および`<time>`には適宜入力)、**[作成]** をクリックします｡

    |設定|値|
    |---|---|
    |仮想マシン スケール セット名|WebServerSS|
    |リソース グループ|既存を利用 - ExerciseRG|
    |ユーザー名|LocalAdmin|
    |パスワードとパスワードの確認|Adm1nPa$$word|
    |インスタンス数|2|
    |インスタンスのサイズ|D2s_v3|
    |負荷分散のオプションを選択|Load Balancer|
    |パブリック IP アドレス名|WebServerPubIP|
    |ドメイン名のラベル|`<your initials><date><time>` (例: ja0904181202)|

1. スケール セットが作成されるまで待ちます。

1. **ExerciseRG** リソース グループに移動します。 **[ExerciseRG]** ブレードで **WebServerSS** オブジェクトをクリックし、**[WebServerSS]** ブレードで **[インスタンス]** をクリックします。 スケール セット内で2 つの仮想マシン インスタンスが実行されることに注意してください。

## <a name="create-and-apply-autoscale-rules"></a>自動スケール規則を作成､適用する

1. **[WebServerSS]** ブレードで、**[スケール]** をクリックします。 **[WebServerSS - スケール]** ブレードで **[自動スケールを有効]** をクリックします｡

1. **WebServerSS - スケール**ブレードで**規則を追加**  をクリックします。

1. [スケール規則] ブレードで次の情報を入力し､**追加** をクリックします。これにより､平均 CPU 使用率が 5 分以上にわたって 75% を上回ったときに臨時の 2 つの仮想マシンをスケールアウトする規則が作成されます｡

    |設定|値|
    |---|---|
    |総時間|平均|
    |メトリックの名前|CPU 使用率|
    |統計時間単位|平均|
    |演算子|より大きい|
    |しきい値|75|
    |時間 (分単位)|5|
    |Operation (運用)|増加単位|
    |インスタンス数|2|
    |クールダウン (分)|5|

1. **WebServerSS - スケール**ブレードで**規則を追加**  をクリックします。

1. [スケール規則] ブレードで次の情報を入力して **[追加]** をクリックします｡これにより、平均 CPU 使用率が 5 分以上にわたって 30% を下回ったときにサーバーを 1台ずつスケールインする規則が作成されます｡

    |設定|値|
    |---|---|
    |総時間|平均|
    |メトリックの名前|CPU 使用率|
    |統計時間単位|平均|
    |演算子|より小さい|
    |しきい値|30|
    |時間 (分単位)|5|
    |Operation (運用)|減少単位|
    |インスタンス数|1|
    |クールダウン (分)|5|

1. **[WebServerSS - スケール]** ブレードの **[自動スケール設定の名前]** ボックスに「 **WebAutoscaleSetting**と入力します。 **[インスタンス数の制限]** の横に次の値を設定し、**[保存]** をクリックします。

    |設定|値|
    |---|---|
    |最小値|2|
    |最大値|8|
    |既定値|2|

## <a name="generate-load-to-demonstrate-autoscaling"></a>負荷を生成して自動スケールのデモをする

ここでは、CPUStress.exe ツールを利用して､スケール セット内の仮想マシンに負荷を生成し、自動スケール アウトのデモをします。

1. 接続先のパブリック IP アドレスを求めるには、 **ExerciseRG** リソース グループに移動します。 **[ExerciseRG]** ブレードで **WebServerSSlb** オブジェクトをクリックします。

1. **[WebServerSSlb]** ブレードで [フロントエンド IP 構成] をクリックし、表示されたパブリック IP アドレスを書き留めます｡ **[LoadBalancerFrontEnd]** ブレードを閉じます。

1. 接続先のポート番号を求めるには､**[WebServerSSlb]** ブレードで **[受信 NAT 規則]** をクリックします。 各仮想マシンの [サービス] 列にあるカスタム ポート番号を書き留めます｡

1. ローカル コンピューター上で **[リモート デスクトップ接続]** を起動します。 **[コンピューター]** ボックスでロード バランサーのパブリック IP アドレスを入力し､コロンに続けてインスタンス 0 のポート番号値を入力して (例:40.67.191.221:50000 )､[接続] をクリックします。

1. **[Windows セキュリティ]** ダイアログ ボックスで **[More choices]** をクリックし､**[別のアカウントを使用] をクリックします｡****[ユーザー名]** ボックスに **LocalAdmin** と入力し、**[パスワード]** ボックスに **Adm1nPa$ $word** と入力して､**[OK]** をクリックします｡

1. **[リモート デスクトップ接続]** ダイアログ ボックスで、**[はい]** をクリックします。

1. 仮想マシンのリモート デスクトップで Internet Explorer を開き、 **[Set up Internet Explorer]** ダイアログ ボックスで **[OK]** をクリックします。

1. **Internet Explorer** のアドレス バーに **http://download.sysinternals.com/files/CPUSTRES.zip** と入力して､ENTER キーを押します。 **Internet Explorer**ダイアログ ボックスで、**[追加]** をクリックします。 **[信頼済みサイト]** ダイアログ ボックスで、**[追加]** をクリックし､**[閉じる]** をクリックします。

1. ダウンロードのプロンプトが自動的に表示されない場合は、再度 URL を入力して、ENTER キーを押します｡ **[Internet Explorer]** ダイアログ ボックスで **[保存]** をクリックします。 ダウンロードが完了したら、**[フォルダーを開く]** をクリックします。

1. **[ダウンロード]** フォルダーで **CPUSTRES** をダブルクリックし、**CPUSTRES** アプリケーションをダブルクリックします。 **[圧縮 (zip 形式) フォルダー]** ダイアログ ボックスで **[実行]** をクリックします。

1. **[CPU Stress]** ウィンドウの **[スレッド 1]** の **[アクティビティ]** ドロップダウン リストから **[最大]** を選択します｡ **[スレッド 2]** で **[Active]** チェック ボックスをクリックし、**[アクティビティ]** ドロップダウン リストから **[最大]** を選択します。

1. [スタート] ボタンをクリックし、**[タスク マネージャー]** をクリックします。 タスク マネージャーで **[詳細]** をクリックし､CPU が 75% を超えていることを確認します。

1. スケール セット内のもう一方の仮想マシンで **CPUSTRES** のインストールと起動手順を繰り返し､5 分間待機します。

1. Azure portal で **ExerciseRG**リソース グループに移動し、 **[ExerciseRG]** ブレードで **WebServerSS** オブジェクトをクリックします｡**[WebServerSS]** ブレードで **インスタンス** をクリックします。 スケール セット内に表示されている仮想マシン インスタンス数とそれらのステータスをメモします｡

ここでは、仮想マシンが 2 つの仮想マシン スケールセットを作成しました。 さらに､そのスケールセットで自動的にスケール アウトとスケール インする規則を作成し、それら規則を自動スケール プロファイルに追加しました。