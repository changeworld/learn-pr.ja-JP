この課題では Azure portal を使用し、仮想マシン スケール セットと自動スケール規則を作成します。

## <a name="create-a-virtual-machine-scale-set"></a>仮想マシン スケール セットを作成する

1. [Azure portal](https://portal.azure.com/learn.docs.microsoft.com?azure-portal=true) で、**[リソースの作成]** をクリックします。

1. 検索ボックスに「**scale set**」と入力し、<kbd>Enter</kbd> キーを押します。 **[結果]** ブレードで **Virtual machine scale set** をクリックし、**[Virtual machine scale set]** ブレードで **[作成]** をクリックします。

1. **[仮想マシン スケール セットの作成]** ブレードで、次の値を入力します。
    - **[名前]** には _WebServerSS_ を使用します。
    - **[オペレーティング システムのディスク イメージ]** は _Windows Server 2016 Datacenter_ のままにします。
    - **[サブスクリプション]** には "_コンシェルジェ サブスクリプション_" を使用します。
    - **[リソース グループ]** では **<rgn>[サンドボックス リソース グループ名]</rgn>** を選択します。
    - 次の一覧から場所を選択します。[!include[](../../../includes/azure-sandbox-regions-note-friendly.md)]

    - 有効な **[ユーザー名]** と **[パスワード]** を設定します。 (後で使うのでメモしておきます)
    - **[インスタンス数]** は _2_ に設定します。
    - **[インスタンス サイズ]** は _D2s_v3_ に設定します。
    - **[自動スケール]** は _[無効]_ のままにします。
    - **[ロード バランサーLoad balancer]** を選択します。
    - **[パブリック IP アドレス名]** に「_WebServerPubIP_」と入力します。
    - **[ドメイン名ラベル]** は、一意になるように "イニシャル + 日付 + 時刻" を使用します。
    - **[仮想ネットワーク]** では **[新規作成]** を選択します。 名前を「**SSVNet**」にして **[作成]** をクリックし、VNet を作成します。

1. **[作成]** をクリックして、スケール セットをデプロイします。

1. スケール セットが作成されるまで待ちます。

## <a name="create-and-apply-autoscale-rules"></a>自動スケール規則を作成して適用する

1. 左サイドバーで **[リソース グループ]** をクリックします。

1. **<rgn>[サンドボックス リソース グループ名]</rgn>** というリソース グループを選択します。

1. **<rgn>[サンド ボックス リソース グループ名]</rgn>** ブレードで、**WebServerSS** オブジェクトをクリックしてスケール セットを開きます。

1. **[WebServerSS]** ブレードで、**[設定]** の **[インスタンス]** をクリックします。 スケール セット内で 2 つの仮想マシン インスタンスが実行されることに注意してください。

1. **[WebServerSS]** ブレードで、**[スケーリング]** をクリックします。

1. **[WebServerSS - スケーリング]** ブレードで **[自動スケールの有効化]** をクリックします。

1. 構成画面で、名前を **WebAutoscaleSetting** に設定します。

1. 既定の条件で **[インスタンスの制限]** を検索し、次の値を設定します。

    |設定|値|
    |---|---|
    |最小値|2|
    |最大値|8|
    |既定値|2|

1. **[ルールの追加]** をクリックします。

1. **[スケール ルール]** ブレードで次の情報を入力し、**[追加]** をクリックします。これにより、平均 CPU 使用率が 5 分以上にわたって 75% を上回ったら、さらに 2 つの仮想マシンをスケールアウトするルールが作成されます。

    |設定|値|
    |---|---|
    |総時間|平均|
    |メトリックの名前|CPU 使用率|
    |統計時間単位|平均|
    |演算子|より大きい|
    |しきい値|75|
    |時間 (分単位)|5|
    |Operation (運用)|増加単位|
    |インスタンス数|2|
    |クールダウン (分)|5|

1. 次の情報を入力して **[追加]** をクリックし、別のルールを追加します。今度は、平均 CPU 使用率が 5 分以上にわたって 30% を下回ったら、サーバーを 1 台ずつスケールインするルールが作成されます。

    |設定|値|
    |---|---|
    |総時間|平均|
    |メトリックの名前|CPU 使用率|
    |統計時間単位|平均|
    |演算子|より小さい|
    |しきい値|30|
    |時間 (分単位)|5|
    |Operation (運用)|減少単位|
    |インスタンス数|1|
    |クールダウン (分)|5|

1. ルールは次のようになります。

    ![VM スケール セットに適用される自動スケール ルール セットのスクリーンショット](../media/5-scale-rules.png)

1. **[保存]** をクリックします。

## <a name="generate-load-to-demonstrate-autoscaling"></a>負荷を生成して自動スケールのデモをする

ここでは、SysInternals の **CPUStress.exe** ツールを利用して、スケール セット内の仮想マシンに負荷を生成し、自動スケール アウトのデモをします。

これを VM で実行します。このために Windows を用意する必要はありませんが、リモート デスクトップ クライアントが "_必要です_"。 Microsoft には Windows 用と macOS 用のリモート デスクトップ クライアントがあり、さまざまな Linux ディストリビューションにもクライアントが含まれます。

1. 接続先のパブリック IP アドレスを求めるには、**<rgn>[サンドボックス リソース グループ名]</rgn>** リソース グループを参照します。 **<rgn>[サンド ボックス リソース グループ名]</rgn>** ブレードで、**WebServerSSlb** オブジェクトをクリックします。

1. **[WebServerSSlb]** ブレードで **[フロントエンド IP 構成]** をクリックして、表示されたパブリック IP アドレスを書き留めます。 **[LoadBalancerFrontEnd]** ブレードを閉じます。

1. 接続先のポート番号を求めるには､**[WebServerSSlb]** ブレードで **[受信 NAT 規則]** をクリックします。 各仮想マシンの [サービス] 列にあるカスタム ポート番号を書き留めます｡

1. ローカル コンピューター上で **[リモート デスクトップ接続]** を起動します。 **[コンピューター]** ボックスにロード バランサーのパブリック IP アドレスを入力し、コロンを入力してから、インスタンス 0 のポート番号値 (例:40.67.191.221:50000 ) を入力して、**[接続]** をクリックします。

1. **[Windows セキュリティ]** ダイアログ ボックスで **[その他]** をクリックし、**[別のアカウントを使う]** をクリックします。 **[ユーザー名]** ボックスと **[パスワード]** ボックスに、スケール セットを作成するときに指定した資格情報を入力します。

1. **[リモート デスクトップ接続]** ダイアログ ボックスで、**[はい]** をクリックします。

1. 仮想マシンのリモート デスクトップで Internet Explorer を開き、**[Internet Explorer の設定]** ダイアログ ボックスで **[OK]** をクリックします。

1. **Internet Explorer** のアドレス バーに「**http://download.sysinternals.com/files/CPUSTRES.zip**」と入力して、<kbd>Enter</kbd> キーを押します。 **[Internet Explorer]** ダイアログ ボックスで、**[追加]** をクリックします。 **[信頼済みサイト]** ダイアログ ボックスで、**[追加]** をクリックし、**[閉じる]** をクリックします。

1. ダウンロードのプロンプトが自動的に表示されない場合は、再度 URL を入力して、<kbd>Enter</kbd> キーを押します。 **[Internet Explorer]** ダイアログ ボックスで **[保存]** をクリックします。 ダウンロードが完了したら、**[フォルダーを開く]** をクリックします。

1. **[ダウンロード]** フォルダーで **CPUSTRES** をダブルクリックし、**CPUSTRES** アプリケーションをダブルクリックします。 **[圧縮 (zip 形式) フォルダー]** ダイアログ ボックスで **[実行]** をクリックします。

1. **[CPU Stress]\(CPU ストレス\)** ウィンドウの **[Thread 1]\(スレッド 1\)** で、**[Activity]\(アクティビティ\)** ドロップダウンから **[Maximum]\(最大\)** を選択します。 **[Thread 2]\(スレッド 2\)** で **[Active]\(アクティブ\)** チェック ボックスをオンにし、**[Activity]\(アクティビティ\)** ドロップダウン内部の下向き矢印をクリックして **[Maximum]\(最大\)** を選択します。 これらの設定はすぐに反映されます。

1. Windows の [スタート] ボタンをクリックし、**[タスク マネージャー]** をクリックします。 タスク マネージャーで **[詳細]** をクリックし、CPU が 75% を超えていることを確認します。

1. スケール セット内の他の仮想マシンで **CPUSTRES** のインストールと起動を**繰り返し**、5 分間待ちます。

1. Azure portal で、**<rgn>[サンドボックス リソース グループ名]</rgn>** リソース グループを参照します。 **<rgn>[サンド ボックス リソース グループ名]</rgn>** ブレードで、**WebServerSS** オブジェクトをクリックします。 **[WebServerSS]** ブレードで、**[インスタンス]** をクリックします。 スケール セット内に表示されている仮想マシン インスタンス数とそれらのステータスをメモします。

ここでは、仮想マシンが 2 つの仮想マシン スケールセットを作成しました。 さらに、そのスケールセットで自動的にスケールアウトとスケールインする規則を作成し、それら規則を自動スケール プロファイルに追加しました。
