リソースを入手することができます、Vm 間で要求を分散するロード バランサーを使って大規模な仮想マシンを 1 つまたは複数の小さな Vm のいずれかを使用する必要があります。

VM プールには、追加または需要が変更されたときに、Vm をすばやく削除できる便利な利点があります。 Toy 企業シナリオでは、この方法は、予期しない需要の急増を処理すると便利になります。 需要が増加し、要求が正常に返されるときに、それらを削除する場合は、プールに Vm を追加できます。 プールも提供の冗長性。1 つの VM が失敗した場合は、サービスを中断させずに要求を処理するために、他のユーザー続行できます。

このセクションでは、スケール セットを使用して複数の Vm をプロビジョニングする方法と自動的に追加し、需要の変化に応じてインスタンスを削除する方法がわかります。 

## <a name="what-is-horizontal-scaling"></a>水平方向のスケーリングとは

*水平方向のスケーリング*を追加または使用可能なリソースの量を調整するプールから仮想マシンを削除するプロセスです。 マシンの追加といいます_スケール アウト_、マシンを削除すると呼びます_スケールイン_します。 水平方向のスケーリングを使用するソリューションには、ロード バランサーまたはプール内の Vm 間で要求を分散するゲートウェイが含まれます。 次の図は、仮想マシン インスタンスの数を変更する例を示します。

![スケール アウト コストを削減するオンデマンドとリソースのスケーリングを処理するためにリソースを示す図。](../media/4-ScaleInOut.png)

この手法は、複数の同一サーバー間で実行できるアプリケーションを最適です。 たとえば、web サーバーおよび複数の Vm 上の web ページを複製することができ、それらはすべての提供先のサーバーに関係なく同じ応答が要求を受信します。 その一方で、バックエンドのデータベースを実行する VM は最適な候補の同期コピーを維持するために、データベースの複数のコピーを実行している必要があるためです。

## <a name="what-is-a-scale-set"></a>スケールの設定とは?

A*スケール セット*の同一の仮想マシン、ロード バランサーまたは、要求を分散するゲートウェイ プールであり、省略可能な Vm を追加またはプールから削除するときを制御する規則のセット。 ここでは、「同一」は、セット内の各 VM が同じイメージを使用して作成され、サイズは同じことです。

いくつかの柔軟性のあるソフトウェアと新しい VM を構成する方法にする必要があります。 基本 OS の定義済みのイメージで開始し、インストール、または OS の設定後に自動的にファイルをコピーするスクリプトを使用できます。 または、オペレーティング システムと、アプリケーション ソフトウェアを既にインストールされているカスタム仮想マシン イメージを作成できます。

## <a name="how-to-distribute-requests"></a>要求を分散する方法

スケール セット内の VM インスタンスに要求を分散するのにロード バランサーまたはアプリケーション ゲートウェイのいずれかを使用することができます。

Azure ロード バランサーは OSI レイヤー 4 (TCP および UDP) で動作し、発信元 IP アドレスとポートと宛先 IP アドレスとポートを組み合わせてに基づいてトラフィックをルーティングします。 クライアント セッションの間で一貫性を保つため、同じ移行先サーバーに、同じソース IP アドレスからのトラフィックのルーティング先のアフィニティを提供できます。 ロード バランサーには、サーバー インスタンスの可用性を決定する正常性プローブのメカニズムもあります。 仮想マシンは、正常性プローブに応答しなくなると、そのマシンに新しい接続をルーティング、load balancer が回避されます。

Application gateway は、OSI レイヤー 7 (アプリケーション層) で動作します。 などの Vm で web サーバーを実行している場合、ゲートウェイことができますを使用して、要求された URL ルーティングを実行します。 これは、要求を転送することは意味`*/customers*`サーバーとの要求の 1 つのプールの URL を`*/partners*`で別のプールへの URL。 アプリケーション ゲートウェイは HTTP を HTTPS へのリダイレクト、暗号化は、仮想マシンと既知の web を検出する規則を使用する web アプリケーション ファイアウォール (WAF) の処理要件を減らすために Secure Sockets Layer (SSL) の終了を指定もできます。悪用し、これらの要求が web サーバーに到達するを防止します。

## <a name="what-is-autoscaling"></a>自動スケールとは何ですか。

_自動スケール_が自動的にスケール アウトまたはスケールインのプロセスを一連のルールに基づいています。 ルールは、マシンの負荷またはスケジュールによってトリガーできます。 次の図は、自動スケール機能が、負荷を処理するインスタンスを管理する方法を示します。

![自動スケールの仮想マシンのプールの CPU のレベルを監視し、CPU 使用率がしきい値を超えるインスタンスが追加されますを示す図。](../media/4-autoscale.png)

スケール セットの自動スケールを有効にするには、自動スケール プロファイルを作成する必要があります。 プロファイルは、セットおよびスケーリング ルール用の VM インスタンスの最小値と最大数を定義します。 自動スケール ルールでは、次の要素があります。

* メトリック ソースの情報または自動スケール ルールをトリガーするデータのソース。 4 つのオプションがあります。
  * *現在のスケール セット*追加のエージェントを必要としない、ホストベースのメトリックを提供します。
  * *[ストレージ アカウント]*。 Azure 診断拡張機能は、パフォーマンス メトリックを Azure Storage に書き込みます。 これらのメトリックは、自動スケール ルールをトリガーに使用されます。
  * *Azure Service Bus キュー*自動スケールをトリガーする、アプリケーション ベースまたはその他の Azure Service Bus メッセージを指定できます。
  * *Azure Application Insights*スケール、アプリケーションから直接、メトリック データのストリーム セットで実行されているアプリケーションにインストールする必要があるインストルメンテーション パッケージを使用します。
* ルール条件 - これは、特定のメトリックを使用して、自動スケール ルールをトリガーします。 ホスト ベースのメトリックを使用している場合は、CPU 使用率、ネットワーク トラフィック量、ディスクの操作の CPU クレジットなどの側面を含めるこのことができます。 たとえば、1 秒あたりのディスク書き込み操作は、しきい値を超えた場合は、スケール アウトするルールを構成できます。 Azure 診断拡張機能または Application Insights を使用して、利用可能なメジャーを使用してルールをトリガーすることができますが、適切なエージェントの構成が必要です。
* 集計の種類 - このメトリック データを測定する方法を指定します、次のオプションのいずれかになります。
  * 平均
  * 最小値
  * 最大値
  * 合計
  * Last (最後へ)
  * Count
* 演算子の演算子は、どのメトリックがルールのアクションをトリガー定義されたしきい値に異なる必要がありますを表します。 これは、ルールはスケール アウトまたはスケールインするかどうかを識別するときに特に重要です。 演算子があります。
  * より大きい
  * 以上
  * より小さい
  * 以下
  * 等しい
  * 等しくない
* 操作 - ルールがトリガーされたときのインスタンスの数の変更方法を指定します。 次の操作を使用できます。
  * *別の数を増やす*仮想マシンの固定数。
  * *パーセントを増やす*既存のインスタンスの割合。
  * *数を増やす*仮想マシンの特定の数。
  * *別の数を減らす*仮想マシンの固定数。
  * *パーセントを減らす*既存のインスタンスの割合。
  * *数を減らす*仮想マシンの特定の数。

スケジュールでトリガーする自動スケール ルールを作成することもできます。 たとえば、需要が高いがわかって朝にスケール アウトし、需要が通常が減少昼食後で拡大または縮小するルールを定義する可能性があります。

## <a name="how-to-create-a-scale-set"></a>スケール セットを作成する方法

スケール セット、Azure portal、Azure PowerShell、または Azure CLI を使用して作成できます。

### <a name="portal"></a>ポータル

Azure portal を使用して、スケール セットを作成する場合は、起動時に作成する VM インスタンスの数と、仮想マシンに使用するオペレーティング システム イメージを指定します。 また、各インスタンスであり、Azure load balancer を使用するかどうかのまたは負荷分散用のアプリケーション ゲートウェイのサイズを指定します。 ロード バランサーを選択した場合、ポータルは既定の正常性プローブをそのポート 80 で作成します。

### <a name="powershell"></a>PowerShell

仮想マシン スケール セットを作成することができます、 **New-azurermvmss** PowerShell コマンドレット。 このコマンドレットは、次のように新しいスケール セット、ロード バランサーを作成し、IP アドレスと仮想ネットワークの割り当てを制御できます。 コマンドレットでは、設定が指定されない限り**New-azurermvmss**次の既定の設定が使用されます。

* 2 つの仮想マシン インスタンスを作成します。
* Windows Server 2016 Datacenter イメージを使用します。
* 標準の DS1_v2 仮想マシンのサイズを使用して、
* ロード バランサーの作成
* Windows、Linux 用のポート 22 のポート 3389 と 5985 のロード バランサー規則を作成します。

**New-azurermvmss** load balancer の正常性プローブを作成できません。 使用してこれを作成するがベスト プラクティス**Add-azurermloadbalancerprobeconfig**スケール セットを作成した後。

スケール セットで水平方向のスケーリングと、アプリケーションを実行する複数のサーバーを提供します。 高を処理する複数のサーバーによりを使用して読み込みをサーバーがクラッシュした場合でも、サービスが使用可能な維持されます。 システムは、予期しない需要の変化を自動的に調整するために、スケール セットに自動スケールを追加できます。