最近、Lamna Healthcare の顧客向けのアプリケーションが停止し、大きな影響があったことがありました。 あるエンジニアに、運用環境の Web アプリケーションが含まれるリソース グループへのアクセス許可が完全な付与されていました。 このユーザーが間違って、顧客のライブ データがホストされているデータベースを含む、リソース グループとその子リソースをすべて削除してしまいました。 

さいわい、アプリケーションのソース コードとリソースはソース コントロールにあり、データベースの定期的なバックアップがスケジュールどおり自動実行されていました。 したがって、サービスは比較的簡単に元に戻りました。 ここでは、どうすればこの停止を、インフラストラクチャへのアクセスを保護する Azure の機能を使用して防ぐことができたかを調べます。

## <a name="criticality-of-infrastructure"></a>インフラストラクチャの重要性

多くの企業にとって、クラウド インフラストラクチャは重要な部分となってきています。 ユーザーおよびプロセスが、必要なアクセス許可のみで、遂行すべき作業を実行できることが保証される必要があります。 不正なアクセス許可を付与してしまうと、データが失われたり、データが漏えいしたり、サービスを提供できなくなってしまいます。 

システム管理者は、ユーザー、システムおよびアクセス許可のセットの責任を多数負っている場合があります。 したがって、アクセス許可の正しい付与の管理がすぐにできなくなり、対応がワンパターンになってしまう場合があります。 このアプローチでは、管理は単純化できるかもしれませんが、必要以上の制限の少ないアクセスを誤って付与してしまいやすくなります。

## <a name="role-based-access-control"></a>ロールベースのアクセス制御

ロールベースのアクセス制御 (RBAC) のアプローチは、若干異なります。 ロールとは、アクセス許可の集合であると定義されています。 セキュリティ プリンシパルは、ロールに直接マップするか、グループ メンバーシップを介してマップします。 セキュリティ プリンシパル、アクセス許可およびリソースを分離すると、アクセスの管理が単純になり、よりきめ細やかに制御ができるようになります。

Azure では、ユーザー、グループおよびロールは、すべて Azure Active Directory (Azure AD) に保存されます。 Azure Resource Manager の API は、ロールベースのアクセス制御を使用し、Azure 内のすべてのリソースへのアクセス管理を制御しています。

![ACL ベースのアクセス](../media-draft/ACL_Based_Access.png)

<!-- ![Role-based access control](../media-draft/Role_Based_Access.png)
 -->

### <a name="roles--management-groups"></a>ロールおよび管理グループ

ロールとは、"読み取り専用" または "共同作成者" など、Azure のサービス インスタンスにアクセスするためにユーザーに付与されるアクセス許可のセットです。 ロールは、サービス インスタンス レベルで個々に付与することもできますが、Azure Resource Manager の階層で下位にも伝送されます。 サブスクリプション全体など、より高いスコープに割り当てられているロールは、サービス インスタンスなどの子スコープへ継承されます。 

管理グループとは、RBAC モデルに最近導入された、追加の階層レベルです。 管理グループには、サブスクリプションをまとめてグループ化する機能や、より高いレベルにポリシーを適用する機能が追加されています。

任意に定義されたサブスクリプション階層でロールを伝送する機能により、管理者は、認証されたユーザーが環境全体への一時的なアクセス許可を得ることができるようにできます。 たとえば、監査担当者は、すべてのサブスクリプションに対して一時的な読み取り専用のアクセス許可を付与することができます。

![管理グループ](../media-draft/management_groups.png)

### <a name="privileged-identity-management"></a>Privileged Identity Management

インフラストラクチャを包括的に管理する場合、Azure のリソースへのアクセスを RBAC を使用して管理することに加え、組織の変化や発展に伴い、ロールのメンバーを継続的に監査することも行われる必要があります。 追加の有料のオファリングに、Azure AD Privileged Identity Management (PIM) があります。これでは、ロールの割り当て、セルフサービス、ジャストインタイムでのロールのアクティブ化および Azure AD と Azure のリソースへのアクセス確認を監視できます。

![Privileged Identity Management](../media-draft/PIM_Dashboard.PNG)

## <a name="providing-identities-to-services"></a>サービスへの ID の提供

サービスに ID があると役立つことが多々あります。 ベスト プラクティスには反しますが、資格情報はしばしば構成ファイルに埋め込まれています。 これらの構成ファイルはセキュリティで保護されていないので、システムやリポジトリにアクセスできるすべてのユーザーがこれらの資格情報にアクセスし、公開されてしまうリスクがあります。

Azure AD では、サービス プリンシパルとマネージド サービス ID の 2 つの方法でこの問題を解決しています。

### <a name="service-principals"></a>サービス プリンシパル

サービス プリンシパルを理解するには、まず、ID 管理の世界で使用される **ID** と**プリンシパル**という用語を理解する必要があります。

**ID** とは、単に認証できるものであるという意味です。 これには、当然ユーザー名とパスワードを持つユーザーが含まれますが、シークレット キーや証明書で認証される場合のあるアプリケーションやその他のサーバーも含まれます。 おまけの定義である**アカウント**とは、ID と関連付けられているデータです。

**プリンシパル**とは、特定のロールや要求と動作する ID です。 多くの場合、ID とプリンシパルを別に考えるのは便利ではありませんが、bash プロンプトで 'sudo' を使用する場合や、"管理者として実行" を Windows で使用する場合を考えてみてください。 それらのいずれの場合も、ユーザーは前と同じ ID でログインしていますが、実行しているロールが変更されています。

したがって、**サービス プリンシパル**は、文字どおりの名前です。 これは、サービスまたはアプリケーションが使用する ID です。 他の ID 同様、割り当てられるロールにすることも可能です。 

たとえば、Lamna Healthcare では、サービス プリンシパルとして認証されるように、その配置スクリプトに割り当てて実行することができます。 これが、破壊的なアクションを実行するアクセス許可を持つ唯一の ID であった場合、リソースの偶発的な削除が再度起こらないことを、Lamna が確認するには非常に役立ちます。

### <a name="managed-service-identities"></a>マネージド サービス ID

サービス プリンシパルを作成するプロセスは退屈であり、それらを維持するのが困難であるタッチ ポイントが多くがあります。 マネージド サービス ID (MSI) ははるかに簡単であり、作業のほとんどがユーザーに代わって実行されます。 

MSI は、MSI をサポートするすべての Azure サービス (これをサポートするサービスは増え続けています) で即座に作成することができます。 ユーザーがサービス用に MSI を作成する場合、アカウントは Azure Active Directory テナントに作成することになります。 Azure インフラストラクチャは、サービスの認証とアカウントの管理を自動で行ってくれます。 そのアカウントは、他のすべての AD アカウントと同様に使用できます。これには、認証されているサービスが安全にその他の Azure リソースにアクセスできるようにすることも含まれます。

Lamna Healthcare では、同社の ID 管理を一歩進め、インフラストラクチャの管理と配置を実行する機能が必要なサポートされているすべてのサービスに、MSI を使用しています。

## <a name="infrastructure-protection-at-lamna-healthcare"></a>Lamna Healthcare でのインフラストラクチャの保護

インフラストラクチャを誤って削除してしまった Lamna Healthcare が、それをどのように解決したかを説明しました。 同社では、ロールベースのアクセス制御を使用し、インフラストラクチャのセキュリティ管理を向上させ、マネージド サービス ID を使用して、資格情報をコードの外に配置し、サービスに必要な ID の管理を簡単にしました。

## <a name="summary"></a>まとめ

インフラストラクチャの可用性と整合性を確保するには、インフラストラクチャを適切に保護する必要があります。 RBAC やマネージド サービス ID などの機能を正しく使用すると、使用している Azure 環境を許可されていないアクセスや意図されていないアクセスから守り、アーキテクチャの ID セキュリティ機能を向上させることができます。