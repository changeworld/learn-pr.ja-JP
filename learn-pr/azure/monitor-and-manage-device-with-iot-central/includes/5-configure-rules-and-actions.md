コーヒー マシンを Azure IoT Central アプリケーションに接続し、コーヒー マシンを監視して管理できるようにするデータの交換を有効にしました。 このユニットでは、コーヒー マシンの水の温度が通常の範囲外にある場合は、アクションをトリガーする規則を作成します。 アクションは、マシンが保証期間内かどうかに応じて、メールまたはモバイル通知のどちらかです。 アクションとして Microsoft Flow を追加するには、Azure サブスクリプションが必要です。 Azure サブスクリプションがない場合は、アクションとしての Microsoft Flow の追加は省略可能です。

## <a name="create-rules-in-iot-central-with-email-as-the-action"></a>電子メールをアクションとして IoT Central でルールを作成する
Azure IoT Central には、通知を送信するネイティブなメール機能があります。 このシナリオでは、コーヒー マシンが最適温度の範囲外にあり、保証で保護されていない場合、IoT Central によってクライアントのメンテナンス部門にメールが送信されます。

移動し、**ルール**この単位で行う演習のページ。 選択 **+ 新しいルール**、し**テレメトリ**します。 コーヒー マシンの保証期限が切れていて、水の温度が最適範囲外になったときの、次の 2 つのルールを追加します。 完了したら、**[保存]** を選択します。 

> [!NOTE]
> 条件が適用されるには、実行されるルールのすべてのステートメントが真になる必要があります。 (例: 最適な温度が未満または保証しながら、定義済みの値より大きいが期限切れ) このシナリオに、条件と、「または」ステートメントは、次のように 2 つの規則にステートメントを分割します。

1. ルールの名前: コーヒー メーカーの水温が低すぎ (期限切れ)

    条件の追加:      
    * Device Warranty Expired equals 1
    * 水の温度がコーヒー メーカー Min 温度未満です。

    ![規則を使用してください。](../images/5-flow-a.png)

1. ルールの名前: コーヒー メーカーの水温が高すぎ (期限切れ)

    条件の追加:      
    * Device Warranty Expired equals 1
    * 水の温度がコーヒー メーカーの最大の温度を超えています。

1. 追加する、**アクション**遠隔測定規則の構成パネルの下にスクロールし、選択、 **+** 、アクションの横にあるを選択し、**電子メール**します。

1. アクションを定義するには、IoT Central アプリケーションへのサインインに使用したメール アドレスを追加します。 水温度が暑すぎるときの通知メッセージを追加します。"コーヒー メーカーの水が熱すぎます。 メンテナンスが必要です。  保証は終了しています。" 水温が低すぎる場合について同じ手順を繰り返します。 メッセージを追加します。"コーヒー メーカーの水が冷たすぎます。 メンテナンスが必要です。  保証は終了しています。"

1. **[保存]** を選択します。 ルールは、規則 ページに表示されます。

1. ルールをトリガーするには、[プロパティ] で指定した範囲外の設定で最適な温度を設定します。 検証を完了したら、電子メールの受信トレイの混雑を回避するためにルールを無効にします。 

## <a name="create-rules-in-iot-central-with-microsoft-flow-as-the-action"></a>Microsoft Flow をアクションとして IoT Central でルールを作成する

Microsoft Flow は、多くのアプリケーション間のワークフローを自動化します。 IoT Central でルールが発動したときにトリガーできるアクションの 1 つです。 このシナリオでは、コーヒー マシンが特定の温度しきい値に達して、保証が有効なときは、Microsoft Flow は地域の担当者にモバイル通知を送信します。 **[ルール]** に移動して、条件を構成し、ルールが発動したときのアクションとしてフローを追加します。 
 
> [!NOTE]
> Microsoft Flow を有効にするための Azure サブスクリプションがない場合、この演習は省略してかまいません。


### <a name="extend-your-iot-central-trial-to-30-days"></a>IoT Central を 30 日間試用版を拡張します。

1. Microsoft Flow をオンにするには、試用期間を 30 日間延長する必要があります。 これを行うには、次のように選択します。**を 30 日間試用版の拡張**[課金] ページで、Azure Active Directory と Azure サブスクリプションを選択します。 Azure サブスクリプションを使用すると、Azure サービスのインスタンスを作成できます。 Azure IoT Central は、ユーザーがアクセスできるすべての Azure サブスクリプションを自動的に検索し、ドロップダウンに表示します。
    
1. Azure サブスクリプションがない場合は、[Azure サインアップ ページ](https://aka.ms/createazuresubscription)で作成できます。 移動し、Azure サブスクリプションを作成した後、**アプリケーション マネージャー**ページ。 新しいサブスクリプションが **[Azure サブスクリプション]** ドロップダウンに表示されます。
        

### <a name="add-the-following-rules-when-the-coffee-machine-is-under-warranty"></a>コーヒー マシンが保証期間内のときの次のルールを追加します。 

1. ルールの名前: コーヒー メーカーの水温が低すぎ (保証)

    条件の追加:      
    * Device Warranty Expired equals 0
    * 水の温度がコーヒー メーカー Min 温度未満です。

1. ルールの名前: コーヒー メーカーの水温が高すぎ (保証)

    条件の追加:      
    * Device Warranty Expired equals 0
    * 水の温度がコーヒー メーカーの最大の温度を超えています。

1. ルールの条件を保存した後、コーヒー メーカーが保証期間内のときの新しいアクションとして Microsoft Flow を選択します。 ブラウザー内に新しいタブまたはウィンドウが開き、Microsoft Flow が表示されます。 概要ページが開き、カスタム アクションに接続している IoT Central コネクタが表示されます。 **[続行]** を選択します。 

    ワークフローを作成するための Microsoft Flow デザイナーが表示されます。 ワークフローには、アプリケーションとルールが既に入力されている IoT Central トリガーが含まれています。

    ここでは、必要なすべてのアクションをワークフローに追加できます。 例として、モバイル通知を送信してみましょう。 通知を検索し、[通知] > [Send me a mobile notification]\(モバイル通知を自分に送信する\) を選択します。

    このアクションの [テキスト] フィールドに通知の内容を入力します。 IoT Central ルールから動的なコンテンツを追加して、デバイスの ID や名前などの重要な情報を渡すことができます。
    
    ![アクションとしての Microsoft Flow の使用](../images/5-flow-b.png)

1. Microsoft Flow でのワークフローの設定が済んだら、Microsoft Store からモバイル デバイスに [Flow アプリ](https://www.microsoft.com/en-us/p/microsoft-flow/9nkn0p5l9n84?activetab=pivot%3aoverviewtab)をダウンロードします。 Flow Web アプリでフローを設定するために使用したものと同じアカウントを使用してサインインします。 テスト目的で、ルールをトリガーする範囲外の最適な温度を設定します。 

    > [!NOTE]
    > デバイスのプロパティ: Device Warranty Expired (デバイス コードで 1 は保証期限切れ、0 は期間内) は、デバイスによってランダムに生成され、デバイスによって Azure IoT Central アプリケーションに送信されます。 テスト目的で、デバイス (1 または 0) 保証が期限切れのコントロールにある場合は、コンピューターを再起動コーヒーをテストするアクションをトリガーする保証の目的の状態が表示されるまでです。 モバイル通知を受信するには、保証有効期限が切れたデバイスが、コンソール ログでは 0 であることが表示されるまで、コーヒー マシンを再起動します。 

    数分後、Flow モバイル アプリで通知が表示されます。

    ![アクションとしての Microsoft Flow の使用](../images/5-flow-c.png)

## <a name="summary"></a>まとめ
IoT Central でルールを作成する方法を学習し、ルールが発動したときに Microsoft Flow を介してメールやモバイル通知などのアクションをトリガーしました。 この場合、コーヒー マシンの水の温度が最適な範囲外通知は、修理の技術者または保証の状態に応じてクライアントに送信されます。 


