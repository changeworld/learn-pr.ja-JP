コーヒー マシンを Azure IoT Central アプリケーションに接続し、コーヒー マシンを監視して管理できるようにするデータの交換を有効にしました。 このユニットでは、コーヒー マシンの水の温度が通常の範囲外にあるときにアクションをトリガーするルールを作成します。 アクションは、マシンが保証期間内かどうかに応じて、メールまたはモバイル通知のどちらかとなります。 アクションとして Microsoft Flow を追加するには、Azure サブスクリプションが必要です。 Azure サブスクリプションがない場合は、アクションとしての Microsoft Flow の追加は省略可能です。

## <a name="create-rules-in-iot-central-with-email-as-the-action"></a>電子メールをアクションとして IoT Central でルールを作成する
Azure IoT Central には、通知を送信するネイティブなメール機能があります。 このシナリオでは、コーヒー マシンが最適温度の範囲外にあり、保証で保護されていない場合、IoT Central によってクライアントのメンテナンス部門にメールが送信されます。

このユニットの演習では、**[ルール]** ページに移動します。 **[+ 新しいルール]**、**[テレメトリ]** の順に選択します。 コーヒー マシンの保証期限が切れていて、水の温度が最適範囲外になったときの、次の 2 つのルールを追加します。 完了したら、**[保存]** を選択します。 

> [!NOTE]
> 条件が適用されている場合、実行されるルールに対して、すべてのステートメントが true である必要があります。 条件がこのシナリオのように "or" ステートメントの場合 (たとえば、保証期限が切れて、最適温度が定義済みの値より小さいか大きい)、ここで示すように 2 つのルールにステートメントを分割します。

1. ルールの名前: コーヒー メーカーの水温が低すぎ (期限切れ)

    条件の追加:      
    * デバイスの保証期限切れは 1 に等しい
    * 水温がコーヒー メーカー最低温度未満である

    ![ルールの使用](../images/5-flow-a.png)

1. ルールの名前: コーヒー メーカーの水温が高すぎ (期限切れ)

    条件の追加:      
    * デバイスの保証期限切れは 1 に等しい
    * 水温がコーヒー メーカー最高温度を超えている

1. **アクション**を追加するには、[Configure Telemetry Rule]\(テレメトリ ルールの構成\) パネルで下にスクロールし、[アクション] の横にある **[+]** を選択してから **[メール]** を選びます。

1. アクションを定義するには、IoT Central アプリケーションへのサインインに使用したメール アドレスを追加します。 水温度が暑すぎるときの通知メッセージを追加します。"コーヒー メーカーの水が熱すぎます。 メンテナンスが必要です。  保証は終了しています。" 水温が低すぎる場合について同じ手順を繰り返します。 メッセージを追加します。"コーヒー メーカーの水が冷たすぎます。 メンテナンスが必要です。  保証は終了しています。"

1. **[保存]** を選択します。 ルールが [ルール] ページに一覧表示されます。

1. ルールをトリガーするには、[設定] の最適温度を、[プロパティ] で指定した範囲外の値に設定します。 検証が終わったら、メールで受信トレイがいっぱいにならないようにルールを無効にします。 

## <a name="create-rules-in-iot-central-with-microsoft-flow-as-the-action"></a>Microsoft Flow をアクションとして IoT Central でルールを作成する

Microsoft Flow は、多くのアプリケーション間のワークフローを自動化します。 IoT Central でルールが発動したときにトリガーできるアクションの 1 つです。 このシナリオでは、コーヒー マシンが特定の温度しきい値に達して、保証が有効なときは、Microsoft Flow は地域の担当者にモバイル通知を送信します。 **[ルール]** に移動して、条件を構成し、ルールが発動したときのアクションとしてフローを追加します。 
 
> [!NOTE]
> Microsoft Flow を有効にするための Azure サブスクリプションがない場合、この演習は省略してかまいません。


### <a name="extend-your-iot-central-trial-to-30-days"></a>IoT Central の試用版の期間を 30 日に延長する

1. Microsoft Flow を有効にするには、試用版の期間を 30 日に延長する必要があります。 そのためには、[課金] ページで **[Extend Trial to 30 days]\(試用版の期間を 30 日に延長する\)** を選択し、Azure Active Directory と Azure サブスクリプションを選びます。 Azure サブスクリプションを使用すると、Azure サービスのインスタンスを作成できます。 Azure IoT Central では、ユーザーがアクセスできるすべての Azure サブスクリプションが自動的に検索され、ドロップダウンに表示されます。
    
1. Azure サブスクリプションがない場合は、[Azure サインアップ ページ](https://aka.ms/createazuresubscription)で作成できます。 Azure サブスクリプションを作成したら、**[Application Manager]\(アプリケーション マネージャー\)** ページに戻ります。 新しいサブスクリプションが **[Azure サブスクリプション]** ドロップダウンに表示されます。
        

### <a name="add-the-following-rules-when-the-coffee-machine-is-under-warranty"></a>コーヒー マシンが保証期間内のときの次のルールを追加します。 

1. ルールの名前: コーヒー メーカーの水温が低すぎ (保証)

    条件の追加:      
    * デバイスの保証期限切れは 0 に等しい
    * 水温がコーヒー メーカー最低温度未満である

1. ルールの名前: コーヒー メーカーの水温が高すぎ (保証)

    条件の追加:      
    * デバイスの保証期限切れは 0 に等しい
    * 水温がコーヒー メーカー最高温度を超えている

1. ルールの条件を保存した後、コーヒー メーカーが保証期間内のときの新しいアクションとして Microsoft Flow を選択します。 ブラウザー内に新しいタブまたはウィンドウが開き、Microsoft Flow が表示されます。 概要ページが開き、カスタム アクションに接続している IoT Central コネクタが表示されます。 **[続行]** を選択します。 

    ワークフローを作成するための Microsoft Flow デザイナーが表示されます。 ワークフローには、アプリケーションとルールが既に入力されている IoT Central トリガーが含まれています。

    ここでは、必要なすべてのアクションをワークフローに追加できます。 例として、モバイル通知を送信してみましょう。 通知を検索し、[通知] > [Send me a mobile notification]\(モバイル通知を自分に送信する\) を選択します。

    このアクションの [テキスト] フィールドに通知の内容を入力します。 IoT Central ルールからの動的なコンテンツを含めて、デバイスの ID や名前などの重要な情報を渡すことができます。
    
    ![アクションとしての Microsoft Flow の使用](../images/5-flow-b.png)

1. Microsoft Flow でのワークフローの設定が済んだら、Microsoft Store からモバイル デバイスに [Flow アプリ](https://www.microsoft.com/en-us/p/microsoft-flow/9nkn0p5l9n84?activetab=pivot%3aoverviewtab)をダウンロードします。 Flow Web アプリでフローを設定するために使用したものと同じアカウントを使用してサインインします。 テストのため、範囲外の最適温度を設定してルールをトリガーします。 

    > [!NOTE]
    > デバイスのプロパティ: デバイスの保証期限切れ (デバイス コードで 1 は保証期限切れ、0 は保証期間内) は、デバイスによってランダムに生成され、デバイスによって Azure IoT Central アプリケーションに送信されます。 テストのため、デバイスの保証期限切れ (1 または 0) を制御したい場合は、テストするアクションをトリガーする目的の保証状態を受信するまで、コーヒー マシンを再起動します。 モバイル通知を受信するには、コンソール ログでデバイスの保証期限切れが 0 と表示されるまで、コーヒー マシンを再起動します。 

    数分後、Flow モバイル アプリに通知が表示されます。

    ![アクションとしての Microsoft Flow の使用](../images/5-flow-c.png)

## <a name="summary"></a>まとめ
IoT Central でルールを作成する方法を学習し、ルールが実行されたときに Microsoft Flow を介してメールやモバイル通知などのアクションをトリガーしました。 この例では、コーヒー マシンの水温が最適範囲から外れると、保証の状態に応じて、通知が修理技術者またはクライアントに送信されます。 


