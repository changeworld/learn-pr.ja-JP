最初の手順は、おそらく、オンプレミスの構成をクラウドに再作成することです。

この基本的な構成により、ネットワークがどのように構成され、ネットワーク トラフィックがどのように Azure を出入りしているかについての感覚をつかむことができます。

## <a name="your-e-commerce-site-at-a-glance"></a>e コマース サイトの概要

大規模なエンタープライズ システムは、多くの場合、連動する相互接続された複数のアプリケーションとサービスで構成されます。 在庫を表示し、顧客が注文できるフロントエンド Web システムを用意することがあります。 そのようなシステムは、在庫データを提供したり、ユーザー プロファイルを管理したり、クレジット カードを処理したり、処理された注文の受注処理を要求したりするために、さまざまな Web サービスと通信します。

これらの複雑なシステムの設計、構築、管理、保守を簡単にするために、ソフトウェア アーキテクトとデザイナーはいくつかの戦略とパターンを採用します。 そのうちのいくつかを見てみましょう。まずは_疎結合アーキテクチャ_です。

#### <a name="benefits-of-loosely-coupled-architectures"></a>疎結合アーキテクチャの利点

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE2yHrc]

### <a name="using-an-n-tier-architecture"></a>n 層アーキテクチャの使用

疎結合システムの構築に使用できるアーキテクチャ パターンは、_n 層_です。

[n 層アーキテクチャ](https://docs.microsoft.com/azure/architecture/guide/architecture-styles/n-tier)では、アプリケーションが 2 つ以上の論理層に分割されます。 アーキテクチャ上、上の階層は下の階層からのサービスにアクセスすることができますが、下の階層が上の階層にアクセスすることはできません。

階層は問題を分割するのに役立ち、再利用できるように設計するのが理想的です。 階層型アーキテクチャを使用することで、メンテナンスも簡略化されます。 階層は個別に更新したり置き換えたりできます。また、必要に応じて新しい階層を挿入することもできます。

_3 層_とは、3 つの階層がある n 層アプリケーションを指します。 あなたの e コマース Web アプリケーションは、この 3 層アーキテクチャに従っています。

* **Web 層**は、ブラウザーを介して、ユーザーに Web インターフェイスを提供します。
* **アプリケーション層**は、ビジネス ロジックを実行します。
* **データ層**には、製品情報と顧客の注文を保持するデータベースとその他のストレージが含まれます。

ユーザーからデータ層への要求のフローを、次の図に示します。

![各層が専用の仮想マシンでホストされている 3 層アーキテクチャを示す図。](../media/2-three-tier.png)

ユーザーが発注ボタンをクリックすると、その要求が Web 層に、ユーザーの住所と支払い情報と共に送信されます。 Web 層はこの情報をアプリケーション層に渡します。そこでは支払い情報の検証とインベントリのチェックが行われます。 アプリケーション層では、後で受注処理に使用するために、注文をデータ層に格納する場合があります。

## <a name="your-e-commerce-site-running-on-azure"></a>Azure で実行されている e コマース サイト

Azure には、コードをホストする完全に事前構成された環境から、自分で構成、カスタマイズ、管理を行う仮想マシンまで、Web アプリケーションをホストするためのさまざまな方法が用意されています。

たとえば、e コマース サイトを仮想マシンで実行することを選択したとします。 Azure で実行されるテスト環境は、次のようになります。 受信要求を制限するセキュリティ機能を有効にした仮想マシン上で実行される 3 層アーキテクチャを、次の図に示します。 

![各層が個別の仮想マシンで実行されている 3 層アーキテクチャを示す図。 各仮想マシンはその IP アドレスでラベル付けされており、またその独自の仮想ネットワーク内にあります。 各仮想ネットワークは、開かれたポートのリストを含むネットワーク セキュリティ グループを持っています。](../media/2-test-deployment.png)

これを 1 つずつ見ていきましょう。

:::row:::
  :::column:::
    ![地球の場所にピンが留められており、Azure リージョンを表しています](../media/2-azure-region.png)
  :::column-end:::
    :::column span="3"::: **Azure リージョンとは?**

_リージョン_とは、特定の地理的な場所内にある Azure データ センターのことです。 米国東部、米国西部、北ヨーロッパなどがリージョンの例です。 このインスタンスでは、アプリケーションが米国東部リージョンで実行されていることがわかります。

  :::column-end:::
:::row-end:::
:::row:::
  :::column:::
    ![仮想ネットワークで実行されている 2 つの仮想マシン](../media/2-azure-vnet.png)
  :::column-end:::
    :::column span="3"::: **仮想ネットワークとは?**

_仮想ネットワーク_とは、Azure 上で論理的に分離されたネットワークのことです。 Hyper-V、VMware、または他のパブリック クラウドでネットワークを設定したことがあれば、Azure 仮想ネットワークにすぐに慣れることができます。

Web 層、アプリケーション層、およびデータ層にはそれぞれ単一の VM があります。 各 VM は仮想ネットワークに属しています。

ユーザーは Web 層と直接やり取りするため、Web 層の VM にはパブリック IP アドレスがあります。 ユーザーがアプリケーション層とデータ層とやり取りすることはありません。 そのため、これらの VM にはそれぞれプライベート IP アドレスがあります。

物理ハードウェアは、Azure データ センターで管理されます。 仮想ネットワークは、ソフトウェアを通じて構成します。これにより、仮想ネットワークを独自のネットワークと同じように扱うことができます。 たとえば、ネットワークでの IP アドレスの割り当てをより細かく制御するため、仮想ネットワークをサブネットに分割することができます。 また、仮想ネットワークが到達できる他のネットワークを選択することもできます。それがパブリック インターネットであっても、プライベート IP アドレス空間内の他のネットワークであってもかまいません。

  :::column-end:::
:::row-end:::
:::row:::
  :::column:::
    ![ネットワーク セキュリティ グループを共有する 2 つの仮想マシン](../media/2-azure-nsg.png)
  :::column-end:::
    :::column span="3"::: **ネットワーク セキュリティ グループとは?**

_ネットワーク セキュリティ グループ_ (NSG) は、Azure リソースへの着信ネットワーク トラフィックを許可または拒否します。 ネットワーク セキュリティ グループを、自分のネットワークのクラウド レベルのファイアウォールとして考えてみましょう。

たとえば、Web 層の VM で、ポート 22 (SSH) とポート 80 (HTTP) での着信トラフィックが許可されていることに注目してください。 この VM のネットワーク セキュリティ グループでは、すべてのソースからのこれらのポート経由の着信トラフィックが許可されます。 信頼できる IP アドレスなど、既知のソースからのみトラフィックを受け入れるようにネットワーク セキュリティ グループを構成することができます。

> [!NOTE]
> ポート 22 では、SSH 経由で Linux システムに直接接続することができます。 ここでは、学習目的のために、ポート 22 を開いています。 実際には、セキュリティを強化するために、仮想ネットワークに VPN アクセスを構成します。

  :::column-end:::
:::row-end:::

## <a name="summary"></a>まとめ

あなたの 3 層アプリケーションは現在、米国東部リージョンの Azure で実行されています。 _リージョン_とは、特定の地理的な場所内にある Azure データ センターのことです。

各階層は、下の階層からのサービスにのみアクセスできます。 Web 層で実行されている VM は、インターネットからトラフィックを受信するため、パブリック IP アドレスを持っています。 それより下の階層 (アプリケーション層とデータ層) の VM は、インターネット経由で直接通信することはないため、それぞれプライベート IP アドレスを持っています。

_仮想ネットワーク_を使用すると、関連するシステムをグループ化したり分離したりすることができます。 _ネットワーク セキュリティ グループ_を定義して、仮想ネットワーク内を通過できるトラフィックを制御します。

ここで説明した構成は、すぐれた出発点となります。 しかし、自身の e コマース サイトをクラウドの運用環境にデプロイするときに、オンプレミスのデプロイで経験したのと同じ問題が発生する可能性があります。
