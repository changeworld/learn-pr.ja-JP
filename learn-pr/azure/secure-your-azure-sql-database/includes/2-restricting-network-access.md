オンライン ビジネスを実行しているし、データベースを Azure に発行すると仮定します。 既定では、Azure SQL Server データベースは、Azure アプリケーションまたは Azure 内で実行されているサービスにアクセスできるになります。 のみに接続する Azure 内のサービスを許可する場合でも、データベースへの接続を制限する承認されたアプリケーションやサービスにする必要があります。

このユニットでは、IP アドレスの範囲を使用して Azure SQL database へのアクセスを制限する方法を紹介します。

## <a name="overview"></a>概要

新しい Azure SQL database は、既定では、のみを許可する Azure サービスに接続します。 この構成接続サービスは、データベースに対する認証を試みることがそれだけで、データベースの内容にアクセスできるとは限りません。 サービスが認証を必要とするは、パブリック インターネット アクセスが制限よりも安全です。 アプリケーションとサービスが必要なだけに、データベースへのアクセスも制限する必要があります。

など、ASP.NET Core アプリケーションを Azure SQL database との対話があります。 これは ASP.NET Core アプリケーション、Azure SQL Server データベースにアクセスする必要があります。 Web アプリケーションからどのようにデータベースにネットワーク アクセスを制限しましたは見てみましょう。

## <a name="restricting-network-access-to-the-database"></a>データベースへのネットワーク アクセスを制限します。

データベースにネットワーク アクセスを制限するには、のみ、特定の IP アドレス範囲からのアクセスを許可します。

![追加説明されている IP 制限の構成で、サーバーのファイアウォール ルールの作成を示す Azure ポータルのスクリーン ショット。](../media-draft/2-setting-ip-address-ranges-on-firewall.png)

1. サーバーのファイアウォール規則を作成するを入力します、**ルール名**、**開始 IP**アドレス、および**終了 IP**アドレス。
1. クリックして**保存**変更を記録します。

作成した規則の一覧の IP アドレスだけでは、データベースへのアクセスがあります。

## <a name="locking-down-access-at-the-database-level"></a>データベース レベルのアクセスをロック

Azure SQL Server のフェールオーバー グループを実行するいると仮定します。 フェールオーバー グループとは、セカンダリ サーバーは異なるリージョンにある通常にあります。 メイン サーバーがオフラインになった場合、サーバーのファイアウォール規則が適用されません。 データベースをホストするサーバーごとサーバーのファイアウォール規則が設定されます。 データベース レベルのファイアウォール ルールの設定、バックアップ データベースにルールをレプリケートすることが保証されます。

データベースのファイアウォール規則を作成するには、SQL Server Management Studio または SQL Operations Studio を使用してデータベースに接続し、新しいクエリを作成します。 次の規則を使用して、ルールの名前、開始 IP アドレス、および終了 IP アドレスには、渡すデータベース ルールを作成します。

```sql
EXECUTE sp_set_database_firewall_rule N'<Rule Name>', '<From IP Address>', '<To IP Address>'
```

たとえば、IP アドレス範囲 – 10.21.2.33 10.21.2.54 から、データベースへのアクセスを制限する、次の SQL のようなルールを使用します。

```sql
EXECUTE sp_set_database_firewall_rule N'Web Apps Firewall Rule', '10.21.2.33', '10.21.2.54'
```

## <a name="enabling-transparent-data-encryption-tde"></a>Transparent Data Encryption (TDE) を有効にします。

### <a name="what-is-transparent-data-encryption"></a>Transparent Data Encryption とは何ですか。

Transparent Data Encryption (TDE) は、データベース、バックアップのファイルおよびログ ファイルのリアルタイムの暗号化と解読を実行します。

新しい Azure SQL データベースが作成されると、TDE が既定で有効になっているが必要です。

データの暗号化をオフにされていないし、古い Azure SQL Server データベースを TDE を有効になっていない可能性があることを確認する重要です。

確認し、TDE を有効にします。

1. ポータルで、データベースを選択します。
1. 'Transparent data encryption' オプションを選択します。
1. データの暗号化オプションで、'On' を選択します。
1. [保存] をクリックします。

## <a name="create-a-secure-connection-to-the-server"></a>サーバーへのセキュリティで保護された接続を作成します。

アプリケーションは、安全な方法で、データベースに接続する必要があります。 セキュリティで保護された接続を作成するのにには、適切なレベルのセキュリティと接続文字列を使用します。 これらの接続は、中間者攻撃の可能性を低減する暗号化する必要があります。

データベースの接続文字列を取得する方法を見てみましょう。

ポータルを使用して、SQL Server に移動します。 アクセスするデータベースを選択します。

選択、*データベース接続文字列の表示*オプション。

ここで、使用可能なオプションをプログラミング言語と一致するタブを選択し、表示されている接続文字列をコピーします。 ここでシークレットと非表示に保持されますとしては、パスワードを完了する必要があります。

![選択した ADO.NET と強調表示されている指定された値のフィールドがデータベース接続文字列 セクションを示す Azure ポータルのスクリーン ショット。](../media-draft/2-viewing-connection-strings.png)

外部の目から接続文字列を保護するために重要です。 接続文字列は、プロジェクト、バージョン コントロール、または継続的インテグレーション システムではなく、Azure Key Vault に格納する必要があります。

### <a name="what-is-the-azure-key-vault"></a>Azure Key Vault とは何ですか。

Azure Key Vault は、資格情報およびその他のキーとシークレットを安全に保管するために使用するツールです。 ソフトウェアまたはハードウェアによっては、これらのシークレットを保護できます。

## <a name="open-the-correct-ports-for-server-access"></a>サーバーへのアクセスの正しいポートを開く

Azure データベースは、ポート 1433 経由で送信方向の通信を許可します。 このポートへのアクセスを持っていない場合は、ネットワーク トラフィックを許可する、ネットワーク管理者に問い合わせてください。

## <a name="restrict-server-access-with-azure-virtual-networks"></a>Azure の仮想ネットワークとサーバーへのアクセスを制限します。

### <a name="what-is-a-virtual-network"></a>仮想ネットワークとは何ですか?

仮想ネットワークでは、Azure のネットワーク内に作成された論理的に分離されたネットワークです。 仮想ネットワークを使用して、他のリソースに接続できる Azure リソースを制御することができます。

データベースに接続する web アプリケーションを実行していることを想像してください。 ネットワークのさまざまな部分を分離するのにサブネットを使用します。 サブネットは、範囲の IP アドレスに基づいてネットワークの一部です。

これらのサブネットを構成するには仮想ネットワークを作成し、ネットワークをサブネットに分割します。 Web アプリケーションは、1 つのサブネットと別のサブネット上のデータベースで動作します。 各サブネットは、独自の規則とその他のネットワークの間の通信を行うためにがあります。 これらのルールでは、データベースから web アプリケーションへのアクセスを制限する機能を提供します。

### <a name="what-is-a-network-security-group"></a>ネットワーク セキュリティ グループとは何ですか。

ネットワーク セキュリティ グループは、許可または拒否して、ソースと宛先アドレスのネットワーク トラフィック規則を定義します。 各サブネットは、ネットワーク セキュリティ グループに割り当てられている必要があります。

次の図は、作成されるグループの例を示します。 Web のサブネットでは、HTTP 接続のみが、インターネットにアクセスを許可します。 データベースのサブネットは、web のサブネットからのアクセスのみを許可します。 仮想ネットワークを設定すると、サービスのアクセスできるし、ホステッド サービスに対するファイアウォールとして機能に関する制限事項が追加されます。

![接続されているデータベースと web アプリケーション用の仮想ネットワーク](../media-draft/2-virtualnetwork-overview.png)

次の例では、仮想マシンは、web ホストとして動作させ、データベースへの接続を使用している前提としています。 この計画的なインフラストラクチャを設定する仮想ネットワークを作成する方法を見てみましょう。

1. Azure portal から、選択、**リソースの作成**リンク。
1. Azure マーケットプ レースから選択**ネットワーク** > **仮想ネットワークの**します。 デプロイ モデルを選択することを要求する場合は、選択**Resource Manager**
1. **[作成]** ボタンをクリックします。
1. 入力、**名前**仮想ネットワーク。
1. 提供、**アドレス空間**を使用できます。 アドレス空間は、範囲の IP アドレスをアウトライン表示の方法です。 この例では`172.16.0.0/16`で区切られます 172.16.255.255 に 172.16.0.0 からアドレスの範囲を指します。

   まだ使用されていないアドレス空間が推奨されます。 この範囲から IP アドレスが検出されると、場所は、このサブネット上にあるものとして定義されます。

1. Azure を選択します。**サブスクリプション**します。
1. 選択するか、新しい作成**リソース グループ**します。
1. 入力、**名前**のサブネットを作成します。
1. 提供、**アドレス範囲**します。
1. をクリックして、**作成**仮想ネットワークを作成するボタンをクリックします。

![説明されている構成と仮想ネットワーク ブレードの作成を示す Azure ポータルのスクリーン ショット。](../media-draft/2-create-virtual-network-settings.png)

仮想ネットワークが作成されると、通知を受け取ります。 をクリックして、**リソースに移動**通知では、ボタンをクリックします。

仮想ネットワーク ブレードに移動しますようになりました。 選択、**設定** > **サブネット**構成セクション。 この時点では、web_subnet と呼ばれる、最初のネットワークをセットアップするときに作成したサブネットが必要があります。

データベース サーバーの IP アドレスを表す別のサブネットを作成する必要があります。

1. をクリックして、 __+ サブネット__データベースの新しいサブネットの追加のプロセスを開始するボタンをクリックします。

1. 入力、**名前**サブネット。 上記の例では、私たちと呼ばれる、database_subnet。

1. レビュー、**アドレス範囲 (CIDR ブロック)** します。 アドレス範囲をシステムに他のサブネットと競合してない範囲で再作成することを確認します。

1. **ネットワーク セキュリティ グループ**はサブネットに適用する必要がある主要な設定です。 ここでは、この設定を空白のままにします。 後でするネットワーク セキュリティ グループを作成し、戻ってこの値を設定します。

1. をクリックして、 **OK**サブネットを保存するボタンをクリックします。

![説明の構成とサブネットの追加 ブレードを表示する Azure ポータルのスクリーン ショット。](../media-draft/2-create-database-subnet.png)

## <a name="creating-a-network-security-group"></a>ネットワーク セキュリティ グループを作成します。

ネットワーク セキュリティ グループの仕事は、ファイアウォールとして動作して、サブネットに出入りするトラフィックのフローを制御します。 2 つのネットワーク セキュリティ グループを作成します。 1 は、web アプリケーションのサブネットで、もう 1 つは、データベース サブネットのです。

1. 選択**リソースの作成**選択**ネットワーク** > **ネットワーク セキュリティ グループ**します。 デプロイ モデルの選択を要求された場合は、リソース マネージャーを選択します。
1. 提供、**名前**ネットワーク セキュリティ グループ。
1. Azure サブスクリプション、リソース グループ、および目的の場所を選択します。
1. **[作成]** ボタンをクリックします。

![Web のサブネット用に選択した web セキュリティ グループを示す Azure ポータルのスクリーン ショット。](../media-draft/2-define-nsg-for-web-subnet.png)

ネットワーク セキュリティ グループが作成された後は、セキュリティ グループの受信と送信のトラフィック規則を設定する時間。

1. 新しいネットワーク セキュリティ グループを選択します。
1. **概要**表示、作成された受信と送信の規則の一覧を表示します。 既定値がある内部 Azure へのアクセスに使用される規則が既に作成されています。

    > [!NOTE]
    > これらの規則を削除することはできません、これらの規則より優先される優先度が高い追加の規則を作成できます。

![ネットワーク セキュリティ グループの事前構成済みの受信と送信セキュリティ規則を示す Azure ポータルのスクリーン ショット。](../media-draft/2-view-web-apps-security-group-rules.png)

1. 新しいルールを作成するには、選択、**受信セキュリティ規則**ネットワーク セキュリティ グループのセクション。
1. **[追加]** をクリックします。 ここでは、ネットワーク セキュリティ規則の詳細を構成できます。

    > [!NOTE]
    > 既定では、ルールを構成する詳細ビューが表示されますをクリックして、**基本**ボタン、ことができますを許可するプロトコルを選択します。

1. インターネットから HTTP サービスへのアクセスを許可するには。 選択する HTTP プロトコルに対してフィルター処理、**サービス タグ**として、**ソース**値。
1. 次に、確認、**ソース サービス タグ**に設定されている**インターネット**。
1. ポートの範囲の値セット`80,443`をこのサービスへのアクセスに使用されるポートを表します。 (HTTP にポート 80 を使用および HTTPS アクセス用ポート 443 を使用)。
1. **[プロトコル]** で **[TCP]** を選択します。
1. 設定**アクション**に**許可**します。
1. 規則に付けます、**優先度**@property`100`します。

    > [!NOTE]
    > 低いルールは、数値より重要です。

![指定の構成とソース サービス タグ (インターネット)、および宛先ポートで追加の受信セキュリティ規則 ブレードを表示する Azure ポータルのスクリーン ショットの範囲 (80,443) フィールドが強調表示されます。](../media-draft/2-add-inbound-security-rule-for-web-nsg.png)

これで、データベースのネットワーク セキュリティ グループの設定を設定する時間になります。 データベースは、web アプリケーションのサブネットの IP 範囲からの SQL 要求を許可する 1 つの受信規則を設定して、し、その他の受信および送信トラフィックを拒否します。 これは、使用すると、データベースへのアクセスを制御し、データベース要求のみが、web サイトからにシステムに取得して、データベースへの他のアクセスが許可されないことを確認できます。

1. をクリックして、**リソースの作成**別に作成するには、もう一度**ネットワーク** > **ネットワーク セキュリティ グループ**デプロイメント モデルとして Resource Manager を使用します。

    この時点のデータベースに 1 つを作成します。

1. 提供、**名前**ネットワーク セキュリティ グループ。
1. Azure サブスクリプション、リソース グループ、および目的の場所を選択します。
1. をクリックして、**作成**新しいネットワーク セキュリティ グループを作成するボタンをクリックします。

    ![サンプル構成を作成するネットワーク セキュリティ グループのブレードを表示する Azure ポータルのスクリーン ショット。](../media-draft/2-create-database-network-security-group.png)

    ネットワーク セキュリティ グループが作成されるまで待機する必要があります。

1. 完了すると、選択、**リソースに移動**通知で作成したネットワーク セキュリティ グループの規則の構成を開始するオプション。

ネットワーク セキュリティ グループの主な焦点では web アプリケーションのサブネットのみからのデータベース要求を許可するのには。 Web のサブネットの IP 範囲からポート 1433 で着信する TCP 要求を設定する必要があります。

1. **受信セキュリティ規則**設定の選択、**追加**新しいルールを作成するボタンをクリックします。 この場合は、web アプリケーションのサブネットからのアクセスのみが許可します。
1. 設定する受信規則を作成します、**ソース**に**IP アドレス**します。
1. ときに、**ソース IP アドレス/CIDR 範囲**が表示されたら、以前に作成された web サブネットから CIDR 範囲を入力してください。
1. **宛先ポート範囲**、入力`1433`を Azure SQL Server のアクセスのみを示します。
1. 設定、**プロトコル**に**TCP**をさらに着信接続を制限します。
1. **許可**アクセス**アクション**します。
1. 付けます、**優先度**の`100`します。
1. **名前**適切にセキュリティの規則。
1. クリックして**追加**規則を追加します。

![説明されている構成で受信セキュリティ規則の追加 ブレードを表示する Azure ポータルのスクリーン ショット。](../media-draft/2-create-inbound-rule-for-db-security-group.png)

基本的なセキュリティ規則は、データベース システムへのアクセスを制限するようになりました。 ネットワーク セキュリティ グループをサブネットに割り当てるには残骸は残っています。

1. 先ほど作成した仮想ネットワークを開きます。 選択、**設定** > **サブネット**セクション。
1. 先ほど作成した web のサブネットを選択します。
1. 選択、**ネットワーク セキュリティ グループ**具体的には、web のオプションとネットワーク セキュリティ グループを作成します。
1. クリックして**保存**され、サブネットに対してネットワーク セキュリティ グループが適用されます。

    ![Web のサブネットに適用されている、ネットワーク セキュリティ グループを示す Azure ポータルのスクリーン ショット](../media-draft/2-define-nsg-for-web-subnet.png)

データベースのサブネットに対して同じ処理を繰り返しますしたいです。

1. サブネットに移動します。
1. データベースのサブネットを選択します。
1. 設定の**ネットワーク セキュリティ グループ**データベースのネットワーク セキュリティ グループにします。
1. **[保存]** をクリックして変更を保存します。

    ![データベースのサブネット用に選択した適用済みのネットワーク セキュリティ グループを示す Azure ポータルのスクリーン ショット。](../media-draft/2-define-nsg-for-db-subnet.png)

アクセスを構成したら、これで、仮想ネットワークとサブネットに対して、データベース サーバーと web サーバーに適用する問題です。

データベース サーバーから始めましょう。

1. データベースを選択します。
1. データベースから選択、**ファイアウォールと仮想ネットワーク**構成設定。

左側で、構成に関する詳細が表示されます。 さまざまな設定がある次のとおりです。

1. まず、 **Azure サービスへのアクセスを許可する**に**OFF**します。 これは、使用するサービスのみが有効になっていることを確認します。

    クライアント IP アドレスが表示されることもわかります。 クライアント IP アドレスは、Azure SQL Server データベースに接続するコンピューターの IP アドレスです。 ルール名の一覧にクライアント IP を追加した可能性があります。 これは、SQL Server Management Studio または SQL Operations Studio のサーバーに接続する場合に便利です。 これにより、接続する IP アドレスを示すルールが追加されます。 行いませんが、ここでは、するは、仮想ネットワークを設定します。

1. をクリックして**既存の仮想ネットワークを追加**、し、新しいルールの詳細を入力するには、オプション画面が表示されます。

1. 入力、**名前**ルールを使用したいのです。
1. 使用していたサブスクリプションを選択します。
1. 最も重要なは、使用している仮想ネットワークを選択します。
1. データベースへのアクセスの適切なネットワーク セキュリティ グループ規則を使用して、サブネットを選択します。
1. すべての設定を構成した後、選択、**を有効にする**ボタンをクリックします。 データベースを仮想ネットワーク内のサブネットに適用されます。

データベースのサブネットを構成した後は、web サーバーと同様の手順を実行します。 どのアプリケーションを構成したらに関係なく、web アプリケーションが web アクセスのサブネットを使用することを確認する問題です。

スケール セットで単一の仮想マシンまたは仮想マシンでのロード バランサーをある場合は、使用される web サブネット、データベースにアクセスできるようにを確認します。 仮想マシンなどのリソースを作成するときに、それらのサービスとアウトの書き込まれる情報を制御する、仮想ネットワークとサブネットが構成されていることを確認します。

![仮想ネットワークとサブネットの値が設定されている新しい仮想マシンの作成、設定ブレードの手順を示す Azure ポータルのスクリーン ショット。](../media-draft/2-configure-virtual-machine-with-subnet.png)

サブネットが、データベースと web アプリを実行する仮想マシンの両方に適用されるを適切な構成が場所になります。 アプリとデータベース間の厳密なアクセスがあります。

ネットワーク セキュリティは、保護の最初の中核となるポイントです。 アプリとデータベースに接続するサービスのみをデータベースに接続しないでことを確認すると、システムがセキュリティを強化。
