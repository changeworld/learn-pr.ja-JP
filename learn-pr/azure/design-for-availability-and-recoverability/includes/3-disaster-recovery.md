高可用性のための設計は、好ましくないイベントや悪条件にもかかわらずアプリケーションまたはプロセスの稼働を継続するために役立ちます。 しかし、何らかの重大事象が発生してデータが失われ、アプリやプロセスがダウンすることを回避できない場合はどうしますか? 災害に見舞われたときに必要なのはプランです。 復旧の目標と期待、プランのコストと制限、およびプランの実施方法を知っておく必要があります。

## <a name="what-is-disaster-recovery"></a>ディザスター リカバリーとは

ディザスター リカバリーとは、ダウンタイムやデータの損失につながる*影響の大きいイベントからの復旧*です。 災害は、高可用性のためのアプリケーション設計によって軽減できる範囲をはるかに超えた長期的な影響を生じさせる単一の大きなイベントです。

「災害」という言葉はしばしば、(地震、洪水、台風などの) *自然*災害や外的事象を想起させますが、他にも多くの種類の災害が存在します。 デプロイまたはアップグレードの致命的な失敗によって、アプリが認識不能な状態に陥る可能性があります。 実装または構成の微妙な誤りによって、不正なデータが書き込まれたり、永続的と見なされていたデータが削除されたりする可能性があります。 悪意のあるハッカーがデータを破損または削除する、また、その他の種類の危害を加えることでアプリをオフラインにしたり一部の機能を停止させたりする可能性があります。

その原因にかかわらず、いったん発生した災害に対する唯一の対処法は、明確に定義されていてテスト済みのディザスター リカバリー プランと、その設計を通じてディザスター リカバリーの取り組みを積極的にサポートするアプリケーションです。

## <a name="how-to-create-a-disaster-recovery-plan"></a>ディザスター リカバリー プランの作成方法

ディザスター リカバリー プランは、災害によって発生したデータ損失およびダウンタイムから復旧するために必要な手順を詳しく記述し、それらの手順を指揮する責任者を特定する単一のドキュメントです。 オペレーターは、災害発生後にアプリケーションの接続を復元してデータを復旧するためのマニュアルとしてこのプランを使用できる必要があります。 ディザスター リカバリーに特化した詳細かつ書面化されたプランは、好ましい結果を確実にするために不可欠です。プラン作成のプロセスはアプリケーションの完全な見取り図を組み立てるために役立ち、成果物である書面化された手順は、災害の余波のパニックと混乱の中で適切な意思決定とプランの遂行を促進します。

ディザスター リカバリー プランの作成には、アプリケーションのワークフロー、データ、インフラストラクチャ、および依存関係に関する専門知識が必要です。

### <a name="risk-assessment-and-process-inventory"></a>リスク評価とプロセス インベントリ

ディザスター リカバリー プラン作成の最初のステップは、さまざまな種類の災害がアプリケーションに及ぼす影響を調べるリスク分析の実行です。 リスク分析にとっては、災害の性質そのものよりも、データ損失やアプリケーションのダウンタイムという形で現れる災害の潜在的な影響のほうが重要です。 さまざまな種類の架空の災害を想定し、できるだけ具体的にそれらの影響を検討します。たとえば、ターゲット型の悪質な攻撃によってコードまたはデータが改変された結果、地震によるネットワーク接続やデータセンター可用性の喪失とは異なった種類の影響が生じる可能性があります。

リスク評価では、際限のないダウンタイムが許されない*すべての*プロセスと、際限のない損失が許されないすべてのデータ カテゴリを検討する必要があります。 複数のアプリケーション コンポーネントに影響を及ぼす災害が発生したときに、プランの所有者がそのプランを使用して、注意が必要な事項、および各項目の優先順位を決める方法の完全なインベントリを実行できることが重要です。

一部のアプリは、単一のプロセスまたはデータ分類を構成するだけの場合があります。 アプリケーションは、組織の複数のアプリケーションを含むより大規模なディザスター リカバリー プランの構成要素の 1 つになる可能性が高いため、これはやはり重要な注意点です。

### <a name="recovery-objectives"></a>復旧目標

完全なプランでは、アプリケーションによって実装されるプロセスごとに、2 つの重要なビジネス要件を指定する必要があります。

* **目標復旧時点 (RPO)**: 許容されるデータ損失の最大継続時間。 RPO は「30 分のデータ」、「4 時間のデータ」のように、数量ではなく時間の単位で計測されます。RPO はデータの*損失*の限定および復旧に関連した概念であり、データの*盗難*には関連しません。
* **目標復旧時間 (RTO)**: 許容されるダウンタイムの最大継続時間。「ダウンタイム」は仕様によって定義する必要があります。

![RTO と RPO](../media-draft/rto-rpo.png)

アプリによって実装される主要なプロセスまたはワークロードごとに、個別の RPO 値と RTO 値を定義する必要があります。 異なるプロセスに対して値が同じになったとしても、それぞれの値は、災害シナリオのリスクと潜在的な復旧戦略をプロセスごとに精査する個別の分析に基づいて算出されたものである必要があります。

RPO と RTO を指定するプロセスによって、アプリケーションのディザスター リカバリー要件が実質的に作成されます。 それぞれのワークロードとデータ カテゴリの優先順位を確定し、費用便益分析を実行する必要があります。この分析には、実装とメンテナンスのコスト、運用コスト、プロセスのオーバーヘッド、パフォーマンスへの影響、ダウンタイムと失われたデータの影響などの懸案事項が含まれます。 アプリケーションにとっての「ダウンタイム」の意味を正確に定義する必要があります。場合によっては、異なる機能レベルに対して別個の RPO 値や RTO 値を確立することもできます。 RPO と RTO の指定は、単に任意の値を選べばよいというものではありません。 ディザスター リカバリー プランの価値の多くは、災害の潜在的な影響やリスク軽減のコストの算定にまで踏み入った調査と分析から生み出されます。

RPO と RTO は*目標*です。 災害は予測不可能であり、特定のイベントに対して確立された RPO と RTO を達成できないことも考えられます。 合意された RPO 値と RTO 値を維持するために必要なコストを負担することについてはビジネスとして合意に達しており、その対価として、ディザスター リカバリーのシナリオではそれらの目標が概ね達成されることが求められます。 すべての災害イベントには、長所と短所を検証する復旧後の振り返りを含めるべきですが、結果的に RPO または RTO を満たすことができない災害には特別な注意を払う価値があります。

### <a name="detailing-recovery-steps"></a>復旧手順の詳述

最終的なプランでは、失われたデータやアプリケーションの接続性を復元するために実施すべき正確な手順を詳しく記述する必要があります。 手順には多くの場合、以下に関する情報が含まれます。

* **バックアップ**: 作成頻度、保存場所、バックアップからのデータ復元方法。
* **データ レプリカ**: レプリカの数と場所、レプリケートされたデータの性質および整合性の特性、別のレプリカへの切り替え方法。
* **デプロイ**: デプロイの実行方法、ロールバック発生のしくみ、デプロイの失敗シナリオ。
* **インフラストラクチャ**: オンプレミスおよびクラウドのリソース、ネットワーク インフラストラクチャ、ハードウェア インベントリ。
* **依存関係**: アプリケーションによって使用される外部サービス (SLA や連絡先情報など)。
* **構成と通知**: アプリケーションを円滑にデグレードするために設定可能なフラグまたはオプション、アプリケーションへの影響をユーザーに通知するために使用されるサービス。

具体的に必要な手順はアプリの実装の詳細によって大きく異なるため、プランを継続的に更新することが重要です。 プランの定期的なテストは、ギャップや古くなった内容を特定するために役立ちます。

## <a name="designing-for-disaster-recovery"></a>ディザスター リカバリーのための設計

ディザスター リカバリーは自動的な機能ではありません。 設計し、構築し、テストする必要があります。 強固なディザスター リカバリー戦略をサポートする必要があるアプリは、最初からディザスター リカバリーを念頭に置いて構築する必要があります。 Azure は、ディザスター リカバリーをサポートするアプリの作成に役立つサービス、機能、およびガイダンスを提供しますが、それらを設計に組み込むことは開発者の責任です。

ディザスター リカバリーのための設計には、2 つの主な懸念事項があります。

* **データ復旧**: バックアップとレプリケーションを使用して失われたデータを復元する。
* **プロセス復旧**: サービスを復旧し、コードをデプロイすることによって障害から復旧する。

### <a name="data-recovery-and-replication"></a>データの復旧とレプリケーション

レプリケーションは、保存されたデータを複数のデータ ストア レプリカに複製します。 *バックアップ*では、復旧に使用するデータの読み取り専用スナップショットが作成され、長期間保持されますが、レプリケーションではそれと異なり、ライブ データのリアルタイムまたはほぼリアルタイムのコピーが作成されます。 レプリケーションの目標は、アプリケーションの応答性を維持しながら、できるだけ少ない待機時間でレプリカを同期し続けることです。 レプリケーションは、高可用性とディザスター リカバリーを設計するための重要なコンポーネントであり、実稼働グレードのアプリケーションの一般的な機能です。

レプリケーションは、*フェールオーバー*を実行することによって、データ ストアの障害または到達不能の影響を緩和するために使用されます。フェールオーバーとは、アプリケーションの構成を変更して、正常動作中のレプリカにデータ要求をルーティングすることです。 多くの場合、フェールオーバーは自動化され、データ ストレージ製品に組み込まれたエラー検出、または独自の監視ソリューションを使用して独自に実装する検出によってトリガーされます。 実装およびシナリオによっては、システム オペレーターが手動でフェールオーバーを実行する必要があります。

レプリケーションはゼロから実装するものではありません。 ほとんどのフル機能のデータベース システムやその他のデータ ストレージ製品およびサービスには、それらに求められる機能面およびパフォーマンス面の要件を満たすために、何らかの種類のレプリケーションが、密接に統合された機能として含まれています。 ただし、アプリケーションの設計にこれらの機能を組み込んで適切に利用することは開発者の役割です。

各種の Azure サービスで、さまざまなレベルおよび概念のレプリケーションがサポートされます。 例:

* **Azure Storage** レプリケーションは事実上自動的です。 アプリケーションもオペレーターも、直接的に操作することはありません。 フェールオーバーは自動的かつ透過的であり、必要なのは、コストとリスクのバランスが取れたレプリケーション レベルを選択することだけです。
* **Azure SQL Database** レプリケーションは、小規模であれば自動的ですが、Azure データセンターまたはリージョンの全面的な障害からの復旧には geo レプリケーションが必要です。 geo レプリケーションのセットアップは手動ですが、サービスの主力機能であり、ドキュメントで十分にサポートされています。
* **Cosmos DB** はグローバル分散データベース システムであり、レプリケーションはその実装の中心です。 Cosmos DB では、レプリケーションを直接構成する代わりに、パーティション分割とデータの整合性に関するオプションを構成します。

データの整合性、パフォーマンス、およびコストに異なった優先順位を付ける、さまざまなレプリケーション設計が存在します。 *アクティブ* レプリケーションでは、複数のレプリカで同時に更新が行われることが必須であり、スループットを犠牲に整合性を保証します。 対照的に、*パッシブ* レプリケーションではバックグラウンドで同期が実行されるので、レプリケーションによってアプリケーションのパフォーマンスが制約されることはありませんが、RPO は増加します。 *アクティブ-アクティブ*または*マルチマスター* レプリケーションでは、複数のレプリカの同時使用を可能にすることで負荷分散を実現しますが、代償としてデータ整合性が複雑化します。一方、*アクティブ-パッシブ* レプリケーションでは、フェールオーバー中に限ったライブ使用のためにレプリカを予約します。

![Azure SQL Database geo レプリケーション](../media-draft/geo-replication.png)

> [!IMPORTANT]
> **レプリケーションもバックアップも、単独では完全なディザスター リカバリー ソリューションではありません**。 データ復旧はディザスター リカバリーの一部でしかなく、レプリケーションは多くの種類のディザスター リカバリーのシナリオを完全に満たすものではありません。 たとえば、データ破損のシナリオでは、破損の性質によっては、プライマリ データ ストアからレプリカに破損が広がり、すべてのレプリカが役に立たなくなって復旧用のバックアップが必要になる可能性があります。

### <a name="process-recovery"></a>プロセス復旧

災害発生後、復旧が必要な資産はビジネス データだけではありません。 災害のシナリオでは、ネットワーク接続の問題、データセンターの障害、VM インスタンスまたはソフトウェア デプロイの損害など、原因はさまざまですが、結果的にダウンタイムも発生するのが一般的です。 正常稼働の状態に復元できるようにアプリケーションを設計する必要があります。

ほとんどの場合、プロセスの復元は、正常稼働している別のデプロイへのフェールオーバーを伴います。 シナリオによっては、地理的位置が重要な要素になる場合があります。たとえば、大規模自然災害によって Azure リージョン全体がオフラインになった場合、別のリージョンにサービスを復元する必要があります。 アプリケーションのディザスター リカバリー要件 (特に RTO) によって、設計の方向性が決まります。また、レプリケート先の環境をいくつ用意するのか、どの地域に環境を置くのか、すぐに稼働できる状態で環境を維持するのか、それとも災害発生時にデプロイを受け入れる準備ができた状態で維持するのか、といった事項についても、要件から判断することになります。

アプリケーションの設計によっては、災害後のプロセス復旧に対するアプリのサポートを向上させるために利用できる、何種類かの戦略と Azure のサービスおよび機能が存在します。

#### <a name="azure-site-recovery"></a>Azure Site Recovery

Azure Site Recovery は、Azure にデプロイされた VM 上で動作するワークロード、物理サーバー上で動作する VM、および、物理サーバー上で直接動作するワークロードのプロセス復旧の管理に特化したサービスです。 Site Recovery はワークロードを別の場所にレプリケートし、障害発生時にフェールオーバーを支援し、ディザスター リカバリー プランのテストをサポートします。

![Azure Site Recovery](../media-draft/asr.png)

Site Recovery は、個別の*ワークロード*に加えて VM 全体および物理サーバー イメージのレプリケーションをサポートします。このワークロードは、個別のアプリケーションを指す場合もあれば、VM またはオペレーティング システムとそのアプリケーションの全体を指す場合もあります。 任意のアプリケーション ワークロードをレプリケート可能ですが、Site Recovery の特色は、SQL Server、SharePoint などの多数の Microsoft サーバー アプリケーションや、SAP などの一部のサード パーティ製アプリケーションの統合サポートです。

VM または物理サーバー上で動作するアプリについては、少なくとも Azure Site Recovery の使用を検討することをお勧めします。これは、プロセス復旧のシナリオと可能性を発見および追求するための優れた方法です。

#### <a name="service-specific-features"></a>サービス固有の機能

App Service のような Azure PaaS 製品で動作するアプリについては、ディザスター リカバリーをサポートするための機能およびガイダンスがほとんどのサービスで提供されます。 多くの場合、ディザスター リカバリーは自動的であり、Azure によって透過的に実行されます。 特定のシナリオでは、サービス固有の機能を使用して高速復旧を実現できます。 たとえば、Azure SQL Server は、別のリージョンにサービスを迅速に復元するための geo レプリケーションをサポートしています。 Azure App Service にはバックアップと復元の機能があり、ドキュメントには、Azure Traffic Manager を使用してセカンダリ リージョンにトラフィックをルーティングするためのガイダンスが含まれています。

![リージョンのペア](../media-draft/AzRegionPairs.png)

## <a name="testing-a-disaster-recovery-plan"></a>ディザスター リカバリー プランのテスト

ディザスター リカバリーの計画は、プランを完成させるだけで終わるわけではありません。 プランをテストし、指示や説明が明確かつ最新であることを確認することは、ディザスター リカバリーの重要な側面です。

間隔を選択し、さまざまな種類や範囲のテストを実行します。たとえば、バックアップとフェールオーバーのメカニズムを毎月テストし、ディザスター リカバリーの完全シミュレーションを 6 か月おきに実行します。 常に、プランに記述されているとおりの手順および詳細に従ってください。プランにあまり詳しくない人には、内容をより明確にするためのヒントを与えることを検討してください。

必ず、独自の監視システムもテストに含めてください。 たとえば、アプリケーションで自動フェールオーバーをサポートしている場合、依存要素またはその他の重要コンポーネントに障害を発生させて、アプリケーションが完全に正しく動作することを確認します。たとえば、自動フェールオーバーの失敗が検出されること、自動フェールオーバーが正しくトリガーされることなどを確認します。

 要件を注意深く識別してプランを作成することによって、復旧の目標を達成するためにはどのような種類のサービスを使用する必要があるかを判断できます。 Azure では、これらの目標を達成するために役立つ、さまざまなサービスおよび機能を提供しています。
