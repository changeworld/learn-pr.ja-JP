単純なブックマーク参照サービスを作成するとします。 最初の段階では、このサービスは読み取り専用とします。 ユーザーはあるエントリを見つけるとき、そのエントリの ID を記した要求を送信します。すると、URL が返されます。 この流れを説明したのが次の図です。

![この Cosmos DB バックエンドでブックマークを見つけるプロセスを示すフロー図](../media-draft/find-bookmark-flow-small.png)

テキストを含む要求がユーザーから届くと、キーまたは ID としてそのテキストを含むバックエンド データベースでエントリを探します。そのエントリを見つけたかどうかを示す結果を返します。

データはどこかに保存する必要があります。 このフローチャートでは、データ ストアは Azure Cosmos DB として表示されています。 しかしながら、どのような方法で関数からそのデータベースに接続し、データを読み込むのでしょうか。 関数の世界では、そのジョブに対して*入力バインディング*を構成します。  Azure Portal では、バインディングを簡単に構成できます。 これから説明することですが、ストレージ接続を開くなどのタスクにコードを記述する必要はありません。 Azure Functions ランタイムとバインディングにより、ユーザーの代わりにこれらのタスクが処理されます。

> [!IMPORTANT]
> ここで作成するリソース (データベース、関数、バインディング、コード) の一部は次のラボで参照します。 少なくとも本コースを完了するまでは、これらのリソースを維持してください。

前のモジュールの場合と同様に、すべて Azure portal で行います。

## <a name="create-an-azure-cosmos-db"></a>Azure Cosmos DB を作成する 

Azure アカウントで Azure portal ([https://portal.azure.com](https://portal.azure.com?azure-portal=true)) にサインインします。

### <a name="create-a-database-account"></a>データベース アカウントを作成する

データベース アカウントは、たくさんあるデータベースの 1 つを管理するためのコンテナーです。 データベースを作成する前に、データベース アカウントを作成する必要があります。

1. Azure portal の左上隅にある **[リソースの作成]** ボタンを選択し、**[データベース]**、**[Azure Cosmos DB]** の順に選択します。

2. **[新しいアカウント]** ページで、新しい Azure Cosmos DB アカウントの設定を入力します。
 
    設定|値|説明
    ---|---|---
    ID|<*一意の名前を入力*>|この Azure Cosmos DB アカウントを識別するための一意の名前を入力します。 指定した ID に *documents.azure.com* が付加されて URI が作成されるので、ID は一意であっても識別可能なものを使用してください。<br><br>ID に含めることができるのは英小文字、数字、ハイフン (-) のみ、3 文字以上で 50 文字以内にする必要があります。
    API|SQL|API によって、作成するアカウントの種類が決まります。 Azure Cosmos DB には、アプリケーションのニーズに応じて、SQL (ドキュメント データベース)、Gremlin (グラフ データベース)、MongoDB (ドキュメント データベース)、Azure Table、Cassandra の 5 つの API が用意されています。現時点では、それぞれ別個のアカウントが必要です。 <br><br>**[SQL]** を選択します。 現時点では、Azure Cosmos DB トリガー、入力バインディング、出力バインディングは、SQL API アカウントと Graph API アカウントでのみ使用できます。 
    サブスクリプション|*ご利用のサブスクリプション*|この Azure Cosmos DB アカウントに使用する Azure サブスクリプションを選択します。
    リソース グループ|既存のものを使用<br><br>*次に、[!INCLUDE [resource-group-name](./rg-name.md)] を入力します。これはこのモジュールのリソースに対して前のユニットで作成したリソース グループです。*| **[既存のものを使用]** を選択しています。このモジュールに作成したすべてのリソースを同じリソース グループに入れるためです。
    場所|**[既存のものを使用]** が設定されると自動的に入力されます。 | Azure Cosmos DB アカウントをホストする地理的な場所を選択します。 データに最も高速にアクセスできる、ユーザーに最も近い場所を使用します。 このラボでは、既存のリソース グループに設定されている場所として場所が自動的に自動設定されます。
    
**[新しいアカウント]** ブレードのその他の値はすべて既定値のままにします。このモジュールで使用するからです。  これには **[Geo 冗長の有効化]**、**[マルチ マスターを有効にする]**、**[仮想ネットワーク]** などがあります。

3. **[作成]** を選択し、データベース アカウントをプロビジョニングし、デプロイします。

4. デプロイには時間がかかることがあります。 そこで、**デプロイ成功**メッセージが表示されるまで待ちます。次のようなメッセージが表示されたら続行してください。

<!-- TODO figure out how to center these image -->

![データベース アカウント デプロイの完了通知](../media-draft/db-deploy-success.PNG)

5. お疲れさまでした。 データベース アカウントが作成され、デプロイされました。

6. ポータルで **[リソースに移動]** を選択し、データベース アカウントに移動します。 次に、データベースにコレクションを追加します。

### <a name="add-a-collection"></a>コレクションの追加

Cosmos DB では、ユーザーが生成した任意のエンティティが*コンテナー*に保存されます。 ドキュメント指向の API である SQL API をサポートするデータベースの場合、*コレクション*がコンテナーになります。 コレクションの中にドキュメントを保存します。 コレクションを作成し、ドキュメントをいくつか追加したとき、全貌が明らかになります。

それでは、Azure portal でデータ エクスプローラー ツールを使用し、データベースとコレクションを作成しましょう。

1. **[データ エクスプローラー]** > **[新しいコレクション]** の順にクリックします。

2. **[コレクションの追加]** で、新しいコレクションの設定を入力します。

    >[!TIP]
    >**[コレクションの追加]** 領域が右端に表示されます。表示されない場合、右にスクロールしてください。

    設定|推奨値|説明
    ---|---|---
    データベース ID|[!INCLUDE [cosmos-db-name](./cosmos-db-name.md)]| データベース名は 1 文字以上 255 文字以内にする必要があります。/、\\、#、? は使えず、末尾にスペースを入れることもできません。<br><br>ここでは自由に入力できますが、新しいデータベースの名前には [!INCLUDE [cosmos-db-name](./cosmos-db-name.md)] を推奨します。このユニットではこれを参照することになります。 |
    コレクション ID|[!INCLUDE [cosmos-coll-name](./cosmos-coll-name.md)]|新しいコレクションの名前として [!INCLUDE [cosmos-coll-name](./cosmos-coll-name.md)] を入力します。 コレクション ID の文字要件はデータベース名と同じです。
    ストレージの容量| 固定 (10 GB)|既定値の **[固定 (10 GB)]** を使用します。 この値はデータベースの記憶域容量です。
    スループット|400 RU|スループットを毎秒 400 要求ユニット (RU/秒) に変更します。 スループットを 400 RU/秒に設定するには、記憶域容量を**固定 (10 GB)** に設定する必要があります。 待ち時間を短縮する場合、後でスループットをスケールアップできます。
    
3. **[OK]** をクリックします。 新しいデータベースとコレクションがデータ エクスプローラーに表示されます。 これでデータベースが用意されました。 データベース内でコレクションを定義しました。 次に、データ (ドキュメント) をいくつか追加します。

### <a name="add-test-data"></a>テスト データを追加する

[!INCLUDE [cosmos-coll-name](./cosmos-coll-name.md)] という名前のデータベースにコレクションを定義しました。このコレクションには何を保存するのでしょうか。 その目的は、Web ページ ブックマークの一覧のように、各ドキュメントに URL と ID を保存することにあります。 

データ エクスプローラーを使用し、新しいコレクションにデータを追加します。

1. データ エクスプローラーで新しいデータベースが [コレクション] ウィンドウに表示されます。 [!INCLUDE [cosmos-db-name](./cosmos-db-name.md)] データベースを展開し、[!INCLUDE [cosmos-coll-name](./cosmos-coll-name.md)] コレクションを展開し、**[ドキュメント]** をクリックし、**[新しいドキュメント]** をクリックします。
  
2. ここで、次の構造でドキュメントをコレクションに追加します。 各ドキュメントはスキーマレス JSON ファイルです。

     ```json
     {
         "id": "docs",
         "URL": "https://docs.microsoft.com/azure"
     }
     ```

3. JSON を **[ドキュメント]** タブに追加したら、**[保存]** をクリックします。

ドキュメントを保存すると、追加時よりプロパティが増えます。 そのプロパティはすべて下線で始まります (_rid、_self、_etag、_attachments、_ts)。 ドキュメント管理に役立てる目的で自動生成されたプロパティです。 その概要をまとめたものが次の表です。


|プロパティ  |説明  |
|---------|---------|
|_rid     |     リソース ID (_rid) は一意の識別子であり、リソース モデルのリソース スタックごとの階層も示します。 ドキュメント リソースの配置と移動のために内部使用されます。    |
|_self     |   リソースの URI であり、一意にアドレス指定できます。      |
|_etag     |   オプティミスティック同時実行制御に必要です。     |
|_attachments     |  添付リソースのアドレス指定可能パス。       |
|_ts     |    このリソースの最終更新を示すタイムスタンプ。    |
 

4. それでは、コレクションにドキュメントをいくつか追加してみましょう。 次のいずれに対しても、**新しいドキュメント** コマンドをもう一度使用し、各々のエントリを作成します。 忘れずに [保存] をクリックし、追加内容を記録してください。

|ID  |値  |
|---------|---------|
|ポータル     |  https://portal.azure.com       |
|詳細情報     |   https://docs.microsoft.com/learn |
|マーケットプレース     |    https://azuremarketplace.microsoft.com/marketplace/apps  |
|ブログ | https://azure.microsoft.com/blog |

完了したら、コレクションは次のスクリーンショットのようになるはずです。

![ブックマーク コレクションに追加したエントリ一覧を示す、ポータルの SQL API UI のスクリーンショット。](../media-draft/db-bookmark-coll.PNG)

ブックマーク コレクションにエントリがいくつか与えられました。 今回のシナリオは次のように動作します。 "id=docs" などが指定された要求が届いたら、ブックマーク コレクションでその ID を探し、URL https://docs.microsoft.com/azure を返します。 それでは、このコレクションで値を探す Azure 関数を作りましょう。

## <a name="create-our-function"></a>関数の作成

1. 前のユニットで作成した関数アプリに移動します。

2. ご利用の関数アプリを展開し、関数のコレクションをポイントし、**[関数]** の横にある [追加] (**+**) ボタンを選択します。 この操作により関数作成プロセスが開始されます。 次のアニメーションで、この操作を示します。

![ユーザーが [関数] メニュー項目をポイントしたときにプラス記号が表示されるというアニメーション。](../media-draft/func-app-plus-hover-small.gif)

3. サポートされているすべてのトリガーがこのページに表示されます。 **[HTTP トリガー]** (次のスクリーン ショットの最初のエントリ) を選択します。

![トリガー テンプレートの選択 UI の一部を示すスクリーン ショット。イメージの左上に TTP トリガーが最初に表示されている。](../media-draft/trigger-templates-small.PNG)

4. 右側に表示された **[新しい関数]** ダイアログに、次の値を使用して入力します。

|フィールド  |値  |
|---------|---------|
|言語     | **JavaScript**        |
|名前     |   [!INCLUDE [func-name-find](./func-name-find.md)]     |
| 承認レベル | **関数** |

5. **[作成]** を選択して関数を作成します。これにより、コード エディターで index.js ファイルが開き、HTTP によってトリガーされる関数の既定の実装が表示されます。

新しい関数を次のようにテストすることで、ここまでの作業を検証できます。

1. 新しい関数で、右上の **[</> 関数の URL の取得]** をクリックし、**[既定値 (関数キー)]** を選択して、**[コピー]** をクリックします。

2. コピーした関数 URL をご利用のブラウザーのアドレス バーに貼り付けます。 この URL の末尾にクエリ文字列 `&name=<yourname>` を追加し、キーボードで `Enter` キーを押して要求を実行します。 次のような応答が関数によって返され、ブラウザーに表示されます。  

これで必要最低限の関数が動作することが分かりました。それでは、Azure Cosmos DB (今回のシナリオでは [!INCLUDE [cosmos-coll-name](./cosmos-coll-name.md)] コレクション) からデータを読み込みます。

## <a name="add-a-cosmos-db-input-binding"></a>Cosmos DB 入力バインディングの追加

作成したデータベースからデータを読み込みます。そこで、入力バインディングを入力します。 ご覧のとおり、わずかな手順でデータベースと通信できるバインディングを構成できます。

1. 左側にある関数メニューで **[統合]** を選択して、[統合] タブを開きます。

使用したテンプレートにより、HTTP トリガーと HTTP 出力バインディングが自動的に作成されました。 それでは、新しい Azure Cosmos DB 入力バインディングを追加しましょう。 

2. **[入力]** 列の下にある **[+ 新しい入力]** を選択します。 入力バインディングとして考えられる全種類の一覧が表示されます。

3. 一覧から **[Azure Cosmos DB]** をクリックし、**[選択]** ボタンをクリックします。 この操作により、Azure Cosmos DB 入力構成ページが開きます。

次に、データベースへの接続を設定します。

4. このページにある **Azure Cosmos DB アカウント接続**という名前のフィールドで、空のフィールドの右にある *[新規]* をクリックします。 この操作により **[接続]** ダイアログが開きます。このダイアログでは **Azure Cosmos DB アカウント**とご利用の Azure サブスクリプションが既に選択されています。 あとは、データベース アカウント ID を選択するだけです。

5. 「**データベース アカウントを作成する**」セクションでは、ID 値を入力する必要がありました。 ここでその値を *[データベース アカウント]* ドロップダウンで見つけ、**[選択]** をクリックします。

データベースへの新しい接続が構成され、**[Azure Cosmos DB アカウント接続]** フィールドに表示されます。 この抽象的な名前に隠された実際の意味を知りたければ、*[値の表示]* をクリックしてください。接続文字列が表示されます。

特定の ID でブックマークを探します。受け取った ID をバインディングに連結します。

7. **[ドキュメント ID (任意)]** フィールドに「`{id}`」を入力します。 これは*バインディング式*と呼ばれています。 関数は、クエリ文字列を使用して検索のための ID を指定する HTTP 要求によってトリガーされます。 ID はコレクション内で一意となるため、バインディングにより 0 ドキュメント (見つからない) か 1 ドキュメント (見つかった) が返されます。

8. 次の表の値を使用し、このページの残りのフィールドに注意深く入力します。 各フィールド名の右にある情報アイコンをクリックすれば、各フィールドの詳しい目的をいつでも確認できます。


|設定  |値  |説明  |
|---------|---------|---------|
|ドキュメント パラメーター名     |  **ブックマーク**       |  コードでこのバインディングを識別するための名前。      |
|データベース名     |  [!INCLUDE [cosmos-db-name](./cosmos-db-name.md)]       | データが読み取られるデータベース。 これはこのレッスンの前半で設定したデータベース名です。        |
|コレクション名     |  [!INCLUDE [cosmos-db-name](./cosmos-coll-name.md)]        | データの読み取り元のコレクション。 この設定はレッスンの前半で定義しました。 |
|SQL クエリ (任意)    |   空白のままにします       |   ID に基づき、一度に 1 ドキュメントだけ取得しています。 そのため、この場合は SQL クエリを使用するよりドキュメント ID フィールドでフィルター処理するほうが効果的です。 エントリを 1 つ返す SQL クエリを作成することもできます (`SELECT * from b where b.ID = {id}`)。 このクエリでは確かにドキュメントが返されますが、ドキュメント コレクションのドキュメントを返します。 コードで無駄にコレクションを操作しなければならないことがあります。 複数のドキュメントを取得するときに SQL クエリの手法を使用してください。   |
|パーティション キー (省略可能)     |   空白のままにします      |  ここでは既定値をそのまま使用してかまいません。       |

9. **[保存]** をクリックし、このバインディング構成に対する変更をすべて保存します。 これでバインディングが定義されたので関数で使用しましょう。

## <a name="update-function-implementation"></a>関数の実装を更新する

1. 関数 [!INCLUDE [func-name-find](./func-name-find.md)] をクリックして、*index.js* をコード エディターで開きます。 データベースから読み込む目的で入力バインディングを追加しています。このバインディングを使用するようにロジックを更新しましょう。

2. index.js 内のすべてのコードを次のスニペットのコードに置換します。

[!code-javascript[](../code/find-bookmark-single.js)]

HTTP 要求により関数がトリガーされると、`id` クエリ パラメーターが Cosmos DB 入力バインディングに渡されます。 この ID に一致するドキュメントが見つかった場合、`bookmark` パラメーターがそれに設定されます。 その場合、ブックマーク ドキュメントで見つかった URL 値を含む応答を作成します。 このキーに一致するドキュメントが見つからなかった場合、ペイロードと状態コードで応答し、その旨をユーザーに伝えます。

## <a name="try-it-out"></a>試してみる

1. 通常は、右上の **[</> 関数の URL の取得]** をクリックし、**[既定値 (関数キー)]** を選択して、**[コピー]** をクリックすることで、関数の URL をコピーします。

2. コピーした関数 URL をご利用のブラウザーのアドレス バーに貼り付けます。 この URL の末尾にクエリ文字列 `&id=docs` を追加し、キーボードで `Enter` キーを押して要求を実行します。 すべて順調であれば、そのリソースへの URL を含む応答が表示されます。

3. `&id=docs` を `&id=missing` に置き換え、応答を観察します。

4. 前のクエリ文字列を `&id=` に置き換え、応答を観察します。

>[!TIP]
>関数ポータル UI の **[テスト]** タブを使用して関数をテストすることもできます。 クエリ パラメーターを追加するか、単純に要求本文を指定することで、前の手順で説明した同じ結果を得ることができます。

このユニットでは、Azure Cosmos DB データベースから読み取る目的で、最初の入力バインディングを手動で作成しました。 バインディングを利用したことで、データベースを検索するために記述するコードの量が最小に抑えられました。 作業の多くはバインディングを宣言によって構成することで行い、残りはプラットフォームにまかせました。  

次のユニットでは、Azure Cosmos DB 出力バインディングを利用し、ブックマーク コレクションにさらにデータを追加します。

> [!TIP]
> このユニットは Azure Cosmos DB のチュートリアルではありません。 さらに詳しく知りたければ、以下に紹介するリソースから始めてください。
>
>* [Azure Cosmos DB の概要: SQL API](https://docs.microsoft.com/azure/cosmos-db/sql-api-introduction)
>
>* [Azure Cosmos DB の技術概要](https://azure.microsoft.com/blog/a-technical-overview-of-azure-cosmos-db/)
>
>* [Azure Cosmos DB のドキュメント](https://docs.microsoft.com/azure/cosmos-db/)