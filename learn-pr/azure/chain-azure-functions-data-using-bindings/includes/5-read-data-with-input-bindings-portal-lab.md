単純なブックマーク参照サービスを作成するとします。 このサービスは、最初は読み取り専用です。 ユーザーは、エントリを見つけるときに、そのエントリの ID を含む要求を送信すると、URL が返されます。 次のフローチャートはこのフローを示しています。

![Cosmos DB バックエンドでブックマークを見つけるプロセスを示すフロー図。 Azure 関数は、ブックマーク ID の要求を受信すると、エラー応答が生成されない場合、要求が有効かどうかを最初にチェックします。 有効な要求の場合、関数はブックマーク ID が Cosmos DB に存在するかどうかチェックし、存在しない場合はエラー応答が生成されます。 ブックマーク ID が見つかると、正常な応答が生成されます。](../media/5-find-bookmark-flow-small.png)

ユーザーからテキストを含む要求が送信されたら、キーまたは ID としてそのテキストを含むエントリをバックエンド データベースで検索することを試みます。 そのエントリが見つかったかどうかを示す結果を返します。

データはどこかに保存する必要があります。 このフローチャートでは、データ ストアは Azure Cosmos DB インスタンスです。 しかし、関数からデータベースに接続し、データを読み取るにはどうすればよいのでしょうか。 関数の世界では、そのジョブのために "*入力バインディング*" を構成します。  Azure portal では、バインディングを簡単に構成できます。 この後説明しますが、ストレージ接続を開くなどのタスクのコードを記述する必要はありません。 Azure Functions ランタイムとバインディングによって、これらのタスクが自動的に処理されます。

## <a name="create-an-azure-cosmos-db-account"></a>Azure Cosmos DB アカウントを作成する

> [!NOTE]
> このユニットは Azure Cosmos DB のチュートリアルではありません。 このモジュールの修了後、詳細を学ぶことに関心がある場合は、Cosmos DB の完全なラーニング パスがあります。

### <a name="create-a-database-account"></a>データベース アカウントを作成する

データベース アカウントとは、1 つ以上のデータベースを管理するためのコンテナーです。 データベースを作成するには、データベース アカウントを作成しておく必要があります。

1. サンドボックスをアクティブ化したときと同じアカウントを使用して [Azure portal](https://portal.azure.com/learn.docs.microsoft.com?azure-portal=true) にサインインしていることを確認します。

1. Azure portal の左上隅にある **[リソースの作成]** ボタンを選択し、**[データベース]** > **[Azure Cosmos DB]** を選択します。

1. **[新しいアカウント]** ページで、新しい Azure Cosmos DB アカウントの設定を入力します。

    | 設定 | 値 | 説明 |
    |---------|-------|-------------|
    | ID |<*一意の名前を入力*>|この Azure Cosmos DB アカウントを識別するための一意の名前を入力します。 指定した ID に `documents.azure.com` が追加されて URI が作成されるので、一意であっても識別可能な ID を使用してください。<br><br>ID には英小文字、数字、ハイフン (-) のみを使用できます。また、3 から 50 文字である必要があります。 |
    | API |SQL|API によって、作成するアカウントの種類が決まります。 Azure Cosmos DB には、アプリケーションのニーズに応じて、SQL (ドキュメント データベース)、Gremlin (グラフ データベース)、MongoDB (ドキュメント データベース)、Azure Table、Cassandra の 5 つの API が用意されています。現時点では、それぞれ別のアカウントが必要です。 <br><br>**[SQL]** を選択します。 現時点では、Azure Cosmos DB トリガー、入力バインディング、出力バインディングは、SQL API アカウントと Graph API アカウントでのみ使用できます。 |
    | サブスクリプション | コンシェルジェ サブスクリプション | この Azure Cosmos DB アカウントに使用する Azure サブスクリプションを選択します。 |
    リソース グループ|既存のものを使用<br><br>次に、**<rgn>[サンドボックス リソース グループ名]</rgn>** を選択します。 | このモジュールで作成したすべてのリソースを無料のサンドボックス リソース グループにまとめるため、**[既存のものを使用]** を選択します。 |
    | 場所 | **[既存のものを使用]** が設定されると自動的に入力されます。 | Azure Cosmos DB アカウントをホストする地理的な場所を選択します。 データに最も高速にアクセスできるように、ユーザーに最も近い場所を使用します。 この演習では、場所は、既存のリソース グループに設定されている場所として事前に決められています。|

    **[新しいアカウント]** ブレードのその他のフィールドはすべて既定値のままにします。このモジュールで使用するからです。  これには **[Geo 冗長の有効化]**、**[マルチ マスターを有効にする]**、**[仮想ネットワーク]** などがあります。

1. **[作成]** を選択し、データベース アカウントをプロビジョニングし、デプロイします。

1. デプロイには時間がかかることがあります。 通知ハブに **"デプロイメントに成功しました"** というメッセージが表示されるのを待ってから次に進みます。

    ![データベース アカウントのデプロイが完了したことを示す通知](../media/5-db-deploy-success.PNG)

1. ポータルで **[リソースに移動]** を選択して、データベース アカウントに移動します。 次に、データベースにコレクションを追加します。

### <a name="add-a-collection"></a>コレクションの追加

Cosmos DB では、ユーザーが生成した任意のエンティティが*コンテナー*に保持されます。 SQL API および MongoDB API アカウントの場合、コンテナーは "*コレクション*" にマップされます。 コレクション内にドキュメントを保存します。

Azure portal でデータ エクスプローラー ツールを使用して、データベースとコレクションを作成しましょう。

1. **[データ エクスプローラー]** > **[新しいコレクション]** を選択します。

2. **[コレクションの追加]** で、新しいコレクションの設定を入力します。

    >[!TIP]
    >**[コレクションの追加]** 領域が右端に表示されます。 この領域を表示するために、右にスクロールすることが必要な場合があります。

    |設定|推奨値|説明
    |---|---|---|
    |データベース ID|[!INCLUDE [cosmos-db-name](./cosmos-db-name.md)]| データベース名は 1 文字以上 255 文字以内にする必要があります。/、\\、#、? は使えず、末尾にスペースを入れることもできません。<br><br>ここでは自由に入力できますが、新しいデータベースの名前には [!INCLUDE [cosmos-db-name](./cosmos-db-name.md)] を推奨します。このユニットではこれを参照することになります。 |
    |コレクション ID|[!INCLUDE [cosmos-coll-name](./cosmos-coll-name.md)]|新しいコレクションの名前として [!INCLUDE [cosmos-coll-name](./cosmos-coll-name.md)] を入力します。 コレクション ID の文字要件はデータベース名と同じです。|
    |ストレージの容量| 固定 (10 GB)|既定値の **[固定 (10 GB)]** を使用します。 この値はデータベースの記憶域容量です。|
    |スループット|1000 RU|スループットを 1 秒あたり 1000 要求ユニット (RU/秒) に変更します。 スループットを 400 RU/秒に設定するには、ストレージ容量を**固定 (10 GB)** に設定する必要があります。 待ち時間を短縮する必要がある場合は、後でパフォーマンスをスケールアップできます。|

3. **[OK]** をクリックします。 新しいデータベースとコレクションがデータ エクスプローラーに表示されます。 これでデータベースが用意されました。 データベース内でコレクションを定義しました。 次に、データ (ドキュメントとも呼ばれます) を追加します。

### <a name="add-test-data"></a>テスト データを追加する

データベース内で [!INCLUDE [cosmos-coll-name](./cosmos-coll-name.md)] というコレクションを定義しました。 Web ページ ブックマークの一覧のように、各ドキュメントに URL と ID を保存します。

データ エクスプローラーを使用して、新しいコレクションにデータを追加します。

1. データ エクスプローラーの [コレクション] ウィンドウに新しいデータベースが表示されます。 [!INCLUDE [cosmos-db-name](./cosmos-db-name.md)] データベース、[!INCLUDE [cosmos-coll-name](./cosmos-coll-name.md)] コレクションの順に展開し、**[ドキュメント]** を選択して、**[新しいドキュメント]** を選択します。

2. 新しいドキュメントの既定の内容を次の JSON に置き換えます。

     ```json
     {
         "id": "docs",
         "URL": "https://docs.microsoft.com/azure"
     }
     ```

3. JSON を **[ドキュメント]** タブに追加したら、**[保存]** をクリックします。

    追加したプロパティよりも多くのプロパティがあることに注意してください。 これらはすべて下線で始まっています (_rid、_self、_etag、_attachments、_ts)。 これらはシステムによって生成されたプロパティであり、ドキュメントの管理に役立ちます。

    |プロパティ  |説明  |
    |---------|---------|
    | `_rid`     |     リソース ID は一意の識別子であり、リソース モデルのリソース スタックごとの階層も示します。 ドキュメント リソースの配置と移動のために内部で使用されます。    |
    | `_self`     |   リソースのアドレス可能な一意の URI。      |
    | `_etag`     |   オプティミスティック同時実行制御に必要です。     |
    | `_attachments`     |  添付リソースのアドレス可能パス。       |
    | `_ts`     |    このリソースの最終更新を示すタイムスタンプ。    |

4. コレクションにドキュメントをさらに追加しましょう。 次の内容でさらに 4 つのドキュメントを作成します。 作業内容を必ず保存してください。

    ```json
    {
        "id": "portal",
        "URL": "https://portal.azure.com"
    }
    ```

    ```json
    {
        "id": "learn",
        "URL": "https://docs.microsoft.com/learn"
    }
    ```

    ```json
    {
        "id": "marketplace",
        "URL": "https://azuremarketplace.microsoft.com/marketplace/apps"
    }
    ```

    ```json
    {
        "id": "blog",
        "URL": "https://azure.microsoft.com/blog"
    }
    ```

1. 完了すると、コレクションは次のようになります。

    ![ブックマーク コレクションに追加したエントリの一覧を示す、ポータルの SQL API UI](../media/5-db-bookmark-coll.PNG)

ブックマーク コレクションにエントリが追加されました。 シナリオは次のように動作します。 たとえば、"id=docs" が指定された要求が届いたら、ブックマーク コレクション内でその ID を検索し、URL `https://docs.microsoft.com/azure` を返します。 このコレクション内の値を検索する Azure 関数を作成しましょう。

## <a name="create-your-function"></a>関数を作成する

1. 前のユニットで作成した関数アプリに移動します。

1. 関数アプリを展開し、関数のコレクションをポイントして、**[関数]** の横の **[追加]** (**+**) ボタンをクリックします。
   この操作により、関数作成プロセスが開始されます。 次のアニメーションはこの操作を示しています。

   ![[関数] メニュー項目をポイントするとプラス記号が表示されることを示すアニメーション。](../media/3-func-app-plus-hover-small.gif)

   このページには、サポートされているすべてのトリガーが表示されます。

1. **[HTTP トリガー]** (次のスクリーン ショットの最初のエントリ) を選択します。

    ![画像の左上に HTTP トリガーが最初に表示されている、トリガー テンプレートの選択 UI の一部を示すスクリーン ショット。](../media/5-trigger-templates-small.png)

1. 右側に表示された **[新しい関数]** ダイアログに次の値を入力します。

    | フィールド | 値 |
    |----------|--------|
    | 言語 | **JavaScript** |
    | 名前     | [!INCLUDE [func-name-find](./func-name-find.md)] |
    | 承認レベル | **関数** |

1. **[作成]** を選択して関数を作成します。
    この操作により、コード エディターで *index.js* ファイルが開き、HTTP によってトリガーされる関数の既定の実装が表示されます。

### <a name="verify-the-function"></a>関数を検証する

新しい関数を次のようにテストすることで、ここまでの作業内容を検証できます。

1. 新しい関数で、右上の **[関数の URL の取得]** をクリックし、**[既定値 (関数キー)]** を選択して、**[コピー]** をクリックします。

1. コピーした関数 URL をブラウザーのアドレス バーに貼り付けます。 URL の末尾にクエリ文字列値 `&name=<yourname>` を追加し、**Enter** キーを押して要求を実行します。 Azure 関数からの応答がブラウザーにすぐに表示されます。

関数の必要最小限の動作を設定しました。次に、Azure Cosmos DB (このシナリオでは [!INCLUDE [cosmos-coll-name](./cosmos-coll-name.md)] コレクション) からデータを読み取りましょう。

## <a name="add-an-azure-cosmos-db-input-binding"></a>Azure Cosmos DB 入力バインディングを追加する

データベースからデータを読み取るには、入力バインディングを定義する必要があります。 次に説明するように、データベースと通信できるバインディングをわずかな手順で構成できます。

1. 左側のウィンドウで **[統合]** を選択して統合タブを開きます。使用したテンプレートによって、HTTP トリガーと HTTP 出力バインディングが作成されています。 ここでは、新しい Azure Cosmos DB 入力バインディングを追加します。

2. **[入力]** 列の **[新しい入力]** を選択します。
   使用可能な入力バインディングの全種類の一覧が表示されます。

3. この一覧で、**[Azure Cosmos DB]** を選択し、**[選択]** をクリックします。
   この操作により、Azure Cosmos DB 入力構成ページが開きます。 次に、データベースへの接続を設定します。

4. **[Azure Cosmos DB アカウント接続]** ボックスの横の **[新規]** を選択します。
   この操作により、**[接続]** ウィンドウが開きます。**Azure Cosmos DB アカウント**と Azure サブスクリプションが既に選択されています。 あとは、データベース アカウント ID を選択するだけです。

5. 「データベース アカウントを作成する」で、ID 値を指定する必要がありました。 **[データベース アカウント]** ドロップダウン リストでその値を見つけ、**[選択]** をクリックします。

6. データベースへの新しい接続が構成され、**[Azure Cosmos DB アカウント接続]** フィールドに表示されます。 この抽象名の背後にある実際の内容に興味がある場合は、*[値の表示]* をクリックして接続文字列を表示します。

特定の ID でブックマークを検索するので、受け取った ID をバインディングに関連付けましょう。

7. **[ドキュメント ID (任意)]** フィールドに「`{id}`」と入力します。 この構文は "*バインド式*" と呼ばれます。 関数は、クエリ文字列を使用して検索する ID を指定した HTTP 要求によってトリガーされます。 ID はコレクション内で一意となるため、バインディングにより 0 ドキュメント (見つからない) か 1 ドキュメント (見つかった) が返されます。

8. 次の表の値を使用し、このページの残りのフィールドに注意深く入力します。 各フィールド名の右にある情報アイコンをクリックすれば、各フィールドの詳しい目的をいつでも確認できます。

    |設定  |値  |説明  |
    |---------|---------|---------|
    |ドキュメント パラメーター名     |  **ブックマーク**       |  コードでこのバインディングを識別するための名前。      |
    |データベース名     |  [!INCLUDE [cosmos-db-name](./cosmos-db-name.md)]       | 使用するデータベース。 この値は、このレッスンで以前に設定したデータベース名です。        |
    |コレクション名     |  [!INCLUDE [cosmos-db-name](./cosmos-coll-name.md)]        | データの読み取り元のコレクション。 この設定はレッスンの前半で定義しました。 |
    |SQL クエリ (任意)    |   空白のままにします       |   ID に基づき、一度に 1 ドキュメントだけ取得しています。 そのため、この場合は SQL クエリを使用するよりドキュメント ID フィールドでフィルター処理するほうが効果的です。 エントリを 1 つ返す SQL クエリを作成することもできます (`SELECT * from b where b.ID = {id}`)。 このクエリでは確かにドキュメントが返されますが、ドキュメント コレクションのドキュメントを返します。 コードで無駄にコレクションを操作しなければならないことがあります。 複数のドキュメントを取得するときに SQL クエリの手法を使用してください。   |
    |パーティション キー (省略可能)     |   空白のままにします      |  ここでは既定値をそのまま使用してかまいません。       |

9. **[保存]** をクリックして、このバインディング構成に対するすべての変更を保存します。

バインディングが定義されたので、関数で使用します。

## <a name="update-function-implementation"></a>関数の実装を更新する

1. 関数 [!INCLUDE [func-name-find](./func-name-find.md)] を選択して、*index.js* をコード エディターで開きます。 データベースから読み取るための入力バインディングを追加したので、このバインディングを使用するようにロジックを更新します。

2. *index.js* 内のすべてのコードを次のスニペットのコードに置き換え、**[保存]** をクリックします。

   [!code-javascript[](../code/find-bookmark-single.js)]

受信 HTTP 要求によって関数がトリガーされ、`id` クエリ パラメーターが Cosmos DB 入力バインディングに渡されます。 データベースでこの ID に一致するドキュメントが見つかった場合、`bookmark` パラメーターが見つかったドキュメントに設定されます。 その場合、ブックマークが設定されたドキュメント内の URL 値を含む応答を作成します。 このキーに一致するドキュメントが見つからなかった場合は、ペイロードと、ドキュメントが見つからなかったことをユーザーに伝える状態コードで応答します。

## <a name="try-it-out"></a>試してみる

1. 右上の **[関数の URL の取得]** を選択し、**[既定値 (関数キー)]**、**[コピー]** の順に選択して関数の URL をコピーします。

2. コピーした関数 URL をブラウザーのアドレス バーに貼り付けます。 この URL の末尾にクエリ文字列値 `&id=docs` を追加し、キーボードの `Enter` キーを押して要求を実行します。 そのリソースの URL を含む応答が表示されます。

3. `&id=docs` を `&id=missing` に置き換え、応答を確認します。

4. 前のクエリ文字列を `&id=` に置き換え、応答を確認します。

    >[!TIP]
    >関数ポータル UI の **[テスト]** タブを使用して関数をテストすることもできます。 クエリ パラメーターを追加するか、要求本文を指定することで、前の手順で説明した同じ結果が得られます。

このユニットでは、Azure Cosmos DB データベースから読み取るために、最初の入力バインディングを手動で作成しました。 バインディングにより、データベースを検索してデータを読み取るために記述するコードの量が最小限に抑えられました。 作業のほとんどは、宣言によってバインディングを構成することで行い、残りはプラットフォームによって処理されました。

次のユニットでは、Azure Cosmos DB 出力バインディングを使用して、ブックマーク コレクションにさらにデータを追加します。