関数アプリを作成したので、Azure 関数をビルド、構成、実行する方法について学習しましょう。

### <a name="triggers"></a>トリガー

関数はイベント駆動型です。つまり、イベントに応答して実行されるということです。

関数を開始するイベントの種類は、*トリガー*と呼ばれます。 関数は必ず 1 つのトリガーで構成します。

 Azure では、次のサービスに対してトリガーをサポートしています。


|サービス  |トリガーの説明  |
|---------|---------|
|Blob Storage     |  新しい BLOB または更新された BLOB が検出されたときに関数を開始します。       |
|Cosmos DB     |  挿入および更新が検出されたときに関数を開始します。      |
|Event Grid     |   Event Grid からイベントを受信したときに関数を開始します。       |
|HTTP     |   HTTP 要求で関数を開始します。      |
|Microsoft Graph イベント     |  Microsoft Graph から受信した Webhook に応答して関数を開始します。 このトリガーの各インスタンスは、それぞれ Microsoft Graph リソースの 1 つの種類に応答できます。       |
|Queue Storage     |    キューで新しい項目を受け取ったときに関数を開始します。 キュー メッセージは、関数への入力として提供されます。      |
|Service Bus     |  Service Bus キューからのメッセージに応答して関数を開始します。       |
|Timer     |  スケジュールに従って関数を開始します。       |
|Webhook     |  Webhook 要求で関数を開始します。       |

### <a name="bindings"></a>バインド

Azure Functions バインドは、データとサービスを作成した関数に接続するための宣言型の方法です。 データ ソースに接続して、接続を管理するために、自分で関数にコードを記述する必要はありません。 ユーザーの代わりに、プラットフォームによってその複雑さが処理されます。 バインドには方向があります。 コードは、*入力*バインドからデータを読み取り、*出力*バインドにデータを書き込みます。 1 つ例を見てみましょう。

Blob Storage からデータを読み取るには、*BLOB* 型の入力バインドを構成します。 メッセージを Queue Storage に書き込むには、*キュー*型の出力バインドを構成します。

サポートされるバインドとトリガーの詳細については、[Azure ドキュメント](https://docs.microsoft.com/azure/azure-functions/functions-triggers-bindings#supported-bindings)を参照してください。

### <a name="a-sample-trigger-and-binding-functionjson"></a>サンプルのトリガーとバインド (function.json)

次の JSON は、関数に対するトリガーとバインドの定義のサンプルです。

```javascript
{
  "bindings": [
    {
      "name": "order",
      "type": "queueTrigger",
      "direction": "in",
      "queueName": "myqueue-items",
      "connection": "MY_STORAGE_ACCT_APP_SETTING"
    },
    {
      "name": "$return",
      "type": "table",
      "direction": "out",
      "tableName": "outTable",
      "connection": "MY_TABLE_STORAGE_ACCT_APP_SETTING"
    }
  ]
}
```

前述のとおり、各バインドには、それが入力バインドなのか出力バインドなのかを定義する方向があります。 トリガーは常に入力バインドです。 上記のサンプルは、**myqueue-items** という名前のキューに追加されるメッセージによってトリガーされる関数を示しています。 次に、関数の戻り値を Azure テーブル ストレージ内の **outTable** テーブルに送信します。

## <a name="creating-a-function-in-the-azure-portal"></a>Azure portal で関数を作成する

Azure では、Azure 関数の一般的なシナリオ向けに、事前構成済みのテンプレートが用意されています。

### <a name="quickstart-templates"></a>クイック スタート テンプレート

Azure 関数を追加するには、関数アプリを選択する必要があります。 関数アプリは、山かっこ内の稲妻アイコンによって識別できます。  
![リソース グループで選択した関数アプリを示すスクリーンショット。](../images/5-function-icon.png)

初めて Azure 関数を追加するときに、クイック スタート画面が表示されます。 この画面を使用して、トリガーの種類とプログラミング言語を選択することができます。 その後、選択内容に基づいて、関数のコードと構成が Azure によって生成されます。 
 
![関数のクイックスタート](../images/5-quickstart-form.png)

### <a name="function-templates"></a>関数テンプレート

テンプレートの選択範囲は、クイック スタートに表示されているテンプレートに限りません。 30 個を超えるさまざまなテンプレートから選択するオプションもあります。 テンプレート リストの画面には、後続の関数の作成時、またはクイック スタート画面で **[カスタム関数]** オプションを選択してアクセスすることができます。  
![用意されている関数を使用してすばやく開始するのに役立つ Azure Functions クイック スタートのユーザー インターフェイスのスクリーンショット。](../images/5-template-list.png)

## <a name="navigating-to-your-function-and-files"></a>関数とファイルに移動する

テンプレートから関数を作成すると、複数のファイルが作成されます。 たとえば、JavaScript を使用して Webhook + API クイック スタートを使用することを選択した場合は、構成ファイル (**function.json**) とソース コード ファイル (**index.js**) が生成されます。 関数アプリで作成した関数は、関数アプリ ポータル内の [関数] メニュー項目の下に表示されます。

関数アプリで関数を選択すると、次のスクリーンショットで示されているように、コード エディターが開き、ご自分の関数用のコードが表示されます。

![関数の開発を高速化するために使用できるテンプレートのセットが一覧表示された関数テンプレートの選択インターフェイスを示すスクリーンショット。](../images/5-file-navigation.png)

前のスクリーンショットで確認できるように、右側にポップアップ メニューがあり、**[ファイルの表示]** へのタブが含まれています。 このタブを選択すると、ご自分の関数を構成するファイル構造が表示されます。  

## <a name="execution-options-for-testing-your-azure-function"></a>Azure 関数をテストするための実行オプション

関数を作成したら、テストを行います。 手動で実行する方法と、Azure portal 内からテストする方法の 2 種類があります。

### <a name="manual-execution-of-a-function"></a>関数の手動での実行

構成されたトリガーを手動でトリガーすることによって、関数を開始できます。 たとえば、HttpTrigger を使用している場合、Postman または cURL などのツールを使用して、自分の関数エンドポイント URL への HTTP 要求を開始することができます。  

![[URL] フィールドに関数 URL が入力され、要求本文にサンプルの本文が入力された、Postman アプリケーション インターフェイスのスクリーンショット (部分)。 ](../images/5-postman-execution.png)

エンドポイント URL を取得するには、左側のナビゲーションから [HTTP トリガー] を選択し、**[関数の URL の取得]** ボタンを選択します。  

![関数が選択され、ページの上部で *関数の URL の取得* アクションが選択された Function App ポータルのスクリーンショット。](../images/5-get-function-url.png)

### <a name="testing-a-function-in-the-azure-portal"></a>Azure portal で関数をテストする

ポータルにも、関数をテストするための便利な手段が用意されています。 コード ウィンドウの右側に、タブ付きのポップアップ ナビゲーション メニューがあります。 このメニューには、**[テスト]** 項目が含まれています。 メニューを展開してこのタブを選択して、別の方法で関数を実行し、結果を表示することができます。 HttpTrigger シナリオに合わせて、HTTP メソッドを設定し、クエリ文字列パラメーターと HTTP ヘッダーを要求に追加することができます。 要求本文を変更して、追加のシナリオをテストすることもできます。 次の例では、*name* と呼ばれる 1 つのパラメーターを持つ要求本文で HTTP POST 要求としてテストが構成されています。
 
![HTTP POST 要求とサンプルの要求本文を示す Function App ポータルのテスト ウィンドウのスクリーンショット。 [出力] ウィンドウには、関数呼び出しの結果である "こんにちは Azure" が含まれています。](../images/5-portal-execution.png)

このテスト ウィンドウで **[実行]** をクリックすると、その結果が出力ウィンドウに状態コードと共に表示されます。 

## <a name="monitoring-an-azure-function"></a>Azure 関数を監視する

メッセージを記録し関数を監視する機能は、開発中と運用環境で重要です。 Azure portal には、監視ダッシュボードと、ご使用の Azure 関数から取得した実行ログと例外を確認するための方法が用意されています。

### <a name="log-window"></a>ログ ウィンドウ

関数にログ ステートメントを追加することもできます。 これらのステートメントは、関数のログ ウィンドウに表示されます。 ログ ウィンドウは、コード ウィンドウの下部にあるタブ付きのポップアップ メニューにあります。 次の JavaScript コード スニペットは、`context.log` メソッドを使用してメッセージを記録する方法について示しています。

```javascript
  context.log('Enter your logging statement here');
```  

![Azure Functions のユーザー インターフェイスのコード エディター セクションのスクリーンショット。 context.log() メソッドを使用してログ ウィンドウにメッセージを記録するコード行も強調表示されています。](../images/5-log-window.png)

### <a name="errors-and-warnings-window"></a>エラーと警告ウィンドウ

エラーと警告ウィンドウ タブは、ログ ウィンドウと同じポップアップ メニューで検索できます。 このウィンドウには、コード内のコンパイル エラーと警告が表示されます。 JavaScript は動的なインタープリタ型言語であるため、次の図は、C# 関数でのコンパイル エラーを示しています。  

![画面の下部で **ログ** ウィンドウが強調表示された、Azure Functions のユーザー インターフェイスのコード エディター セクションのスクリーン ショット。](../images/5-errors-window.png)

### <a name="monitoring-dashboard"></a>監視ダッシュボード

関数アプリのナビゲーション メニューでは、関数ノードを展開すると **[監視]** メニュー項目が表示されます。 監視ダッシュボードには、関数の実行履歴を表示する簡単な方法が用意されています。 このビューには、タイムスタンプ、結果コード、期間、および操作 ID も表示されます (正常に完了した場合)。 データは、Azure Application Insights を通じて入力されます。  

![関数の呼び出しの成功と失敗の一覧を示している、**[監視]** 関数のメニュー項目から起動した監視ダッシュボードのスクリーンショット。](../images/5-monitor-function.png)
