オンプレミス環境を Azure と統合するには、暗号化された接続を作成できる必要があります。 または、インターネット経由で、専用リンク経由で接続できます。 ここでは、Azure VPN Gateway、オンプレミス環境からの着信接続のエンドポイントを提供することについて説明します。

Azure の仮想ネットワークを設定し、すべてのデータが Azure からサイトに転送間 Azure 仮想ネットワークが暗号化されていることを確認する必要があります。 また、リージョンとサブスクリプション間で仮想ネットワークを接続する方法を知っている必要があります。

## <a name="what-is-a-vpn-gateway"></a>VPN ゲートウェイとは何ですか。

Azure VPN ゲートウェイでは、インターネット経由でオンプレミスの場所から Azure への着信暗号化された接続のエンドポイントを提供します。 送信できますマイクロソフトの専用ネットワーク経由で Azure の仮想ネットワーク間で暗号化されたトラフィックの Azure データ センターをリンクする別のリージョンで。 この構成を使用すると、異なるリージョンの仮想マシンとサービスを安全にリンクできます。

各仮想ネットワークには VPN ゲートウェイを 1 つだけ作成できます。 その VPN ゲートウェイへのすべての接続は、使用可能なネットワーク帯域幅を共有します。

各仮想ネットワーク ゲートウェイは 2 つ以上の仮想マシン (Vm) があります。 これらの VM は、自身で指定する _ゲートウェイ サブネット_ という特別なサブネットにデプロイされています。 これらには、特定のゲートウェイ サービスと共に、他のネットワークに接続するためのルーティング テーブルが含まれます。 これらの VM とゲートウェイ サブネットは、強化されたネットワーク デバイスに似ています。 これらの VM を直接構成する必要はありませんし、ゲートウェイ サブネットに追加リソースをデプロイする必要はありません。

仮想ネットワーク ゲートウェイの作成は完了までに時間がかかる場合があるため、適切な計画を立てることが不可欠です。 仮想ネットワーク ゲートウェイを作成すると、プロビジョニング プロセスによってゲートウェイの VM が生成され、それがゲートウェイ サブネットにデプロイされます。 これらの VM では、ゲートウェイで構成した設定が使用されます。

重要な設定は **_ゲートウェイの種類_** です。VPN ゲートウェイの場合、この種類は "vpn" となります。 VPN ゲートウェイのオプションには以下が含まれます。

- IPSEC/IKE VPN トンネル、他の VPN ゲートウェイへの VPN ゲートウェイをリンク経由でネットワークへのネットワーク接続。

- クロスプレミス IPsec/IKE VPN トンネリング。専用の VPN デバイスを通じてオンプレミス ネットワークを Azure と接続し、サイト間接続を作成します。

- Over IKEv2 または SSTP、クライアント コンピューターを Azure のリソースにリンクするポイント対サイト接続します。

ここで、VPN ゲートウェイを計画するために考慮する必要がある要素を見てみましょう。

## <a name="plan-a-vpn-gateway"></a>VPN ゲートウェイを計画します。

VPN ゲートウェイを計画するときは、考慮すべき 3 つのアーキテクチャがあります。

- インターネット経由でのポイント対サイト
- インターネット経由でのサイト間
- 専用ネットワーク経由でのサイト間 (Azure ExpressRoute など)

### <a name="planning-factors"></a>要素の計画

計画プロセスの間で検討する必要がある要素には、以下が含まれます。

- スループット - Mbps または Gbps
- バックボーン - インターネットかプライベートか
- パブリック (静的) IP アドレスの可用性
- VPN デバイスの互換性
- 複数のクライアント接続か、またはサイト間のリンクか
- VPN ゲートウェイの種類
- Azure VPN Gateway の SKU

計画に関するこれらの問題の一部をまとめたものを、次の表に示します。 残りの部分については後ほど説明します。

|                           |  ポイント対サイト            | サイトのサイト                          |  ExpressRoute                 |
| -------------             | -------------             | -------------                         | ---------                     |
| Azure でサポートされるサービス  | クラウド サービスと VM    | クラウド サービスと VM                | サポートされているすべてのサービス        |
| 一般的な帯域幅         | VPN ゲートウェイ SKU によって異なります    | 集計を含む最大 1 Gbps         | 50 Mbps から 10 Gbps       |
| サポート対象プロトコル       | IPsec と SSTP            | IPsec                                 | 直接接続、VLAN      |
| ルーティング                   | RouteBased (動的)      | PolicyBased (静的) および RouteBased   | BGP                           |
| 接続の回復性     | アクティブ/パッシブ            | アクティブ/パッシブまたはアクティブ/アクティブ       | アクティブ/アクティブ                 |
| ユース ケース                  | テストとプロトタイプ作成   | 開発、テスト、小規模の運用  | エンタープライズ/ミッション クリティカル   |

### <a name="gateway-skus"></a>ゲートウェイの SKU

Azure には、ゲートウェイ サービス用に次の SKU が用意されています。

| SKU              |  S2S/ネットワークのトンネル | P2S 接続  |  合計スループット ベンチマーク   | 用途                         |
| -------------    | -------------             | -------------    | ---------                         | ---------                       |
| Basic            | 最大 10                    | 最大 128          | 100 Mbps                          | 開発/テスト/POC                    |
| VpnGw1           | 最大 30                    | 最大 128          | 650 Mbps                          | 実稼働/クリティカルなワークロード   |
| VpnGw2           | 最大 30                    | 最大 128          | 1 Gbps                            | 実稼働/クリティカルなワークロード   |
| VpnGw3           | 最大 30                    | 最大 128          | 1.25 Gbps                          | 実稼働/クリティカルなワークロード   |

> [!Note]
> 適切な SKU を選択することが重要です。 間違った使用して、VPN gateway を設定した場合、それを停止して、ゲートウェイは、時間がかかることができますを再構築する必要があります。

## <a name="workflow"></a>ワークフロー

Azure での仮想プライベート ネットワークを使用するクラウド接続の計画を立てるときは、次のワークフローを適用する必要があります。

1. 接続するすべてのネットワークのアドレス空間をリストする、接続トポロジを設計します。

1. Azure 仮想ネットワークを作成します。

1. 仮想ネットワークの VPN ゲートウェイを作成します。

1. 必要に応じて、オンプレミス ネットワークやその他の仮想ネットワークへの接続を作成および構成します。

1. 必要に応じて、作成し、Azure VPN ゲートウェイのポイント対サイト接続を構成します。

### <a name="design-considerations"></a>設計上の考慮事項

仮想ネットワークに接続する VPN ゲートウェイを設計するときは、次の要素を考慮する必要があります。

- サブネットが重複することはできません。

    1 つの場所内のサブネットに別の場所のように同じアドレス空間が含まれていないことが重要です。

- IP アドレスは一意である必要があります。

    これら 2 つのホスト間でトラフィックをルーティングすることはできませんし、ネットワークへのネットワーク接続は失敗、異なる場所に同じ IP アドレスを持つ 2 つのホストを含めることはできません。

- VPN ゲートウェイと呼ばれる、ゲートウェイ サブネットは必要**GatewaySubnet**

    この名前にするのには、ゲートウェイが必要し、その他のリソースを含めることはできません。

### <a name="create-an-azure-virtual-network"></a>Azure の仮想ネットワークを作成する

VPN ゲートウェイを作成する前に、Azure の仮想ネットワークを作成する必要があります。

### <a name="create-a-vpn-gateway"></a>VPN ゲートウェイの作成

作成する VPN ゲートウェイの種類は、アーキテクチャによって異なります。 オプションは次のとおりです。

- RouteBased

    ルート ベース VPN デバイスでは、-任意 (ワイルドカード) のトラフィック セレクターを使用し、別の IPsec トンネルへ直接トラフィックをルーティング/転送テーブルを使用します。 ルート ベースの接続は、通常、それぞれの IPsec トンネルがネットワーク インターフェイスまたは VTI (仮想トンネル インターフェイス) としてモデル化されるルーターのプラットフォームに基づいて構築されます。

- PolicyBased

    ポリシー ベース VPN デバイスでは、両方のネットワークからプレフィクスの組み合わせを使用して、トラフィックは IPsec トンネルを介して暗号化/暗号化解除する方法を定義します。 ポリシー ベースの接続は、通常、パケット フィルタリングを実行するファイアウォール デバイスに基づいて構築されます。 IPsec トンネルの暗号化と復号化は、パケット フィルタリングと処理エンジンに追加されます。

## <a name="set-up-a-vpn-gateway"></a>VPN ゲートウェイを設定します。

実行する必要がある手順は、インストールする VPN ゲートウェイの種類によって異なります。 たとえば、Azure portal を使用してポイント対サイト VPN ゲートウェイを作成するには、次の手順を実行するは。

1. 仮想ネットワークの作成

2. ゲートウェイ サブネットの追加

3. DNS サーバーの指定 (省略可能)

4. 仮想ネットワーク ゲートウェイの作成

5. 証明書の生成

6. クライアント アドレス プールの追加

7. トンネルの種類を構成します。

8. 認証の種類を構成します。

9. ルート証明書の公開証明書データのアップロード

10. エクスポートしたクライアント証明書のインストール

11. VPN クライアント構成パッケージの生成とインストール

12. Azure への接続

いくつかの構成パスで複数のオプションでは、各 Azure VPN ゲートウェイでは、このコースですべてのセットアップをカバーすることはできません。 詳細については、その他のリソースに関するセクションをご覧ください。

## <a name="configure-the-gateway"></a>ゲートウェイの構成

ゲートウェイを作成したら、それを構成する必要があります。  これは、いくつかの構成設定 (名前、場所、DNS サーバーなど) を指定する必要があります。演習では、これらについて詳しく説明します。

## <a name="summary"></a>まとめ

Azure VPN ゲートウェイは、ポイント対サイト、サイト対サイトを有効にする Azure の仮想ネットワークまたはネットワークへのネットワーク接続のコンポーネントです。 Azure VPN ゲートウェイには、Azure のリソースへの接続を Azure にオンプレミスのネットワークを拡張または異なるリージョン内の仮想ネットワークとサブスクリプション間の接続を容易にするために個々 のクライアント コンピューターが有効にします。
