<span data-ttu-id="29de8-101">今日のアプリケーションで最もよく見られるセキュリティ上の弱点は､外部ソースから受信した入力､特に_ユーザー入力_を正しく処理しないことです｡</span><span class="sxs-lookup"><span data-stu-id="29de8-101">The most prevalent security weakness of applications today is to not correctly process input received from external sources, particularly _user input_.</span></span> <span data-ttu-id="29de8-102">どのような入力であれ、必ず詳細に調べて､使用する前に必ず妥当であることを検証するようにしてください｡</span><span class="sxs-lookup"><span data-stu-id="29de8-102">You should always take a close look at any input to make sure it has been validated before it is used.</span></span> <span data-ttu-id="29de8-103">この検証を怠ると､データの損失や暴露､特権のエスカレーション､さらには他のユーザーのコンピューター上の悪意のあるコードの実行まで起きることがあります｡</span><span class="sxs-lookup"><span data-stu-id="29de8-103">Failing to do this can result in data loss or exposure, escalation of privilege, or even execution of malicious code on other users' computers!</span></span>

<span data-ttu-id="29de8-104">悲劇的なことは､これが解決の容易な問題であるという点です｡</span><span class="sxs-lookup"><span data-stu-id="29de8-104">The tragic thing is that this is an easy problem to solve.</span></span> <span data-ttu-id="29de8-105">ここでは､受信時､画面への表示時､または保存時のデータの処理方法を取り上げます｡</span><span class="sxs-lookup"><span data-stu-id="29de8-105">Here we will cover how to treat data; when it’s received, when it’s displayed on the screen, and when it's stored for later use.</span></span>

## <a name="why-do-we-need-to-validate-our-input"></a><span data-ttu-id="29de8-106">なぜ私たちは入力を検証する必要があるのでしょうか。</span><span class="sxs-lookup"><span data-stu-id="29de8-106">Why do we need to validate our input?</span></span>

<span data-ttu-id="29de8-107">Web サイトでアカウントを作成できるようにするインターフェイスを構築しているときのことを考えてみてください。</span><span class="sxs-lookup"><span data-stu-id="29de8-107">Imagine that you are building an interface to allow a user to create an account on your website.</span></span> <span data-ttu-id="29de8-108">プロファイル データには、サイトにアクセスするユーザーの誰にも表示する名前、電子メール、ニックネームが含まれます。</span><span class="sxs-lookup"><span data-stu-id="29de8-108">Our profile data includes a name, email, and a nickname that we will display to everyone who visits the site.</span></span> <span data-ttu-id="29de8-109">新しいユーザーがプロファイルを作成し、SQL コマンドを含むニックネームを入力したら､どうでしょう｡</span><span class="sxs-lookup"><span data-stu-id="29de8-109">What if a new user creates a profile and enters a nickname that includes some SQL commands?</span></span> <span data-ttu-id="29de8-110">例えば､不正なユーザーが次のように入力したら｡</span><span class="sxs-lookup"><span data-stu-id="29de8-110">For example - what if our bad user enters something like:</span></span>

```output
Eve'); DROP TABLE Users;--
```

<span data-ttu-id="29de8-111">この値がデータベースに挿入すると､絶対に実行したくないコマンドを実行するように SQL ステートメントが改変される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="29de8-111">If we just blindly insert this value into a database, it could potentially alter the SQL statement to execute commands we absolutely don't want to run!</span></span> <span data-ttu-id="29de8-112">これは、「SQL インジェクション」攻撃と呼ばれ､正しく入力を処理しなかったときに発生する可能性がある_数多くある_悪用の 1つです｡</span><span class="sxs-lookup"><span data-stu-id="29de8-112">This is referred to as a "SQL Injection" attack and is one of the _many_ types of exploits that can potentially be done when you don't properly handle inputs.</span></span> <span data-ttu-id="29de8-113">この問題を解決するためには､何をすればよいのでしょうか｡</span><span class="sxs-lookup"><span data-stu-id="29de8-113">So, what can we do to fix this?</span></span> <span data-ttu-id="29de8-114">このユニットでは、こうした悪用に対処するために入力をサニタイズするタイミングと出力のエンコード方法、パラメーター化クエリを作成する方法を学びます｡</span><span class="sxs-lookup"><span data-stu-id="29de8-114">This unit will teach you when to sanitize input, how to encode output, and how to create parameterized queries (which solves the above exploit!).</span></span> <span data-ttu-id="29de8-115">アプリケーションに入力される悪意のある入力に対する防御手法は大きく3つあります｡</span><span class="sxs-lookup"><span data-stu-id="29de8-115">These are the three main defense techniques against malicious input being entered into your applications.</span></span>

## <a name="when-do-i-need-to-validate-input"></a><span data-ttu-id="29de8-116">いつ入力を検証すればよいのでしょうか｡</span><span class="sxs-lookup"><span data-stu-id="29de8-116">When do I need to validate input?</span></span>

<span data-ttu-id="29de8-117">答えは_常に_です｡</span><span class="sxs-lookup"><span data-stu-id="29de8-117">The answer is _always_.</span></span> <span data-ttu-id="29de8-118">アプリケーションに対する**あらゆる**入力を検証する必要があります。</span><span class="sxs-lookup"><span data-stu-id="29de8-118">You must validate **every** input for your application.</span></span> <span data-ttu-id="29de8-119">これには、URLのパラメータ､ユーザーからの入力､データベースからのデータ、API からのデータ､その他､ユーザーが操作できる可能性があるクリアーな形式で渡されるあらゆるものが含まれます｡</span><span class="sxs-lookup"><span data-stu-id="29de8-119">This includes parameters in the URL, input from the user, data from the database, data from an API and anything that is passed in the clear that a user could potentially manipulate.</span></span> <span data-ttu-id="29de8-120">必ずブラックリストではなく､ホワイトリスト方式を採用してください｡このことは､｢問題がないことが既知｣の入力だけを受け付けることを意味します｡ブラックリスト方式では､不正な入力だけに注目することになり､危険性がある入力を完全に網羅することこは不可能なためです｡</span><span class="sxs-lookup"><span data-stu-id="29de8-120">Always use a whitelist approach, which means you only accept "known good" input, instead of a blacklist (where you specifically look for bad input) because it's impossible to think of a complete list of potentially dangerous input.</span></span>  <span data-ttu-id="29de8-121">この防御策が回避できないよう､この作業はクライアント側ではなく､サーバー側で行ってください (両方で行ってもよい)｡</span><span class="sxs-lookup"><span data-stu-id="29de8-121">Do this work on the server, not the client-side (or in addition to the client-side), to ensure that your defenses cannot be circumvented.</span></span> <span data-ttu-id="29de8-122">**あらゆる**データを信頼できないデータとみなしてください｡そうすることで､Web アプリでよくある脆弱性の大半から身を守ることができます｡</span><span class="sxs-lookup"><span data-stu-id="29de8-122">Treat **ALL** data as untrusted and you will protect yourself from most of the common web app vulnerabilities.</span></span>

<span data-ttu-id="29de8-123">ASP.NET を使用している場合、そのフレームワークには､クライアントとサーバーの双方で[入力を検証するための優れたサポート](https://docs.microsoft.com/aspnet/web-pages/overview/ui-layouts-and-themes/validating-user-input-in-aspnet-web-pages-sites)が用意されています｡</span><span class="sxs-lookup"><span data-stu-id="29de8-123">If you are using ASP.NET, the framework provides [great support for validating input](https://docs.microsoft.com/aspnet/web-pages/overview/ui-layouts-and-themes/validating-user-input-in-aspnet-web-pages-sites) on both the client and server side.</span></span>

<span data-ttu-id="29de8-124">別の Web フレームワークを使用している場合は、[OWASP Input Validation Cheatsheet](https://www.owasp.org/index.php/Input_Validation_Cheat_Sheet)に入力を検証するために素晴らしいテクニックがいくつか用意されています｡</span><span class="sxs-lookup"><span data-stu-id="29de8-124">If you are using another web framework, there are some great techniques for doing input validation available on the [OWASP Input Validation Cheatsheet](https://www.owasp.org/index.php/Input_Validation_Cheat_Sheet).</span></span>


## <a name="always-use-parameterized-queries"></a><span data-ttu-id="29de8-125">つねにパラメーター化クエリを利用する</span><span class="sxs-lookup"><span data-stu-id="29de8-125">Always use parameterized queries</span></span>

<span data-ttu-id="29de8-126">SQL データベースはデータの格納に広く利用されているデータベースです｡例えば私たちは､ SQL Server にプロファイル情報を格納することができます｡</span><span class="sxs-lookup"><span data-stu-id="29de8-126">SQL databases are commonly used to store data - we might be storing our profile information in SQL Server for example.</span></span>  <span data-ttu-id="29de8-127">コードに大急ぎでインライン SQL やその他データベース クエリを作成して､そのままデータベースに送信しないでください｡すでに目にしたように､これは災厄の処方箋になります｡</span><span class="sxs-lookup"><span data-stu-id="29de8-127">Never create inline SQL or other database queries "on the fly" in your code and send it directly to the database, this is a recipe for disaster, as we saw above.</span></span>

<span data-ttu-id="29de8-128">たとえば、**以下を行わないでください** (インライン SQL と呼ばれる)。</span><span class="sxs-lookup"><span data-stu-id="29de8-128">For example, **do not do this** (known as inline SQL):</span></span>

```csharp
string userName = ... // receive input from the user BEWARE!
...
string query = "SELECT *  FROM  [dbo].[users] WHERE userName = '" + userName + "'";
```

<span data-ttu-id="29de8-129">ここでは、テキスト文字列を連結して､クエリを作成しています｡ユーザーから入力を受け取り､ユーザーを検索する動的な SQL クエリを生成します。</span><span class="sxs-lookup"><span data-stu-id="29de8-129">Here we concatenate text strings together to create the query, taking the input from the user and generating a dynamic SQL query to lookup the user.</span></span> <span data-ttu-id="29de8-130">ここでも、悪意のあるユーザーがこれを行っていることに気付いた場合、あるいは脆弱性があるかどうか見るためにいくつかの入力を_試し_ただけでも､大きな災厄になる可能性があります｡</span><span class="sxs-lookup"><span data-stu-id="29de8-130">Again, if an evil user realized we were doing this, or just _tried_ different input styles to see if there was a vulnerability, we could end up with a major disaster.</span></span> <span data-ttu-id="29de8-131">そうではなく、パラメーター化 SQL ステートメントを利用することを優先してください｡もっと良いのは､ストアド プロシージャを利用することです。</span><span class="sxs-lookup"><span data-stu-id="29de8-131">Instead, prefer to use parameterized SQL statements, or even better - stored procedures:</span></span>

```sql
-- Lookup a user
CREATE PROCEDURE sp_findUser
(
@UserName varchar(50)
)

SELECT *  FROM  [dbo].[users] WHERE userName = @UserName
```

<span data-ttu-id="29de8-132">そうすれば､コードからそのプロシージャを安全に呼び出し､ SQL ステートメントの一部として扱われることを心配せずに `userName` の文字列を渡すことができます。</span><span class="sxs-lookup"><span data-stu-id="29de8-132">Then you can invoke the procedure from your code safely, passing it the `userName` string without worrying about it being treated as part of the SQL statement.</span></span>

## <a name="always-encode-your-output"></a><span data-ttu-id="29de8-133">必ず出力をエンコードする</span><span class="sxs-lookup"><span data-stu-id="29de8-133">Always encode your output</span></span>

<span data-ttu-id="29de8-134">ビジュアルに､またはファイルで出力を提示する場合は､必ずエンコードして､エスケープしてください｡</span><span class="sxs-lookup"><span data-stu-id="29de8-134">Any output you present visually or in files should always be encoded and escaped.</span></span> <span data-ttu-id="29de8-135">そうすることで､サニタイズの過程で何かが失われても身を守ることができます｡さもないと､悪用される恐れがあるコードが誤って生成されてしまいます｡</span><span class="sxs-lookup"><span data-stu-id="29de8-135">This can protect you in case something was missed in the sanitization pass, or the code accidentally generates something that can be used maliciously.</span></span> <span data-ttu-id="29de8-136">そうすることで､あらゆるものが_出力_として表示され､実行すべきものとして解釈されることがなくなります｡</span><span class="sxs-lookup"><span data-stu-id="29de8-136">This will make sure that everything is displayed as _output_ and not inadvertently interpreted as something that should be executed.</span></span> <span data-ttu-id="29de8-137">これはまた別の非常に一般的な攻撃方法であり､「クロス サイト スクリプティング」(XSS) と呼ばれます｡</span><span class="sxs-lookup"><span data-stu-id="29de8-137">This is another very common attack technique referred to as "Cross-Site Scripting" (XSS).</span></span>

<span data-ttu-id="29de8-138">エンコードはそれほど一般的な要件であるため､ASP.NET が自動的に行ってくれるもう 1 つのことでもあります｡</span><span class="sxs-lookup"><span data-stu-id="29de8-138">Since this is such as common requirement, this is another areas where ASP.NET will do the work for you.</span></span> <span data-ttu-id="29de8-139">既定では、[あらゆる出力がすでにエンコードされています](https://docs.microsoft.com/en-us/aspnet/core/security/cross-site-scripting?view=aspnetcore-2.1)｡</span><span class="sxs-lookup"><span data-stu-id="29de8-139">By default, [all output is already encoded](https://docs.microsoft.com/en-us/aspnet/core/security/cross-site-scripting?view=aspnetcore-2.1).</span></span> <span data-ttu-id="29de8-140">別の web フレームワークを使用している場合は、[OWASP XSS Prevention Cheatsheet](https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet) で Web サイトでの出力エンコードに関するオプションを確認できます｡</span><span class="sxs-lookup"><span data-stu-id="29de8-140">If you are using another web framework, you can verify your options for output encoding on websites with the [OWASP XSS Prevention Cheatsheet](https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet).</span></span>

## <a name="summary"></a><span data-ttu-id="29de8-141">まとめ</span><span class="sxs-lookup"><span data-stu-id="29de8-141">Summary</span></span>

<span data-ttu-id="29de8-142">入力からの不要部分の削除と検証は、入力が有効であり､安全に使用、保存できることを確認するための必須要件です。</span><span class="sxs-lookup"><span data-stu-id="29de8-142">Santizing and validating your input is a necessary requirement to ensure your input is valid and safe to use and store.</span></span> <span data-ttu-id="29de8-143">最新の Web フレームワークには､この仕事の一部を自動化するための機能が組み込まれています｡必ず､ご利用のフレームワークのマニュアルを読んで､どんな機能があるのか確認してください｡</span><span class="sxs-lookup"><span data-stu-id="29de8-143">Most modern web frameworks offer built-in features which can automate some of this work - make sure to check your preferred framework's documentation and see what features it offers.</span></span> <span data-ttu-id="29de8-144">また、このことが最もよく起きえる場所は web アプリケーションですが､他のタイプのアプリケーションにも同様の問題がある可能性があることを忘れないでください｡ですから､素晴らしいデスクトップ アプリを作成しているとしても､安全だとは思わないでください｡</span><span class="sxs-lookup"><span data-stu-id="29de8-144">Also, keep in mind that while the most common place this occurs is in web applications, other types of applications can have similar issues - so don't think you're safe if you are writing that cool desktop app!</span></span> <span data-ttu-id="29de8-145">アプリを使用してデータが破壊されたり､会社の評判が落とされたりすることのないよう､いつでもユーザーの入力を適切に処理する必要があります。</span><span class="sxs-lookup"><span data-stu-id="29de8-145">You still need to properly handle user input to ensure someone doesn't use your app to corrupt your data, or damage your company's reputation.</span></span>


## <a name="knowledge-check"></a><span data-ttu-id="29de8-146">知識チェック</span><span class="sxs-lookup"><span data-stu-id="29de8-146">Knowledge Check</span></span>

<span data-ttu-id="29de8-147">サニタイズの必要があるデータ ソースは次のどれでしょうか｡</span><span class="sxs-lookup"><span data-stu-id="29de8-147">Which of the following data sources need to be sanitized?</span></span>
* <span data-ttu-id="29de8-148">他社製 API からのデータ</span><span class="sxs-lookup"><span data-stu-id="29de8-148">Data from a 3rd party API</span></span>
* <span data-ttu-id="29de8-149">URL パラメーターからのデータ</span><span class="sxs-lookup"><span data-stu-id="29de8-149">Data from the URL parameter</span></span>
* <span data-ttu-id="29de8-150">入力フィールドから収集されたユーザーのデータ</span><span class="sxs-lookup"><span data-stu-id="29de8-150">Data collected from the user via an input field</span></span>
* <span data-ttu-id="29de8-151">上記のすべて (正解)</span><span class="sxs-lookup"><span data-stu-id="29de8-151">All the above (correct answer)</span></span>

<span data-ttu-id="29de8-152">出力をエンコードする必要があるデータは次のどれでしょうか｡</span><span class="sxs-lookup"><span data-stu-id="29de8-152">Which of the following data needs to be output encoded?</span></span>
* <span data-ttu-id="29de8-153">データベースに保存するデータ</span><span class="sxs-lookup"><span data-stu-id="29de8-153">Data saved to the database</span></span>
* <span data-ttu-id="29de8-154">画面に出力する日付 (正解)</span><span class="sxs-lookup"><span data-stu-id="29de8-154">Date to be output to the screen (correct answer)</span></span>
* <span data-ttu-id="29de8-155">他社製 API に送信するデータ</span><span class="sxs-lookup"><span data-stu-id="29de8-155">Data sent to a 3rd party API</span></span>
* <span data-ttu-id="29de8-156">URL パラメーターのデータ</span><span class="sxs-lookup"><span data-stu-id="29de8-156">Data in the URL parameters</span></span>

<span data-ttu-id="29de8-157">パラメーター化クエリ (SQL ではストアド プロシージャ) は、以下の理由からいつでもデータベースと通信するためのより安全な選択肢である｡</span><span class="sxs-lookup"><span data-stu-id="29de8-157">Parameterized queries (stored procedures in SQL) are always a more secure choice for talking to the database because:</span></span>
* <span data-ttu-id="29de8-158">インライン データベース コマンドよりも体系的であり､このためユーザーの混乱が少ない｡</span><span class="sxs-lookup"><span data-stu-id="29de8-158">They are more organized than inline database commands, and therefore less confusing for users.</span></span>
* <span data-ttu-id="29de8-159">ストアド プロシージャにはスクリプトの明確なアウトラインがあり､可視性に優れている｡</span><span class="sxs-lookup"><span data-stu-id="29de8-159">There is a clear outline of the script in the stored procedure, ensuring better visibility.</span></span>
* <span data-ttu-id="29de8-160">ハッカーは SQL プログラミングを理解していない｡</span><span class="sxs-lookup"><span data-stu-id="29de8-160">Hackers don’t understand how to program in SQL.</span></span>
* <span data-ttu-id="29de8-161">パラメーター化クエリでは、クエリの実行前に変数が置き換えられる｡これは､変数の代わりにコードを送信する機会がなくなることを意味する｡</span><span class="sxs-lookup"><span data-stu-id="29de8-161">Parameterized queries substitute variables before running queries, meaning it avoids the opportunity for code to be submitted in place of a variable.</span></span> <span data-ttu-id="29de8-162">(正解)</span><span class="sxs-lookup"><span data-stu-id="29de8-162">(correct answer)</span></span>
