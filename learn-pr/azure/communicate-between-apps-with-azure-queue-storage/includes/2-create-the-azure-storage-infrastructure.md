<span data-ttu-id="4ffda-101">ネットワーク帯域幅が狭いときや需要が高いときに中断する可能性があるため、分散アプリケーションのコンポーネント間の直接通信には問題があります。</span><span class="sxs-lookup"><span data-stu-id="4ffda-101">Direct communication between the components of a distributed application can be problematic because it might be disrupted when network bandwidth is low or when demand is high.</span></span>

<span data-ttu-id="4ffda-102">この問題は演習のシステムに見られます。Web ポータルから Web サービスが呼び出されるシステムです。サービスが適時に応答している場合は問題ありません。</span><span class="sxs-lookup"><span data-stu-id="4ffda-102">We've seen this in our system: the web portal calls a web service, which works great if the service responds in a timely manner.</span></span> <span data-ttu-id="4ffda-103">トラフィックが増えると問題が発生するため、キューを使用してフロントエンド アプリと中間層の Web サービス間の直接リンクを排除することを計画します。</span><span class="sxs-lookup"><span data-stu-id="4ffda-103">High traffic causes problems and so the plan is to use a queue to eliminate the direct link between the front-end apps and your middle-tier web service.</span></span>

## <a name="what-is-azure-queue-storage"></a><span data-ttu-id="4ffda-104">Azure Queue Storage とは</span><span class="sxs-lookup"><span data-stu-id="4ffda-104">What is Azure Queue storage?</span></span>

<span data-ttu-id="4ffda-105">Azure Queue Storage は、クラウドベースのキューを実装する Azure サービスです。</span><span class="sxs-lookup"><span data-stu-id="4ffda-105">Azure Queue storage is an Azure service that implements cloud-based queues.</span></span> <span data-ttu-id="4ffda-106">各キューにはメッセージの一覧が保持されています。</span><span class="sxs-lookup"><span data-stu-id="4ffda-106">Each queue maintains a list of messages.</span></span> <span data-ttu-id="4ffda-107">アプリケーション コンポーネントは、REST API または Azure が提供するクライアント ライブラリを使用してキューにアクセスします。</span><span class="sxs-lookup"><span data-stu-id="4ffda-107">Application components access a queue using a REST API or an Azure-supplied client library.</span></span> <span data-ttu-id="4ffda-108">通常、1 つ以上の_送信側_コンポーネントと 1 つ以上の_受信側_コンポーネントがあります。</span><span class="sxs-lookup"><span data-stu-id="4ffda-108">Typically, you will have one or more _sender_ components and one or more _receiver_ components.</span></span> <span data-ttu-id="4ffda-109">送信側コンポーネントは、メッセージをキューに追加します。</span><span class="sxs-lookup"><span data-stu-id="4ffda-109">Sender components add messages to the queue.</span></span> <span data-ttu-id="4ffda-110">受信側コンポーネントは、キューの先頭から処理対象のメッセージを取得します。</span><span class="sxs-lookup"><span data-stu-id="4ffda-110">Receiver components retrieve messages from the front of the queue for processing.</span></span> <span data-ttu-id="4ffda-111">次の図は、メッセージを Azure Queue に追加する複数の送信側アプリケーションと、メッセージを取得する 1 つの受信側アプリケーションを示しています。</span><span class="sxs-lookup"><span data-stu-id="4ffda-111">The following illustration shows multiple sender applications adding messages to the Azure Queue and one receiver application retrieving the messages.</span></span>

![Azure Queue Storage のアーキテクチャを示す概要図](../media/2-queue-overview.png)

<span data-ttu-id="4ffda-113">価格は、キュー サイズと操作数に基づいています。</span><span class="sxs-lookup"><span data-stu-id="4ffda-113">Pricing is based on queue size and number of operations.</span></span> <span data-ttu-id="4ffda-114">大きいメッセージ キューの方が小さいキューよりもコストが高くなります。</span><span class="sxs-lookup"><span data-stu-id="4ffda-114">Larger message queues cost more than smaller queues.</span></span> <span data-ttu-id="4ffda-115">また、メッセージの追加やメッセージの削除などの操作ごとに料金が発生します。</span><span class="sxs-lookup"><span data-stu-id="4ffda-115">Charges are also incurred for each operation, such as adding a message and deleting a message.</span></span> <span data-ttu-id="4ffda-116">価格の詳細については、[Azure Queue Storage の価格](https://azure.microsoft.com/pricing/details/storage/queues/)に関するページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="4ffda-116">For pricing details, see [Azure Queue storage pricing](https://azure.microsoft.com/pricing/details/storage/queues/).</span></span>

## <a name="why-use-queues"></a><span data-ttu-id="4ffda-117">キューを使用する理由</span><span class="sxs-lookup"><span data-stu-id="4ffda-117">Why use queues?</span></span>

<span data-ttu-id="4ffda-118">待機中のメッセージをキューに一時的に保存することで、回復性が高くなります。</span><span class="sxs-lookup"><span data-stu-id="4ffda-118">A queue increases resiliency by temporarily storing waiting messages.</span></span> <span data-ttu-id="4ffda-119">需要が低いときまたは通常のときは、宛先コンポーネントがキューからメッセージを削除する処理がメッセージがキューに追加される処理よりも速いので、キューのサイズは小さいままです。</span><span class="sxs-lookup"><span data-stu-id="4ffda-119">At times of low or normal demand, the size of the queue remains small because the destination component removes messages from the queue faster than they are added.</span></span> <span data-ttu-id="4ffda-120">需要が高いときは、キューのサイズが大きくなる可能性がありますが、メッセージは失われません。</span><span class="sxs-lookup"><span data-stu-id="4ffda-120">At times of high demand, the queue may increase in size, but messages are not lost.</span></span> <span data-ttu-id="4ffda-121">需要が正常に戻ると、宛先コンポーネントは処理に追いついて、キューを空にすることができます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-121">The destination component can catch up and empty the queue as demand returns to normal.</span></span>

<span data-ttu-id="4ffda-122">1 つのキューは最大で **500 TB** になる可能性があるため、_数百万個_単位のメッセージが格納される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="4ffda-122">A single queue can be up to **500 TB** in size, so it can potentially store _millions_ of messages.</span></span> <span data-ttu-id="4ffda-123">1 つのキューのターゲット スループットは 1 秒あたり 2,000 メッセージなので、大規模なシナリオを処理できます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-123">The target throughput for a single queue is 2000 messages per second, allowing it to handle high-volume scenarios.</span></span>

<span data-ttu-id="4ffda-124">キューを使用すると、需要の変化に合わせて自動的かつ即時にアプリケーションをスケーリングできます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-124">Queues let your application scale automatically and immediately when demand changes.</span></span> <span data-ttu-id="4ffda-125">そのため、失うと損害になる重大なビジネス データの場合に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-125">This makes them useful for critical business data that would be damaging to lose.</span></span> <span data-ttu-id="4ffda-126">Azure には、自動的にスケーリングするサービスが他にも多くあります。</span><span class="sxs-lookup"><span data-stu-id="4ffda-126">Azure offers many other services that scale automatically.</span></span> <span data-ttu-id="4ffda-127">たとえば、**自動スケール**機能は、Azure 仮想マシン スケール セット、クラウド サービス、Azure App Service プラン、App Service 環境で使用できます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-127">For example, the **Autoscale** feature is available on Azure virtual machine scale sets, cloud services, Azure App Service plans, and App Service environments.</span></span> <span data-ttu-id="4ffda-128">そのため、需要の高い期間を指定し、管理者の操作を介さずに自動的に容量を追加するように、Azure が使用するルールを定義できます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-128">This lets you define rules that Azure uses to identify periods of high demand and automatically add capacity without involving an administrator.</span></span> <span data-ttu-id="4ffda-129">自動スケーリングは需要にすぐに反応しますが、即時ではありません。</span><span class="sxs-lookup"><span data-stu-id="4ffda-129">Autoscaling responds to demand quickly, but not instantaneously.</span></span> <span data-ttu-id="4ffda-130">対照的に、Azure Queue Storage は、処理リソースを使用できるようになるまでメッセージを格納することで、高い需要を即時に処理します。</span><span class="sxs-lookup"><span data-stu-id="4ffda-130">By contrast, Azure Queue storage instantaneously handles high demand by storing messages until processing resources are available.</span></span>

## <a name="what-is-a-message"></a><span data-ttu-id="4ffda-131">メッセージとは</span><span class="sxs-lookup"><span data-stu-id="4ffda-131">What is a message?</span></span>

<span data-ttu-id="4ffda-132">キュー内のメッセージは、最大 64 KB のバイト配列です。</span><span class="sxs-lookup"><span data-stu-id="4ffda-132">A message in a queue is a byte array of up to 64 KB.</span></span> <span data-ttu-id="4ffda-133">メッセージ コンテンツはどの Azure コンポーネントでもまったく解釈されません。</span><span class="sxs-lookup"><span data-stu-id="4ffda-133">Message contents are not interpreted at all by any Azure component.</span></span>

<span data-ttu-id="4ffda-134">構造化メッセージを作成する場合は、XML または JSON を使用してメッセージ コンテンツの形式を設定できます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-134">If you want to create a structured message, you could format the message content using XML or JSON.</span></span> <span data-ttu-id="4ffda-135">カスタム形式の生成と解釈は、コード側の役割です。</span><span class="sxs-lookup"><span data-stu-id="4ffda-135">Your code is responsible for generating and interpreting your custom format.</span></span> <span data-ttu-id="4ffda-136">たとえば、次のようなカスタム JSON メッセージを作成できます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-136">For example, you could make a custom JSON message that looks like the following:</span></span>

```json
{
    "Message": {
        "To": "news@contoso.com",
        "From": "writer@contoso.com",
        "Subject": "Support request",
        "Body": "Send me a photographer!"
    }
}
```

## <a name="creating-a-storage-account"></a><span data-ttu-id="4ffda-137">ストレージ アカウントの作成</span><span class="sxs-lookup"><span data-stu-id="4ffda-137">Creating a storage account</span></span>

<span data-ttu-id="4ffda-138">キューはストレージ アカウントの一部である必要があります。</span><span class="sxs-lookup"><span data-stu-id="4ffda-138">A queue must be part of a storage account.</span></span> <span data-ttu-id="4ffda-139">Azure CLI (または PowerShell)、または Azure portal を使用してストレージ アカウントを作成できます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-139">You can create a storage account using the Azure CLI (or PowerShell), or Azure portal.</span></span> <span data-ttu-id="4ffda-140">すべての手順が案内され、各情報の入力が求められるので、ポータルが最も簡単です。</span><span class="sxs-lookup"><span data-stu-id="4ffda-140">The portal is easiest because it's all guided and prompts you for each piece of information.</span></span> 

<span data-ttu-id="4ffda-141">次のスクリーンショットは、ストレージ アカウント カテゴリの場所を示しています。</span><span class="sxs-lookup"><span data-stu-id="4ffda-141">The following screenshot shows the location of the Storage accounts category.</span></span>

![ストレージ アカウント カテゴリが強調表示されている [すべてのサービス] ブレードのスクリーンショット。](../media/2-create-storage-account-1.png)

<span data-ttu-id="4ffda-143">アカウントの作成時に指定できるオプションがいくつかありますが、そのほとんどは既定の選択を使用できます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-143">There are several options you can supply when you create the account, most of which you can use the default selection.</span></span> <span data-ttu-id="4ffda-144">前のモジュールではこれらのオプションについて説明しましたが、各オプションに関連付けられている `(i)` のヒントをポイントすると、その機能の概要が表示されます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-144">We covered these options in a previous module, but you can hover over the `(i)` tip associated with each option to get a reminder of what it does.</span></span> <span data-ttu-id="4ffda-145">次に、ポータル ブレードの入力例を示します。</span><span class="sxs-lookup"><span data-stu-id="4ffda-145">Here's an example of filling out the portal blade.</span></span>

<span data-ttu-id="4ffda-146">次のスクリーンショットは、[ストレージ アカウントの作成] ブレードとストレージ アカウントの作成に必要な情報を示します。</span><span class="sxs-lookup"><span data-stu-id="4ffda-146">The following screenshot displays the Create storage account blade and the information required to create a storage account.</span></span>

![ストレージ アカウントの作成時に指定するオプションを示す [ストレージ アカウントの作成] ブレードのスクリーンショット。](../media/2-create-storage-account-2.png)

### <a name="settings-for-queues"></a><span data-ttu-id="4ffda-148">キューの設定</span><span class="sxs-lookup"><span data-stu-id="4ffda-148">Settings for queues</span></span>
<span data-ttu-id="4ffda-149">キューを含むストレージ アカウントを作成するときは、次の設定を考慮する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4ffda-149">When you create a storage account that will contain queues, you should consider the following settings:</span></span>

- <span data-ttu-id="4ffda-150">キューは、Azure 汎用ストレージ アカウント (v1 または v2) の一部としてのみ利用できます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-150">Queues are only available as part of Azure general-purpose storage accounts (v1 or v2).</span></span> <span data-ttu-id="4ffda-151">BLOB ストレージ アカウントに追加することはできません。</span><span class="sxs-lookup"><span data-stu-id="4ffda-151">You cannot add them to Blob storage accounts.</span></span>
- <span data-ttu-id="4ffda-152">StorageV2 アカウントに対して表示される **[アクセス層]** 設定は、BLOB ストレージにのみ適用され、キューには影響しません。</span><span class="sxs-lookup"><span data-stu-id="4ffda-152">The **Access tier** setting which is shown for StorageV2 accounts applies only to Blob storage and does not affect queues.</span></span>
- <span data-ttu-id="4ffda-153">ソース コンポーネント、宛先コンポーネント、または (できれば) 両方のコンポーネントに近い場所を選択するようにします。</span><span class="sxs-lookup"><span data-stu-id="4ffda-153">You should choose a location that is close to either the source components or destination components or (preferably) both.</span></span>
- <span data-ttu-id="4ffda-154">データは常に複数のサーバーにレプリケートされるので、ディスク障害やその他のハードウェアの問題から保護されます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-154">Data is always replicated to multiple servers to guard against disk failures and other hardware problems.</span></span> <span data-ttu-id="4ffda-155">レプリケーション戦略には選択肢があります。**ローカル冗長ストレージ (LRS)** は低コストですが、データセンター全体に影響する災害に対しては脆弱です。一方、**geo 冗長ストレージ (GRS)** では、データが他の Azure データ センターにレプリケートされます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-155">You have a choice of replication strategies: **Locally Redundant Storage (LRS)** is low-cost but vulnerable to disasters that affect an entire data center while **Geo-Redundant Storage (GRS)** replicates data to other Azure data centers.</span></span> <span data-ttu-id="4ffda-156">実際の冗長性のニーズを満たすレプリケーション戦略を選択してください。</span><span class="sxs-lookup"><span data-stu-id="4ffda-156">Choose the replication strategy that meets your redundancy needs.</span></span>
- <span data-ttu-id="4ffda-157">パフォーマンス レベルによって、メッセージの保存方法が決まります。**Standard** の場合は磁気ドライブが使用されていますが**Premium** の場合はソリッドステート ドライブが使用されています。</span><span class="sxs-lookup"><span data-stu-id="4ffda-157">The performance tier determines how your message are stored: **Standard** uses magnetic drives while **Premium** uses solid-state drives.</span></span> <span data-ttu-id="4ffda-158">需要のピークが短いと予想される場合は、Standard を選択します。</span><span class="sxs-lookup"><span data-stu-id="4ffda-158">Choose Standard if you expect peaks in demand to be short.</span></span> <span data-ttu-id="4ffda-159">キューの長さが長くなり、メッセージにアクセスする時間を最小限に抑える必要がある場合は、Premium を検討します。</span><span class="sxs-lookup"><span data-stu-id="4ffda-159">Consider Premium if queue length sometimes becomes long and you need to minimize the time to access messages.</span></span>
- <span data-ttu-id="4ffda-160">機密情報がキューを経由する可能性がある場合は、安全な転送が必要です。</span><span class="sxs-lookup"><span data-stu-id="4ffda-160">Require secure transfer if sensitive information may pass through the queue.</span></span> <span data-ttu-id="4ffda-161">この設定により、キューへのすべての接続が Secure Sockets Layer (SSL) を使用して確実に暗号化されます。</span><span class="sxs-lookup"><span data-stu-id="4ffda-161">This setting ensures that all connections to the queue are encrypted using Secure Sockets Layer (SSL).</span></span>