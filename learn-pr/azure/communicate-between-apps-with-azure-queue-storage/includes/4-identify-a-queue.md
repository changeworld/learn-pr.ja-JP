ストレージ アカウントを作成したので、そのストレージに格納されるキューをどのように使用するかを見てみましょう。

キューにアクセスするには、3 つの情報が必要です。

 1. ストレージ アカウント名
 2. キュー名
 3. 承認トークン

この情報は、キューにアクセスする両方のアプリケーション (メッセージを追加する Web フロントエンドと、追加されたメッセージを処理する中間層) によって使用されます。

## <a name="queue-identity"></a>キュー ID

すべてのキューには、作成時に割り当てる名前があります。 名前は、ストレージ アカウント内で一意である必要があります。しかし、ストレージ アカウント名とは異なり、グローバルに一意である必要はありません。

ストレージ アカウント名とキュー名の組み合わせによってキューを一意に識別します。

## <a name="access-authorization"></a>アクセスの承認

キューに対するすべての要求は承認される必要があり、選択肢として複数のオプションがあります。

| 承認の種類 | 説明 |
|--------------------|-------------|
| **Azure Active Directory** | ロールベースの認証を使用し、AAD の資格情報に基づいて特定のクライアントを識別できます。 |
| **共有キー** | これはストレージ アカウントに関連付けられた、暗号化されたキー署名です。**アカウント キー**と呼ばれる場合もあります。 すべてのストレージ アカウントでは、これらのうち 2 つのキーを使用し、アクセスを認証するために各要求と共にキーを渡します。 このアプローチを使用することは、ルート パスワードを使用するのに似ています。ルート パスワードにより、ストレージ アカウントへの_フル アクセス_が提供されます。 |
| **共有アクセス署名** | 共有アクセス署名 (SAS) は、ストレージ アカウントでのオブジェクトに対する制限されたアクセスをクライアントに許可する、生成された URI です。 特定のリソース、アクセス許可、スコープへのアクセスをあるデータ範囲に制限し、一定期間後にアクセス権を自動的に無効にすることができます。  |

> [!NOTE]
> キューに関する作業を始める最もシンプルな方法であるため、ここではアカウント キー承認を使用します。ただし、運用アプリでは共有アクセス署名 (SAS) または Azure Active Directory (AAD) を使用することをお勧めします。

### <a name="retrieving-the-account-key"></a>アカウント キーの取得
 
アカウント キーは、Azure portal のご自分のストレージ アカウントの **[設定] > [アクセス キー]** セクションで確認できます。またはコマンド ラインを使用して取得できます。

```azurecli
az storage account keys list ...
```

```powershell
Get-AzureRmStorageAccountKey ...
```

## <a name="accessing-queues"></a>キューへのアクセス

REST API を使用してキューにアクセスします。 そのためには、ストレージ アカウントに指定した名前とドメイン `queue.core.windows.net` およびアクセスするキューへのパスを結合した URL を使用します。 たとえば、「`http://<storage account>.queue.core.windows.net/<queue name>`」のように入力します。 すべての要求に `Authorization` ヘッダーを含める必要があります。 値として 3 つの承認スタイルのうちどれでも設定できます。

### <a name="using-the-azure-storage-client-library-for-net"></a>.NET 用 Azure Storage クライアント ライブラリの使用

.NET 用 Azure Storage クライアント ライブラリは、Microsoft によって提供された、ユーザーに代わって REST 要求の作成と REST 応答の解析を行うライブラリです。 これにより、作成する必要があるコードの量が大幅に減少します。 クライアント ライブラリを使用したアクセスでも、同じ情報 (ストレージ アカウント名、キュー名、アカウント キー) が必要です。ただし、形式は異なります。

クライアント ライブラリでは、**接続文字列**を使用して接続を確立します。 接続文字列は、Azure portal のご自分のストレージ アカウントの **[設定]** セクションで確認するか、Azure CLI と PowerShell を使用して確認できます。

接続文字列は、ストレージ アカウント名とアカウント キーを結合した文字列で、ストレージ アカウントにアクセスするためにアプリケーションに知らされる必要があります。 形式は次のようになります。

```csharp
string connectionString = "DefaultEndpointsProtocol=https;AccountName=<your storage account name>;AccountKey=<your key>;EndpointSuffix=core.windows.net"
```

> [!WARNING]
> この接続文字列にアクセスできるユーザーはだれでもキューを操作できるため、この文字列の値は、安全な場所に格納する必要があります。

接続文字列にキュー名が含まれていないことに注意してください。 キュー名は、キューへの接続を確立するときにコードの中で指定されます。

Azure から接続文字列を取得し、それを使用するために新しいアプリケーションを設定しましょう。