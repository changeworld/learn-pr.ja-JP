<span data-ttu-id="6663c-101">Azure Cosmos DB により開発者は、整合性のレベルに応じて明確に定義された整合性モデルを 5 種類の中から選択することができます。具体的には、"強固"、"有界整合性制約"、"セッション"、"一貫性のあるプレフィックス"、"最終的" の 5 つが用意されています。</span><span class="sxs-lookup"><span data-stu-id="6663c-101">Azure Cosmos DB allows developers to choose between five well-defined consistency models along the consistency spectrum – strong, bounded staleness, session, consistent prefix, and eventual.</span></span> <span data-ttu-id="6663c-102">これらの整合性レベルを利用すると、ニーズに応じてデータベースの可用性とパフォーマンスを最大限に活用できます。</span><span class="sxs-lookup"><span data-stu-id="6663c-102">These consistency levels enable you to maximize the availability and performance of your database, depending on your needs.</span></span> <span data-ttu-id="6663c-103">特定の順序でデータを処理する必要がある場合なら、整合性に "強固" を選ぶことが適切かもしれません。</span><span class="sxs-lookup"><span data-stu-id="6663c-103">For cases when data must be processed in a specific order, strong consistency might be the right choice.</span></span> <span data-ttu-id="6663c-104">あるいは、データの一貫性が直ちに必要ではない場合なら、整合性に "最終的" を選ぶことが適切かもしれません。</span><span class="sxs-lookup"><span data-stu-id="6663c-104">Or for cases when data doesn't need to be immediately consistent, eventual consistency might be the right choice.</span></span> 

<span data-ttu-id="6663c-105">このユニットでは、Azure Cosmos DB で利用可能な整合性レベルについて理解し、オンラインの衣料品サイトに適切な整合性レベルを決定します。</span><span class="sxs-lookup"><span data-stu-id="6663c-105">In this unit, you'll familiarize yourself with the available consistency levels in Azure Cosmos DB and determine the correct consistency level for your online clothing site.</span></span>

## <a name="consistency-basics"></a><span data-ttu-id="6663c-106">整合性の基本</span><span class="sxs-lookup"><span data-stu-id="6663c-106">Consistency basics</span></span>

<span data-ttu-id="6663c-107">各データベース アカウントは既定の整合性レベルを備えています。これによって、アカウント内のデータの整合性が決定されます。</span><span class="sxs-lookup"><span data-stu-id="6663c-107">Each database account has a default consistency level, which determines the consistency of data within the account.</span></span> <span data-ttu-id="6663c-108">整合性レベルの一方の終端は、"強固" です。この整合性レベルでは、線形化可能性を提供し、読み取りに対して最新バージョンのアイテムを返すことが保証されています。</span><span class="sxs-lookup"><span data-stu-id="6663c-108">At one end of the spectrum is Strong consistency, which offers a linearizability guarantee with the reads guaranteed to return the most recent version of an item.</span></span> <span data-ttu-id="6663c-109">整合性レベルのもう一方の終端は、"最終的" です。この整合性レベルでは、長期間書き込みがない場合にグループ内のレプリカが最終的には収束することが保証されます。</span><span class="sxs-lookup"><span data-stu-id="6663c-109">At the other end of the spectrum is Eventual consistency, which guarantees that in absence of any further writes, the replicas within the group eventually converge.</span></span> <span data-ttu-id="6663c-110">中間の整合性レベルは "セッション" です。この整合性レベルでは、単調読み取り、単調書き込み、および自己の書き込みの読み取り (RYW) が保証されるため、最もよく使用されます。</span><span class="sxs-lookup"><span data-stu-id="6663c-110">In the middle is Session consistency, which is the most popular because it guarantees monotonic reads, monotonic writes, and read your own writes (RYW) guarantees.</span></span>

![Azure Cosmos DB の 5 つの整合性レベル](../media/5-change-consistency/five-consistency-levels.png)

<span data-ttu-id="6663c-112">各整合性レベルが保証する内容を次の表に示します。</span><span class="sxs-lookup"><span data-stu-id="6663c-112">Guarantees about each consistency level are listed in the following table.</span></span>
 
<span data-ttu-id="6663c-113">**整合性レベルと保証内容**</span><span class="sxs-lookup"><span data-stu-id="6663c-113">**Consistency levels and guarantees**</span></span>

| <span data-ttu-id="6663c-114">整合性レベル</span><span class="sxs-lookup"><span data-stu-id="6663c-114">Consistency Level</span></span> | <span data-ttu-id="6663c-115">保証内容</span><span class="sxs-lookup"><span data-stu-id="6663c-115">Guarantees</span></span> |
| --- | --- |
| <span data-ttu-id="6663c-116">強固</span><span class="sxs-lookup"><span data-stu-id="6663c-116">Strong</span></span> | <span data-ttu-id="6663c-117">線形化可能性。</span><span class="sxs-lookup"><span data-stu-id="6663c-117">Linearizability.</span></span> <span data-ttu-id="6663c-118">読み取りでは、項目の最新バージョンを返すことが保証されます。</span><span class="sxs-lookup"><span data-stu-id="6663c-118">Reads are guaranteed to return the most recent version of an item.</span></span>|
| <span data-ttu-id="6663c-119">有界整合性制約</span><span class="sxs-lookup"><span data-stu-id="6663c-119">Bounded Staleness</span></span> | <span data-ttu-id="6663c-120">一貫性のあるプレフィックス。</span><span class="sxs-lookup"><span data-stu-id="6663c-120">Consistent Prefix.</span></span> <span data-ttu-id="6663c-121">書き込みに対して読み取りが、最大でプレフィックス k または間隔 t だけ遅延します。</span><span class="sxs-lookup"><span data-stu-id="6663c-121">Reads lag behind writes by at most k prefixes or t interval.</span></span> |
| <span data-ttu-id="6663c-122">セッション</span><span class="sxs-lookup"><span data-stu-id="6663c-122">Session</span></span>   | <span data-ttu-id="6663c-123">一貫性のあるプレフィックス。</span><span class="sxs-lookup"><span data-stu-id="6663c-123">Consistent Prefix.</span></span> <span data-ttu-id="6663c-124">単調読み取り、単調書き込み、自己の書き込みの読み取り、読み取り後の書き込み。</span><span class="sxs-lookup"><span data-stu-id="6663c-124">Monotonic reads, monotonic writes, read-your-writes, write-follows-reads.</span></span> |
| <span data-ttu-id="6663c-125">一貫性のあるプレフィックス</span><span class="sxs-lookup"><span data-stu-id="6663c-125">Consistent Prefix</span></span> | <span data-ttu-id="6663c-126">返される更新が、それ以外の全更新の一部のプレフィックスとなります (ギャップなし)。</span><span class="sxs-lookup"><span data-stu-id="6663c-126">Updates returned are some prefix of all the updates, with no gaps.</span></span> |
| <span data-ttu-id="6663c-127">最終的</span><span class="sxs-lookup"><span data-stu-id="6663c-127">Eventual</span></span>  | <span data-ttu-id="6663c-128">読み取りは順不同です。</span><span class="sxs-lookup"><span data-stu-id="6663c-128">Out of order reads.</span></span> |

<span data-ttu-id="6663c-129">Azure portal で、お使いの Azure Cosmos DB アカウントでの既定の整合性レベルを構成できます (さらに、後から特定の読み取り要求で既定の整合性を上書きすることもできます)。</span><span class="sxs-lookup"><span data-stu-id="6663c-129">You can configure the default consistency level on your Azure Cosmos DB account (and later override the consistency on a specific read request) in the Azure portal.</span></span> <span data-ttu-id="6663c-130">内部的には、複数のリージョンにまたがる可能性があるパーティション セット内のデータに対して、既定の整合性レベルが適用されます。</span><span class="sxs-lookup"><span data-stu-id="6663c-130">Internally, the default consistency level applies to data within the partition sets, which may span regions.</span></span>

<span data-ttu-id="6663c-131">Azure Cosmos DB では、整合性が "セッション"、"一貫性のあるプレフィックス"、"最終的" の場合の読み取りは、整合性が "強固" または "有界整合性制約" の場合の読み取りよりも、要求単位での消費量を 2 倍節約できます。</span><span class="sxs-lookup"><span data-stu-id="6663c-131">In Azure Cosmos DB, reads served at session, consistent prefix and eventual consistency are twice as cheap, in terms of request unit consumption, as reads with strong or bounded staleness consistency.</span></span>

### <a name="use-of-consistency-levels"></a><span data-ttu-id="6663c-132">整合性レベルの使用</span><span class="sxs-lookup"><span data-stu-id="6663c-132">Use of consistency levels</span></span>

<span data-ttu-id="6663c-133">Azure Cosmos DB テナントの約 73% が "セッション" 整合性を使い、20% が "有界整合性制約" を使っています。</span><span class="sxs-lookup"><span data-stu-id="6663c-133">About 73% of Azure Cosmos DB tenants use session consistency and 20% prefer bounded staleness.</span></span> <span data-ttu-id="6663c-134">Azure Cosmos DB の顧客の約 3% が、アプリケーション用に特定の一貫性の設定を選ぶ前に、さまざまな一貫性レベルを試しています。</span><span class="sxs-lookup"><span data-stu-id="6663c-134">Approximately 3% of Azure Cosmos DB customers experiment with various consistency levels initially before settling on a specific consistency choice for their application.</span></span> <span data-ttu-id="6663c-135">要求ベースで整合性レベルを上書きするのは、Azure Cosmos DB テナントのわずか 2% です。</span><span class="sxs-lookup"><span data-stu-id="6663c-135">Only 2% of Azure Cosmos DB tenants override consistency levels on a per request basis.</span></span>

## <a name="consistency-levels-in-detail"></a><span data-ttu-id="6663c-136">整合性レベルの詳細</span><span class="sxs-lookup"><span data-stu-id="6663c-136">Consistency levels in detail</span></span>

<span data-ttu-id="6663c-137">整合性レベルについてより詳しく理解するには、Azure portal で提供されている音符ベースの整合性の例を確認してから、その下にある各レベルの情報を確認してください。</span><span class="sxs-lookup"><span data-stu-id="6663c-137">To learn more about the consistency levels, review the music-note based consistency examples provided in the Azure portal, then review the information below about each level.</span></span>

1. <span data-ttu-id="6663c-138">Azure portal で、**[既定の整合性]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="6663c-138">In the Azure portal, click **Default consistency**.</span></span>
2. <span data-ttu-id="6663c-139">異なるそれぞれの整合性モデルをクリックして、音楽の例を確認します。</span><span class="sxs-lookup"><span data-stu-id="6663c-139">Click through each of the different consistency models and watch the musical examples.</span></span> <span data-ttu-id="6663c-140">データが異なるリージョンにどのように書き込まれるか、また、整合性の選択が音符データの書き込み方法にどのように影響するかを確認します。</span><span class="sxs-lookup"><span data-stu-id="6663c-140">See how data is written to the different regions and how the choice of consistency impacts how the note data is written.</span></span> <span data-ttu-id="6663c-141">"強固" は、単一のリージョンに書き込まれるデータしか利用できないので、灰色表示になっています。</span><span class="sxs-lookup"><span data-stu-id="6663c-141">Note that Strong is grayed out as it is only available for data written to a single region.</span></span>

    ![ポータルでの整合性の設定について理解する](../media/5-change-consistency/consistency.gif)

<span data-ttu-id="6663c-143">整合性レベルについて、さらに詳しく確認していきましょう。</span><span class="sxs-lookup"><span data-stu-id="6663c-143">Let's learn more about the consistency levels.</span></span> <span data-ttu-id="6663c-144">これらの各整合性レベルを使用して、衣料品の小売サイトの製品データおよびユーザー データをどのように操作できるかを検討します。</span><span class="sxs-lookup"><span data-stu-id="6663c-144">Think about how each of these consistency levels could work for your product and user data for your clothing retail site.</span></span>

### <a name="strong-consistency"></a><span data-ttu-id="6663c-145">"強固" 整合性</span><span class="sxs-lookup"><span data-stu-id="6663c-145">Strong consistency</span></span>

* <span data-ttu-id="6663c-146">"強固" 整合性では、[線形化可能性](https://aphyr.com/posts/313-strong-consistency-models)が保証されます。ここでは読み取りに対して最新バージョンのアイテムを返すことが保証されています。</span><span class="sxs-lookup"><span data-stu-id="6663c-146">Strong consistency offers a [linearizability](https://aphyr.com/posts/313-strong-consistency-models) guarantee with the reads guaranteed to return the most recent version of an item.</span></span>
* <span data-ttu-id="6663c-147">レプリカのマジョリティ クォーラムによってコミットされた後でのみ、書き込み結果が見える状態になることが保証されます。</span><span class="sxs-lookup"><span data-stu-id="6663c-147">Strong consistency guarantees that a write is only visible after it is committed durably by the majority quorum of replicas.</span></span> <span data-ttu-id="6663c-148">書き込みは、プライマリとセカンダリのクォーラムとの両方によって同期的かつ永続的にコミットされるか、または中止されるか、のどちらかとなります。</span><span class="sxs-lookup"><span data-stu-id="6663c-148">A write is either synchronously committed durably by both the primary and the quorum of secondaries, or it is aborted.</span></span> <span data-ttu-id="6663c-149">読み取りは常に、マジョリティ リード クォーラムによって認識されます。未コミットの書き込みや部分的な書き込みがクライアントから見えることはなく、読み取りの内容は常に、認識された最新の書き込み結果であることが保証されます。</span><span class="sxs-lookup"><span data-stu-id="6663c-149">A read is always acknowledged by the majority read quorum, a client can never see an uncommitted or partial write and is always guaranteed to read the latest acknowledged write.</span></span> 
* <span data-ttu-id="6663c-150">"強固" 整合性を使用するように構成された Azure Cosmos DB アカウントでは、複数の Azure リージョンをその Azure Cosmos DB アカウントに関連付けることができません。</span><span class="sxs-lookup"><span data-stu-id="6663c-150">Azure Cosmos DB accounts that are configured to use strong consistency cannot associate more than one Azure region with their Azure Cosmos DB account.</span></span>  
* <span data-ttu-id="6663c-151">"強固" 整合性を使用した場合の (消費される要求ユニットに関する) 読み取り操作のコストは、"セッション" や "最終的" 整合性よりも高いものの、"有界整合性制約" と同じです。</span><span class="sxs-lookup"><span data-stu-id="6663c-151">The cost of a read operation (in terms of request units consumed) with strong consistency is higher than session and eventual, but the same as bounded staleness.</span></span>

### <a name="bounded-staleness-consistency"></a><span data-ttu-id="6663c-152">"有界整合性制約" 整合性</span><span class="sxs-lookup"><span data-stu-id="6663c-152">Bounded staleness consistency</span></span>

* <span data-ttu-id="6663c-153">"有界整合性制約" 整合性では、最大でアイテムの *K* 個のバージョンまたはプレフィックスあるいは期間 *t* の分だけ、読み取りが書き込みに対し遅れてもかまわないことが保証されます。</span><span class="sxs-lookup"><span data-stu-id="6663c-153">Bounded staleness consistency guarantees that the reads may lag behind writes by at most *K* versions or prefixes of an item or *t* time-interval.</span></span>
* <span data-ttu-id="6663c-154">このため、"有界整合性制約" を選択する場合、"遅延" は、アイテムのバージョンの数 *K* (書き込みに対する読み取りの遅れ) と、期間 *t* の 2 つの方法で構成できます。</span><span class="sxs-lookup"><span data-stu-id="6663c-154">Therefore, when choosing bounded staleness, the "staleness" can be configured in two ways: number of versions *K* of the item by which the reads lag behind the writes, and the time interval *t*.</span></span>
* <span data-ttu-id="6663c-155">"有界整合性制約" では、"遅延の枠" の中以外では、総合的にグローバルな順序が提供されます。</span><span class="sxs-lookup"><span data-stu-id="6663c-155">Bounded staleness offers total global order except within the "staleness window."</span></span> <span data-ttu-id="6663c-156">リージョン内では、"整合性制約期間" 内外の両方で単調読み取りの保証が実現されます。</span><span class="sxs-lookup"><span data-stu-id="6663c-156">The monotonic read guarantees exist within a region both inside and outside the "staleness window."</span></span>
* <span data-ttu-id="6663c-157">"有界整合性制約" では、整合性が "セッション" または "最終的" の場合よりも、強力な一貫性が保証されます。</span><span class="sxs-lookup"><span data-stu-id="6663c-157">Bounded staleness provides a stronger consistency guarantee than session, consistent-prefix, or eventual consistency.</span></span> <span data-ttu-id="6663c-158">グローバルに配布されたアプリケーションの場合、強固な整合性だけでなく 99.99% の可用性と短い待機時間も求められるシナリオでは、"有界整合性制約" を使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="6663c-158">For globally distributed applications, we recommend you use bounded staleness for scenarios where you would like to have strong consistency but also want 99.99% availability and low latency.</span></span>
* <span data-ttu-id="6663c-159">Bounded Staleness 一貫性が構成された Azure Cosmos DB アカウントでは、任意の数の Azure リージョンをその Azure Cosmos DB アカウントと関連付けることができます。</span><span class="sxs-lookup"><span data-stu-id="6663c-159">Azure Cosmos DB accounts that are configured with bounded staleness consistency can associate any number of Azure regions with their Azure Cosmos DB account.</span></span> 
* <span data-ttu-id="6663c-160">"有界整合性制約" を使用した場合の (消費される RU に関する) 読み取り操作のコストは "セッション" 整合性や "最終的" 整合性よりも高いものの、"強固" 整合性と同じです。</span><span class="sxs-lookup"><span data-stu-id="6663c-160">The cost of a read operation (in terms of RUs consumed) with bounded staleness is higher than session and eventual consistency, but the same as strong consistency.</span></span>

### <a name="session-consistency"></a><span data-ttu-id="6663c-161">"セッション" 整合性</span><span class="sxs-lookup"><span data-stu-id="6663c-161">Session consistency</span></span>

* <span data-ttu-id="6663c-162">"強固" と "有界整合性制約" 整合性レベルで得られるグローバルな整合性モデルとは異なり、"セッション" 整合性はクライアント セッションを対象とします。</span><span class="sxs-lookup"><span data-stu-id="6663c-162">Unlike the global consistency models offered by strong and bounded staleness consistency levels, session consistency is scoped to a client session.</span></span>
* <span data-ttu-id="6663c-163">Session 一貫性は、デバイスまたはユーザーのセッションが関係するすべてのシナリオに最適です。これは、モノトニックな読み取り、モノトニックな書き込み、自己の書き込みの読み取り (RYW) が保証されるためです。</span><span class="sxs-lookup"><span data-stu-id="6663c-163">Session consistency is ideal for all scenarios where a device or user session is involved since it guarantees monotonic reads, monotonic writes, and read your own writes (RYW) guarantees.</span></span>
* <span data-ttu-id="6663c-164">Session 一貫性では、セッションの予測可能な一貫性が確保されます。また、書き込みと読み取りの待機時間が最も短い一方で、読み取りスループットは最大です。</span><span class="sxs-lookup"><span data-stu-id="6663c-164">Session consistency provides predictable consistency for a session, and maximum read throughput while offering the lowest latency writes and reads.</span></span>
* <span data-ttu-id="6663c-165">"セッション" 整合性が構成された Azure Cosmos DB アカウントでは、任意の数の Azure リージョンをその Azure Cosmos DB アカウントと関連付けることができます。</span><span class="sxs-lookup"><span data-stu-id="6663c-165">Azure Cosmos DB accounts that are configured with session consistency can associate any number of Azure regions with their Azure Cosmos DB account.</span></span>
* <span data-ttu-id="6663c-166">"セッション" 整合性レベルを使用した場合の (消費される RU に関する) 読み取り操作のコストは、"強固" および "有界整合性制約" より低く、"最終的" 整合性より高くなります。</span><span class="sxs-lookup"><span data-stu-id="6663c-166">The cost of a read operation (in terms of RUs consumed) with session consistency level is less than strong and bounded staleness, but more than eventual consistency.</span></span>

### <a name="consistent-prefix-consistency"></a><span data-ttu-id="6663c-167">"一貫性のあるプレフィックス" 整合性</span><span class="sxs-lookup"><span data-stu-id="6663c-167">Consistent prefix consistency</span></span>

* <span data-ttu-id="6663c-168">"一貫性のあるプレフィックス" では、長期間書き込みがない場合にグループ内のレプリカが最終的には収束することが保証されます。</span><span class="sxs-lookup"><span data-stu-id="6663c-168">Consistent prefix guarantees that in absence of any further writes, the replicas within the group eventually converge.</span></span> 
* <span data-ttu-id="6663c-169">また、読み取りでは決して順不同の書き込みが確認されないことが保証されます。</span><span class="sxs-lookup"><span data-stu-id="6663c-169">Consistent prefix guarantees that reads never see out of order writes.</span></span> <span data-ttu-id="6663c-170">書き込みが `A, B, C` の順で実行された場合、クライアントでは `A`、`A,B`、または `A,B,C` が確認されますが、`A,C` または `B,A,C` などの順不同が確認されることはありません。</span><span class="sxs-lookup"><span data-stu-id="6663c-170">If writes were performed in the order `A, B, C`, then a client sees either `A`, `A,B`, or `A,B,C`, but never out of order like `A,C` or `B,A,C`.</span></span>
* <span data-ttu-id="6663c-171">"一貫性のあるプレフィックス" が構成された Azure Cosmos DB アカウントでは、任意の数の Azure リージョンをその Azure Cosmos DB アカウントと関連付けることができます。</span><span class="sxs-lookup"><span data-stu-id="6663c-171">Azure Cosmos DB accounts that are configured with consistent prefix consistency can associate any number of Azure regions with their Azure Cosmos DB account.</span></span> 

### <a name="eventual-consistency"></a><span data-ttu-id="6663c-172">"最終的" 整合性</span><span class="sxs-lookup"><span data-stu-id="6663c-172">Eventual consistency</span></span>

* <span data-ttu-id="6663c-173">"最終的" 整合性では、長期間書き込みがない場合にグループ内のレプリカが最終的には収束することが保証されます。</span><span class="sxs-lookup"><span data-stu-id="6663c-173">Eventual consistency guarantees that in absence of any further writes, the replicas within the group eventually converge.</span></span>
* <span data-ttu-id="6663c-174">Eventual 一貫性は最も弱い形態の一貫性であり、クライアントは、過去に認識した値よりも古い値を取得する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="6663c-174">Eventual consistency is the weakest form of consistency where a client may get the values that are older than the ones it had seen before.</span></span>
* <span data-ttu-id="6663c-175">Eventual の一貫性は、読み取りの一貫性という点は最も弱いですが、読み取りと書き込みの待機時間は最短となります。</span><span class="sxs-lookup"><span data-stu-id="6663c-175">Eventual consistency provides the weakest read consistency but offers the lowest latency for both reads and writes.</span></span>
* <span data-ttu-id="6663c-176">Eventual 一貫性が構成された Azure Cosmos DB アカウントでは、任意の数の Azure リージョンをその Azure Cosmos DB アカウントと関連付けることができます。</span><span class="sxs-lookup"><span data-stu-id="6663c-176">Azure Cosmos DB accounts that are configured with eventual consistency can associate any number of Azure regions with their Azure Cosmos DB account.</span></span> 
* <span data-ttu-id="6663c-177">"最終的" 整合性レベルを使用した場合の (消費される RU に関する) 読み取り操作のコストは、すべての Azure Cosmos DB の整合性レベルの中で最も低くなります。</span><span class="sxs-lookup"><span data-stu-id="6663c-177">The cost of a read operation (in terms of RUs consumed) with the eventual consistency level is the lowest of all the Azure Cosmos DB consistency levels.</span></span>

## <a name="summary"></a><span data-ttu-id="6663c-178">まとめ</span><span class="sxs-lookup"><span data-stu-id="6663c-178">Summary</span></span>

<span data-ttu-id="6663c-179">このユニットでは、整合性レベルを使用して、高可用性を最大化する共に、待機時間を最小限に抑える方法を説明しました。</span><span class="sxs-lookup"><span data-stu-id="6663c-179">In this unit, you've learned how consistency levels can be used to maximize high-availability and minimize latency.</span></span>