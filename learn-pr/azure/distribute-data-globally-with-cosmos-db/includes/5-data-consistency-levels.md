Azure Cosmos DB により開発者は、整合性のレベルに応じて明確に定義された整合性モデルを 5 種類の中から選択することができます。具体的には、"強固"、"有界整合性制約"、"セッション"、"一貫性のあるプレフィックス"、"最終的" の 5 つが用意されています。 これらの整合性レベルを利用すると、ニーズに応じてデータベースの可用性とパフォーマンスを最大限に活用できます。 特定の順序でデータを処理する必要がある場合なら、整合性に "強固" を選ぶことが適切かもしれません。 あるいは、データの一貫性が直ちに必要ではない場合なら、整合性に "最終的" を選ぶことが適切かもしれません。 

このユニットでは、Azure Cosmos DB で利用可能な整合性レベルについて理解し、オンラインの衣料品サイトに適切な整合性レベルを決定します。

## <a name="consistency-basics"></a>整合性の基本

各データベース アカウントは既定の整合性レベルを備えています。これによって、アカウント内のデータの整合性が決定されます。 整合性レベルの一方の終端は、"強固" です。この整合性レベルでは、線形化可能性を提供し、読み取りに対して最新バージョンのアイテムを返すことが保証されています。 整合性レベルのもう一方の終端は、"最終的" です。この整合性レベルでは、長期間書き込みがない場合にグループ内のレプリカが最終的には収束することが保証されます。 中間の整合性レベルは "セッション" です。この整合性レベルでは、単調読み取り、単調書き込み、および自己の書き込みの読み取り (RYW) が保証されるため、最もよく使用されます。

![Azure Cosmos DB の 5 つの整合性レベル](../media/5-change-consistency/five-consistency-levels.png)

各整合性レベルが保証する内容を次の表に示します。
 
**整合性レベルと保証内容**

| 整合性レベル | 保証内容 |
| --- | --- |
| 強固 | 線形化可能性。 読み取りでは、項目の最新バージョンを返すことが保証されます。|
| 有界整合性制約 | 一貫性のあるプレフィックス。 書き込みに対して読み取りが、最大でプレフィックス k または間隔 t だけ遅延します。 |
| セッション   | 一貫性のあるプレフィックス。 単調読み取り、単調書き込み、自己の書き込みの読み取り、読み取り後の書き込み。 |
| 一貫性のあるプレフィックス | 返される更新が、それ以外の全更新の一部のプレフィックスとなります (ギャップなし)。 |
| 最終的  | 読み取りは順不同です。 |

Azure portal で、お使いの Azure Cosmos DB アカウントでの既定の整合性レベルを構成できます (さらに、後から特定の読み取り要求で既定の整合性を上書きすることもできます)。 内部的には、複数のリージョンにまたがる可能性があるパーティション セット内のデータに対して、既定の整合性レベルが適用されます。

Azure Cosmos DB では、整合性が "セッション"、"一貫性のあるプレフィックス"、"最終的" の場合の読み取りは、整合性が "強固" または "有界整合性制約" の場合の読み取りよりも、要求単位での消費量を 2 倍節約できます。

### <a name="use-of-consistency-levels"></a>整合性レベルの使用

Azure Cosmos DB テナントの約 73% が "セッション" 整合性を使い、20% が "有界整合性制約" を使っています。 Azure Cosmos DB の顧客の約 3% が、アプリケーション用に特定の一貫性の設定を選ぶ前に、さまざまな一貫性レベルを試しています。 要求ベースで整合性レベルを上書きするのは、Azure Cosmos DB テナントのわずか 2% です。

## <a name="consistency-levels-in-detail"></a>整合性レベルの詳細

整合性レベルについてより詳しく理解するには、Azure portal で提供されている音符ベースの整合性の例を確認してから、その下にある各レベルの情報を確認してください。

1. Azure portal で、**[既定の整合性]** をクリックします。
2. 異なるそれぞれの整合性モデルをクリックして、音楽の例を確認します。 データが異なるリージョンにどのように書き込まれるか、また、整合性の選択が音符データの書き込み方法にどのように影響するかを確認します。 "強固" は、単一のリージョンに書き込まれるデータしか利用できないので、灰色表示になっています。

    ![ポータルでの整合性の設定について理解する](../media/5-change-consistency/consistency.gif)

整合性レベルについて、さらに詳しく確認していきましょう。 これらの各整合性レベルを使用して、衣料品の小売サイトの製品データおよびユーザー データをどのように操作できるかを検討します。

### <a name="strong-consistency"></a>"強固" 整合性

* "強固" 整合性では、[線形化可能性](https://aphyr.com/posts/313-strong-consistency-models)が保証されます。ここでは読み取りに対して最新バージョンのアイテムを返すことが保証されています。
* レプリカのマジョリティ クォーラムによってコミットされた後でのみ、書き込み結果が見える状態になることが保証されます。 書き込みは、プライマリとセカンダリのクォーラムとの両方によって同期的かつ永続的にコミットされるか、または中止されるか、のどちらかとなります。 読み取りは常に、マジョリティ リード クォーラムによって認識されます。未コミットの書き込みや部分的な書き込みがクライアントから見えることはなく、読み取りの内容は常に、認識された最新の書き込み結果であることが保証されます。 
* "強固" 整合性を使用するように構成された Azure Cosmos DB アカウントでは、複数の Azure リージョンをその Azure Cosmos DB アカウントに関連付けることができません。  
* "強固" 整合性を使用した場合の (消費される要求ユニットに関する) 読み取り操作のコストは、"セッション" や "最終的" 整合性よりも高いものの、"有界整合性制約" と同じです。

### <a name="bounded-staleness-consistency"></a>"有界整合性制約" 整合性

* "有界整合性制約" 整合性では、最大でアイテムの *K* 個のバージョンまたはプレフィックスあるいは期間 *t* の分だけ、読み取りが書き込みに対し遅れてもかまわないことが保証されます。
* このため、"有界整合性制約" を選択する場合、"遅延" は、アイテムのバージョンの数 *K* (書き込みに対する読み取りの遅れ) と、期間 *t* の 2 つの方法で構成できます。
* "有界整合性制約" では、"遅延の枠" の中以外では、総合的にグローバルな順序が提供されます。 リージョン内では、"整合性制約期間" 内外の両方で単調読み取りの保証が実現されます。
* "有界整合性制約" では、整合性が "セッション" または "最終的" の場合よりも、強力な一貫性が保証されます。 グローバルに配布されたアプリケーションの場合、強固な整合性だけでなく 99.99% の可用性と短い待機時間も求められるシナリオでは、"有界整合性制約" を使用することをお勧めします。
* Bounded Staleness 一貫性が構成された Azure Cosmos DB アカウントでは、任意の数の Azure リージョンをその Azure Cosmos DB アカウントと関連付けることができます。 
* "有界整合性制約" を使用した場合の (消費される RU に関する) 読み取り操作のコストは "セッション" 整合性や "最終的" 整合性よりも高いものの、"強固" 整合性と同じです。

### <a name="session-consistency"></a>"セッション" 整合性

* "強固" と "有界整合性制約" 整合性レベルで得られるグローバルな整合性モデルとは異なり、"セッション" 整合性はクライアント セッションを対象とします。
* Session 一貫性は、デバイスまたはユーザーのセッションが関係するすべてのシナリオに最適です。これは、モノトニックな読み取り、モノトニックな書き込み、自己の書き込みの読み取り (RYW) が保証されるためです。
* Session 一貫性では、セッションの予測可能な一貫性が確保されます。また、書き込みと読み取りの待機時間が最も短い一方で、読み取りスループットは最大です。
* "セッション" 整合性が構成された Azure Cosmos DB アカウントでは、任意の数の Azure リージョンをその Azure Cosmos DB アカウントと関連付けることができます。
* "セッション" 整合性レベルを使用した場合の (消費される RU に関する) 読み取り操作のコストは、"強固" および "有界整合性制約" より低く、"最終的" 整合性より高くなります。

### <a name="consistent-prefix-consistency"></a>"一貫性のあるプレフィックス" 整合性

* "一貫性のあるプレフィックス" では、長期間書き込みがない場合にグループ内のレプリカが最終的には収束することが保証されます。 
* また、読み取りでは決して順不同の書き込みが確認されないことが保証されます。 書き込みが `A, B, C` の順で実行された場合、クライアントでは `A`、`A,B`、または `A,B,C` が確認されますが、`A,C` または `B,A,C` などの順不同が確認されることはありません。
* "一貫性のあるプレフィックス" が構成された Azure Cosmos DB アカウントでは、任意の数の Azure リージョンをその Azure Cosmos DB アカウントと関連付けることができます。 

### <a name="eventual-consistency"></a>"最終的" 整合性

* "最終的" 整合性では、長期間書き込みがない場合にグループ内のレプリカが最終的には収束することが保証されます。
* Eventual 一貫性は最も弱い形態の一貫性であり、クライアントは、過去に認識した値よりも古い値を取得する可能性があります。
* Eventual の一貫性は、読み取りの一貫性という点は最も弱いですが、読み取りと書き込みの待機時間は最短となります。
* Eventual 一貫性が構成された Azure Cosmos DB アカウントでは、任意の数の Azure リージョンをその Azure Cosmos DB アカウントと関連付けることができます。 
* "最終的" 整合性レベルを使用した場合の (消費される RU に関する) 読み取り操作のコストは、すべての Azure Cosmos DB の整合性レベルの中で最も低くなります。

## <a name="summary"></a>まとめ

このユニットでは、整合性レベルを使用して、高可用性を最大化する共に、待機時間を最小限に抑える方法を説明しました。