<span data-ttu-id="c683e-101">複数のリージョンでデータをレプリケートした後は、Azure Cosmos DB で提供されている自動フェールオーバー ソリューションを利用できます。</span><span class="sxs-lookup"><span data-stu-id="c683e-101">Once you've replicated your data in multiple regions, you can take advantage of the automated failover solutions Azure Cosmos DB provides.</span></span> <span data-ttu-id="c683e-102">自動フェールオーバーは、いずれかの読み取りまたは書き込みリージョンがオフラインになる障害またはその他のイベントが発生すると有効になる機能です。これにより、オフラインのリージョンから第 2 優先のリージョンへ要求がリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="c683e-102">Automated failover is a feature that comes into play when there's a disaster or other event that takes one of your read or write regions offline, and it redirects requests from the offline region to the next most prioritized region.</span></span> 

<span data-ttu-id="c683e-103">たとえば、米国東部、米国西部、および英国西部にのみレプリケートされているオンライン衣料品サイトでは、米国東部がオフラインになった場合に、遅延を抑えるために読み取りを英国西部ではなく米国西部にリダイレクトできるよう、優先順位を設定することができます。</span><span class="sxs-lookup"><span data-stu-id="c683e-103">For your online clothing site, which you just replicated into East US, West US, and West UK, you can prioritize that if the East US goes offline, you can redirect reads to West US instead of West UK, to limit latency.</span></span> 

<span data-ttu-id="c683e-104">このユニットでは、フェールオーバーの仕組みと、会社のデータがレプリケートされているリージョンの優先順位を設定する方法について学習します。</span><span class="sxs-lookup"><span data-stu-id="c683e-104">In this unit you'll learn about how failover works and set the priority for the regions in which your company's data has been replicated.</span></span>

## <a name="failover-basics"></a><span data-ttu-id="c683e-105">フェールオーバーの基本</span><span class="sxs-lookup"><span data-stu-id="c683e-105">Failover basics</span></span>

<span data-ttu-id="c683e-106">Azure のリージョン内障害やデータセンターの停止はめったに発生しませんが、発生した場合、Azure Cosmos DB により、影響を受けるリージョンに存在するすべての Azure Cosmos DB アカウントのフェールオーバーが自動的にトリガーされます。</span><span class="sxs-lookup"><span data-stu-id="c683e-106">In the rare event of an Azure regional outage or data center outage, Azure Cosmos DB automatically triggers failovers of all Azure Cosmos DB accounts with a presence in the affected region.</span></span>

<span data-ttu-id="c683e-107">**読み取りリージョンで障害が起きた場合**</span><span class="sxs-lookup"><span data-stu-id="c683e-107">**What happens if a read region has an outage?**</span></span>

<span data-ttu-id="c683e-108">影響を受けるリージョンのいずれかに読み取りリージョンを指定している Azure Cosmos DB アカウントは、自動的にそれらの書き込みリージョンから切断され、オフラインとしてマークされます。</span><span class="sxs-lookup"><span data-stu-id="c683e-108">Azure Cosmos DB accounts with a read region in one of the affected regions are automatically disconnected from their write region and marked offline.</span></span> <span data-ttu-id="c683e-109">Cosmos DB SDK ではリージョン内探索プロトコルが実装されており、リージョンが使用可能になったことを自動的に検出し、優先リージョンの一覧に従って次の使用可能なリージョンに読み込み呼び出しをリダイレクトすることができます。</span><span class="sxs-lookup"><span data-stu-id="c683e-109">The Cosmos DB SDKs implement a regional discovery protocol that allows them to automatically detect when a region is available and redirect read calls to the next available region in the preferred region list.</span></span> <span data-ttu-id="c683e-110">優先リージョンの一覧にあるいずれのリージョンも使用可能でない場合、呼び出しは自動的に現在の書き込みリージョンに戻ります。</span><span class="sxs-lookup"><span data-stu-id="c683e-110">If none of the regions in the preferred region list is available, calls automatically fall back to the current write region.</span></span> <span data-ttu-id="c683e-111">リージョン内フェールオーバーを処理するアプリケーション コードは、変更する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="c683e-111">No changes are required in your application code to handle regional failovers.</span></span> <span data-ttu-id="c683e-112">この処理全体において、Azure Cosmos DB によって一貫性の保証が継続的に実現されています。</span><span class="sxs-lookup"><span data-stu-id="c683e-112">During this entire process, consistency guarantees continue to be honored by Azure Cosmos DB.</span></span>

<span data-ttu-id="c683e-113">影響を受けたリージョンが障害から復旧したら、そのリージョン内で影響を受けたすべての Azure Cosmos DB アカウントは、サービスにより自動的に復旧されます。</span><span class="sxs-lookup"><span data-stu-id="c683e-113">Once the affected region recovers from the outage, all the affected Azure Cosmos DB accounts in the region are automatically recovered by the service.</span></span> <span data-ttu-id="c683e-114">そして、影響を受けたリージョンに読み取りリージョンがあった Azure Cosmos DB アカウントは、自動的に現在の書き込みリージョンと同期してオンラインになります。</span><span class="sxs-lookup"><span data-stu-id="c683e-114">Azure Cosmos DB accounts that had a read region in the affected region will then automatically sync with current write region and turn online.</span></span> <span data-ttu-id="c683e-115">Azure Cosmos DB SDK では、新しいリージョンが使用可能かを検出し、そのリージョンを現在の読み取りリージョンとして選択すべきかどうか、アプリケーションで構成された優先リージョンの一覧に基づいて判断します。</span><span class="sxs-lookup"><span data-stu-id="c683e-115">The Azure Cosmos DB SDKs discover the availability of the new region and evaluate whether the region should be selected as the current read region based on the preferred region list configured by the application.</span></span> <span data-ttu-id="c683e-116">それ以降の読み取りは、アプリケーション コードを変更しなくても、復旧したリージョンにリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="c683e-116">Subsequent reads are redirected to the recovered region without requiring any changes to your application code.</span></span>

<span data-ttu-id="c683e-117">**書き込みリージョンで障害が起きた場合**</span><span class="sxs-lookup"><span data-stu-id="c683e-117">**What happens if a write region has an outage?**</span></span>

<span data-ttu-id="c683e-118">影響を受けたリージョンが現在の書き込みリージョンであり、Azure Cosmos DB アカウントの自動フェールオーバーが有効になっている場合、リージョンは自動的にオフラインとしてマークされます。</span><span class="sxs-lookup"><span data-stu-id="c683e-118">If the affected region is the current write region and automatic failover is enabled for the Azure Cosmos DB account, then the region is automatically marked as offline.</span></span> <span data-ttu-id="c683e-119">そして、影響を受けた Azure Cosmos DB アカウントでは、代替リージョンが書き込みリージョンとして昇格されます。</span><span class="sxs-lookup"><span data-stu-id="c683e-119">Then, an alternative region is promoted as the write region for the affected Azure Cosmos DB account.</span></span>

<span data-ttu-id="c683e-120">自動フェールオーバー中、Azure Cosmos DB では、指定された優先順位に基づいて、指定の Azure Cosmos DB アカウント用の次の書き込みリージョンが自動的に選択されます。</span><span class="sxs-lookup"><span data-stu-id="c683e-120">During automatic failovers, Azure Cosmos DB automatically chooses the next write region for a given Azure Cosmos DB account based on the specified priority order.</span></span> <span data-ttu-id="c683e-121">アプリケーションでは、DocumentClient クラスの WriteEndpoint プロパティを使用して、書き込みリージョン内の変更を検出できます。</span><span class="sxs-lookup"><span data-stu-id="c683e-121">Applications can use the WriteEndpoint property of DocumentClient class to detect the change in write region.</span></span>

<span data-ttu-id="c683e-122">影響を受けたリージョンが障害から復旧したら、そのリージョン内で影響を受けたすべての Cosmos DB アカウントは、サービスにより自動的に復旧されます。</span><span class="sxs-lookup"><span data-stu-id="c683e-122">Once the affected region recovers from the outage, all the affected Cosmos DB accounts in the region are automatically recovered by the service.</span></span>

<span data-ttu-id="c683e-123">では、データベースの読み取りリージョンを変更してみましょう。</span><span class="sxs-lookup"><span data-stu-id="c683e-123">Now let's modify the read region for your database.</span></span>

## <a name="set-read-region-priorities"></a><span data-ttu-id="c683e-124">読み取りリージョンの優先順位を設定する</span><span class="sxs-lookup"><span data-stu-id="c683e-124">Set read region priorities</span></span>

1. <span data-ttu-id="c683e-125">Azure portal の **[データをグローバルにレプリケートする]** 画面で、**[自動フェールオーバー]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="c683e-125">In the Azure portal, on the **Replicate data globally** screen, click **Automatic Failover**.</span></span> <span data-ttu-id="c683e-126">自動フェールオーバーは、データベースが複数のリージョンに既にレプリケートされている場合にのみ有効になります。</span><span class="sxs-lookup"><span data-stu-id="c683e-126">Automatic failover is only enabled if the database has already been replicated to more than one region.</span></span>
2. <span data-ttu-id="c683e-127">**[自動フェールオーバー]** 画面で、**[自動フェールオーバーの有効化]** を **[ON]** にします。</span><span class="sxs-lookup"><span data-stu-id="c683e-127">On the **Automatic Failover** screen, change **Enable Automatic Failover** to **ON**.</span></span>
3. <span data-ttu-id="c683e-128">**[読み取りリージョン]** セクションで、**[米国東部]** 行の左側の部分をクリックし、先頭位置までドラッグ アンド ドロップします。</span><span class="sxs-lookup"><span data-stu-id="c683e-128">In the **Read regions** section, click the left portion of the **East US** row, and then drag and drop at the top position.</span></span>
4. <span data-ttu-id="c683e-129">**[日本東部]** 行の左側の部分をクリックし、2 番目の位置までドラッグ アンド ドロップします。</span><span class="sxs-lookup"><span data-stu-id="c683e-129">Click the left portion of the **Japan East** row, and then drag and drop to the second position.</span></span>
5. <span data-ttu-id="c683e-130">**[OK]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="c683e-130">Click **OK**.</span></span>

    ![ポータルで読み取りリージョンを変更する](../media/4-change-priorities/change-read-priorities.gif)

## <a name="summary"></a><span data-ttu-id="c683e-132">まとめ</span><span class="sxs-lookup"><span data-stu-id="c683e-132">Summary</span></span>

<span data-ttu-id="c683e-133">このユニットでは、自動フェールオーバーによって提供される内容、予想外の障害から保護するための使用方法、および読み取りリージョンの優先順位を変更する方法を学習しました。</span><span class="sxs-lookup"><span data-stu-id="c683e-133">In this unit, you've learned what automatic failover provides, how you can use it to protect against unforeseen outages, and how to modify read region priorities.</span></span>