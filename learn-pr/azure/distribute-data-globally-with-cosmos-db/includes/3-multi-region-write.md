eコマース シナリオで優れたユーザー エクスペリエンスを確保するには、高可用性と低遅延が必要です。

先ほど作成した Azure Cosmos DB アカウントでマルチマスター サポートを有効にすることで、これらのパフォーマンスの両方の側面で複数の利点が得られます。そのすべての利点は、Azure Cosmos DB で提供される財務的な裏付けのあるサービス レベル アグリーメント (SLA) によって保証されます。

## <a name="what-is-multi-master-support"></a>マルチマスター サポートとは

マルチマスター サポートは、新しい Azure Cosmos DB アカウントで有効にできるオプションです。 アカウントが複数のリージョンでレプリケートされると、各リージョンはマスター リージョンとなり、write-anywhere モデル (アクティブ/アクティブ パターンともいう) に同等に関与します。

マルチマスター構成でマスター リージョンとして稼働する Azure Cosmos DB リージョンは、すべてのレプリカに書き込まれたデータを収束し、グローバルな一貫性とデータ整合性を確保するために自動的に動作します。

Azure Cosmos DB のマルチマスター サポートを利用することで、世界中の書き込み可能なリージョン内のコンテナーに対する書き込みを行うことができます。 書き込まれたデータはすぐにその他のすべてのリージョンに伝達されます。  

## <a name="what-are-the-benefits-of-multi-master-support"></a>マルチマスター サポートの利点とは

マルチマスター サポートの利点は次のとおりです。

* 1 桁の書き込み待機時間 – マルチマスター アカウントでは書き込み待機時間が改善され、99% の書き込みでは 10 ミリ秒未満となりました。マルチマスター以外のアカウントの場合は 15 ミリ秒未満です。
* 99.999% の読み取り/書き込み可用性 - マルチマスター アカウントでは書き込み可用性が向上し、99.999% となりました。マルチ マスター以外のアカウントの場合は 99.99% です。
* 無制限の書き込みスケーラビリティとスループット – マルチマスター アカウントでは、数十億ものデバイスをサポートするために無制限の書き込みスケーラビリティとスループットが提供され、すべてのリージョンに書き込むことができます。
* 組み込みの競合解決 - マルチマスター アカウントには、グローバルなデータ整合性と一貫性を確保するために競合解決の 3 つの方法が用意されています。 

## <a name="conflict-resolution"></a>競合解決

マルチマスター サポートが追加されたことで、さまざまなリージョンへの書き込みの際に競合が発生する可能性があります。 競合は Azure Cosmos DB では非常にまれなことであり、リージョン間で伝達される前に、複数のリージョンで項目が同時に変更されたときにのみ発生する可能性があります。 グローバルにレプリケーションが発生する速度を考えれば、仮にあったとしてもめったに発生することはありません。 しかし、Azure Cosmos DB には競合解決モードが用意されており、ユーザーは、同じレコードが 2 つ以上のリージョンで異なる作成者によって同時に更新されるシナリオを処理する方法を決定することができます。  

Azure Cosmos DB では、3 つの競合解決モードが提供されます。 
* **Last-Writer-Wins (LWW)**: ドキュメント内のユーザー定義の整数プロパティの値に基づいて、競合が解決されます。 既定では、最後に書き込まれたドキュメントを判別するために _ts が使用されます。 Last-Writer-Wins は、既定の競合処理メカニズムです。
* **カスタム - ユーザー定義プロシージャ**: コレクションにユーザー定義プロシージャを登録することで、競合解決を完全に制御できます。 ユーザー定義プロシージャは、非常に特殊な署名による特殊な種類のストアド プロシージャです。 ユーザー定義プロシージャが失敗したか、存在しない場合、Azure Cosmos DB によって、すべての競合が読み取り専用の競合フィードに追加され、非同期的に処理することができます。  
* **カスタム - 非同期**: Azure Cosmos DB によってすべての競合がコミット対象から除外され、ユーザーのアプリケーションによる遅延解決のために読み取り専用の競合フィードに登録されます。 アプリケーションでは非同期的に競合解決を行い、任意のロジックを使用するか、任意の外部ソース、アプリケーションまたはサービスを参照して競合を解決することができます。

## <a name="summary"></a>まとめ

このユニットでは、可用性とパフォーマンスを向上させるために複数のリージョンにデータを書き込むことができる、マルチマスター アカウントについて学習しました。