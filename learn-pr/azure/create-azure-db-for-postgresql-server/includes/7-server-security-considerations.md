オンプレミスの PostgreSQL データベースを使用するいると仮定します。 セキュリティのあらゆる面を管理しているし、標準的な PostgreSQL サーバー レベルのファイアウォール規則を使用して、サーバーにすべてのアクセスをロックしました。 Azure のファイアウォール規則のようにサーバー レベルの同じ構成できることを確認するようになりました。

## <a name="server-security-considerations-and-connection-methods"></a>サーバーのセキュリティに関する考慮事項との接続方法

多くの Azure Database for PostgreSQL サーバーとデータベースへのアクセスを制限するオプションがあります。 ネットワーク アクセスは、ネットワーク、サーバー、またはデータベース レベルで制限できます。 次のオプションのいずれかを使用することができます。

- データベースへのアクセスを制限するユーザー アカウント
- 仮想ネットワークのネットワーク アクセスを制限するには
- サーバーへのアクセスを制限するファイアウォール規則

### <a name="authentication-and-authorization"></a>認証と権限承認

Azure Database for PostgreSQL サーバーは、ネイティブ PostgreSQL 認証をサポートします。 接続し、サーバーの管理者ログインを持つサーバーに対して認証できます。 ユーザー アクセスを制限する特定のデータベースに接続を作成することもあります。

### <a name="what-is-a-virtual-network"></a>仮想ネットワークとは何ですか?

仮想ネットワークとは、Azure ネットワーク内で作成される論理的に分離されたネットワークです。 仮想ネットワークを使用して、他のリソースに接続できる Azure リソースを制御することができます。

データベースに接続する web アプリケーションを実行していることを想像してください。 ネットワークのさまざまな部分を分離するのにサブネットを使用します。 サブネットは、範囲の IP アドレスに基づくネットワークの一部です。

これらのサブネットを構成するには仮想ネットワークを作成し、ネットワークをサブネットに分割します。 Web アプリケーションは、1 つのサブネットと別のサブネット上のデータベースで動作します。 各サブネットは、独自の規則とその他のネットワークの間の通信を行うためにがあります。 これらのルールでは、データベースから web アプリケーションへのアクセスを制限する機能を提供します。

仮想ネットワークの作成はこのモジュールの範囲外です。 詳細については、必要がある場合は、仮想ネットワークに関連するその他のラーニング モジュールを探索してください。

### <a name="what-is-a-firewall"></a>ファイアウォールとは何ですか。

ファイアウォールは、各要求の発信元 IP アドレスに基づいてサーバーへのアクセスを許可するサービスです。 IP アドレスの範囲を指定するファイアウォール規則を作成します。 IP アドレスは、サーバーへのアクセスを許可するこれらのクライアントのみが与えられます。 ファイアウォール規則、一般に、含めることも特定のネットワーク プロトコルとポート情報。 たとえば、既定では、PostgreSQL サーバーは、ポート 5432 での TCP 要求をリッスンします。

### <a name="azure-database-for-postgresql-server-firewall"></a>Azure Database for PostgreSQL サーバーのファイアウォール

Azure Database for PostgreSQL サーバーのファイアウォールでは、どのコンピューターに権限を指定するまで、データベース サーバーにすべてのアクセスができなくなります。 ファイアウォールの構成サーバーへの接続を許可する範囲の IP アドレスを指定することができます。 サーバーは、常に既定の PostgreSQL の接続情報を使用します。

![Azure のファイアウォール機能図](../media-draft/7-firewall-diagram.png)

### <a name="azure-database-for-postgresql-server-ssl-connections"></a>PostgreSQL サーバーの SSL 接続用の azure データベース

Azure Database for PostgreSQL では、クライアント アプリケーションが Secure Sockets Layer (SSL) を使用して、PostgreSQL サービスに接続するが優先されます。 "Man in the middle"に対して保護により、データベース サーバーとクライアント アプリケーションの間の SSL 接続を適用して、サーバーとクライアント間のデータを暗号化することで同様の攻撃です。 SSL を有効にするには、キーと動作するには、クライアントとサーバー接続の間の厳密な認証の交換する必要があります。 SSL の使用に関する詳細については、この機械学習モジュールの範囲を超えています。 詳細については、必要がある場合は、SSL に関連するその他の学習モジュールを探索してください。

## <a name="configure-connection-security"></a>接続のセキュリティを構成します。

決定し、Azure Database for PostgreSQL サーバーのファイアウォールを構成する手順を見てみましょう。 先ほど作成したサーバーに接続する方法を確認します。

最初に開きます、 [Azure portal](https://portal.azure.com?azure-portal=true)ファイアウォール規則を作成するサーバー リソースに移動します。

選択し、**接続のセキュリティ**オプション、右側に接続のセキュリティ ブレードを開きます。

![PostgreSQL データベースのリソース ブレードの接続のセキュリティ セクションを示す Azure portal のスクリーン ショット](../media-draft/7-db-security-settings.png)

この画面では、いくつかのオプションがあります。 次のようにすることができます。

- をクリックしてファイアウォールのエントリとして、ポータルにアクセスするために使用する IP アドレスを追加、**クライアント IP の追加**ボタンをクリックします。
- Azure サービスへのアクセスを許可します。 既定では、すべての Azure サービスによって**しない**PostgreSQL サーバーにアクセスします。
- IP アドレスの範囲を入力して、ファイアウォール規則を追加します。
- SSL 接続を強制します。 このオプションは、SSL 証明書を使用してサーバーに接続するようにクライアントを強制します。

をクリックしてください、**保存**変更を行った後に、更新された構成を保存する、入力フィールドの上のアイコン。

### <a name="allow-access-to-azure-services"></a>Azure サービスへのアクセス許可

Azure Cloud Shell にアクセスしたり、サーバーの構成を使用することを有効にすることを確認して**Azure サービスへのアクセスを許可する**します。 この手順は、Cloud Shell からのアクセスを許可するサーバーの構成にファイアウォール規則を追加しようとしています。 このルールは、追加したカスタムの規則の 1 つとして表示されません。

無効にする必要がありますも**強制 SSL 接続**します。 PowerShell は、SSL がクライアント接続に必要な場合は、サーバーに接続できません。

これらのオプションの両方により、コマンドラインに表示しない場合に、正しく構成されているエラー メッセージが発生します。

たとえば、アクセスが Azure サービスが許可されていないと、SSL 接続を強制が有効な場合、ファイアウォールがアクセスをブロックしているときにこのエラーのような画面が表示されます。

> psql: FATAL: pg_hba.conf エントリのホスト「123.45.67.89」ユーザー「管理者」データベース"postgres", SSL の致命的なエラー: SSL 接続が必要です。 Please specify SSL options and retry. (SSL のオプションを指定して再試行してください。)

### <a name="create-a-firewall-rule-using-the-portal"></a>ポータルを使用してファイアウォール規則を作成します。

たとえば、任意の IP アドレスからのアクセスを提供するファイアウォール規則を作成したいとします。

> [!WARNING]
> このファイアウォール規則を作成、サーバーに接続しようとしています。 インターネット経由で任意の IP アドレスを許可します。 いなくてもクライアントでは、ユーザー名とパスワードなしのサーバーにアクセスできませんをする、慎重にこの規則を有効にする、およびセキュリティへの影響を理解することはありません。

新しいファイアウォール規則を作成するには、ラベル付きのフィールドに次のデータを入力します。

- ルール名: `AllowAll`
- 開始 IP: `0.0.0.0`
- 終了 IP: `255.255.255.255`

ファイアウォール規則を削除するには、削除するルールの末尾にある省略記号 (...) をクリックします。 をクリックして、**削除**ルールを削除するボタンをクリックします。

をクリックして、**保存**ルールの削除をコミットする入力フィールドの上のアイコン。

### <a name="create-a-firewall-rule-using-the-azure-cli"></a>Azure CLI を使用してファイアウォール規則を作成します。

Azure CLI を使用して、ファイアウォール規則を使用してサーバーを追加する、 `az postgres server firewall-rule create` Azure CloudShell を使用してコマンドします。

たとえば、上記と同じ規則を作成したいとします。 次のコマンドを使用します。

  ```azurecli
  az postgres server firewall-rule create --resource-group <resource_group_name> --server <server-name> --name AllowAll --start-ip-address 0.0.0.0 --end-ip-address 255.255.255.255
  ```

コマンドを使用してサーバーからファイアウォール規則を削除する`az postgres server firewall-rule delete`します。

たとえば、作成したファイアウォールを削除するとします。 次のコマンドを使用します。

  ```azurecli
  az postgres server firewall-rule delete --name AllowAll --resource-group <resource_group_name> --server-name <server-name>
  ```

## <a name="connecting-to-your-server"></a>サーバーに接続します。

など、最新のデータベースは、PostgreSQL には、最高のパフォーマンスを実現するために通常のサーバー管理が必要です。 さまざまな接続し、Azure Database for PostgreSQL サーバーを管理するオプションがあります。 使用して`psql`サーバーに接続します。

### <a name="what-is-psql"></a>Psql とは何ですか。

コマンド ライン ツールと呼ばれる`psql`は、PostgreSQL の PostgreSQL サーバーおよびデータベースを操作するための対話型ターミナルに分散します。 `psql` Azure database for PostgreSQL と同様に機能の他の PostgreSQL の実装を含むと Azure Cloud Shell に含まれています。 `psql`ツールでは、データベースを管理できるだけでなく、これらのデータベースに対して構造のクエリを実行することができます。

使用して`psql`PostgreSQL サーバーに成功した接続が必要です。 使用する場合、多数のコマンド ライン パラメーターを使用できるしてある`psql`します。

- `--host` -をしたい接続ホスト。
- `--username` -ユーザー名と接続先となる ID。
- `--dbname` -に接続するデータベースの名前。

> [!Note]
> 接続します通常、`postgres`管理データベース サーバーのアクセスとデータベースの構成を管理するときにします。

完全なコマンドを次に示します。

  ```bash
  psql --host=<server-name>.postgres.database.azure.com --username=<admin-user>@<server-name> --dbname=<database>
  ```

接続すると後、は、コマンド プロンプトが表示され、サーバーとデータベースにコマンドを実行できます。

今すぐ PostgreSQL セキュリティ設定を Azure データベースを構成するために実行する手順を説明しました。 次の単位では、PostgreSQL のセキュリティ設定用 Azure データベースを構成します。 Cloud Shell を使用してサーバーに接続することもあります。
