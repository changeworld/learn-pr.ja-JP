あなたは、オンプレミスの PostgreSQL データベースを使用しているとします。 セキュリティのあらゆる面を管理していて、標準的な PostgreSQL サーバー レベルのファイアウォール規則を使用してサーバーへのすべてのアクセスをロック ダウンしました。 ここまでの説明で、Azure で同一のサーバー レベルのファイアウォール規則を構成する方法について理解を深めることができました。

作成した Azure Database for PostgreSQL サーバーのいずれかに接続しましょう。

## <a name="allow-azure-service-access"></a>Azure サービスへのアクセス許可

始める前に、サーバーに接続するのに PowerShell および `psql` を使用する場合は、Azure サービスへのアクセスを許可する必要があります。 アクセスを許可するには 2 つの方法があります。

1 つ目の方法では、**[Azure サービスへのアクセスを許可]** をオンにします。 アクセスを許可すると、作成したカスタム規則の一覧に規則が入力されていない場合でも、ファイアウォール規則が作成されます。

2 つ目の方法では、すべての IP アドレスへのアクセスを許可するファイアウォール規則を作成します。 この規則には、`psql` の実行に使用する、PowerShell を実行しているクライアントの IP アドレスが含まれます。

**[SSL 接続を強制する]** オプションを無効にする必要もあります。

### <a name="create-a-firewall-rule"></a>ファイアウォール規則を作成する

1. サンドボックスをアクティブ化したときと同じアカウントを使用して、[Azure portal](https://portal.azure.com/learn.docs.microsoft.com?azure-portal=true) にサインインします。

1. ファイアウォール規則を作成する対象のサーバー リソースに移動します。

1. **[接続のセキュリティ]** オプションを選択して、右側の接続のセキュリティ ブレードを開きます。

    ![PostgreSQL データベース リソース ブレードの [接続のセキュリティ] セクションを示す Azure portal のスクリーン ショット](../media/7-db-security-settings.png)

`psql` を実行している PowerShell クライアントへのアクセスを許可する必要があります。

次のいずれかを選択できます。

- **[Azure サービスへのアクセスを許可]** を **[オン]** に設定します。
- **[SSL 接続を強制する]** を **[無効]** に設定します。
- **[保存]** をクリックして、変更を保存します。

または、すべての IP アドレスへのアクセスを許可するファイアウォール規則を追加します。 次の値を使用します。

- 規則名: `AllowAll`
- 開始 IP: `0.0.0.0`
- 終了 IP: `255.255.255.255`
- **[SSL 接続を強制する]** を **[無効]** に設定します。
- **[保存]** をクリックして、変更を保存します。

> [!Warning]
> このファイアウォール規則を作成すると、インターネット上のすべての IP アドレスがサーバーへの接続を試みることができます。 運用環境では、アクセスを特定の IP アドレスに限定します。

### <a name="connect-to-the-database-with-psql"></a>psql を使用してデータベースに接続する

1. 右側の Azure Cloud Shell で、次のコマンドを使用して PSQL をご自分のサーバーに接続します。 サーバー名と管理者名は必ず置換してください。

    ```bash
    psql --host=<server-name>.postgres.database.azure.com --username=<admin-user>@<server-name> --dbname=postgres
    ```

    `server-name` および `admin-user` に選択した値を使用します。

1. **postgres** は、すべての PostgreSQL サーバーの作成に使用される既定の管理データベースです。 サーバーの作成時に指定したパスワードを入力するよう求めるプロンプトが表示されます。

1. 正常に接続されたら、<kbd>\l</kbd> コマンドを実行してすべてのデータベースを一覧表示します。 このコマンドにより、2 つ以上の既定のデータベースが返されます。

1. <kbd>q</kbd> キーを押してリストを終了します。

1. 他の PSQL コマンドを試すことができます。
    - <kbd>\?</kbd> ヘルプを表示します。
    - <kbd>\dt</kbd>: テーブルを一覧表示します。

1. サーバー上で PSQL 演算の実行が完了したら、コマンド <kbd>\q</kbd> を実行して PSQL を終了します。
