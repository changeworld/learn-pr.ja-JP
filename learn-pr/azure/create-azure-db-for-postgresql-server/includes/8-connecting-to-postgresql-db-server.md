オンプレミスの PostgreSQL データベースを使用しているとします。 セキュリティのあらゆる面を管理していて、標準的な PostgreSQL サーバー レベルのファイアウォール規則を使用してサーバーへのすべてのアクセスをロック ダウンしました。 ここまでの説明で、Azure で同一のサーバー レベルのファイアウォール規則を構成する方法について理解を深めることができました。

ここでは、以前に `psql` を使用して作成した Azure Database for PostgreSQL サーバーの 1 つに接続してみます。

## <a name="allow-azure-service-access"></a>Azure サービスへのアクセス許可

作業を開始する前に、次のことを行います。 サーバーに接続するのに PowerShell および `psql` を使用する場合は、Azure サービスへのアクセスを許可する必要があります。 アクセスを許可するには 2 つの方法があります。

1 つ目の方法では、**[Azure サービスへのアクセスを許可]** をオンにします。 アクセスを許可すると、作成したカスタム規則の一覧に規則が入力されていない場合でも、ファイアウォール規則が作成されます。

2 つ目の方法では、すべての IP アドレスへのアクセスを許可するファイアウォール規則を作成します。 この規則には、`psql` の実行に使用する、PowerShell を実行しているクライアントの IP アドレスが含まれます。

**[SSL 接続を強制する]** を無効にする必要もあります。

早速始めましょう。

[Azure portal](https://portal.azure.com?azure-portal=true) にサインインします。 ファイアウォール規則を作成する対象のサーバー リソースに移動します。

**[接続のセキュリティ]** オプションを選択して、右側の接続のセキュリティ ブレードを開きます。

![PostgreSQL データベースのセキュリティ設定](../media-draft/7-db-security-settings.png)

`psql` を実行している PowerShell クライアントへのアクセスを許可する必要があります。

次のいずれかを選択できます。

- **[Azure サービスへのアクセスを許可]** を **[オン]** に設定します。
- **[SSL 接続を強制する]** を **[無効]** に設定します。
- **[保存]** をクリックして、変更を保存します。

または、すべての IP アドレスへのアクセスを許可するファイアウォール規則を追加します。 次の値を使用します。

- 規則名: `AllowAll`
- 開始 IP: `0.0.0.0`
- 終了 IP: `255.255.255.255`
- **[SSL 接続を強制する]** を **[無効]** に設定します。
- **[保存]** をクリックして、変更を保存します。

> [!Warning]
> このファイアウォール規則を作成すると、インターネット上のすべての IP アドレスがサーバーへの接続を試みることができます。 クライアントがユーザー名とパスワードなしではサーバーにアクセスできない場合でも、セキュリティへの影響を確実に理解したうえで、慎重にこの規則を有効にします。 運用環境では、特定のクライアント IP アドレスへのアクセスのみを許可します。

次の手順では、Azure Cloud Shell セッションを開始します。 このラボでは、コマンドライン環境として `bash` を使用します。

- Azure portal から Cloud Shell を開きます。 [Azure portal](https://portal.azure.com?azure-portal=true) に移動し、[Open Cloud Shell]\(Cloud Shell を開く\) ボタンをクリックします。

  ![Cloud Shell ボタン](../media-draft/cloud-shell-button.png)

- 複数のサブスクリプションがある場合は、適切なサブスクリプションを使用していることを確認します。 次のコマンドを実行して、アクティブなサブスクリプションを設定することもできます。 0 をサブスクリプション ID に置き換えます。

   ```bash
   az account set --subscription 00000000-0000-0000-0000-000000000000
   ```

- 次のコマンドを使用して、psql をサーバーに接続します。

  ```bash
  psql --host=<server-name>.postgres.database.azure.com --username=<admin-user>@<server-name> --dbname=postgres
  ```

   `server-name` および `admin-user` は、サーバーの作成時に管理者アカウントに対して選択した値です。 `postgres` は、すべての PostgreSQL サーバーの作成に使用される既定の管理データベースです。 サーバーの作成時に指定したパスワードを入力するよう求めるプロンプトが表示されます。

- 正常に接続されたら、`\l` コマンドを実行してすべてのデータベースを一覧表示します。

   このコマンドにより、2 つ以上の既定のデータベースが返されます。

- サーバー上で psql 演算の実行が完了したら、コマンド `\q` を実行して `psql` を終了します。

- 最後に、Cloud Shell を終了するには、`exit` コマンドを実行します。
